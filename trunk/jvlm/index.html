<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>jVLM alpha (grib viewer only)</title>
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <!--[if IE]><script src="excanvas.js"></script><![endif]-->
    <script type="text/javascript" src="http://clients.multimap.com/API/maps/1.1/metacarta_04"></script>
    <script src='http://dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6.1'></script>
    <script src="http://api.maps.yahoo.com/ajaxymap?v=3.0&appid=euzuro-openlayers"></script>
    <script src='http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAU9L35N6EdAtdkT4Cb2abDRR9fpxOiyHPEX_8YzC8CNXvq83W-hRDmTj4GD1F8DLKiaJ97BAfcB5i7w'></script>
    <script src="/externals/OpenLayers/OpenLayers.js"></script>
    <script src='ControlSwitch.js' type='text/javascript'></script>
    <script src='gribmap.js' type='text/javascript'></script>
    <link rel="stylesheet" type="text/css" href="jvlm.css" />
    <script>
    function init() {

        //Pour tenter le rechargement des tiles quand le temps de calcul est > au timeout
        OpenLayers.IMAGE_RELOAD_ATTEMPTS = 5;

        var options = {
            //Projection mercator sphérique (type google map ou osm)
            projection: new OpenLayers.Projection("EPSG:900913"),
            //projection pour l'affichage des coordonnées
            displayProjection: new OpenLayers.Projection("EPSG:4326"),
            //unité : le m
            units: "m",
            maxResolution: 156543.0339,
            maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34,
                                             20037508.34, 20037508.34),
            restrictedExtent: new OpenLayers.Bounds(-40037508.34, -20037508.34,
                                             40037508.34, 20037508.34),
            };

        var layeroption = {
            //sphérique
            sphericalMercator: true,
            //FIXME: voir s'il y a des effets spécifiques à certains layers
            transitionEffect: "resize",
            //pour passer l'ante-meridien sans souci
            wrapDateLine:true,
            };

        //MAP

        map = new OpenLayers.Map(
            "jVlmMap", //identifiant du div contenant la carte openlayer
            options);

        //FIXME : Le layer VLM peut utiliser plusieurs sous-domaine pour paralélliser les téléchargements des tiles.
        //var urlArray = "/cache/gshhstiles/${z}/${x}/${y}.png";
        var urlArray = [ "http://c1.v-l-m.org/gshhstiles/${z}/${x}/${y}.png", "http://c2.v-l-m.org/gshhstiles/${z}/${x}/${y}.png", "http://c3.v-l-m.org/gshhstiles/${z}/${x}/${y}.png", "http://c4.v-l-m.org/gshhstiles/${z}/${x}/${y}.png" ];

        var vlm = new OpenLayers.Layer.XYZ(
            "VLM Layer",
            urlArray,
            layeroption
            );

        //Le Layer Virtual Earth = Bing
        //FIXME : utiliser le nouveau module OpenLayers.Bing()
        var ve = new OpenLayers.Layer.VirtualEarth( "VE", layeroption);
        
        //Le Layer Yahoo
        //FIXME: Bug avec Opera
        var yahoo = new OpenLayers.Layer.Yahoo( "Yahoo", layeroption);

        //Layer Multimap, désactivé car fonctionnement erratique
        //var mm = new OpenLayers.Layer.MultiMap( "MultiMap", layeroption);
        
        //Le layer openlayer classique
        //FIXME: voir les types de layers
        var wms = new OpenLayers.Layer.WMS( "OpenLayers WMS",
                      "http://vmap0.tiles.osgeo.org/wms/vmap0",
                      {layers: 'basic', sphericalMercator: true,}
                      );

        //Le calque de vent made in Vlm
        var grib = new Gribmap.Layer("Gribmap", layeroption);
        //grib.setOpacity(0.9); //FIXME: faut il garder une transparence du vent ?
        
        //Layer Google Physical
        var gphy = new OpenLayers.Layer.Google(
            "Google Physical",
            { type: G_PHYSICAL_MAP,
              sphericalMercator: true,
              transitionEffect: "resize",
              wrapDateLine:true,
            }
        );
        
        //Layer Google Hybrid
        //FIXME: faut t il vraiment le conserver ?
        var ghyb = new OpenLayers.Layer.Google(
            "Google Hybrid",
            { type: G_HYBRID_MAP,
              numZoomLevels: 20,
              sphericalMercator: true,
              transitionEffect: "resize",
              wrapDateLine:true,
            }
        );
        
        //Layer Google Satelit
        var gsat = new OpenLayers.Layer.Google(
            "Google Satellite",
            { type: G_SATELLITE_MAP,
              numZoomLevels: 22,
              sphericalMercator: true,
              transitionEffect: "resize",
              wrapDateLine:true,
            }
        );
        
        //La minimap utilise le layer VLM
        var vlmoverview = vlm.clone();
        
        //Et on ajoute tous les layers à la map.
        map.addLayers([vlm, wms, ve, yahoo, gphy, ghyb, gsat, grib]);
        //map.addLayers([vlm, grib]); //FOR DEBUG
       
       //Controle l'affichage des layers
        map.addControl( new OpenLayers.Control.LayerSwitcher() );

        //Controle l'affichage de la position ET DU VENT de la souris
        map.addControl( new Gribmap.MousePosition({gribmap: grib}) );
        
        //Affichage de l'échelle
        map.addControl(new OpenLayers.Control.ScaleLine());
        
        //Le Permalink
        //FIXME: éviter que le permalink soit masqué par la minimap ?
        map.addControl(new OpenLayers.Control.Permalink('permalink'));
        
        //FIXME: Pourquoi le graticule est il un control ?
        map.addControl(new OpenLayers.Control.Graticule());
        
        //Navigation clavier
        map.addControl(new OpenLayers.Control.KeyboardDefaults());
        
        //Le panel de vent
        map.addControl(new Gribmap.ControlWind());

        //Evite que le zoom molette surcharge le js du navigateur
        var nav = map.getControlsByClass("OpenLayers.Control.Navigation")[0];
        nav.handlers.wheel.cumulative = false;
        nav.handlers.wheel.interval = 100;

        //Minimap
        var ovmapOptions = {
            maximized: true,
            layers: [vlmoverview]
        }
        map.addControl(new OpenLayers.Control.OverviewMap(ovmapOptions));
        
        //Pour centrer quand on a pas de permalink dans l'url
        if (!map.getCenter()) {
            // Don't do this if argparser already did something...
            map.zoomToMaxExtent(); 
        }
    }
    </script>
  </head>
  <body onload="init();">
    <div id="jVlmMap">
      <div id="logovlm"><img src="http://virtual-loup-de-mer.org/images/logos/logovlmnew.png" /></div>
    </div>
  </body>
</html>

