#Documentation pour migrer un serveur VLM vers un autre

##Contexte
On veut migrer :
- les services svn+trac du /home/dev
- les service vlm du /home/vlm
- minimiser le temps d'interruption

##Stratégie de bascule
- STEP 1 : préparation du serveur NEPTUNE2
- STEP 2 : copie de /home/dev
- STEP 3 : installation from scratch du /home/vlm + copie base
- STEP 4 : tests à réaliser
- STEP 5 : sync J-1
- STEP 6 : bascule de l'ip du serveur nouveau (dit NEPTUNE2) sur l'ancienne ip du serveur actuel (dit NEPTUNE2)
- STEP 7 : Phase de surveillance
- STEP 8 : shutdown de NEPTUNE

## STEP1 : Préparation Serveur
* OK : install debian (fm)
* OK : rsync du /root/.ssh (fm)
* OK : authorisation de la clef publique du root neptune sur lui meme
* OK : apt-get install rsync : OK
* OK : maj du sytème (apt-get update && apt-get upgrade)
* OK : rsync du /etc/ dans /root/etc/ for the record
  * rsync -avz root@neptune.v-l-m.org:/etc ./
  * dans /root/sync-etc.sh
* OK : Script de comparaison des paquets installés dans /root/cmp-dpkg.sh

## STEP2 : Préparation env de dev
* OK : Création du user dev (uuid : 1001)
* Relire : http://dev.virtual-loup-de-mer.org/vlm/wiki/ConfigurationServeur
* OK : Rsync du /home/dev de Neptune vers Neptune2
  * rsync -avz root@v-l-m.org:/home/dev/* /home/dev/
  * dans /root/sync-dev.sh
* OK : Ajustements conf svn :
  * DONE : suppression du post-commit hook pour le bot cia (cause des lenteurs en commit)
* Ajustements conf apache
  * DONE : copie de la conf apache de dev dans sites-available
  * DONE : a2ensite dev.virtual-loup-de-mer.org
  * DONE : apt-get install apache2
  * DONE : a2enmod dav
  * DONE : apt-get install libapache2-svn
  * DONE : a2enmod authz_svn
  * DONE : apt-get install python-setuptools trac trac-accountmanager
  ********** Argh... c'est le bordel de reprendre à l'identique
  * TODO : désinstaller le superflu

##STEP2BIS : Migration vers GitHub
* DONE : Test import dans github du svn
  * ~OK, mais pb d'attribution de certains commits (ceux de paparazzia par exemple ;))
  * A refaire à la main avec git-svn ?
* DONE : Test import trac avec trac2github
  * ~OK mais pb de dispositif anti-abuse
  * A ajuster (tempo de 4 secondes + bugfix sur les commentaires
* Association des comptes des membres de vlm au projet
  * Done : Phille, FM, Sbs, spf, pzia
  * Todo ?

## STEP3 : Installation VLM
* Relire : http://dev.virtual-loup-de-mer.org/vlm/wiki/installation
* Suivre la doc (en s'aidant de la conf /etc/ précédente) pour catcher les manques
* Si un fqdn existe, le paramètrer dans apache en plus des autres
* Tester avec un client en changeant son /etc/hosts

## STEP4 : TESTS, TESTS, TESTS
* Test d'import de course depuis testing
* Test de mails
* Test de publication de news

## STEP5 : Sync J-1
* (permettra de documenter ce qu'il y a faire comme sync "just in time")
* ? Backup serveur via sauvegarde hébergement ?

## STEP6 : BASCULE
* Reboot du serveur NEPTUNE2 (cible)
* Arrêter les crons sur NEPTUNE et NEPTUNE2
* Passer les instances VLM en maintenance
* Sync finale
* Bascule IP
* Sortie de la maintenance pour NEPTUNE2
* Relance des crons
* Test de publication news

## STEP7 : 
* Vérifier la publication des news
* Vérifier l'import de course la première fois
* Vérifier les envois de mails
* Import de course en réel
Quoi surveiller d'autre ?

##STEP 8
Fin de Neptune (so long)

