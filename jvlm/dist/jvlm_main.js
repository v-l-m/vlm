"use strict";function _defineProperties(e,t){for(var a=0;a<t.length;a++){var o=t[a];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,a){return t&&_defineProperties(e.prototype,t),a&&_defineProperties(e,a),e}function _typeof(e){"@babel/helpers - typeof";return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Array.prototype.findIndex||Object.defineProperty(Array.prototype,"findIndex",{value:function(e){if(null==this)throw new TypeError('"this" is null or not defined');var t=Object(this),a=t.length>>>0;if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var o=arguments[1],n=0;n<a;){var r=t[n];if(e.call(o,r,n,t))return n;n++}return-1},configurable:!0,writable:!0});var MAP_OP_SHOW_SEL=0,PrefMgr=function e(){_classCallCheck(this,e);this.CurTheme="bleu-noir",this.MapPrefs=new MapPrefs,this.GConsentDate=null,this.GConsentLastNo=null,this.InputDigits=3,this.RacesStorageLUT=[],this.VLMRacesStorage=[],this.LastSelBoat=null,this.BoatPrefs=[],this.AdvancedStats=!1,this.GetBoatPrefEntry=function(e){if(!this.BoatPrefs)return this.BoatPrefs=[],null;for(var t in this.BoatPrefs)if(this.BoatPrefs[t]&&this.BoatPrefs[t].idu===e)return this.BoatPrefs[t];return null},this.GetLastZoom=function(e){var t=this.GetBoatPrefEntry(e);return t?t.LastZoom:4},this.SetLastZoom=function(e,t){var a=this.GetBoatPrefEntry(e);if(a)a.LastZoom=t;else{var o={idu:e,LastZoom:t};this.BoatPrefs.push(o)}this.Save()},this.GetTrackEstimate=function(e){var t=this.GetBoatPrefEntry(e);if(!(t&&t.EstimateTrack&&Array.isArray(t.EstimateTrack)))return[];try{for(var a in t.EstimateTrack)t.EstimateTrack[a]&&"string"==typeof t.EstimateTrack[a].Date&&(t.EstimateTrack[a].Date=moment(t.EstimateTrack[a].Date).toDate());return t.EstimateTrack}catch(e){console.log("Exception recovering TrackEstimate : "+e)}},this.StoreTrackEstimate=function(e,t){var a=this.GetBoatPrefEntry(e);if(a)a.EstimateTrack=t;else{var o={idu:IdBoat,EstimateTrack:t};this.BoatPrefs.push(o)}this.Save(!0)},this.ClearRaceData=function(e){this.RacesStorageLUT[e]&&(VLM2Prefs.VLMRacesStorage.splice(this.RacesStorageLUT[e],1),this.RacesStorageLUT.splice(e,1),this.Save())},this.HasRaceStorage=function(e){return void 0!==this.RacesStorageLUT&&void 0!==this.RacesStorageLUT[e]},this.Init=function(){this.MapPrefs.Load(),this.Load()},this.Load=function(){if(store.enabled){this.GConsentDate=LoadLocalPref("GConsentDate",null),this.GConsentLastNo=LoadLocalPref("GConsentLastNo",null),this.AdvancedStats=LoadLocalPref("AdvancedStats",!1),this.LastSelBoat=LoadLocalPref("LastSelBoat",null),this.BoatPrefs=[];try{this.BoatPrefs=JSON.parse(LoadLocalPref("BoatPrefs","[]"))}catch(e){this.BoatPrefs=[]}try{this.VLMRacesStorage=JSON.parse(LoadLocalPref("VLMRacesStorage",null))}catch(e){this.VLMRacesStorage=null}for(var e in this.InputDigits=JSON.parse(LoadLocalPref("InputDigits",3)),this.CurTheme=LoadLocalPref("CurTheme","bleu-noir"),this.VLMRacesStorage||(this.VLMRacesStorage=[]),this.VLMRacesStorage)this.VLMRacesStorage[e]&&(this.RacesStorageLUT[this.VLMRacesStorage[e].RaceId]=e)}},this.Save=function(e){store.enabled&&store.set("ColorTheme",this.CurTheme),e||this.MapPrefs.Save(),store.set("GConsentDate",this.GConsentDate),store.set("GConsentLastNo",this.GConsentLastNo),store.set("VLMRacesStorage",JSON.stringify(this.VLMRacesStorage)),store.set("BoatPrefs",JSON.stringify(this.BoatPrefs)),store.set("InputDigits",this.InputDigits),store.set("AdvancedStats",this.AdvancedStats),store.set("LastSelBoat",this.LastSelBoat)},this.UpdateVLMPrefs=function(e){switch(e.mapOpponents){case"mylist":case"mapselboats":case"NULL":case"null":case"all":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowSel;break;case"meandtop10":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowTopN;break;case"my10opps":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.Show10Around;break;case"my5opps":case"maponlyme":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.Show5Around;break;case"myboat":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowMineOnly;break;default:VLMAlertDanger("unexpected mapping option : "+e.mapOpponents)}},this.GetRaceFromStorage=function(e){if(this.RacesStorageLUT[e])return this.VLMRacesStorage[this.RacesStorageLUT[e]];var t=new Race(e),a=this.VLMRacesStorage.length;return this.VLMRacesStorage[a]=t,this.RacesStorageLUT[e]=a,this.Save(),t}},MapPrefs=function e(){_classCallCheck(this,e),this.ShowReals=!0,this.ShowCompass=!0,this.ShowOppNumbers=!0,this.MapOppShow=null,this.MapOppShowOptions={ShowSel:0,ShowMineOnly:1,Show5Around:2,ShowTopN:3,Show10Around:4},this.WindArrowsSpacing=64,this.MapZoomLevel=4,this.PolarVacCount=12,this.UseUTC=!1,this.EstTrackMouse=!1,this.TrackEstForecast=!0,this.ShowTopCount=50,this.Load=function(){store.enabled&&(this.ShowReals=LoadLocalPref("#ShowReals",!0),this.ShowCompass=LoadLocalPref("#ShowCompass",!0),this.ShowOppNumbers=LoadLocalPref("#ShowOppNumbers",!1),this.MapZoomLevel=LoadLocalPref("#MapZoomLevel",4),this.UseUTC=LoadLocalPref("#UseUTC",!1),this.EstTrackMouse=LoadLocalPref("#EstTrackMouse",!0),this.TrackEstForecast=LoadLocalPref("#TrackEstForecast",!1),this.PolarVacCount=LoadLocalPref("#PolarVacCount",12),this.PolarVacCount||(this.PolarVacCount=12),this.ShowTopCount=LoadLocalPref("ShowTopCount",50))},this.Save=function(){store.enabled&&(store.set("#ShowReals",this.ShowReals),store.set("#ShowCompass",this.ShowCompass),store.set("#ShowOppNumbers",this.ShowOppName),store.set("#MapZoomLevel",this.MapZoomLevel),store.set("#PolarVacCount",this.PolarVacCount),store.set("#UseUTC",this.UseUTC),store.set("#TrackEstForecast",this.TrackEstForecast),store.set("#EstTrackMouse",this.EstTrackMouse),store.set("ShowTopCount",this.ShowTopCount));var e="mapselboats";switch(this.MapOppShow){case this.MapOppShowOptions.ShowMineOnly:e="myboat";break;case this.MapOppShowOptions.Show5Around:e="my5opps";break;case this.MapOppShowOptions.ShowTopN:e="meandtop10";break;case this.MapOppShowOptions.Show10Around:e="my10opps"}var t={mapOpponents:e};void 0!==_CurPlayer&&_CurPlayer&&void 0!==t&&t&&UpdateBoatPrefs(_CurPlayer.CurBoat,{prefs:t})},this.GetOppModeString=function(e){switch(e){case this.MapOppShowOptions.ShowSel:return GetLocalizedString("mapselboats");case this.MapOppShowOptions.ShowMineOnly:return GetLocalizedString("maponlyme");case this.MapOppShowOptions.Show5Around:return GetLocalizedString("mapmy5opps");case this.MapOppShowOptions.ShowTopN:return GetLocalizedString("mapmeandtop10");case this.MapOppShowOptions.Show10Around:return GetLocalizedString("mapmy10opps");default:return e}}},VLM2Prefs=new PrefMgr;function LoadLocalPref(e,t){var a=store.get(e);return void 0===a&&(a=t),a}VLM2Prefs.Init();var WPMinimapHandlerClass=function e(){_classCallCheck(this,e),this.Minimap=$("#WPMiniMap")[0],this.TimeOut=null,this.LMap=null,this.Races={},this.FindRaceInfo=function(e){if(!_CurPlayer)return null;if(_CurPlayer.RaceInfo&&_CurPlayer.RaceInfo[e])return _CurPlayer.RaceInfo[e];var t=[_CurPlayer.Fleet,_CurPlayer.fleet_boatsit];for(var a in t)if(t[a]){var o=t[a];for(var n in o)if(o[n]){var r=o[n];if(r.Engaged()==e&&r.RaceInfo)return r.RaceInfo}}return null},this.GetWayPoint=function(e){var t=e.currentTarget,a=null,o=null;t.attributes.raceid&&(a=t.attributes.raceid.value),t.attributes.wp_id&&(o=t.attributes.wp_id.value);var n=this.FindRaceInfo(a);if(n){for(var r in n.races_waypoints)if(n.races_waypoints[r]&&n.races_waypoints[r].idwaypoint==o){var i=[];return i.push([FIELD_MAPPING_TEXT,".MiniMapRaceName",n.racename]),i.push([FIELD_MAPPING_TEXT,".MiniMapWPIndex",n.races_waypoints[r].wporder+" - "+n.races_waypoints[r].libelle]),FillFieldsFromMappingTable(i),n.races_waypoints[r]}return null}},this.Show=function(e){var t=this.GetWayPoint(e);if(t){if(!t.MapCenter)if(void 0===t.longitude2||void 0===t.latitude2)t.MapCenter=[t.latitude1,t.longitude1],t.MapZoom=t.maparea-1;else{t.MapCenter=[(t.latitude1+t.latitude2)/2,(t.longitude1+t.longitude2)/2];var a=Math.abs(t.latitude1-t.latitude2),o=Math.abs(t.longitude1-t.longitude2);t.MapZoom=0,t.MapZoom=a>2*o?Math.log(90/a)/Math.log(2):Math.log(360/o)/Math.log(2)}this.LMap?(this.LMap.setView(t.MapCenter,t.MapZoom),RemoveFromMap(this.LMap.MinimapFeature,this.LMap),this.LMap.MinimapFeature.GateMarker=null):(this.InitMap(t.MapCenter,t.MapZoom),this.LMap.MinimapFeature={});var n=t.wporder;MakeSingleGateMapFeatures(this.LMap,t,n,this.LMap.MinimapFeature,!0),RestoreMarkersOnMap(this.LMap.MinimapFeature,this.LMap),this.TimeOut&&clearTimeout(this.TimeOut);e.currentTarget.getBoundingClientRect();$("#WPMiniMapDialog").hasClass("in")||$("#WPMiniMapDialog").modal("show"),this.LMap.invalidateSize()}},this.Hide=function(){$(this.Minimap).addClass("hidden")},this.InitMap=function(e,t){this.LMap=L.map("WPMiniMap");var a=tileUrlSrv;new L.tileLayer(a,{attribution:"gshhsv2",maxZoom:20,tms:!1,id:"WPMinimap",detectRetina:!0,subdomains:tilesUrlArray}).addTo(this.LMap),e||(e=[0,0]),t||(t=0),this.LMap.setView(e,t),$("#WPMiniMapDialog").on("shown.bs.modal",function(){$.Deferred(WPMiniMapHandler.OnModalShown.bind(WPMiniMapHandler))})},this.OnModalShown=function(e){this.LMap.invalidateSize()}},WPMiniMapHandler=null;function HandleWPMiniMapHover(e){WPMiniMapHandler||(WPMiniMapHandler=new WPMinimapHandlerClass),WPMiniMapHandler.Show(e)}function AutoPilotOrder(e,t){if(this.Date=new Date((new Date).getTime()-(new Date).getTime()%3e5+45e4),this.PIM=PM_HEADING,this.PIP_Value=0,this.PIP_Coords=new VLMPosition(0,0),this.PIP_WPAngle=-1,this.ID=-1,void 0!==e&&e){if(!(t-1 in e.VLMInfo.PIL))return void alert("Invalid Pilototo order number. Report error to devs.");var a=e.VLMInfo.PIL[t-1];switch(this.Date=new Date(1e3*parseInt(a.TTS,10)),this.PIM=parseInt(a.PIM,10),this.ID=parseInt(a.TID,10),this.PIM){case PM_ANGLE:case PM_HEADING:this.PIP_Value=parseInt(a.PIP,10);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:var o=a.PIP.split(","),n=o[1].split("@");this.PIP_Coords.Lat.Value=parseFloat(o[0]),this.PIP_Coords.Lon.Value=parseFloat(n[0]),this.PIP_WPAngle=parseFloat(n[1])}}this.GetOrderDateString=function(){return this.Date.getDate()+"/"+(this.Date.getMonth()+1)+"/"+this.Date.getFullYear()},this.GetOrderTimeString=function(){return this.Date.getHours()+":"+this.Date.getMinutes()+":15"},this.GetPIMString=function(){switch(this.PIM){case PM_HEADING:return GetLocalizedString("autopilotengaged");case PM_ANGLE:return GetLocalizedString("constantengaged");case PM_ORTHO:return GetLocalizedString("orthodromic");case PM_VMG:return"VMG";case PM_VBVMG:return"VBVMG"}},this.GetPIPString=function(){switch(this.PIM){case PM_HEADING:case PM_ANGLE:return this.PIP_Value;case PM_ORTHO:case PM_VMG:case PM_VBVMG:return this.PIP_Coords.GetVLMString()+"@"+PIP_WPAngle}}}function HandleSendAPUpdate(e){var t="add";if(void 0!==_CurAPOrder&&_CurAPOrder){var a={idu:_CurPlayer.CurBoat.IdBoat(),tasktime:Math.round(_CurAPOrder.Date/1e3),pim:_CurAPOrder.PIM};switch(-1!==_CurAPOrder.ID&&(t="update",a.taskid=_CurAPOrder.ID),_CurAPOrder.PIM){case PM_HEADING:case PM_ANGLE:a.pip=_CurAPOrder.PIP_Value;break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:a.pip={},a.pip.targetlat=_CurAPOrder.PIP_Coords.Lat.Value,a.pip.targetlong=_CurAPOrder.PIP_Coords.Lon.Value,a.pip.targetandhdg=-1===_CurAPOrder.PIP_WPAngle?null:_CurAPOrder.PIP_WPAngle}$.post("/ws/boatsetup/pilototo_"+t+".php","parms="+JSON.stringify(a),function(e){e.success?RefreshCurrentBoat(!1,!0,"AutoPilot"):alert(e.error.msg)})}}function HandleAPFieldChange(e){var t=e.target;if(void 0!==t.attributes.id)switch(t.attributes.id.value){case"AP_PIP":_CurAPOrder.PIP_Value=parseFloat(t.value),_CurAPOrder.PIP_Value.toString()!==t.Value&&(t.value=_CurAPOrder.PIP_Value.toString());break;case"AP_WPLat":CheckFloatInput(_CurAPOrder.PIP_Coords.Lat,t);break;case"AP_WPLon":CheckFloatInput(_CurAPOrder.PIP_Coords.Lon,t);break;case"AP_WPAt":var a={};a.Value=_CurAPOrder.PIP_WPAngle,CheckFloatInput(a,t),_CurAPOrder.PIP_WPAngle=a.Value}}function CheckFloatInput(e,t){var a;"object"===_typeof(e)?(e.Value=parseFloat(t.value),a=e.Value):a=e=parseFloat(t.value),a.toString()!==t.Value&&(t.value=a.toString())}var BoatEstimate=function e(t){_classCallCheck(this,e),this.Position=null,this.Date=null,this.PrevDate=null,this.Mode=null,this.Value=null,this.Meteo=null,this.CurWP=new VLMPosition(0,0),this.HdgAtWP=-1,this.RaceWP=1,this.Heading=null,void 0!==t&&t&&(this.Position=new VLMPosition(t.Position.Lon.Value,t.Position.Lat.Value),this.Date=new Date(t.Date),this.PrevDate=new Date(t.PrevDate),this.Mode=t.Mode,this.Value=t.Value,void 0!==t.Meteo&&t.Meteo&&(this.Meteo=new WindData({Speed:t.Meteo.Speed,Heading:t.Meteo.Heading})),this.CurWP=t.CurWP,this.RaceWP=t.RaceWP,this.Heading=t.Heading)},Estimator=function e(t){if(_classCallCheck(this,e),void 0===t||!t)throw"Boat must exist for tracking....";this.Boat=t,this.MaxVacEstimate=0,this.CurEstimate=new BoatEstimate,this.Running=!1,this.EstimateTrack=[],this.ProgressCallBack=null,this.ErrorCount=0,this.EstimateMapFeatures=[],this.Stop=function(){this.Running&&(this.EstimateTrack?StatMGR.Stat("Estimator_Stop",null,null,this.EstimateTrack.length):StatMGR.Stat("Estimator_Stop",null,null,0),this.Running=!1,this.ReportProgress(!0),this.LastPctRefresh=-1,this.LastPctDraw=-1,this.ReportProgress(!0)),VLM2Prefs.StoreTrackEstimate(this.Boat.IdBoat(),this.EstimateTrack)},this.Start=function(e){if(this.ProgressCallBack=e,!this.Running)if(this.Running=!0,this.LastPctRefresh=0,this.LastPctDraw=0,GribMgr.Init(),void 0!==this.Boat.VLMInfo){if(this.CurEstimate.Position=new VLMPosition(this.Boat.VLMInfo.LON,this.Boat.VLMInfo.LAT),this.CurEstimate.Date=new Date(1e3*this.Boat.VLMInfo.LUP+1e3*this.Boat.VLMInfo.VAC),this.CurEstimate.PrevDate=this.CurEstimate.Date,this.CurEstimate.Date<new Date)if(void 0===this.Boat.RaceInfo)this.CurEstimate.Date=new Date;else{if(this.CurEstimate.PrevDate=new Date(1e3*parseInt(this.Boat.RaceInfo.deptime,10)+6e3),this.CurEstimate.PrevDate<new Date){var t=(new Date).getTime()/1e3;t-=t%this.Boat.VLMInfo.VAC,this.CurEstimate.PrevDate=new Date(1e3*t+6e3)}var a=new Date(this.CurEstimate.PrevDate.getTime()+1e3*this.Boat.VLMInfo.VAC);this.CurEstimate.Date=a}for(var o in this.CurEstimate.Mode=parseInt(this.Boat.VLMInfo.PIM,10),this.CurEstimate.CurWP=new VLMPosition(this.Boat.VLMInfo.WPLON,this.Boat.VLMInfo.WPLAT),this.CurEstimate.HdgAtWP=parseFloat(this.Boat.VLMInfo["H@WP"]),this.CurEstimate.RaceWP=parseInt(this.Boat.VLMInfo.NWP,10),this.CurEstimate.Mode!=PM_HEADING&&this.CurEstimate.Mode!=PM_ANGLE||(this.CurEstimate.Value=parseFloat(this.Boat.VLMInfo.PIP)),this.CurEstimate.PilOrders=[],this.Boat.VLMInfo.PIL){var n=this.Boat.VLMInfo.PIL[o],r={PIP:n.PIP,PIM:n.PIM,STS:n.STS,TTS:n.TTS};this.CurEstimate.PilOrders.push(r)}this.EstimateTrack=[],this.MaxVacEstimate=new Date(GribMgr.MaxWindStamp),this.ReportProgress(!1),this.EstimateTrack.push(new BoatEstimate(this.CurEstimate)),this.ErrorCount=0,StatMGR.Stat("Estimator_Start"),setTimeout(this.Estimate.bind(this),0)}else this.Stop()},this.Estimate=function(e){if(!this.Running||this.CurEstimate.Date>=this.MaxVacEstimate)this.Stop();else{var t,a=this.CurEstimate.Position.Lat.Value,o=this.CurEstimate.Position.Lon.Value;do{if(!(t=GribMgr.WindAtPointInTime(this.CurEstimate.PrevDate,a,o))||isNaN(t.Speed))return this.ErrorCount>10?(isNan(t.Speed)&&(StatMGR.Stat("NaN Speed in Grib",null,null,GribMgr.WindTableLength),console.log("Nan Speed @"+a+" / "+o),GribMGR.ClearBogusData(this.CurEstimate.PrevDate,a,o)),void this.Stop()):(this.ErrorCount++,void setTimeout(this.Estimate.bind(this),1e3));this.ErrorCount=0}while(!t);for(var n in this.CurEstimate.Meteo=t,this.CurEstimate.PilOrders){var r=this.CurEstimate.PilOrders[n];if(r&&"pending"===r.STS)if(new Date(1e3*parseInt(r.TTS,10))<=this.CurEstimate.Date){switch(this.CurEstimate.Mode=parseInt(r.PIM,10),this.CurEstimate.Mode){case PM_ANGLE:case PM_HEADING:this.CurEstimate.Value=parseFloat(r.PIP);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:var i=r.PIP.split("@"),s=i[0].split(",");this.CurEstimate.CurWP=new VLMPosition(parseFloat(s[1]),parseFloat(s[0])),this.CurEstimate.HdgAtWP=parseFloat(i[1]);break;default:return alert("unsupported pilototo mode"),void this.Stop()}this.CurEstimate.PilOrders[n].STS="Planned",this.CurEstimate.PilOrders[n].Pos=this.CurEstimate.Position;break}}var l=this.CurEstimate.Value,d=0,c=null,u=null;switch(this.CurEstimate.Mode){case PM_ANGLE:if(l=t.Heading+this.CurEstimate.Value,d=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(d))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();c=this.CurEstimate.Position.ReachDistLoxo(d/3600*this.Boat.VLMInfo.VAC,l);break;case PM_HEADING:if(d=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(d))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();c=this.CurEstimate.Position.ReachDistLoxo(d/3600*this.Boat.VLMInfo.VAC,l);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:if(u=this.GetNextWPCoords(this.CurEstimate),this.CurEstimate.Mode==PM_ORTHO){if(l=this.CurEstimate.Position.GetOrthoCourse(u),d=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(d))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();c=this.CurEstimate.Position.ReachDistOrtho(d/3600*this.Boat.VLMInfo.VAC,l)}else{if(l=this.CurEstimate.Mode==PM_VMG?PolarsManager.GetVMGCourse(this.Boat.VLMInfo.POL,t.Speed,t.Heading,this.CurEstimate.Position,u):PolarsManager.GetVBVMGCourse(this.Boat.VLMInfo.POL,t.Speed,t.Heading,this.CurEstimate.Position,u),d=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(d))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();c=this.CurEstimate.Position.ReachDistLoxo(d/3600*this.Boat.VLMInfo.VAC,l)}this.CheckWPReached(u,this.CurEstimate.Position,c);break;default:throw"Unsupported pilotmode for estimate..."+this.CurEstimate.Mode}console.log(this.CurEstimate.Date+this.CurEstimate.Position.toString(!0)+"=> "+c.Lon.toString(!0)+" "+c.Lat.toString(!0)+" Wind : "+RoundPow(t.Speed,4)+"@"+RoundPow(t.Heading,4)+" Boat "+RoundPow(d,4)+"kts"+RoundPow((l+360)%360,4));var p=!1;this.CheckGateValidation(c)&&(p=this.GetNextRaceWP()),this.CurEstimate.Heading=l,this.CurEstimate.Position=c,this.EstimateTrack.push(new BoatEstimate(this.CurEstimate)),this.CurEstimate.Date=new Date(1e3*(this.CurEstimate.Date/1e3+this.Boat.VLMInfo.VAC)),this.CurEstimate.PrevDate=this.CurEstimate.Date,p?this.Stop():(setTimeout(this.Estimate.bind(this),0),this.ReportProgress(!1))}},this.LoadTrack=function(){this.EstimateTrack=VLM2Prefs.GetTrackEstimate(this.Boat.IdBoat())},this.GetPilotPoints=function(){var e=[];for(var t in this.CurEstimate.PilOrders){var a=this.CurEstimate.PilOrders[t];a&&void 0!==a.Pos&&e.push(a)}return e},this.GetNextRaceWP=function(){var e=Object.keys(this.Boat.RaceInfo.races_waypoints).length;if(this.CurEstimate.RaceWP===e)return!0;for(var t=this.CurEstimate.RaceWP+1;t<=e;t++)if(!(this.Boat.RaceInfo.races_waypoints[t].wpformat&WP_ICE_GATE)){this.CurEstimate.RaceWP=t;break}return!1},this.CheckGateValidation=function(e){var t=this.GetNextGateSegment(this.CurEstimate),a=(this.Boat.RaceInfo.races_waypoints[this.CurEstimate.RaceWP],{P1:this.CurEstimate.Position,P2:e});return VLMMercatorTransform.SegmentsIntersect(t,a)},this.CheckWPReached=function(e,t,a){if(this.CurEstimate.CurWP.Lat.value||this.CurEstimate.CurWP.Lon.Value){var o=e.GetOrthoDist(t),n=e.GetOrthoDist(a),r=t.GetOrthoDist(a);(o<r||n<r)&&(this.CurEstimate.CurWP=new VLMPosition(0,0),-1!=this.CurEstimate.HdgAtWP&&(this.CurEstimate.Mode=PM_HEADING,this.CurEstimate.Value=this.CurEstimate.HdgAtWP),console.log("WP Reached"))}},this.GetNextWPCoords=function(e){return e.CurWP.Lat.value||e.CurWP.Lon.Value?e.CurWP:this.Boat.GetNextWPPosition(e.RaceWP,e.Position,e.CurWP)},this.GetNextGateSegment=function(e){return this.Boat.GetNextGateSegment(e.RaceWP)},this.ReportProgress=function(e){var t=0;this.ProgressCallBack&&(e||this.EstimateTrack.length>1&&(t=RoundPow(100*(1-(t=(this.MaxVacEstimate-this.EstimateTrack[this.EstimateTrack.length-1].Date)/(this.MaxVacEstimate-this.EstimateTrack[0].Date))),1)),this.ProgressCallBack(e,t,this.CurEstimate.Date))},this.GetClosestEstimatePoint=function(e){return e instanceof VLMPosition?this.GetClosestEstimatePointFromPosition(e):e instanceof Date?this.GetClosestEstimatePointFromTime(e):null},this.GetClosestEstimatePointFromTime=function(e){if(!e||!Object.keys(this.EstimateTrack).length)return null;var t,a=0;for(a=0;a<Object.keys(this.EstimateTrack).length;a++)if(this.EstimateTrack[a]){if(!(e>this.EstimateTrack[a].Date))break;t=e-this.EstimateTrack[a].Date}if(a<Object.keys(this.EstimateTrack).length&&void 0!==this.EstimateTrack[a+1]&&this.EstimateTrack[a+1]){var o=e-this.EstimateTrack[a+1].Date;Math.abs(o)<Math.abs(t)&&a++}return this.EstimateTrack[a]},this.GetClosestEstimatePointFromPosition=function(e){if(!e)return null;var t,a=1e30,o=null;for(t=0;t<Object.keys(this.EstimateTrack).length;t++)if(this.EstimateTrack[t]){var n=e.GetEuclidianDist2(this.EstimateTrack[t].Position);n<a&&(o=this.EstimateTrack[t],a=n)}return o},this.ClearEstimatePosition=function(e){this.ShowEstimatePosition(e,null)},this.ShowEstimatePosition=function(e,t){var a=GetRaceMapFeatures(e);if(e&&t&&t.Position&&(e.VLMInfo.LON!==t.Position.Lon.Value||e.VLMInfo.LAT!==t.Position.Lat.Value)){if(!a)return;var o=[t.Position.Lat.Value,t.Position.Lon.Value];if(a.BoatEstimateMarker)a.BoatEstimateMarker.setLatLng(o).addTo(map);else{var n=GetBoatEstimateMarker();a.BoatEstimateMarker=L.marker(o,{icon:n}).addTo(map)}if(a.BoatEstimateMarker&&a.BoatEstimateMarker.setRotationAngle(t.Heading),void 0!==t.Meteo&&t.Meteo){var r=BuildPolarLine(e,new VLMPosition(o[1],o[0]),VLM2Prefs.MapPrefs.PolarVacCount,t.Date);a.BoatEstimateMarkerPolar=DefinePolarMarker(r,a.BoatEstimateMarkerPolar)}}else a&&(a.BoatEstimateMarker&&a.BoatEstimateMarker.remove(),a.BoatEstimateMarkerPolar&&a.BoatEstimateMarkerPolar.remove())},this.GetEstimateTracks=function(e){var t=[],a=null,o=null;if("undefined"==typeof track||!e){if(!this.EstimateTrack||!this.EstimateTrack[0])return null;e=this.EstimateTrack}var n=(new moment.utc).startOf("hour"),r=(n.hour()+3)%6,i=1e3*n.add(-r,"hour").add(.5,"hour").add(5,"minute").unix();for(var s in e)if(e[s]){var l=e[s],d=l.Date.getTime()-i,c=Math.floor(d/6/36e5);c<0?c=0:c>2&&(c=2),void 0===t[c]&&(t[c]=[]),c!==a&&o&&t[c].push([o.Position.Lat.Value,o.Position.Lon.Value]),t[c].push([l.Position.Lat.Value,l.Position.Lon.Value]),o=l,a=c}return t}};function Coords(e,t){this.Value="number"==typeof e?e:parseFloat(e),this.IsLon=t,this.Deg=function(){return Math.abs(this.Value)},this.Min=function(){return 60*(Math.abs(this.Value)-Math.floor(this.Deg()))},this.Sec=function(){return 60*(this.Min()-Math.floor(this.Min()))},this.toString=function(e){if(e)return this.Value;var t="";return t=void 0===this.IsLon||0==this.IsLon?this.Value>=0?" N":" S":this.Value>=0?" E":" W",Math.floor(this.Deg())+"° "+Math.floor(this.Min())+"' "+RoundPow(this.Sec(),2)+'"'+t}}function GetDegMinSecFromNumber(e,t,a,o){SplitNumber(e,t,void 0),SplitNumber(NaN,a,void 0),SplitNumber(NaN,o,void 0)}function SplitNumber(e,t,a){Math.floor(e)}var SrvIndex=1,MIN_MAP_ZOOM=5,GribMap={ServerURL:function(){return"undefined"!=typeof WindGridServers&&WindGridServers?(0===(SrvIndex=(SrvIndex+1)%WindGridServers.length)&&(SrvIndex=1),WindGridServers[SrvIndex]):""}},Pixel=function e(t,a){_classCallCheck(this,e),this.x=t,this.y=a,this.moveBy=function(e){this.x+=e.x,this.y+=e.y},this.moveByPolar=function(e,t){var a=(t-90)*Math.PI/180;this.x+=e*Math.cos(a),this.y+=e*Math.sin(a)}},BeaufortColors=["#FFFFFF","#7878c4","#4070ac","#305093","#349350","#B4CD0A","#b2b212","#c4b21a","#ff9200","#ff5800","#ff2200","#cb0000","#650000"];GribMap.Layer=L.Layer.extend({initialize:function(e){e||(e={}),this.cfg=e,this._canvas=L.DomUtil.create("canvas"),this._data=[],this._max=1,this._min=0,this.cfg.container=this._canvas,this._Density=10,this._Time=new Date,this.DrawWindDebugCnt=0,this.DrawWindDebugDepth=0},GetGribMapTime:function(){return this._Time},SetGribMapTime:function(e){this._Time=e,this._update()},_CheckDensity:function(e){var t=e.measureText("XX.X/XXX.X°");this._Density=Math.floor(this._width/1.5/t.width)},onAdd:function(e){var t=e.getSize();this._map=e,this._width=t.x,this._height=t.y,this._canvas.width=t.x,this._canvas.height=t.y,this._canvas.style.width=t.x+"px",this._canvas.style.height=t.y+"px",this._canvas.style.position="absolute",this._origin=this._map.layerPointToLatLng(new L.Point(0,0)),e.getPanes().overlayPane.appendChild(this._canvas),e.on("moveend",this._reset,this),this._reset(),this._draw()},addTo:function(e){return e.addLayer(this),this},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._canvas),e.off("moveend",this._reset,this)},_draw:function(){this._map&&this._update()},_update:function(e){var t=this._canvas.getContext("2d");this._CheckDensity(t),t.clearRect(0,0,this._canvas.width,this._canvas.height),this._DrawWindArea(t,e)},_DrawWindArea:function(e){this.DrawWindDebugCnt++;this.arrowstep;var t,a,o=1;if(t=this._map.getBounds(),!((a=this._map.getZoom())<MIN_MAP_ZOOM)){for(var n=t.getWest(),r=t.getEast(),i=t.getNorth(),s=t.getSouth(),l=(r-n)/this._Density,d=(i-s)/this._Density,c=L.latLng(i,n),u=map.project(c,a),p=null,h=!1,f=n;f<=r;f+=l)for(var P=s;P<=i;P+=d)try{if(p=GribMgr.WindAtPointInTime(this._Time,P,f)){var g=L.latLng(P,f),M=map.project(g,a);this._drawWind(e,M.x-u.x,M.y-u.y,a,p.Speed,p.Heading)}else h=!0}catch(e){o>0&&(console.log("_DrawWindArea "+f+" / "+P+" / <br>"+e),o-=1)}h&&setTimeout(this._update.bind(this),250)}},_drawWind:function(e,t,a,o,n,r){var i=this._drawWindTriangle(e,t,a,n,r);e.fillStyle="#620062",this._drawWindText(e,t,i+2,n,r)},_drawWindText:function(e,t,a,o,n){var r=t,i=a,s="?? / ???";(o||n)&&(i+=n>90&&n<270?13+5*Math.cos(n*Math.PI/180):7-5*Math.cos(n*Math.PI/180),s=RoundPow(o,1)+"/"+RoundPow(n,1)+"°");var l=e.measureText(s).width/2;e.fillText(s,r-l,i)},_drawWindTriangle:function(e,t,a,o,n){var r,i,s,l,d,c,u;if(!n&&!o)return 0;u=Math.log(o+1),c=(n+180)%360,r=new Pixel(t,a),i=new Pixel(t,a),s=new Pixel(t,a),r.moveByPolar(2+3*u,c),i.moveByPolar(0+2*u,c-135),s.moveByPolar(0+2*u,c+135),l=new Pixel((r.x+i.x+s.x)/3,(r.y+i.y+s.y)/3),d=new Pixel(t-l.x,a-l.y),r.moveBy(d),i.moveBy(d),s.moveBy(d);var p=this.windSpeedToColor(o);return e.fillStyle=p,e.strokeStyle=o<2?0:p,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(i.x,i.y),e.lineTo(s.x,s.y),e.fill(),e.stroke(),e.closePath(),Math.max(r.y,i.y,s.y)},windSpeedToColor:function(e){var t=GribMgr.GetBeaufort(e);return BeaufortColors[t]},_reset:function(){var e=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setTransform(this._canvas,e,1);var t=this._map.getSize();this._width!==t.x&&(this._canvas.width=t.x,this._width=t.x),this._height!==t.y&&(this._canvas.height=t.y,this._height=t.y),this._draw()},_animateZoom:function(e){var t=this._map.getZoomScale(e.zoom),a=this._map._getCenterOffset(e.center)._multiplyBy(-t).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,a,t):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(a)+" scale("+t+")"}});var BeaufortScale=[1,4,7,11,17,22,28,34,41,48,56,64],MaxBeaufort=12,GribData=function e(t){_classCallCheck(this,e),this.UGRD=NaN,this.VGRD=NaN,this.TWS=NaN,void 0!==t&&(this.UGRD=t.UGRD,this.VGRD=t.VGRD,this.TWS=t.TWS),this.Strength=function(){return 1.9438445*Math.sqrt(this.UGRD*this.UGRD+this.VGRD*this.VGRD)},this.Direction=function(){var e=Math.sqrt(this.UGRD*this.UGRD+this.VGRD*this.VGRD),t=Math.acos(-this.VGRD/e);return this.UGRD>0&&(t=2*Math.PI-t),(t=t/Math.PI*180%360)<0?t+=360:t>=360&&(t-=360),t}},WindData=function e(t){_classCallCheck(this,e),this.Speed=NaN,this.Heading=NaN,this.IsValid=function(){return!isNaN(this.Speed)&&!isNaN(this.Heading)},void 0!==t&&(this.Speed=t.Speed,this.Heading=t.Heading)},VLM2GribManager=function e(){_classCallCheck(this,e);this.Tables=[],this.TableTimeStamps=[],this.Inited=!1,this.Initing=!1,this.MinWindStamp=0,this.MaxWindStamp=0,this.WindTableLength=0,this.LoadQueue=[],this.GribStep=.5,this.LastGribDate=new Date(0),this.BeaufortCache=[],this.BeaufortCacheHits=0,this.BeaufortRecursionHits=0,this.BeaufortCacheRatio=0,this.GribGen=(new Date).getTime()/1e3,this.Init=function(){this.Inited||this.Initing||(this.Initing=!0,$.get("/ws/windinfo/list.php?v="+Math.round((new Date).getTime()/1e3/60/3),this.HandleGribList.bind(this)))},this.ClearBogusData=function(e,t,a){var o=this.GetTableIndexFromTime(e),n=this.GetTableCoordIndex(t,a),r=n.LonIdx1,i=n.LatIdx1;o in this.Tables&&this.Tables[o][r]&&this.Tables[o][r][i]&&(this.Tables[o][r][i]=null),this.GribGen++,this.CheckGribLoadedIdx(o,r,i)},this.GetBeaufort=function(e,t,a){if(t||a){this.BeaufortRecursionHits++;var o=Math.floor((a+t)/2);return e===BeaufortScale[o]?(this.BeaufortCache[e]=o,o):e<BeaufortScale[o]?o!==t?this.GetBeaufort(e,t,o):(this.BeaufortCache[e]=o,o):o+1<a?this.GetBeaufort(e,o,a):(this.BeaufortCache[e]=a,a)}if(e=Math.floor(e),this.BeaufortCache[e])return this.BeaufortCacheHits++,this.BeaufortCacheRatio=this.BeaufortCacheHits/(this.BeaufortCacheHits+this.BeaufortRecursionHits),this.BeaufortCache[e];var n=Math.floor(MaxBeaufort/2);return e<BeaufortScale[n]?this.GetBeaufort(e,0,n):this.GetBeaufort(e,n,MaxBeaufort)},this.GetTableCoordIndex=function(e,t){return{LonIdx1:(180/this.GribStep+Math.floor(e/this.GribStep)+360/this.GribStep)%(360/this.GribStep),LatIdx1:(90/this.GribStep+Math.floor(t/this.GribStep)+180/this.GribStep)%(180/this.GribStep)}},this.GetTableIndexFromTime=function(e){return Math.floor((e/1e3-this.MinWindStamp/1e3)/10800)},this.HandleGribList=function(e){this.TableTimeStamps=e.grib_timestamps,this.Inited=!0,this.Initing=!1,this.MinWindStamp=new Date(1e3*this.TableTimeStamps[0]),this.MaxWindStamp=new Date(1e3*this.TableTimeStamps[this.TableTimeStamps.length-1]),this.WindTableLength=this.TableTimeStamps.length},this.WindAtPointInTime=function(e,t,a,o){if(!this.Inited)return!1;var n=this.GetTableIndexFromTime(e);if(n<0)return!1;if(n+1>=this.TableTimeStamps.length)return!1;var r=new WindData;if(Math.abs(t)>85)return r.Heading=0,r.Speed=0,r;var i=this.CheckGribLoaded(n,t,NormalizeLongitudeDeg(a),o),s=this.CheckGribLoaded(n+1,t+this.GribStep,NormalizeLongitudeDeg(a+this.GribStep),o);if(i&&!s&&(s=this.CheckGribLoaded(n+1,t+this.GribStep,NormalizeLongitudeDeg(a+this.GribStep),o)),!i||!s)return!1;var l=this.GetHydbridMeteoAtTimeIndex(n,t,NormalizeLongitudeDeg(a));if(!l)return!1;var d=this.GetHydbridMeteoAtTimeIndex(n+1,t,NormalizeLongitudeDeg(a));if(!d)return!1;var c=l.UGRD,u=l.VGRD,p=d.UGRD,h=d.VGRD,f=e/1e3-this.TableTimeStamps[n],P=new GribData({UGRD:c+f/10800*(p-c),VGRD:u+f/10800*(h-u)});return r.Heading=P.Direction(),r.Speed=l.TWS+f/10800*(d.TWS-l.TWS),r},this.GetHydbridMeteoAtTimeIndex=function(e,t,a){for(var o=a;o<0;)o+=360;for(;o>360;)o-=360;for(var n=t;n<0;)n+=90;for(;n>90;)n-=90;var r=this.GetTableCoordIndex(a,t),i=r.LonIdx1,s=r.LatIdx1,l=(i+1)%(360/this.GribStep),d=(s+1)%(180/this.GribStep),c=o/this.GribStep-Math.floor(o/this.GribStep),u=n/this.GribStep-Math.floor(n/this.GribStep),p=this.Tables[e][i][s].UGRD,h=this.Tables[e][i][d].UGRD,f=this.Tables[e][l][s].UGRD,P=this.Tables[e][l][d].UGRD,g=this.Tables[e][i][s].VGRD,L=this.Tables[e][i][d].VGRD,M=this.Tables[e][l][s].VGRD,m=this.Tables[e][l][d].VGRD,C=this.Tables[e][i][s].Strength(),v=this.Tables[e][i][d].Strength(),S=this.Tables[e][l][s].Strength(),I=this.Tables[e][l][d].Strength(),_=this.QuadraticAverage(C,v,S,I,c,u);return new GribData({UGRD:this.QuadraticAverage(p,h,f,P,c,u),VGRD:this.QuadraticAverage(g,L,M,m,c,u),TWS:_})},this.QuadraticAverage=function(e,t,a,o,n,r){var i=e+r*(t-e);return i+n*(a+r*(o-a)-i)},this.CheckGribLoaded=function(e,t,a,o){var n=180/this.GribStep+Math.floor(a/this.GribStep),r=90/this.GribStep+Math.floor(t/this.GribStep),i=180/this.GribStep+Math.ceil(a/this.GribStep),s=90/this.GribStep+Math.ceil(t/this.GribStep);return!!(e in this.Tables&&this.Tables[e][n]&&this.Tables[e][n][r]&&this.Tables[e][n][s]&&this.Tables[e][i]&&this.Tables[e][i][r]&&this.Tables[e][i][s])||(this.CheckGribLoadedIdx(e,n,r,o),this.CheckGribLoadedIdx(e,n,s,o),this.CheckGribLoadedIdx(e,i,r,o),this.CheckGribLoadedIdx(e,i,s,o),!1)},this.CheckGribLoadedIdx=function(e,t,a,o){if(isNaN(t)||isNaN(a));if(!(this.Tables.length&&this.Tables[e]&&this.Tables[e][t]&&this.Tables[e][t][a])){var n,r,i=a*this.GribStep-90,s=t*this.GribStep-180,l=5*Math.floor(i/5),d=5*Math.floor(s/5);i<l?l=(n=l)-10:n=l+10,s<d?d=(r=d)-10:r=d+10,r>180&&(r=180,this.CheckGribLoadedIdx(e,0,a,o)),d<-180&&(d=-180,this.CheckGribLoadedIdx(e,180/this.GribStep-1,a,o));var c="0/"+d+"/"+r+"/"+n+"/"+l;this.AddGribLoadKey(c,n,l,d,r,o)}},this.AddGribLoadKey=function(e,t,a,o,n,r){e in this.LoadQueue?void 0!==r&&r&&this.LoadQueue[e].CallBacks.push(r):(this.LoadQueue[e]={length:0,CallBacks:[r]},$.get(GribMap.ServerURL()+"/ws/windinfo/smartgribs.php?north="+t+"&south="+a+"&west="+o+"&east="+n+"&seed="+this.GribGen,this.HandleGetSmartGribList.bind(this,e)))},this.HandleGetSmartGribList=function(e,t){if(t.success){for(var a in this.LastGribDate!==parseInt(t.GribCacheIndex,10)&&(this.LastGribDate=parseInt(t.GribCacheIndex,10),this.Tables=[],this.Inited=!1,this.Init()),t.gribs_url)if(t.gribs_interim_url){if(t.gribs_interim_url[a]){var o=t.gribs_interim_url[a].replace(".grb",".txt"),n=this.GribGen;$.get("/cache/gribtiles/"+o+"&seed="+n,this.HandleSmartGribData.bind(this,e,o))}}else if(t.gribs_url[a]){var r=t.gribs_url[a].replace(".grb",".txt"),i=this.GribGen;$.get("/cache/gribtiles/"+r+"&seed="+i,this.HandleSmartGribData.bind(this,e,r))}}else console.log(t)},this.AsyncCallBackQueueHandler=function(e){var t=(new Date).getTime();if(e)for(var a in e){if((new Date).getTime()-t>1e3){return void((e=e.filter(function(e){return null!==e})).length>=1&&(e=[],setTimeout(this.AsyncCallBackQueueHandler.bind(this),50,e),console.log("Sync Callback hangs "+e.length)))}e[a]&&(1,e[a](),e[a]=null)}},this.HandleSmartGribData=function(e,t,a){this.ProcessInputGribData(t,a,e)&&this.LoadQueue[e]&&setTimeout(this.AsyncCallBackQueueHandler.bind(this),25,this.LoadQueue[e].CallBacks)},this.ForceReloadGribCache=function(e,t){var a=this.GribGen;$.get("/cache/gribtiles/"+t+"&force=yes&seed="+a,this.HandleSmartGribData.bind(this,e,t))},this.ProcessInputGribData=function(e,t,a){var o=t.split("\n"),n=o.length,r=[],i=0;if("--\n"===t)return this.ForceReloadGribCache(a,e),!1;if(-1!==t.search("invalid"))return console.log("invalid request :"+e),!1;for(var s=0;s<n;s++){var l=o[s];if("--"===l||-1==l.search(":")){i=s+1;break}l&&-1===l.search("GRID:")&&r.push(this.ProcessCatalogLine(l))}if(!(r.length<this.WindTableLength)){for(var d=e.split("/"),c=0;c<r.length;c++){if(void 0===o[i]||""===o[i]){this.ForceReloadGribCache(a,e);break}var u=o[i].split(" "),p=parseInt(u[0],10),h=parseInt(u[1],10);if(isNaN(h)){this.ForceReloadGribCache(a,e);break}for(var f=180/this.GribStep+parseInt(d[1],10)/this.GribStep,P=0;P<p;P++)for(var g=h+90/this.GribStep+parseInt(d[0],10)/this.GribStep,L=0;L<h;L++){r[c].DateIndex in this.Tables||(this.Tables[r[c].DateIndex]=[]);var M=this.Tables[r[c].DateIndex];f+P in M||(M[f+P]=[]),g-L-1 in M[f+P]||(M[f+P][g-L-1]=null);var m=this.Tables[r[c].DateIndex][f+P][g-L-1];void 0!==m&&m||(m=new GribData,this.Tables[r[c].DateIndex][f+P][g-L-1]=m),m[r[c].Type]=parseFloat(o[i+1+L*p+P])}i+=p*h+1}return!0}this.ForceReloadGribCache(a,e)},this.ProcessCatalogLine=function(e){var t=new WindCatalogLine,a=e.split(":");if(t.Type=a[3],void 0===a[12]||"anl"===a[12])t.DateIndex=0;else{t.DateIndex=parseInt(a[12].substring(0,a[12].indexOf("hr")),10)/3;var o=new Date(this.MinWindStamp.getTime()+108e5*t.DateIndex);o>this.MaxWindStamp&&(this.MaxWindStamp=o,this.WindTableLength=t.DateIndex+1,this.TableTimeStamps[t.DateIndex]=o.getTime()/1e3)}return t}},WindCatalogLine=function e(){_classCallCheck(this,e),this.Type="",this.DateIndex=0},WindTable=function e(){_classCallCheck(this,e),this.GribStep=.5,this.Table=[],this.TableDate=0,this.Init=function(e){for(lat=-90;lat<=90;lat+=this.GribStep)for(lon=-90;lon<=90;lon+=this.GribStep)this.Table[lat][lon]=null}},GribMgr=new VLM2GribManager;function HandleGribTestClick(e){for(var t=_CurPlayer.CurBoat,a=0;a<=0;a++){var o=new Date(1e3*t.VLMInfo.LUP+a*t.VLMInfo.VAC*1e3),n=GribMgr.WindAtPointInTime(o,t.VLMInfo.LAT,t.VLMInfo.LON);n?console.log(o+" "+n.Speed+"@"+n.Heading):console.log("no meteo yet at time : "+o)}}GribMgr.Init();var RACE_TYPE_CLASSIC=0,RACE_TYPE_RECORD=1,RACE_TYPE_OMORMB=2,FIELD_MAPPING_TEXT=0,FIELD_MAPPING_VALUE=1,FIELD_MAPPING_CHECK=2,FIELD_MAPPING_IMG=3,FIELD_MAPPING_CALLBACK=4,FIELD_MAPPING_STYLE=5,FIELD_MAPPING_POPUP=6,MAX_PILOT_ORDERS=5,BoatRacingStatus=["RAC","CST","LOC","DNS"],BoatArrivedStatus=["ARR"],BoatNotRacingStatus=["DNF","HC","HTP"],BoatRacingClasses={RAC:"ft_class_racing",CST:"ft_class_oncoast",LOC:"ft_class_locked",DNS:"ft_class_dns"},SetWPPending=!1,WPPendingTarget=null,GribWindController=null,map=null,Rankings=[],PilototoFt=null,RankingFt=null,RaceHistFt=null,ICS_WPft=null,NSZ_WPft=null,VLMINdexFt=null,RC_PwdResetReq=null,RC_PwdResetConfirm=null,OnPlayerLoadedCallBack=null,GetLanguage=function(){return navigator.userLanguage||navigator.languages&&navigator.languages.length&&navigator.languages[0]||navigator.language||navigator.browserLanguage||navigator.systemLanguage||"en"};$(document).ready(function(){$.ajaxSetup({error:function(e,t,a){401===e.status||403===e.status||"error"===e.status?window.location.replace("/"):404===e.status?$("#ErrorRedirectPanel").modal("show"):VLMAlertDanger("An error occurred: "+t+"nError: "+a)}}),InitLocale(GetLanguage()),InitMenusAndButtons(),PolarsManager.Init(),InitAlerts();var e=CheckPageParameters();setInterval(PageClock,1e3),e||(CheckLogin(),LeafletInit(),setTimeout(function(){map.GribMap=(new GribMap.Layer).addTo(map)},500)),GetFlagsList()});var COMPASS_SIZE=350;function LeafletInit(){map=L.map("jVlmMap").setView([0,0],8);var e=tileUrlSrv;L.tileLayer(e,{attribution:"gshhsv2",maxZoom:20,tms:!1,id:"vlm",detectRetina:!0,subdomains:tilesUrlArray}).addTo(map),map.WMControl=L.control.WindMouseControl().addTo(map),DrawCompass(),map.on("mousemove",HandleMapMouseMove),map.on("moveend",HandleMapGridZoom),map.on("click",HandleMapMouseClick),map.on("zoomend",HandleMapGridZoom)}function DrawCompass(){VLM2Prefs.MapPrefs.ShowCompass?map.Compass?(map.Compass.addTo(map),map.Compass.on("dragend",HandleCompassDragEnd),map.Compass.on("mousemove",HandleCompassMouseMove),map.Compass.on("mouseout",HandleCompassMouseOut)):(map.Compass=new L.marker([0,0],{icon:new L.icon({iconSize:[350,341],iconAnchor:[175,170],iconUrl:"images/compas-transparent.gif"}),draggable:!0,zIndexOffset:-1e3}).addTo(map),map.Compass.on("dragend",HandleCompassDragEnd),map.Compass.on("mousemove",HandleCompassMouseMove),map.Compass.on("mouseout",HandleCompassMouseOut)):map.Compass&&(map.Compass.off("dragend",HandleCompassDragEnd),map.Compass.off("mousemove",HandleCompassMouseMove),map.Compass.off("mouseout",HandleCompassMouseOut),map.Compass.remove())}function HandleCompassMouseOut(e){map.Compass.dragging.enable()}function HandleCompassMouseMove(e){var t=map.getZoom(),a=map.project(map.Compass.getLatLng(),t),o=map.project(map.mouseEventToLatLng(e.originalEvent),t),n=a.x-o.x,r=a.y-o.y;n*n+r*r<COMPASS_SIZE*COMPASS_SIZE/8?map.Compass.dragging.disable():map.Compass.dragging.enable()}function HandleCompassDragEnd(e){if(_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.VLMInfo.LAT&&_CurPlayer.CurBoat.VLMInfo.LON){var t=_CurPlayer.CurBoat,a=[_CurPlayer.CurBoat.VLMInfo.LAT,_CurPlayer.CurBoat.VLMInfo.LON],o=map.Compass.getLatLng(),n=GetRaceMapFeatures(t);n.Compass||(n.Compass={});var r=map.getZoom(),i=map.project(a,r),s=map.project(o,r);Math.abs(i.x-s.x)<BOAT_MARKET_SIZE/2&&Math.abs(i.y-s.y)<BOAT_MARKET_SIZE/2?(n.Compass.Lat=-1,n.Compass.Lon=-1):(n.Compass.Lat=o.lat,n.Compass.Lon=o.lng)}}function HandleMapGridZoom(e){var t=e.sourceTarget,a=t.getZoom(),o=t.getBounds();_CurPlayer.CurBoat&&_CurPlayer.CurBoat.IdBoat&&_CurPlayer.CurBoat.IdBoat()&&VLM2Prefs.SetLastZoom(_CurPlayer.CurBoat.IdBoat(),a);var n=o._northEast.lng-o._southWest.lng,r=o._northEast.lat-o._southWest.lat,i=n;r<n&&(i=r),(i=Math.pow(.25,Math.ceil(Math.log(i)/Math.log(.25))))>5?i=Math.pow(5,Math.floor(Math.log(i)/Math.log(5))):i<.25&&(i=.25),void 0===t.GridLayer?(t.Grid=[],t.GridLayer=L.layerGroup().addTo(t)):t.GridLayer.clearLayers();for(var s={weight:1,opacity:.4,color:"black"},l={permanent:!0,opacity:.4,offset:[0,-10]},d={permanent:!0,opacity:.4,offset:[0,30]},c={permanent:!0,opacity:.4,offset:[10,0]},u={permanent:!0,opacity:.4,offset:[-10,0]},p=0,h=Math.floor(o._southWest.lng);h<=o._northEast.lng;h+=i){var f=[[o._southWest.lat,h],[o._northEast.lat,h]];t.Grid[p]=L.polyline(f,s),t.GridLayer.addLayer(t.Grid[p++]);var P=RoundPow(4*h,0)/4;t.Grid[p]=L.circleMarker(f[0],{radius:1}).bindTooltip(""+P,l),t.GridLayer.addLayer(t.Grid[p++]),t.Grid[p]=L.circleMarker(f[1],{radius:1}).bindTooltip(""+P,d),t.GridLayer.addLayer(t.Grid[p++])}for(var g=Math.floor(o._southWest.lat);g<=o._northEast.lat;g+=i){var M=[[g,o._southWest.lng],[g,o._northEast.lng]],m=RoundPow(4*g,0)/4;t.Grid[p]=L.polyline(M,s),t.GridLayer.addLayer(t.Grid[p]),t.Grid[p]=L.circleMarker(M[0],{radius:1}).bindTooltip(""+m,c),t.GridLayer.addLayer(t.Grid[p++]),t.Grid[p]=L.circleMarker(M[1],{radius:1}).bindTooltip(""+m,u),t.GridLayer.addLayer(t.Grid[p++])}}var PasswordResetInfo=[],_RecaptchaInited=!1,_RecaptchaCallBack=[],_RecaptchaErrorMsgTimeoutHandle=null;function HandlePasswordResetLink(e){if(!_RecaptchaInited)return _RecaptchaCallBack.push(function(t){HandlePasswordResetLink(e)}),void(_RecaptchaCallBack=setTimeout(function(e){VLMAlertInfo(GetLocalizedString("WaitingRecpatchaCheckAdBlock"))},2e3));PasswordResetInfo=unescape(e).split("|"),initrecaptcha(!1,!0)&&$("#ResetaPasswordConfirmation").modal("show")}function CheckPageParameters(){var e=!1,t=window.location.search,a=!0;return t&&function(){var o=t.split("?")[1].split("&"),n=[];for(var r in o)if(o[r]){var i=o[r].split("=");i[0]&&i[1]&&(n[i[0]]=i[1])}var s=function(t){if(n[t])switch(t){case"PwdResetKey":HandlePasswordResetLink(n[t]);break;case"RaceRank":a=!1,RankingFt.OnReadyTable=function(){HandleShowOtherRaceRank(n[t])},e=!0;break;case"VLMIndex":a=!1,VLMINdexFt.OnReadyTable=function(){HandleShowIndex(n[t])},e=!0;break;case"ICSRace":a=!1,HandleShowICS(n[t]),e=!0;break;case"createplayer":"validate"!==n[t]?VLMAlertDanger("Invalid request has been ignored"):(_CurPlayer.CreateBoatInfo={},_CurPlayer.CreateBoatInfo.UserName=decodeURIComponent(HTMLDecode(n.emailid)),_CurPlayer.CreateBoatInfo.Seed=n.seed)}};for(var l in n)s(l)}(),e||(a?($(".RaceNavBar").css("display","inherit"),$(".OffRaceNavBar").css("display","none")):($(".RaceNavBar").css("display","none"),$(".OffRaceNavBar").css("display","inherit"),ShowApropos(!1))),e}function HandleShowICS(e){LoadRaceInfo(e,null,function(e){e&&(FillRaceInstructions(e),$("#RacesInfoForm").modal("show"))})}function LoadRaceInfo(e,t,a){t||(t=""),$.get("/ws/raceinfo/desc.php?idrace="+e+"&v="+t,function(t){_CurPlayer&&(_CurPlayer.RaceInfo||(_CurPlayer.RaceInfo={}),_CurPlayer.RaceInfo[e]=t),a(t)})}function HandleVLMIndex(e){if(e){var t;$("#Ranking-Panel").show();var a=1;for(t in e)e[t]&&(e[t].rank=a,e[t].vlmindex='<span data-toggle="tooltip" title="'+e[t].vlmindex+'">'+parseInt(e[t].vlmindex,10)+"</span>",a++);BackupVLMIndexTable(),VLMINdexFt.loadRows(e),$("#DivVlmIndex").removeClass("hidden"),$("#RnkTabsUL").addClass("hidden"),$("#DivRnkRAC").addClass("hidden")}}function HandleShowIndex(e){var t=HandleVLMIndex;$.get("/cache/rankings/VLMIndex_"+e+".json",t)}function HandleShowOtherRaceRank(e){RankingFt.RaceRankingId=e,LoadRaceInfo(e,0,function(e){FillRaceInfoHeader(e)}),LoadRankings(e,OtherRaceRankingLoaded)}function OtherRaceRankingLoaded(e){$("#Ranking-Panel").show(),SortRanking("RAC",0,e),console.log("off race ranking loaded")}function initrecaptcha(e,t){if(_RecaptchaInited&&"undefined"==typeof grecaptcha||!grecaptcha)return(new MsgBox).Show(MsgBox.MSGBOX_OKONLY,GetLocalizedString("PasswordResetError"),GetLocalizedString("RemoveAdBlock")),!1;if(e&&!RC_PwdResetReq)return RC_PwdResetReq=grecaptcha.render("recaptcha-PwdReset1"),!0;if(t&&!RC_PwdResetConfirm)return RC_PwdResetConfirm=grecaptcha.render("recaptcha-PwdReset2"),!0;for(var a in _RecaptchaErrorMsgTimeoutHandle&&(clearTimeout(_RecaptchaErrorMsgTimeoutHandle),_RecaptchaErrorMsgTimeoutHandle=null),_RecaptchaInited=!0,_RecaptchaCallBack)_RecaptchaCallBack[a]&&_RecaptchaCallBack[a]();return!0}function HandleShowServerInfoModal(e){ServerStatsMgr.LoadStats()}function InitMenusAndButtons(){function e(){var e=$(window).width(),t=.12*$(window).width(),a=$(".VLMSplash").height()-t-180;$(".VLMSplashUpperFiller").css("height",t),$(".VLMSplashSmall").css("height",e).css("background-position-y",.1*$(window).width()),$(".Apropos-text").css("max-height",a)}$("div.vresp.modal").on("shown.bs.modal",function(){$(this).show(),setModalMaxHeight(this)}),$("#ServerStatsLink").click(HandleShowServerInfoModal),$("#ServerInfo").on("hide.bs.modal",ServerStatsMgr.CancelStats.bind(ServerStatsMgr)),e(),$(window).resize(function(){e(),0!=$(".modal.in").length&&setModalMaxHeight($(".modal.in"))}),$("#BtnChangePassword").on("click",function(e){e.preventDefault(),HandlePasswordChangeRequest(e)}),$("#ResetPasswordButton").on("click",function(e){null!==RC_PwdResetReq&&grecaptcha.execute(RC_PwdResetReq)}),$("#ConfirmResetPasswordButton").on("click",function(e){null!==RC_PwdResetConfirm&&grecaptcha.execute(RC_PwdResetConfirm)}),$("#LoginForm").on("show.bs.modal",function(e){ShowApropos(!1)}),$("#LoginForm").on("hide.bs.modal",function(e){ShowApropos(!1)}),$(".logindlgButton").on("click",function(e){$("#LoginForm").modal("show")}),$(".logOutButton").on("click",function(e){Logout()}),$("#Menu").menu(),$("#Menu").hide(),$("input[type=submit],button").button().click(function(e){e.preventDefault()}),$(".JVLMTabs").tabs(),HidePb("#PbLoginProgress"),HidePb("#PbGetBoatProgress"),HidePb("#PbGribLoginProgress"),$(".BCPane.WP_PM_Mode").click(function(){MoveWPBoatControlerDiv("#"+$(this)[0].classList[2])}),$(".BtnRaceList").click(function(){LoadRacesList(0),$("#RacesListForm").modal("show")}),InitRankingEvents(),$("#LoginButton").click(function(){OnLoginRequest()}),$("#LoginPanel").keypress(function(e){"13"===e.which&&(OnLoginRequest(),$("#LoginForm").modal("hide"))}),$("#BtnSetting").click(ShowPrefsDialog),$("#SettingValidateButton").click(SaveBoatAndUserPrefs),$("#SettingCancelButton").click(function(){LoadVLMPrefs(),SetDDTheme(VLM2Prefs.CurTheme),$("#SettingsForm").modal("show")}),$("#BtnPM_Heading").click(function(){SendVLMBoatOrder(PM_HEADING,$("#PM_Heading")[0].value)}),$("#BtnPM_Angle").click(function(){SendVLMBoatOrder(PM_ANGLE,$("#PM_Angle")[0].value)}),$("#BtnPM_Tack").click(function(){$("#PM_Angle")[0].value=-$("#PM_Angle")[0].value}),$("#BtnCreateAccount").click(function(){HandleCreateUser()}),$(".CreatePassword").pstrength(),$("#NewPlayerEMail").blur(function(e){$("#NewPlayerEMail").verimail({messageElement:"#verimailstatus",language:_CurLocale})}),$("#InscriptForm").on("shown.bs.modal",function(){$(this).find("div.modal-body :input").val("")}),$("#SetWPOnClick").click(HandleStartSetWPOnClick),$("#SetWPOffClick").click(HandleCancelSetWPOnClick),HandleCancelSetWPOnClick(),$("body").on("click",".PIL_EDIT",HandlePilotEditDelete),$("body").on("click",".PIL_DELETE",HandlePilotEditDelete),$("#AutoPilotAddButton").click(HandleOpenAutoPilotSetPoint),$("#AP_SetTargetWP").click(HandleClickToSetWP),InitDateTimePicker(),$("#AP_Time").on("dp.change",HandleDateChange),$("#APValidateButton").click(HandleSendAPUpdate),$(".APField").on("change",HandleAPFieldChange),$(".APMode").on("click",HandleAPModeDDClick),$(".Draggable").draggable({handle:".modal-header,.modal-body"}),$("#MapPrefsToggle").click(HandleShowMapPrefs),$(".chkprefstore").on("change",HandleMapPrefOptionChange),$(".MapOppShowLi").click(HandleMapOppModeChange),$(".DDTheme").click(HandleDDlineClick),$("#StartEstimator").on("click",HandleStartEstimator),$("#EstimatorStopButton").on("click",HandleStopEstimator),InitGribSlider(),InitFootables(),$(document.body).on("click",".RaceHistLink",function(e){HandleShowBoatRaceHistory(e)}),$("[PilRefresh]").on("click",HandleUpdatePilototoTable),$("#HistRankingButton").on("click",function(e){ShowUserRaceHistory(e,_CurPlayer.CurBoat.IdBoat())}),$(".RaceListTab").on("click",function(e){ShowUserRaceHistory(e,_CurPlayer.CurBoat.IdBoat())}),$("#RacesFilterText").on("input",HandleRacesListFilterChange),$(".RaceListFormTab").on("click",function(e){FillRacesListForm(e)}),$("#BtnPM_Ortho, #BtnPM_VMG, #BtnPM_VBVMG").click(function(){var e,t=PM_ORTHO,a=$("#PM_Lat")[0].value,o=$("#PM_Lon")[0].value;switch(e=parseInt($("#PM_WPHeading")[0].value,10),$(this)[0].id){case"BtnPM_Ortho":t=PM_ORTHO;break;case"BtnPM_VMG":t=PM_VMG;break;case"BtnPM_VBVMG":t=PM_VBVMG}SendVLMBoatOrder(t,o,a,e)}),$("#CalendarPanel").on("shown.bs.modal",function(e){HandleShowAgenda()}),$(".BoatSelectorDropDownList").on("click",HandleBoatSelectionChange),$("#cp11").colorpicker({useAlpha:!1,format:!1}),$(document.body).on("click",".ShowICSButton",function(e){HandleFillICSButton(e)}),$(document.body).on("click",".ShowRaceInSpectatorMode",function(e){HandleGoToRaceSpectator(e)}),$("#PolarTab").on("click",HandlePolarTabClik),InitPrefsDialogHandlers(),UpdateVersionLine(),$(document.body).on("mouseover",".HoverShowMiniMap",HandleWPMiniMapHover)}function InitDateTimePicker(){var e={locale:_CurLocale,format:"DD MM YYYY, HH:mm:ss",timeZone:""};VLM2Prefs.MapPrefs.UseUTC&&(e.format="DD MM YYYY, HH:mm:ss [Z]",e.timeZone="UTC"),$("#AP_Time").datetimepicker(e)}function InitPrefsDialogHandlers(){$("#AddBoatToFleet").on("click",HandleAddBoatToFleetRequest)}function HandleAddBoatToFleetRequest(){$("#AddBoatToFleet").addClass("hidden"),$("#PnlAddBoat").removeClass("hidden"),$("#NewBoatName")[0].value=GetRandomShipName()}function InitRankingEvents(){$(document.body).on("click",".RankingButton",function(e){var t=$(e.currentTarget).attr("IdRace");void 0!==t&&t&&window.open("/jvlm?RaceRank="+t,"RankTab")}),$(document.body).on("click","[RnkSort]",function(e){HandleRaceSortChange(e)}),$("#Ranking-Panel").on("show.bs.collapse",function(e){ResetRankingWPList(e)})}function UpdateVersionLine(){var e=new moment(BuildDate);$("#BuildDate").text("Build : "+e.fromNow()),$('[data-toggle="tooltip"]').tooltip()}var _CachedRaceInfo=null;function HandlePolarTabClik(){_CachedRaceInfo&&DrawPolar(_CachedRaceInfo)}function InitPolar(e){_CachedRaceInfo=e}function HandleGoToRaceSpectator(e){if(void 0!==e&&e){e.target;var t=$(e.currentTarget).attr("idRace");if(void 0!==t&&t)return void window.open("/guest_map/index.html?idr="+t,"Spec_"+t)}}function HandleFillICSButton(e){if(void 0!==e&&e){e.target;var t=$(e.currentTarget).attr("idRace");if(void 0!==t&&t)return void HandleShowICS(t)}void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&FillRaceInstructions(_CurPlayer.CurBoat.RaceInfo)}var VLMAgenda=null;function HandleShowAgenda(){VLMAgenda&&VLMAgenda.destroy();var e=jQuery("#Calendar")[0];(VLMAgenda=new FullCalendar.Calendar(e,{plugins:["dayGrid"],locale:_CurLocale,editable:!1,header:{left:"title",center:"",right:"today prev,next"},firstDay:1,events:"/feed/races.fullcalendar.php",data:function(){return{jvlm:1}},timeFormat:"H:mm",loading:function(e){e?jQuery("#loading").show():jQuery("#loading").hide()}})).render(),$("#Infos").modal("hide")}function HandlePasswordChangeRequest(e){var t=$("#CurPassword")[0].value,a=$("#NewPassword1")[0].value,o=$("#NewPassword2")[0].value;if($(".Password").val(""),t&&""!==t)if(a===o)if(""!==a){var n={OldPwd:t,NewPwd:a};$.post("/ws/playersetup/password_change.php","parms="+JSON.stringify(n),function(e){HandlePasswordChangeResult(e)})}else VLMAlertDanger(GetLocalizedString("NewPwdRequired"));else VLMAlertDanger(GetLocalizedString("CurPwdRequired"));else VLMAlertDanger(GetLocalizedString("CurPwdRequired"))}function HandlePasswordChangeResult(e){e.success?VLMAlertInfo():VLMAlertDanger(GetLocalizedString(e.error.msg))}function SendResetPassword(e){PasswordResetInfo[0],PasswordResetInfo[1];$.get("/ws/playersetup/password_reset.php?email="+PasswordResetInfo[0]+"&seed="+PasswordResetInfo[1]+"&key="+e,function(e){HandlePasswordReset(e,!0)})}function SendResetPasswordLink(e){var t=$(".UserName").val();if(""===t)return VLMAlertDanger(GetLocalizedString("Enter your email for resetting your password")),void grecaptcha.reset(RC_PwdResetReq);var a={email:t,key:e};$.post("/ws/playersetup/password_reset.php","parms="+JSON.stringify(a),function(e){HandlePasswordReset(e,!1)})}function HandlePasswordReset(e,t){e.success?t?(VLMAlertInfo(GetLocalizedString("Check your inbox to get your new password.")),grecaptcha.reset(RC_PwdResetReq)):(VLMAlertInfo(GetLocalizedString("An email has been sent. Click on the link to validate.")),grecaptcha.reset(RC_PwdResetConfirm)):(VLMAlertDanger("Something went wrong :("),grecaptcha.reset(RC_PwdResetReq),grecaptcha.reset(RC_PwdResetConfirm))}function InitFooTable(e){var t=FooTable.init("#"+e,{name:e,on:{"ready.ft.table":HandleReadyTable,"after.ft.paging":HandlePagingComplete,"postdraw.ft.table":HandleTableDrawComplete}});return t.DrawPending=!0,t.CallbackPending=null,t}function InitFootables(){$("#DiscontinueRaceButton").on("click",HandleDiscontinueRaceRequest),PilototoFt=InitFooTable("PilototoTable"),RankingFt=InitFooTable("RankingTable"),RaceHistFt=InitFooTable("BoatRaceHist"),ICS_WPft=InitFooTable("RaceWayPoints"),NSZ_WPft=InitFooTable("NSZPoints"),VLMINdexFt=InitFooTable("VLMIndexTable")}function HandleUpdatePilototoTable(e){UpdatePilotInfo(_CurPlayer.CurBoat)}function InitSlider(e,t,a,o,n,r){var i=$("#"+t);$("#"+e).slider({orientation:"vertical",min:a,max:o,value:n,create:function(){i.text($(this).slider("value"))},slide:function(e,t){r(e,t)}})}function InitGribSlider(){InitSlider("GribSlider","GribSliderHandle",0,72,0,HandleGribSlideMove)}function HandleRaceSortChange(e){var t=$(e.currentTarget).attr("rnksort");switch(t){case"WP":RankingFt.DrawPending||SortRanking(t,$(e.currentTarget).attr("WPRnk"));break;case"DNF":case"HTP":case"HC":case"ABD":case"RAC":case"ARR":SortRanking(t);break;default:console.log("Sort change request"+e)}}function HandleGribSlideMove(e,t){if(void 0!==map.GribMap){$("#GribSliderHandle").text(t.value);var a=(new Date).getTime();if(map.GribMap.SetGribMapTime(a+36e5*t.value),VLM2Prefs.MapPrefs.TrackEstForecast&&_CurPlayer.CurBoat.Estimator)RefreshEstPosLabels(_CurPlayer.CurBoat.GetClosestEstimatePoint(new Date(a+3600*t.value*1e3))),StartEstimateTimeout()}}function HandleDiscontinueRaceRequest(){GetUserConfirmation(GetLocalizedString("unsubscribe"),!0,HandleRaceDisContinueConfirmation)}function HandleRaceDisContinueConfirmation(e){e?(DiconstinueRace(_CurPlayer.CurBoat.IdBoat(),_CurPlayer.CurBoat.Engaged()),$("#ConfirmDialog").modal("hide"),$("#RacesInfoForm").modal("hide")):VLMAlertDanger("Ouf!")}function HandleStopEstimator(e){var t=_CurPlayer.CurBoat;void 0!==t&&t&&t.Estimator.Stop()}function HandleStartEstimator(e){var t=_CurPlayer.CurBoat;if(void 0!==t&&t){var a=GetRaceMapFeatures(t);if(a)for(var o in a.PilotMarkers)a.PilotMarkers[o]&&(a.PilotMarkers[o].remove(),a.PilotMarkers[o].unbindPopup(a.PilotMarkers[o].getPopup()));t.Estimator.Start(HandleEstimatorProgress)}}function HandleEstimatorProgress(e,t,a){var o=_CurPlayer.CurBoat.Estimator;o&&(e?($("#StartEstimator").removeClass("hidden"),$("#PbEstimatorProgressBar").addClass("hidden"),$("#EstimatorStopButton").addClass("hidden"),o.LastPctRefresh=-1,o.LastPctDraw=-1,DrawBoat(_CurPlayer.CurBoat)):t-o.LastPctRefresh>.25?($("#EstimatorStopButton").removeClass("hidden"),$("#StartEstimator").addClass("hidden"),$("#PbEstimatorProgressBar").removeClass("hidden"),$("#PbEstimatorProgressText").removeClass("hidden"),$("#PbEstimatorProgressText").text(t),$("#PbEstimatorProgress").css("width",t+"%"),$("#PbEstimatorProgress").attr("aria-valuenow",t),$("#PbEstimatorProgress").attr("aria-valuetext",t),o.LastPctRefresh=t):t-o.LastPctDraw>1&&(DrawBoatEstimateTrack(_CurPlayer.CurBoat,GetRaceMapFeatures(_CurPlayer.CurBoat)),o.LastPctDraw=t))}function HandleFlagLineClick(e){SelectCountryDDFlag(e.target.attributes.flag.value)}function HandleCancelSetWPOnClick(){SetWPPending=!1,$("#SetWPOnClick").show(),$("#SetWPOffClick").hide()}function HandleStartSetWPOnClick(){SetWPPending=!0,WPPendingTarget="WP",$("#SetWPOnClick").hide(),$("#SetWPOffClick").show()}function ClearBoatSelector(){$(".BoatSelectorDropDownList").empty()}function AddBoatToSelector(e,t){BuildUserBoatList(e,t)}function BuildUserBoatList(e,t){$(".BoatSelectorDropDownList").append(GetBoatDDLine(e,t))}function GetBoatDDLine(e,t){var a='<li class="DDLine" BoatID="'+e.IdBoat()+'">';return a=a+GetBoatInfoLine(e,t)+"</li>"}function UpdateBoatList(e){if(_CurPlayer&&_CurPlayer.Fleet){var t=_CurPlayer.Fleet.concat(_CurPlayer.BSFleet);for(var a in t)if(t[a]){var o=t[a];if((!e||e.IdBoat()==o.IdBoat())&&(UpdateBoatStatusAndName(o),e))return}}}function UpdateBoatStatusAndName(e){if(e){var t=$("Div[boatid='"+e.IdBoat()+"'] img");t.removeClass("BStatus_Docked").removeClass("BStatus_Racing").removeClass("BStatus_Stranded"),e.Engaged()?e.VLMInfo&&e.VLMInfo["S&G"]?t.addClass("BStatus_Stranded"):e.VLMInfo&&t.addClass("BStatus_Racing"):t.addClass("BStatus_Docked"),$(".BoatStatusName[boatid='"+e.IdBoat()+"']").text(e.BoatName())}}function GetBoatInfoLine(e,t){var a="<div boatid="+e.IdBoat()+">",o="BStatus_Racing";return e.Engaged()||(o="BStatus_Docked"),void 0!==e.VLMInfo&&e.VLMInfo["S&G"]&&(o="BStatus_Stranded"),t||(a+='<span class="badge">BS'),a=a+'<img class="BoatStatusIcon '+o+'" />',t||(a+="</span>"),a=a+'<span>-</span><span class="BoatStatusName" boatid='+e.IdBoat()+">"+HTMLDecode(e.BoatName())+"</span></div>"}function ShowBgLoad(){$("#BgLoadProgress").css("display","block")}function HideBgLoad(){$("#BgLoadProgress").css("display","block")}function ShowPb(e){$(e).show()}function HidePb(e){$(e).hide()}function DisplayLoggedInMenus(e){var t,a;e?(t="block",a="none"):(t="none",a="block"),$("[LoggedInNav='true']").css("display",t),$("[LoggedInNav='false']").css("display",a),void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.IsAdmin?$("[AdminNav='true']").css("display","block"):$("[AdminNav='true']").css("display","none"),ShowApropos(e)}function ShowApropos(e){e?($(".VLMSplash").css("visibility","hidden"),$(".MapContainer").css("visibility","visible")):($(".VLMSplash").css("visibility","visible"),$(".MapContainer").css("visibility","hidden"))}function HandleRacingDockingButtons(e){e?($('[RacingBtn="true"]').removeClass("hidden"),$('[RacingBtn="false"]').addClass("hidden")):($('[RacingBtn="true"]').addClass("hidden"),$('[RacingBtn="false"]').removeClass("hidden"))}function UpdateInMenuDockingBoatInfo(e){HandleRacingDockingButtons(void 0!==e&&void 0!==e.VLMInfo&&parseInt(e.VLMInfo.RAC,10))}function SetTWASign(e){var t=e.VLMInfo.TWD,a=e.VLMInfo.HDG,o=t-a;o<-180&&(o+=360),o>180&&(o-=360);o*e.VLMInfo.TWA>0&&(e.VLMInfo.TWA=-e.VLMInfo.TWA)}function UpdateInMenuRacingBoatInfo(e,t){if(e&&void 0!==e){HandleRacingDockingButtons(!0),SetTWASign(e),"2"===e.VLMInfo.PIM&&"0"===e.VLMInfo.PIP&&(e.VLMInfo.HDG=e.VLMInfo.TWD,e.VLMInfo.BSP=0),e.VLMInfo?($(".NWPBadge").css("visibility","visible"),$(".NWPBadge").text(e.VLMInfo.NWP)):$(".NWPBadge").css("visibility","hidden");var a=new Coords(e.VLMInfo.LON,!0),o=new Coords(e.VLMInfo.LAT),n=[];n.push([FIELD_MAPPING_TEXT,"#BoatLon",a.toString()]),n.push([FIELD_MAPPING_TEXT,"#BoatLat",o.toString()]),n.push([FIELD_MAPPING_TEXT,".BoatSpeed",RoundPow(e.VLMInfo.BSP,2)]),n.push([FIELD_MAPPING_TEXT,".BoatHeading",RoundPow(e.VLMInfo.HDG,1)]),n.push([FIELD_MAPPING_VALUE,"#PM_Heading",RoundPow(e.VLMInfo.HDG,VLM2Prefs.InputDigits)]),n.push([FIELD_MAPPING_TEXT,"#BoatAvg",RoundPow(e.VLMInfo.AVG,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatDNM",RoundPow(e.VLMInfo.DNM,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatLoch",RoundPow(e.VLMInfo.LOC,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatOrtho",RoundPow(e.VLMInfo.ORT,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatLoxo",RoundPow(e.VLMInfo.LOX,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatVMG",RoundPow(e.VLMInfo.VMG,1)]),n.push([FIELD_MAPPING_TEXT,".BoatWindSpeed",RoundPow(e.VLMInfo.TWS,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatWindDirection",RoundPow(e.VLMInfo.TWD,1)]),n.push([FIELD_MAPPING_CHECK,"#PM_WithWPHeading","-1.0"!==e.VLMInfo["H@WP"]]),n.push([FIELD_MAPPING_TEXT,"#RankingBadge",e.VLMInfo.RNK]),n.push([FIELD_MAPPING_VALUE,"#PM_WPHeading",e.VLMInfo["H@WP"]]),n.push([FIELD_MAPPING_TEXT,".BoatClass",e.VLMInfo.POL.substring(5)]),n.push([FIELD_MAPPING_TEXT,".RaceName",e.VLMInfo.RAN]);var r=new VLMPosition(e.VLMInfo.WPLON,e.VLMInfo.WPLAT);n.push([FIELD_MAPPING_VALUE,"#PM_Lat",r.Lat.Value]),n.push([FIELD_MAPPING_VALUE,"#PM_Lon",r.Lon.Value]),0===r.Lon.Value&&0===r.Lat.Value&&(r=e.GetNextWPPosition()),void 0!==r&&r?(n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLat",r.Lat.toString()]),n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLon",r.Lon.toString()])):(n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLat","N/A"]),n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLon","N/A"])),parseInt(e.VLMInfo.PIM,10)===PM_ANGLE?(n.push([FIELD_MAPPING_TEXT,".BoatWindAngle",RoundPow(Math.abs(e.VLMInfo.PIP),1)]),n.push([FIELD_MAPPING_VALUE,"#PM_Angle",RoundPow(e.VLMInfo.PIP,VLM2Prefs.InputDigits)])):(n.push([FIELD_MAPPING_TEXT,".BoatWindAngle",RoundPow(Math.abs(e.VLMInfo.TWA),1)]),n.push([FIELD_MAPPING_VALUE,"#PM_Angle",RoundPow(e.VLMInfo.TWA,VLM2Prefs.InputDigits)])),FillFieldsFromMappingTable(n);var i="lime";e.VLMInfo.TWA>0&&(i="red"),$(".BoatWindAngle").css("color",i);var s=Math.round(100*(e.VLMInfo.TWD+180))/100,l=(Math.round(100*e.VLMInfo.TWS),e.VLMInfo.POL),d=Math.round(100*e.VLMInfo.HDG)/100,c=Math.round(100*e.VLMInfo.TWS)/100,u=Math.round(100*e.VLMInfo.ORT)/100;$("#ImgWindAngle").attr("src","windangle.php?wheading="+s+"&boatheading="+d+"&wspeed="+c+"&roadtoend="+u+"&boattype="+l+"&jvlm="+e.VLMInfo.NOW),$("#ImgWindAngle").css("transform","rotate("+s+"deg)"),$("#DeckImage").css("transform","rotate("+d+"deg)"),$(".PMActiveMode").css("display","none"),$(".BCPane").removeClass("active");var p=".ActiveMode_",h="";switch(e.VLMInfo.PIM){case"1":p+="Heading",h="BearingMode";break;case"2":p+="Angle",h="AngleMode";break;case"3":p+="Ortho",h="OrthoMode";break;case"4":p+="VMG",h="VMGMode";break;case"5":p+="VBVMG",h="VBVMGMode";break;default:VLMAlert("Unsupported VLM PIM Mode, expect the unexpected....","alert-info")}$(p).css("display","inline"),$("."+h).addClass("active"),$("#"+h).addClass("active"),UpdatePilotInfo(e),UpdatePolarImages(e)}}function FillFieldsFromMappingTable(e){for(var t in e)if(e[t])switch(e[t][0]){case FIELD_MAPPING_TEXT:$(e[t][1]).text(e[t][2]);break;case FIELD_MAPPING_VALUE:$(e[t][1]).val(e[t][2]);break;case FIELD_MAPPING_CHECK:$(e[t][1]).prop("checked",e[t][2]);break;case FIELD_MAPPING_IMG:$(e[t][1]).attr("src",e[t][2]);break;case FIELD_MAPPING_CALLBACK:e[t][2](e[t][1]);break;case FIELD_MAPPING_STYLE:$(e[t][1]).css(e[t][2],e[t][3]);break;case FIELD_MAPPING_POPUP:$(e[t][1]).attr("title",e[t][2])}}function FillRaceInstructions(e){if(void 0!==e&&e){var t=!0;void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&(t=_CurPlayer.CurBoat.RaceInfo.idraces!==e.idraces),t?$("#DiscontinueRaceTab").addClass("hidden"):$("#DiscontinueRaceTab").removeClass("hidden");FillRaceInfoHeader(e),FillRaceWaypointList(e),InitPolar(e),$.get("/ws/raceinfo/exclusions.php?idr="+e.idraces+"&v="+e.VER,function(e){e&&e.success&&FillNSZList(e.Exclusions)})}}var PolarSliderInited=!1;function FillRaceInfoHeader(e){if(void 0!==e&&e){var t=[];t.push([FIELD_MAPPING_TEXT,".ICSRaceName",e.racename]),t.push([FIELD_MAPPING_TEXT,".RaceId",e.idraces]),t.push([FIELD_MAPPING_TEXT,".BoatType",e.boattype.substring(5)]),t.push([FIELD_MAPPING_TEXT,".VacFreq",parseInt(e.vacfreq,10)]),t.push([FIELD_MAPPING_TEXT,"#LockTime",parseInt(e.coastpenalty,10)/60]),t.push([FIELD_MAPPING_TEXT,"#EndRace",parseInt(e.firstpcttime,10)]),t.push([FIELD_MAPPING_TEXT,"#RaceStartDate",GetLocalUTCTime(1e3*parseInt(e.deptime,10),!0,!0)]),t.push([FIELD_MAPPING_TEXT,"#RaceLineClose",GetLocalUTCTime(1e3*parseInt(e.closetime,10),!0,!0)]),t.push([FIELD_MAPPING_IMG,"#RaceImageMap","/cache/racemaps/"+e.idraces+".png"]),FillFieldsFromMappingTable(t)}}function HandlePolarSpeedSlide(e,t,a){$("#PolarSpeedHandle").text(t.value),DrawPolar(a)}function DrawPolar(e){var t=$("#PolarCanvas")[0],a=25;PolarSliderInited&&(a=parseFloat($("#PolarSpeedHandle").text()));var o=PolarsManager.GetPolarLine(e.boattype,a,function(){DrawPolar(e)},null,1);if(o){PolarSliderInited||(InitSlider("PolarSpeedSlider","PolarSpeedHandle",0,60,a,function(t,a){HandlePolarSpeedSlide(t,a,e)}),PolarSliderInited=!0),t.width=$("#PolarCanvas").width(),t.height=t.width;var n,r,i=t.getContext("2d"),s=!0,l=Math.PI/o.length,d=t.width/2,c=t.width/2,u=PolarsManager.GetPolarMaxSpeed(e.boattype,a),p=0,h=!0;for(var f in i.beginPath(),i.lineWidth="1",i.strokeStyle="#FF0000",o)if(o[f]){var P=o[f],g=(f=parseInt(f,10))*l,L=d+c*P*Math.cos(g),M=3+c*P*Math.sin(g),m=Math.cos(g+0)*P;h&&m<=p?(i.stroke(),i.beginPath(),i.moveTo(n,r),i.strokeStyle="#FFFFFF",h=!1):!h&&m>=p&&(i.stroke(),i.beginPath(),i.moveTo(n,r),i.strokeStyle="#FF0000",h=!0),p=m,s?(i.moveTo(M,L),s=!1):i.lineTo(M,L),n=M,r=L}i.stroke(),i.beginPath(),i.lineWidth="1",i.strokeStyle="#00FF00",i.moveTo(3,0),i.lineTo(3,t.height),i.stroke(),i.moveTo(2,t.height/2),i.lineTo(3+t.width,t.height/2),i.stroke();var C=Math.round(u/5);C||(C=1);for(var v=1;C*v-1<=u;v++)i.beginPath(),i.strokeStyle="#7FFFFF",i.arc(3,d,c*v*C/u,Math.PI/2,1.5*Math.PI,!0),i.stroke(),i.strokeText(" "+C*v,4+C*c*v/u,d+10)}}function UpdatePolarImages(e){var t,a=e.VLMInfo.POL.substring(5),o="";for(t=0;t<=45;t+=15)o+='<li><img class="polaire" src="/scaledspeedchart.php?boattype=boat_'+a+"&amp;minws="+t+"&amp;maxws="+(t+15)+'&amp;pas=2" alt="speedchart"></li>';$("#PolarList").empty(),$("#PolarList").append(o)}function BackupFooTable(e,t,a){e.DOMBackup?void 0===$(t)[0]&&($(e.RestoreId).append(e.DOMBackup),console.log("Restored footable "+t+" "+new Date)):(e.DOMBackup=$(t),e.RestoreId=a)}function UpdatePilotInfo(e){if(void 0!==e&&e&&!PilototoFt.DrawPending){BackupFooTable(PilototoFt,"#PilototoTable","#PilototoTableInsertPoint");var t=[];if(e&&e.VLMInfo&&e.VLMInfo.PIL&&e.VLMInfo.PIL.length>0){for(var a in e.VLMInfo.PIL)if(e.VLMInfo.PIL[a]){var o=GetPilototoTableLigneObject(e,a);t.push(o)}e.VLMInfo.PIL.length<MAX_PILOT_ORDERS?$("#AutoPilotAddButton").removeClass("hidden"):$("#AutoPilotAddButton").addClass("hidden")}PilototoFt.DrawPending=!0,PilototoFt.loadRows(t,!1),console.log("loaded pilototo table"),UpdatePilotBadge(e)}}function HandleReadyTable(e,t){console.log("Table ready"+t),t.DrawPending=!1,t.OnReadyTable&&t.OnReadyTable()}function HandlePagingComplete(e,t){var a,o={ft_class_myboat:"rnk-myboat",ft_class_friend:"rnk-friend",ft_class_oncoast:"rnk-oncoast",ft_class_racing:"rnk-racing",ft_class_locked:"rnk-locked",ft_class_dns:"rnk-dns"};for(var n in o)o[n]&&$("td").closest("tr").removeClass(o[n]);for(a in o)o[a]&&$('td:contains("'+a+'")').closest("tr").addClass(o[a]);t.DrawPending=!1}function HandleTableDrawComplete(e,t){if(console.log("TableDrawComplete "+t.id),t.DrawPending=!1,t===RankingFt)setTimeout(function(){DeferedGotoPage(e,t)},500);else if(t.CallbackPending)return void setTimeout(function(){t.CallbackPending(),t.CallbackPending=null},500)}function DeferedGotoPage(e,t){RankingFt.TargetPage&&(RankingFt.gotoPage(RankingFt.TargetPage),RankingFt.TargetPage=0),setTimeout(function(){DeferedPagingStyle(e,t)},200)}function DeferedPagingStyle(e,t){HandlePagingComplete(e,t)}function GetPilototoTableLigneObject(e,t){var a=e.VLMInfo.PIL[t],o=GetLocalUTCTime(1e3*a.TTS,!0,!0),n=GetPilotModeName(a.PIM);return t=parseInt(t,10)+1,$("#EditCellTemplate .PIL_EDIT").attr("pil_id",t),$("#DeleteCellTemplate .PIL_DELETE").attr("TID",a.TID).attr("pil_id",t),{date:o,PIM:n,PIP:a.PIP,Status:a.STS,Edit:$("#EditCellTemplate").first().html(),Delete:$("#DeleteCellTemplate").first().html()}}function ShowAutoPilotLine(e,t){var a="#PIL"+t,o=e.VLMInfo.PIL[t-1],n=new Date(1e3*o.TTS),r=GetPilotModeName(o.PIM);if(void 0===$(a)[0]);$(a)[0].attributes.TID=o.TID,SetSubItemValue(a,"#PIL_DATE",n),SetSubItemValue(a,"#PIL_PIM",r),SetSubItemValue(a,"#PIL_PIP",o.PIP),SetSubItemValue(a,"#PIL_STATUS",o.STS),$(a).show()}function GetPILIdParentElement(e){for(var t=e;;){if(void 0===t)return;if("id"in t.attributes){var a=t.attributes.id.value;if(4===a.length&&"PIL"===a.substring(0,3))return t}t=t.parentElement}}function HandlePilotEditDelete(e){var t=$(this)[0],a=t.attributes.class.value,o=_CurPlayer.CurBoat;parseInt(t.attributes.pil_id.value,10);"PIL_EDIT"===a?HandleOpenAutoPilotSetPoint(e):"PIL_DELETE"===a&&DeletePilotOrder(o,t.attributes.TID.value)}function GetPilotModeName(e){switch(parseInt(e,10)){case 1:return GetLocalizedString("autopilotengaged");case 2:return GetLocalizedString("constantengaged");case 3:return GetLocalizedString("orthoengaged");case 4:return GetLocalizedString("bestvmgengaged");case 5:return GetLocalizedString("vbvmgengaged");default:return"PIM ???"+e+"???"}}function SetSubItemValue(e,t,a){var o=$(e).find(t);o.length>0&&o.text(a)}function UpdatePilotBadge(e){var t,a=0;if(void 0!==e&&e){var o=e.VLMInfo.PIL;if(void 0!==o&&o&&o.length)for(t in o)"pending"===o[t].STS&&a++;a>0?($(".PilotOrdersBadge").show(),$(".PilotOrdersBadge").text(a)):$(".PilotOrdersBadge").hide()}}function MoveWPBoatControlerDiv(e){$(e).prepend($("#PM_WPMode_Div"))}function UpdatePrefsDialog(e){if(void 0===e)$("#BtnSetting").addClass("hidden");else if($("#BtnSetting").removeClass("hidden"),$("#pref_boatname").val(e.BoatName()),void 0!==e.VLMInfo){SelectCountryDDFlag(e.VLMInfo.CNT);var t=SafeHTMLColor(e.VLMInfo.COL);$("#pref_boatcolor").val(t),$("#cp11").colorpicker({useAlpha:!1,format:!1,color:t})}}var RaceSorterclass=function e(t){_classCallCheck(this,e),this.OldRacesSortMode=1,t&&(this.OldRacesSortMode=-1),this.sort=function(e,t){return e.CanJoin===t.CanJoin?e.deptime>t.deptime?1*this.OldRacesSortMode:e.deptime===t.deptime?e.racename>t.racename?1*this.OldRacesSortMode:e.racename===t.racename?0:-1*this.OldRacesSortMode:-1*this.OldRacesSortMode:e.CanJoin?1:-1}};function FillRacesListForm(e){var t=null;e&&e.currentTarget&&e.currentTarget.value&&(t=200),LoadRacesList(t)}var OldRaceArray=[],FilterTimerHandler=null;function HandleRacesListFilterChange(e){FilterTimerHandler&&clearTimeout(FilterTimerHandler),FilterTimerHandler=setTimeout(function(t){RaceListFilterChange(e)},300)}function RaceListFilterChange(e){var t=e.currentTarget,a=$(".raceheaderline");if(t){$("#RaceListPanel").empty();var o=t.value.trim().toLowerCase();a.map(function(e){var t=$(a[e]).attr("racelistid"),n=OldRaceArray[OldRaceArray.findIndex(function(e){return e.idraces==t})];""===o||n.racename.toLowerCase().includes(o)?$(a[e]).removeClass("hidden"):$(a[e]).addClass("hidden")}),$("#RaceListPanel").append(a)}}function LoadRacesList(e){var t=0,a=_CurPlayer.CurBoat.IdBoat(),o=0,n=$("#RacesFilterText").val();if($(".racelistpreloader").removeClass("hidden"),$("#BtnMoreOldRaces").addClass("hidden"),e){if(void 0===(o=parseInt($("#BtnMoreOldRaces").addClass("hidden").attr("PageLength"),10))||isNaN(o))o=0,$("#RaceListPanel").empty(),$("#BtnMoreOldRaces").removeClass("hidden").attr("PageLength",100);else if(-1==o)return;t=e+o}else $("#RaceListPanel").empty(),OldRaceArray=[],$(".RaceListTab").removeClass("Active"),$(".RaceListTab [value=0]").addClass("Active"),$("#BtnMoreOldRaces").attr("PageLength",100);$.get("/ws/raceinfo/list.php?iduser="+a+"&OldRaces="+t+"&v="+(new Date).getTime(),function(t){var a=t,r=!1,i=0,s=0,l=function(e){if(a[e]){-1===OldRaceArray.findIndex(function(t){return t.idraces===a[e].idraces})&&(OldRaceArray.push(a[e]),r=!0,s+=1)}i+=1};for(var d in a)l(d);var c=new RaceSorterclass(null!==e);for(var u in OldRaceArray.sort(c.sort.bind(c)),OldRaceArray)OldRaceArray[u]&&!OldRaceArray[u].Loaded&&(OldRaceArray[u].Loaded=!0,AddRaceToList(OldRaceArray[u],n));console.log("RaceList COunters"+i+"/"+s+"/"+OldRaceArray.length),$(".racelistpreloader").addClass("hidden"),e&&r?$("#BtnMoreOldRaces").removeClass("hidden").attr("PageLength",o+e):$("#BtnMoreOldRaces").attr("PageLength",0);var p=0;$("#RaceListPanel .btn-group .btn-md").each(function(){$(this).height()>p&&(p=$(this).height())}),$("#RaceListPanel .btn-group .btn-md").height(p)})}function AddRaceToList(e,t){var a,o,n=$("#RaceListPanel").first(),r=(new Date(0),(e.racetype&RACE_TYPE_RECORD)==RACE_TYPE_RECORD),i=-1===e.started,s=!1;t&&(e.racename.toLowerCase().includes(t.toLowerCase())||(s=!0)),_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&_CurPlayer.CurBoat.RaceInfo.idraces&&(e.CanJoin=e.CanJoin&"0"===_CurPlayer.CurBoat.RaceInfo.idraces);var l=new Date,d=new Date(1e3*e.deptime);new Date(1e3*e.closetime)<=l?a="NoJoinRace":d<=l?(a="CanJoinRace",o=GetLocalizedString("closerace")+" "+moment("/date("+1e3*e.closetime+")/").fromNow()):(a="CanJoinRaceNotStarted",o=GetLocalizedString("departuredate")+" "+moment("/date("+1e3*e.deptime+")/").fromNow());var c="???";e.boattype&&(c=e.boattype.substring(5));var u='<div class="raceheaderline panel panel-default '+a+" "+(s?"hidden":"")+'" racelistid="'+e.idraces+'">  <div data-toggle="collapse" href="#RaceDescription'+e.idraces+'" class="panel-body collapsed " data-parent="#RaceListPanel" aria-expanded="false">    <div class="row">      <div class="col-xs-3">        <img class="racelistminimap" src="/cache/minimaps/'+e.idraces+'.png" ></img>      </div>      <div class="col-xs-9">        <div class="row">'+(r?'<span class="PRecordRace">P</span>':"")+'          <span ">'+e.racename+("0"!==e.racelength?" ("+e.racelength+" Nm)":"")+(e.engaged?" ("+e.racing+"/"+e.engaged+")":"")+'          </span>        </div>        <div class="btn-group col-xs-12">          <button id="JoinRaceButton" type="button" class="'+(e.CanJoin?"":"hidden")+' BtnRaceList btn-default btn-sm col-xs-4 col-md-3" IdRace="'+e.idraces+'"  >'+GetLocalizedString("subscribe")+'          </button>          <button id="SpectateRaceButton" type="button" class="'+(i?"hidden":"")+' BtnRaceList  ShowRaceInSpectatorMode btn-default btn-sm col-xs-4 col-md-3" IdRace="'+e.idraces+'"  >'+GetLocalizedString("Spectator")+'          </button>          <button type="button" class="ShowICSButton btn-default BtnRaceList btn-sm col-xs-4 col-md-3" IdRace="'+e.idraces+'"  >'+GetLocalizedString("ic")+'          </button>          <button type="button" class="RankingButton btn-default BtnRaceList btn-sm col-xs-4 col-md-3" IdRace="'+e.idraces+'"  >'+GetLocalizedString("ranking")+"          </button>        </div>"+(o?'      <div class="row">       <span "> '+o+"       </span>      </div>":"")+'      </div>    </div>  </div>  <div id="RaceDescription'+e.idraces+'" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">    <div class="panel-body">      <div class="col-xs-12"><img class="img-responsive" src="/cache/racemaps/'+e.idraces+'.png" width="530px"></div>        <div class="col-xs-12"><p>'+GetLocalizedString("race")+" : "+e.racename+"</p>          <p>Départ : "+GetLocalUTCTime(1e3*e.deptime,!0,!0)+"</p>          <p>"+GetLocalizedString("boattype")+" : "+c+"</p>          <p>"+GetLocalizedString("crank")+" : "+e.vacfreq+"'</p>          <p>"+GetLocalizedString("locktime")+parseInt(e.coastpenalty,10)/60+" '</p>          <p>"+GetLocalizedString("closerace")+GetLocalUTCTime(1e3*e.closetime,!0,!0)+"</p>"+(r?"":(e.RaceCloseDate?"          <p>"+GetLocalizedString("endrace")+GetLocalUTCTime(1e3*e.RaceCloseDate,!0,!0)+"</p>":"          <p>"+GetLocalizedString("endrace")+(100+e.firstpcttime)+"%")+"</p>")+"        </div>      </div>    </div>  </div>";n.prepend(u),$("#JoinRaceButton").click(function(e){EngageBoatInRace(e.currentTarget.attributes.idrace.value,_CurPlayer.CurBoat.IdBoat())})}function PageClock(){if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat){var e=_CurPlayer.CurBoat;if(void 0!==e&&void 0!==e.RaceInfo){var t=GetRaceClock(e.RaceInfo,e.VLMInfo.UDT),a=$(".RaceChrono");t<0?a.removeClass("ChronoRaceStarted").addClass("ChronoRacePending"):a.addClass("ChronoRaceStarted").removeClass("ChronoRacePending"),$("#RefreshAge").text(moment(_CurPlayer.CurBoat.LastRefresh).fromNow());var o=new Date(1e3*e.VLMInfo.LUP),n=e.VLMInfo.VAC,r=n-(new Date-o)/1e3%n;if(r>=n-1&&100,$("#pbar_innerdivvac").css("width",+Math.round(r%60*100/60)+"px"),$("#pbar_innerdivmin").css("width",Math.round(r/n*100)+"px"),e.VLMInfo&&e.VLMInfo["S&G"]){var i=moment(1e3*e.VLMInfo["S&G"]),s=moment();s<i?($("#PenaltyDuration").text(s.to(i)),$(".RaceChrono").addClass("hidden"),$("#PenaltyBadge").removeClass("hidden")):($("#PenaltyBadge").addClass("hidden"),$(".RaceChrono").removeClass("hidden"))}else $("#PenaltyBadge").addClass("hidden"),$(".RaceChrono").removeClass("hidden");a.text(GetFormattedChronoString(t))}}}function GetRaceClock(e,t){var a=new Date,o=new Date(1e3*e.deptime);if(e.racetype&RACE_TYPE_RECORD){var n=parseInt(t,10);if(-1===n)return 0;var r=new Date(1e3*n);return Math.floor((a-r)/1e3)}return Math.floor((a-o)/1e3)}function DisplayCurrentDDSelectedBoat(e){$(".BoatDropDown:first-child").html("<span BoatID="+e.IdBoat()+">"+GetBoatInfoLine(e,e.IdBoat()in _CurPlayer.Fleet)+'</span><span class="caret"></span>')}function PadLeftZero(e){return e<100?("00"+e).slice(-2):e}function GetFormattedChronoString(e){if(e<0)e=-e;else if(0===e)return"--:--:--";var t=PadLeftZero(e%60),a=PadLeftZero(Math.floor(e/60)%60),o=PadLeftZero(Math.floor(e/3600)%24),n=PadLeftZero(Math.floor(e/3600/24)),r=o.toString()+":"+a.toString()+":"+t.toString();return n>0&&(r=n.toString()+" d "+r),r}function RefreshCurrentBoat(e,t,a){var o=$(".BoatDropDown > span");void 0!==o&&void 0!==o[0]&&("BoatId"in o[0].attributes||"boatid"in o[0].attributes)&&SetCurrentBoat(GetBoatFromIdu(o[0].attributes.BoatID.value),e,t,a)}function UpdateLngDropDown(){var e=GetCurrentLocale();$("#SelectionLanguageDropDown:first-child").html('<img class=" LngFlag" lang="'+e+'" src="images/lng-'+e+'.png" alt="'+e+'"><span class="caret"></span>')}var _CurAPOrder=null;function HandleOpenAutoPilotSetPoint(e){var t,a=e.target;if("id"in a.attributes)t=a.attributes.id.nodeValue;else{if(!("class"in a.attributes))return void VLMAlert("Something bad has happened reload this page....","alert-danger");t=a.attributes.class.nodeValue}switch(t){case"AutoPilotAddButton":_CurAPOrder=new AutoPilotOrder;break;case"PIL_EDIT":var o=parseInt(a.attributes.pil_id.value,10);_CurAPOrder=new AutoPilotOrder(_CurPlayer.CurBoat,o),$("#AutoPilotSettingForm").modal("show");break;default:return void VLMalert("Something bad has happened reload this page....","alert-danger")}RefreshAPDialogFields()}function RefreshAPDialogFields(){InitDateTimePicker(),$("#AP_Time").data("DateTimePicker").date(_CurAPOrder.Date),$("#AP_PIM:first-child").html("<span>"+_CurAPOrder.GetPIMString()+'</span><span class="caret"></span>'),$("#AP_PIP").val(_CurAPOrder.PIP_Value),$("#AP_WPLat").val(_CurAPOrder.PIP_Coords.Lat.Value),$("#AP_WPLon").val(_CurAPOrder.PIP_Coords.Lon.Value),$("#AP_WPAt").val(_CurAPOrder.PIP_WPAngle),UpdatePIPFields(_CurAPOrder.PIM)}function HandleDateChange(e){_CurAPOrder.Date=e.date}function HandleClickToSetWP(){SetWPPending=!0,WPPendingTarget="AP",$("#AutoPilotSettingForm").modal("hide")}function HandleAPModeDDClick(e){var t=e.target.attributes.PIM.value;_CurAPOrder.PIM=parseInt(t,10),$("#AP_PIM:first-child").html("<span>"+_CurAPOrder.GetPIMString()+'</span><span class="caret"></span>'),UpdatePIPFields(_CurAPOrder.PIM)}function UpdatePIPFields(e){var t=!0;switch(e){case PM_HEADING:case PM_ANGLE:t=!0;break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:t=!1}t?($(".AP_PIPRow").removeClass("hidden"),$(".AP_WPRow").addClass("hidden")):($(".AP_PIPRow").addClass("hidden"),$(".AP_WPRow").removeClass("hidden"))}function SaveBoatAndUserPrefs(e){var t={},a=!1,o=$("#SelectionThemeDropDown").attr("SelTheme");void 0!==o&&(VLM2Prefs.CurTheme=o),VLM2Prefs.AdvancedStats=$("#AdvancedStats").is(":checked"),VLM2Prefs.Save(),ComparePrefString($("#pref_boatname")[0].value,_CurPlayer.CurBoat.BoatName())||(t.boatname=encodeURIComponent($("#pref_boatname")[0].value),a=!0),ComparePrefString($("#pref_boatcolor")[0].value,SafeHTMLColor(_CurPlayer.CurBoat.VLMInfo.COL))||(t.color=$("#pref_boatcolor")[0].value.substring(1),a=!0);var n=GetPrefSelFlag();ComparePrefString(n,_CurPlayer.CurBoat.VLMInfo.CNT)||(t.country=encodeURIComponent(n),a=!0),a&&void 0!==_CurPlayer&&_CurPlayer&&UpdateBoatPrefs(_CurPlayer.CurBoat,{prefs:t})}function GetPrefSelFlag(){return $("#CountryDropDown:first-child [flag]")[0].attributes.flag.value}function ComparePrefString(e,t){return e.toString()===t.toString()}function SelectCountryDDFlag(e){$("#CountryDropDown:first-child").html("<div>"+GetCountryDropDownSelectorHTML(e,!1)+'<span class="caret"></span></div>')}function ResetCollapsiblePanels(e){$(".collapse").collapse("hide")}function HandleBoatSelectionChange(e){var t=$(e.target).closest("li").attr("BoatID");if(t){var a=GetBoatFromIdu(t=parseInt(t,10));ResetCollapsiblePanels(),void 0!==a&&a?(SetCurrentBoat(a,!0,!1),DisplayCurrentDDSelectedBoat(a)):VLMAlertDanger(GetLocalizedString("Error Reload"))}}var LastMouseMoveCall=0,ShowEstTimeOutHandle=null;function HandleMapMouseClick(e){SetWPPending&&("WP"===WPPendingTarget?(CompleteWPSetPosition(e),HandleCancelSetWPOnClick()):"AP"===WPPendingTarget?(SetWPPending=!1,_CurAPOrder.PIP_Coords=new VLMPosition(e.latlng.lng,e.latlng.lat),$("#AutoPilotSettingForm").modal("show"),RefreshAPDialogFields()):SetWPPending=!1)}function HandleMapMouseMove(e){var t=e.latlng;if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat&&void 0!==_CurPlayer.CurBoat.VLMInfo){var a=new VLMPosition(t.lng,t.lat),o=new VLMPosition(_CurPlayer.CurBoat.VLMInfo.LON,_CurPlayer.CurBoat.VLMInfo.LAT),n=_CurPlayer.CurBoat.GetNextWPPosition(),r=null,i=new Date-LastMouseMoveCall>300;if(VLM2Prefs.MapPrefs.EstTrackMouse&&i&&(r=_CurPlayer.CurBoat.GetClosestEstimatePoint(a),LastMouseMoveCall=new Date,clearTimeout(ShowEstTimeOutHandle),StartEstimateTimeout()),$("#MI_Lat").text(a.Lat.toString()),$("#MI_Lon").text(a.Lon.toString()),$("#MI_LoxoDist").text(o.GetLoxoDist(a,2)+" nM"),$("#MI_OrthoDist").text(o.GetOrthoDist(a,2)+" nM"),$("#MI_Loxo").text(o.GetLoxoCourse(a,2)+" °"),$("#MI_Ortho").text(o.GetOrthoCourse(a,2)+" °"),void 0!==n&&n?($("#MI_WPLoxoDist").text(n.GetLoxoDist(a,2)+" nM"),$("#MI_WPOrthoDist").text(n.GetOrthoDist(a,2)+" nM"),$("#MI_WPLoxo").text(n.GetLoxoCourse(a,2)+" °"),$("#MI_WPOrtho").text(n.GetOrthoCourse(a,2)+" °")):($("#MI_WPLoxoDist").text("--- nM"),$("#MI_WPOrthoDist").text("--- nM"),$("#MI_WPLoxo").text("--- °"),$("#MI_WPOrtho").text("--- °")),GribMgr){var s="-- N/A --",l="-- N/A --",d="-- N/A --";if(GribMgr.LastGribDate){s=moment("/date("+1e3*GribMgr.LastGribDate+")/").fromNow();var c=moment("/date("+1e3*GribMgr.TableTimeStamps[0]+")/"),u=moment("/date("+1e3*GribMgr.TableTimeStamps[GribMgr.TableTimeStamps.length-1]+")/"),p=moment.duration(u.diff(c));l=GetLocalUTCTime(c.add(3.5,"h"),!0,!0),d=p.asHours()+" h";var h=(new Date).getTime()/1e3;h-c.local().unix()>25200?$("#GribLoadOK").addClass("GribNotOK"):h-c.local().unix()>21600?$("#GribLoadOK").addClass("GribGetsOld"):$("#GribLoadOK").removeClass("GribNotOK").removeClass("GribGetsOld")}$("#MI_SrvrGribAge").text(s),$("#MI_LocalGribAge").text(l),$("#MI_LocalGribSpan").text(d)}i&&RefreshEstPosLabels(r)}}function StartEstimateTimeout(){ShowEstTimeOutHandle=setTimeout(function(){_CurPlayer.CurBoat.GetClosestEstimatePoint(null),RefreshEstPosLabels(null)},5e3)}function RefreshEstPosLabels(e){e&&void 0!==e.Date?$("#MI_EstDate").text(GetLocalUTCTime(e.Date,!1,!0)):$("#MI_EstDate").text("")}function GetWPrankingLI(e){return'<li id="RnkWP'+e.wporder+'" RnkSort="WP" WPRnk="'+e.wporder+'"><a href="#DivRnkRAC" RnkSort="WP" WPRnk="'+e.wporder+'">WP '+e.wporder+" : "+e.libelle+"</a></li>"}function ResetRankingWPList(e){$("[WPRnk]").remove(),$("#RnkTabsUL").addClass("WPNotInited")}function CheckWPRankingList(e,t){var a=$(".WPNotInited"),o=GetRankingRaceId(e),n=!1;if(void 0!==a&&a&&o)if(void 0!==e&&e&&void 0!==e.RaceInfo&&e.RaceInfo&&o===e.RaceInfo.RaceId)BuildWPTabList(void 0,a),n=!0;else if("object"===_typeof(t)&&t)BuildWPTabList(t,a),n=!0;else{var r=0;void 0!==e&&e&&void 0!==e.VLMInfo&&(r=e.VLMInfo.VER),$.get("/ws/raceinfo/desc.php?idrace="+o+"&v="+r,function(t){CheckWPRankingList(e,t)})}n&&($(a).removeClass("WPNotInited"),$(".JVLMTabs").tabs("refresh"))}function BuildWPTabList(e,t){var a;if(void 0!==t&&t)for(a in void 0!==e&&e||(e=Boat.RaceInfo.races_waypoints),e.races_waypoints)if(e.races_waypoints[a]){var o=GetWPrankingLI(e.races_waypoints[a]);$(t).append(o)}}function SortRanking(e,t,a){var o=null;void 0!==_CurPlayer&&_CurPlayer&&(o=_CurPlayer.CurBoat),CheckWPRankingList(o,a);var n=null;switch(void 0!==o&&o&&o.VLMPrefs&&o.VLMPrefs.mapPrefOpponents&&(n=o.VLMPrefs.mapPrefOpponents.split(",")),e){case"WP":SetRankingColumns(e),SortRankingData(o,e,t=parseInt(t,10)),FillWPRanking(o,t,n);break;case"DNF":case"HC":case"ARR":case"HTP":case"ABD":SetRankingColumns(e),SortRankingData(o,e),FillStatusRanking(o,e,n);break;default:SetRankingColumns("RAC"),SortRankingData(o,"RAC"),FillRacingRanking(o,n)}}function SetRankingColumns(e){switch(e){case"WP":SetWPRankingColumns();break;case"DNF":case"HC":case"ARR":case"HTP":case"ABD":SetNRClassRankingColumns();break;default:SetRacingClassRankingColumns()}}var RACColumnHeader=["Rank","Name","Distance","Time","Loch","Lon","Lat","Last1h","Last3h","Last24h","Delta1st"],NRColumnHeader=["Rank","Name","Distance"],WPColumnHeader=["Rank","Name","Time","Loch"],RACColumnHeaderLabels=["ranking","boatname","distance","racingtime","Loch","Lon","Lat","Last1h","Last3h","Last24h","ecart"],NRColumnHeaderLabels=["ranking","boatname","status"],WPColumnHeaderLabels=["ranking","boatname","racingtime","ecart"];function SetRacingClassRankingColumns(){SetColumnsVisibility(RACColumnHeader,RACColumnHeaderLabels)}function SetNRClassRankingColumns(){SetColumnsVisibility(NRColumnHeader,NRColumnHeaderLabels)}function SetWPRankingColumns(){SetColumnsVisibility(WPColumnHeader,WPColumnHeaderLabels)}function SetColumnsVisibility(e,t){var a;for(a=0;a<RankingFt.columns.array.length;a++)if(RankingFt.columns.array[a]){var o=e.indexOf(RankingFt.columns.array[a].name);o>-1&&$("[data-name='"+e[o]+"']").attr("I18n",t[o]),RankingFt.columns.array[a].visible=o>-1}LocalizeItem($("[I18n][data-name]").get())}function RnkIsArrived(e){return!(void 0===e||void 0===e.status||!e.status)&&-1!==BoatArrivedStatus.indexOf(e.status)}function RnkIsRacing(e){return!(void 0===e||void 0===e.status||!e.status)&&-1!==BoatRacingStatus.indexOf(e.status)}function Sort2ArrivedBoats(e,t){var a=parseInt(e.duration,10)+parseInt(e.penalty,10),o=parseInt(t.duration,10)+parseInt(t.penalty,10);return a>o?(DebugRacerSort(e,t,1),1):a<o?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,0),0)}function Sort2RacingBoats(e,t){var a=parseInt(e.nwp,10),o=parseInt(t.nwp,10);if(a===o){var n=parseFloat(e.dnm),r=parseFloat(t.dnm);if(n>r)return DebugRacerSort(e,t,1),1;if(n===r){DebugRacerSort(e,t,0);var i=e.country>t.country?1:e.country===t.country?0:-1;return i||(e.idusers>t.idusers?1:e.idusers===t.idusers?0:-1)}return DebugRacerSort(e,t,-1),-1}return a>o?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,1),1)}function GetWPDuration(e,t){return e&&e.WP&&e.WP[t-1]&&e.WP[t-1].duration?parseInt(e.WP[t-1].duration,10):9999999999}function WPRaceSort(e){return function(t,a){return GetWPDuration(t,e)-GetWPDuration(a,e)}}function RacersSort(e,t){return RnkIsRacing(e)&&RnkIsRacing(t)?Sort2RacingBoats(e,t):RnkIsArrived(e)&&RnkIsArrived(t)?Sort2ArrivedBoats(e,t):RnkIsArrived(e)?(DebugRacerSort(e,t,-1),-1):RnkIsArrived(t)?(DebugRacerSort(e,t,1),1):RnkIsRacing(e)?(DebugRacerSort(e,t,1),-1):RnkIsRacing(t)?(DebugRacerSort(e,t,1),1):Sort2NonRacing(e,t)}var AlertTemplate,DebugCount=1;function DebugRacerSort(e,t,a){}function Sort2NonRacing(e,t){if(void 0!==e.idusers&&void 0!==t.idusers){var a=e.country>t.country?1:e.country===t.country?0:-1;if(a)return a;var o=parseInt(e.idusers,10),n=parseInt(t.idusers,10);return o>n?(DebugRacerSort(e,t,1),1):o<n?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,0),0)}if("undefined"!=typeof IdUser1)return-1;if("undefined"!=typeof IdUser2)return-1;var r=[e,t];return r.sort(),r[0]===e?1:-1}function GetRankingRaceId(e,t){return t||RankingFt.RaceRankingId?t||RankingFt.RaceRankingId:e.Engaged()}function SortRankingData(e,t,a,o){if(o=GetRankingRaceId(e,o),e||Rankings[o]){var n;if(Rankings&&Rankings[o]&&void 0===Rankings[o].RacerRanking)for(n in Rankings[o].RacerRanking=[],Rankings[o])Rankings[o][n]&&Rankings[o].RacerRanking.push(Rankings[o][n]);switch(t){case"WP":Rankings[o].RacerRanking.sort(WPRaceSort(a));break;case"RAC":case"DNF":case"HC":case"HTP":case"ABD":case"ARR":void 0!==Rankings&&Rankings[o]&&Rankings[o].RacerRanking&&Rankings[o].RacerRanking.sort(RacersSort);break;default:VLMAlertInfo("unexpected sort option : "+t)}var r=1,i=0;if(e&&e.IdBoat&&Rankings&&Rankings[o])for(i in Rankings[o].RacerRanking)if(Rankings[o].RacerRanking[i]&&e&&e.IdBoat()===i){r=i+1;break}return r}}function FillWPRanking(e,t,a){var o,n=1,r=0,i=[];BackupRankingTable();var s=GetRankingRaceId(e);for(o in Rankings[s].RacerRanking)if(Rankings[s].RacerRanking[o]){var l=Rankings[s].RacerRanking[o];l.WP&&l.WP[t-1]&&!l.WP[t-1].Delta&&(r?(l.WP[t-1].Delta=l.WP[t-1].duration-r,l.WP[t-1].Pct=100*(l.WP[t-1].duration/r-1)):(r=l.WP[t-1].duration,l.WP[t-1].Delta=0,l.WP[t-1].Pct=0)),l.WP&&l.WP[t-1]&&(i.push(GetRankingObject(l,parseInt(o,10)+1,t,a)),void 0!==e&&e&&e.IdBoat&&e.IdBoat()===parseInt(l.idusers,10)&&(n=i.length))}var d=RoundPow(n/20,0)+(n%20>=10?0:1);RankingFt.DrawPending=!0,RankingFt.loadRows(i),RankingFt.TargetPage=d}function BackupICS_WPTable(){BackupFooTable(ICS_WPft,"#RaceWayPoints","#RaceWayPointsInsertPoint")}function getWaypointHTMLSymbols(e){var t="";switch(e&(WP_CROSS_CLOCKWISE|WP_CROSS_ANTI_CLOCKWISE)){case WP_CROSS_ANTI_CLOCKWISE:t+="&#x21BA; ";break;case WP_CROSS_CLOCKWISE:t+="&#x21BB; "}switch((e&WP_CROSS_ONCE)==WP_CROSS_ONCE&&(t+="&#x2285; "),e&(WP_ICE_GATE_N|WP_ICE_GATE_S)){case WP_ICE_GATE_S:t+="&#x27F0;";break;case WP_ICE_GATE_N:t+="&#x27F1;"}return t.trim()}function getWaypointHTMLSymbolsDescription(e){var t="";switch(e&(WP_CROSS_CLOCKWISE|WP_CROSS_ANTI_CLOCKWISE)){case WP_CROSS_ANTI_CLOCKWISE:t+=GetLocalizedString("Anti-clockwise")+" ";break;case WP_CROSS_CLOCKWISE:t+=GetLocalizedString("Clockwise")+" "}switch((e&WP_CROSS_ONCE)==WP_CROSS_ONCE&&(t+=GetLocalizedString("Only once")),e&(WP_ICE_GATE_N|WP_ICE_GATE_S)){case WP_ICE_GATE_S:t+=GetLocalizedString("Ice gate")+"("+GetLocalizedString("South")+") ";break;case WP_ICE_GATE_N:t+=GetLocalizedString("Ice gate")+"("+GetLocalizedString("North")+") "}return""!==t&&(t=GetLocalizedString("Crossing")+" : "+t),t.trim()}function NormalizeRaceInfo(e){if(void 0!==e&&e&&!e.IsNormalized){for(var t in e.startlat/=VLM_COORDS_FACTOR,e.startlong/=VLM_COORDS_FACTOR,e.races_waypoints)if(e.races_waypoints[t]){var a=e.races_waypoints[t];a.latitude1/=VLM_COORDS_FACTOR,a.longitude1/=VLM_COORDS_FACTOR,void 0!==a.latitude2&&(a.latitude2/=VLM_COORDS_FACTOR,a.longitude2/=VLM_COORDS_FACTOR)}e.IsNormalized=!0}}function FillRaceWaypointList(e){if(ICS_WPft.DrawPending)ICS_WPft.CallbackPending||(ICS_WPft.CallbackPending=function(){FillRaceWaypointList(e)});else if(BackupICS_WPTable(),e){NormalizeRaceInfo(e);var t=[],a={WaypointId:0};for(var o in a.WP1=e.startlat+"<BR>"+e.startlong,a.WP2="",a.Spec="",a.Type=GetLocalizedString("startmap"),a.Name="",t.push(a),e.races_waypoints)if(e.races_waypoints[o]){var n=e.races_waypoints[o],r={};r.WaypointId='<span class="HoverShowMiniMap" RaceId="'+e.idraces+'"  WP_Id="'+n.idwaypoint+'">'+n.wporder+"</span>",r.WP1=n.latitude1+"<BR>"+n.longitude1,void 0!==n.latitude2?r.WP2=n.latitude2+"<BR>"+n.longitude2:r.WP2="@"+n.laisser_au,r.Spec="<span title='"+getWaypointHTMLSymbolsDescription(n.wpformat)+"'>"+getWaypointHTMLSymbols(n.wpformat)+"</span>",r.Type=GetLocalizedString(n.wptype),r.Name=n.libelle,t.push(r)}ICS_WPft.loadRows(t)}}function BackupNSZ_Table(){BackupFooTable(NSZ_WPft,"NSZPoints","NSZPointsInsertPoint")}function FillNSZList(e){if(NSZ_WPft.DrawPending)NSZ_WPft.CallbackPending||(NSZ_WPft.CallbackPending=function(){FillNSZList(e)});else if(BackupNSZ_Table(),e){var t=[];for(var a in e)if(e[a]){var o=e[a],n={};n.NSZId=a,n.Lon1=o[0][1],n.Lat1=o[0][0],n.Lon2=o[1][1],n.Lat2=o[1][0],t.push(n)}NSZ_WPft.loadRows(t)}}function BackupRankingTable(){BackupFooTable(RankingFt,"#RankingTable","#my-rank-content")}function BackupVLMIndexTable(){BackupFooTable(VLMINdexFt,"#VLMIndexTable","#my-vlmindex-content")}function FillStatusRanking(e,t,a){var o,n=1,r=[],i=GetRankingRaceId(e);for(o in BackupRankingTable(),Rankings[i].RacerRanking)if(Rankings[i].RacerRanking[o]){var s=Rankings[i].RacerRanking[o];s.status===t&&(r.push(GetRankingObject(s,parseInt(o,10)+1,null,a)),void 0!==e&&e&&e.IdBoat()===parseInt(s.idusers,10)&&(n=r.length))}var l=RoundPow(n/20,0)+(n%20>=10?0:1);RankingFt.loadRows(r),RankingFt.TargetPage=l,RankingFt.DrawPending=!0}function FillRacingRanking(e,t){var a,o=[],n=0,r={Arrived1stTime:null,Racer1stPos:null},i=0,s=0;BackupRankingTable();var l=GetRankingRaceId(e),d=0;if(l&&void 0!==Rankings&&void 0!==Rankings[l]&&Rankings[l]&&Rankings[l].RacerRanking)for(a in Rankings[l].RacerRanking)if(Rankings[l].RacerRanking[a]){var c=Rankings[l].RacerRanking[a];if(void 0!==e&&e&&e.IdBoat&&e.IdBoat()===parseInt(c.idusers,10)&&(n=o.length),!RnkIsArrived(c)&&!RnkIsRacing(c))break;RnkIsArrived(c)?(i&&parseInt(c.duration,10)===i||(i=parseInt(c.duration,10),s+=1),r.Arrived1stTime||(r.Arrived1stTime=parseInt(c.duration,10))):!RnkIsRacing(c)||r.Racer1stPos&&c.nwp===d?s+=1:(r.Racer1stPos=c.dnm,d=c.nwp,s+=1),o.push(GetRankingObject(c,s,null,t,r))}var u=RoundPow(n/20,0)+(n%20>=10?0:1);RankingFt.loadRows(o),RankingFt.TargetPage=u,RankingFt.DrawPending=!0}function GetBoatInfoLink(e){var t=parseInt(e.idusers,10),a=e.boatname,o="";return e.country&&void 0===(o=GetCountryFlagImgHTML(e.country))&&(o=""),o+='<a class="RaceHistLink" boatid ="'+t+'"data-toggle="tooltip" title="'+a+"-"+t+'" >'+e.PlayerName+"</a>"}function GetRankingObject(e,t,a,o,n){var r="";void 0!==e.Challenge&&e.Challenge[1]&&(r='<img class="RnkLMNH" src="images/LMNH.png"></img>'+r);var i={Rank:t,Name:r+=GetBoatInfoLink(e),Distance:"",Time:"",Loch:"",Lon:"",Lat:"",Last1h:"",Last3h:"",Last24h:"",Class:"",Delta1st:""};if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.GetRankingObject&&parseInt(e.idusers,10)===_CurPlayer.CurBoat.IdBoat()&&(i.Class+=" ft_class_myboat"),void 0!==o&&o&&-1!==o.indexOf(e.idusers)&&(i.Class+=" ft_class_friend"),RnkIsRacing(e)&&!a){var s="["+e.nwp+"] -=> "+RoundPow(e.dnm,2);if(t>1&&n&&n.Racer1stPos){new VLMPosition(e.longitude,e.latitude);i.Delta1st=RoundPow(e.dnm-n.Racer1stPos,2)}i.Distance=s;var l=Math.round((new Date-new Date(1e3*parseInt(e.deptime,10)))/1e3);for(var d in i.Time="-1"===e.deptime?"":GetFormattedChronoString(l),i.Loch=e.loch,i.Lon=FormatLon(e.longitude),i.Lat=FormatLat(e.latitude),i.Last1h=e.last1h,i.Last3h=e.last3h,i.Last24h=e.last24h,BoatRacingStatus)e.status===BoatRacingStatus[d]&&(i.Class+="  "+BoatRacingClasses[BoatRacingStatus[d]])}else if(a){var c;if(i.Time=GetFormattedChronoString(parseInt(e.WP[a-1].duration,10)),e.WP[a-1].Delta){var u=RoundPow(e.WP[a-1].Pct,2);c=GetFormattedChronoString(e.WP[a-1].Delta)+" (+"+u+" %)"}else c=GetLocalizedString("winner");i.Loch=c}else{var p=GetLocalizedString("status_"+e.status);i.Distance=p;var h=parseInt(e.duration,10);i.Time=GetFormattedChronoString(h),n&&h!==n.Arrived1stTime?(i.Time+=" ( +"+RoundPow(h/n.Arrived1stTime*100-100,2)+"% )",i.Delta1st=GetFormattedChronoString(h-n.Arrived1stTime)):n&&h==n.Arrived1stTime&&(i.Delta1st=GetLocalizedString("winner")),i.Loch=e.loch}return i}function formatCoords(e){e=Math.abs(e);var t=Math.trunc(e);return t+"° "+Math.trunc(60*(e-t))+"' "+RoundPow(3600*(e-t)%60,4)+'"'}function FormatLon(e){var t=e>0?"W":"E";return formatCoords(e)+t}function FormatLat(e){var t=e>0?"N":"S";return formatCoords(e)+t}function HandleShowMapPrefs(e){$("#DisplayReals").attr("checked",VLM2Prefs.MapPrefs.ShowReals),$("#ShowCompass").attr("checked",VLM2Prefs.MapPrefs.ShowCompass),$("#DisplayNames").attr("checked",VLM2Prefs.MapPrefs.ShowOppNumbers),$("#EstTrackMouse").attr("checked",VLM2Prefs.MapPrefs.EstTrackMouse),$("#TrackEstForecast").attr("checked",VLM2Prefs.MapPrefs.TrackEstForecast),$("#UseUTC").attr("checked",VLM2Prefs.MapPrefs.UseUTC),$("#DDMapSelOption:first-child").html("<span Mode="+VLM2Prefs.MapPrefs.MapOppShow+">"+VLM2Prefs.MapPrefs.GetOppModeString(VLM2Prefs.MapPrefs.MapOppShow)+'</span><span class="caret"></span>'),VLM2Prefs.MapPrefs.MapOppShow===VLM2Prefs.MapPrefs.MapOppShowOptions.ShowTopN?($("#NbDisplayBoat").removeClass("hidden"),$("#NbDisplayBoat").val(VLM2Prefs.MapPrefs.ShowTopCount)):$("#NbDisplayBoat").addClass("hidden"),$("#VacPol").val(VLM2Prefs.MapPrefs.PolarVacCount)}function HandleMapPrefOptionChange(e){var t=e.target;if(void 0!==t&&void 0!==t.attributes.id){var a=t.attributes.id.value,o=t.checked;switch(a){case"DisplayReals":case"ShowReals":case"UseUTC":case"DisplayNames":case"ShowOppNumbers":case"EstTrackMouse":case"TrackEstForecast":VLM2Prefs.MapPrefs[a]=o;break;case"ShowCompass":VLM2Prefs.MapPrefs[a]=o,DrawCompass();break;case"VacPol":var n=parseInt($("#VacPol").val(),10);n>0&&n<120?VLM2Prefs.MapPrefs.PolarVacCount=n:$("#VacPol").value(12);break;case"NbDisplayBoat":var r=parseInt($("#NbDisplayBoat").val(),10);VLM2Prefs.MapPrefs.ShowTopCount=r;break;default:return void console.log("unknown pref storage called : "+a)}VLM2Prefs.Save(),RefreshCurrentBoat(!1,!1)}}function SafeHTMLColor(e){return void 0===e&&(e="#000000"),(e=""+e).length<6&&(e=("000000"+e).slice(-6)),"#"!==e.substring(0,1)?e="#"+e:"#"===e.substring(1,2)&&(e=e.substring(1)),e}function HandleMapOppModeChange(e){var t=e.target;if(void 0!==t&&t&&void 0!==t.attributes&&"undefined"!==t.attributes.Mode&&t.attributes.Mode){var a=parseInt(t.attributes.Mode.value,10);VLM2Prefs.MapPrefs.MapOppShow=a,VLM2Prefs.Save(),HandleShowMapPrefs(e)}}function SetActiveStyleSheet(e){var t,a;for(t=0;a=document.getElementsByTagName("link")[t];t++)-1!==a.getAttribute("rel").indexOf("style")&&a.getAttribute("title")&&(a.disabled=!0,a.getAttribute("title")===e&&(a.disabled=!1))}function SetDDTheme(e){SetActiveStyleSheet(e),$("#SelectionThemeDropDown:first-child").html(e+'<span class="caret"></span>'),$("#SelectionThemeDropDown").attr("SelTheme",e)}function HandleDDlineClick(e){e.target;SetDDTheme(e.target.attributes.ddtheme.value)}function InitAlerts(){$("#AlertBox").css("display","block"),AlertTemplate=$("#AlertBox")[0],$("#AlertBoxContainer").empty(),$("#AlertBoxContainer").removeClass("hidden")}function VLMAlertSuccess(e){VLMAlert(e,"alert-success")}function VLMAlertDanger(e){VLMAlert(e,"alert-danger")}function VLMAlertInfo(e){VLMAlert(e,"alert-info")}Math.trunc=Math.trunc||function(e){return isNaN(e)?NaN:e>0?Math.floor(e):Math.ceil(e)};var AlertIntervalId=null;function VLMAlert(e,t){AlertIntervalId&&clearInterval(AlertIntervalId),void 0!==t&&t||(t="alert-info"),$("#AlertBoxContainer").empty().append(AlertTemplate).show(),$("#AlertText").text(e),$("#AlertBox").removeClass("alert-sucess"),$("#AlertBox").removeClass("alert-warning"),$("#AlertBox").removeClass("alert-info"),$("#AlertBox").removeClass("alert-danger"),$("#AlertBox").addClass(t),$("#AlertBox").show(),$("#AlertCloseBox").unbind().on("click",AutoCloseVLMAlert),AlertIntervalId&&clearInterval(AlertIntervalId),AlertIntervalId=setTimeout(AutoCloseVLMAlert,5e3)}function AutoCloseVLMAlert(){$("#AlertBox").hide()}function GetUserConfirmation(e,t,a){$("#ConfirmDialog").modal("show"),t?($("#OKBtn").hide(),$("#CancelBtn").hide(),$("#YesBtn").show(),$("#NoBtn").show()):($("#OKBtn").show(),$("#CancelBtn").show(),$("#YesBtn").hide(),$("#NoBtn").hide()),$("#ConfirmText").text(e),$(".OKBtn").unbind().on("click",function(){$("#ConfirmDialog").modal("hide"),a(!0)}),$(".NOKBtn").unbind().on("click",function(){$("#ConfirmDialog").modal("hide"),a(!1)})}function GetRaceRankingLink(e){return'<a href="/jvlm?RaceRank='+e.idrace+'" target="RankTab">'+e.racename+"</a>"}function FillBoatPalmares(e,t){var a;if("success"===t){var o=[];for(a in e.palmares)if(e.palmares[a]){var n=e.palmares[a],r={RaceId:e.palmares[a].idrace,RaceName:GetRaceRankingLink(e.palmares[a]),Ranking:n.ranking.rank+" / "+n.ranking.racercount};o.push(r)}RaceHistFt.loadRows(o)}var i=GetLocalizedString("palmares");i=i.replace("%s",e.boat.name),$("#palmaresheaderline").text(i)}function ShowUserRaceHistory(e,t){var a=e.currentTarget.value;switch(void 0===a?($("#RaceHistory").modal("show"),a=0,$(".RaceListTab").attr("BoatId",t)):t=$(".RaceListTab").attr("BoatId"),a){case 2:break;case 1:default:var o=1==a?"&GetPlayerRaces=1":"";StatMGR.Stat("BoatPalmares",1==a?"Player":"Boat"),$("#RaceRankingsPreloader").removeClass("hidden"),$(".racelistpreloader").addClass("hidden"),$.get("/ws/boatinfo/palmares.php?idu="+t+o,function(e,t){$("#RaceListDiv").removeClass("hidden"),FillBoatPalmares(e,t),$(".racelistpreloader").addClass("hidden")})}$(".JVLMTabs").tabs("refresh")}function HandleShowBoatRaceHistory(e){var t=$(e.target).attr("boatid");t&&ShowUserRaceHistory(e,t)}function HandleCreateUserResult(e,t){if("success"===t&&e)if($(".ValidationMark").addClass("hidden"),e.success?($(".ValidationMark.Valid").removeClass("hidden"),VLMAlertSuccess(GetLocalizedString("An email has been sent. Click on the link to validate.")),$("#InscriptForm").modal("hide"),$("#LoginForm").modal("hide")):e.request&&e.request.errorstring?VLMAlertDanger(GetLocalizedString(e.request.errorstring)):VLMAlertDanger(GetLocalizedString(e.error.msg)),e.request)e.request.MailOK?$(".ValidationMark.Email.Valid").removeClass("hidden"):$(".ValidationMark.Email.Invalid").removeClass("hidden"),e.request.PasswordOK?$(".ValidationMark.Password.Valid").removeClass("hidden"):$(".ValidationMark.Password.Invalid").removeClass("hidden"),e.request.PlayerNameOK?$(".ValidationMark.Pseudo.Valid").removeClass("hidden"):$(".ValidationMark.Pseudo.Invalid").removeClass("hidden");else if(e.error)switch(e.error.code){case"NEWPLAYER01":$(".ValidationMark.Email.Invalid").removeClass("hidden");break;case"NEWPLAYER02":$(".ValidationMark.Pseudo.Invalid").removeClass("hidden");break;case"NEWPLAYER03":$(".ValidationMark.Password.Invalid").removeClass("hidden")}$("#BtnCreateAccount").show()}function HandleCreateUser(){var e=$("#NewPlayerPseudo")[0].value,t={emailid:$("#NewPlayerEMail")[0].value,password:$("#NewPlayerPassword")[0].value,pseudo:e};$("#BtnCreateAccount").hide(),$.post("/ws/playerinfo/player_create.php",t,function(e,t){HandleCreateUserResult(e,t)})}function setModalMaxHeight(e){var t=$(e),a=t.find(".modal-content"),o=a.outerHeight()-a.innerHeight(),n=$(window).width()<768?20:60,r=$(window).height()-(n+o)-((t.find(".modal-header").outerHeight()||0)+(t.find(".modal-footer").outerHeight()||0));a.css({overflow:"hidden"}),t.find(".modal-body").css({"max-height":r,"overflow-y":"auto","overflow-x":"hidden"})}function GetLocalUTCTime(e,t,a){var o=e,n="";return moment.isMoment(e)||(o=t?moment(e).utc():moment(e)),VLM2Prefs.MapPrefs.UseUTC?(o.isLocal()&&(o=o.utc()),n=" Z"):o.isLocal()||(o=o.local()),a?o.format("LLLL")+n:o}function ShowPrefsDialog(e){LoadVLMPrefs(),$("#AddBoatToFleet").removeClass("hidden"),$("#PnlAddBoat").addClass("hidden"),SetDDTheme(VLM2Prefs.CurTheme),$("#SettingsForm").modal("show")}if("undefined"==typeof jQuery)throw new Error("jQuery progress timer requires jQuery");!function(e,t,a,o){var n="progressTimer",r={timeLimit:60,warningThreshold:5,onFinish:function(){},baseStyle:"",warningStyle:"progress-bar-danger",completeStyle:"progress-bar-success",showHtmlSpan:!0,errorText:"ERROR!",successText:"100%"},i=function(t,a){this.element=t,this.$elem=e(t),this.options=e.extend({},r,a),this._defaults=r,this._name=n,this.metadata=this.$elem.data("plugin-options"),this.init()};i.prototype.constructor=i,i.prototype.init=function(){var a=this;return e(a.element).empty(),a.span=e("<span/>"),a.barContainer=e("<div>").addClass("progress"),a.bar=e("<div>").addClass("progress-bar active progress-bar-striped").addClass(a.options.baseStyle).attr("role","progressbar").attr("aria-valuenow","0").attr("aria-valuemin","0").attr("aria-valuemax",a.options.timeLimit),a.span.appendTo(a.bar),a.options.showHtmlSpan||a.span.addClass("sr-only"),a.bar.appendTo(a.barContainer),a.barContainer.appendTo(a.element),a.start=new Date,a.limit=1e3*a.options.timeLimit,a.warningThreshold=1e3*a.options.warningThreshold,a.interval=t.setInterval(function(){a._run.call(a)},250),a.bar.data("progress-interval",a.interval),!0},i.prototype.destroy=function(){this.$elem.removeData()},i.prototype._run=function(){var e=this,t=new Date-e.start,a=t/e.limit*100;e.bar.attr("aria-valuenow",a),e.bar.width(a+"%");var o=a.toFixed(2);return o>=100&&(o=100),e.options.showHtmlSpan&&e.span.html(o+"%"),t>=e.warningThreshold&&e.bar.removeClass(this.options.baseStyle).removeClass(this.options.completeStyle).addClass(this.options.warningStyle),t>=e.limit&&e.complete.call(e),!0},i.prototype.removeInterval=function(){var a=e(".progress-bar",this.element);if(void 0!==a.data("progress-interval")){var o=a.data("progress-interval");t.clearInterval(o)}return a},i.prototype.complete=function(){var t=this,a=t.removeInterval.call(t),o=arguments;0!==o.length&&"object"===_typeof(o[0])&&(t.options=e.extend({},t.options,o[0])),a.removeClass(t.options.baseStyle).removeClass(t.options.warningStyle).addClass(t.options.completeStyle),a.width("100%"),t.options.showHtmlSpan&&e("span",a).html(t.options.successText),a.attr("aria-valuenow",100),setTimeout(function(){t.options.onFinish.call(a)},500),t.destroy.call(t)},i.prototype.error=function(){var t=this,a=t.removeInterval.call(t),o=arguments;0!==o.length&&"object"===_typeof(o[0])&&(t.options=e.extend({},t.options,o[0])),a.removeClass(t.options.baseStyle).addClass(t.options.warningStyle),a.width("100%"),t.options.showHtmlSpan&&e("span",a).html(t.options.errorText),a.attr("aria-valuenow",100),setTimeout(function(){t.options.onFinish.call(a)},500),t.destroy.call(t)},e.fn[n]=function(t){var a=arguments;if(t===o||"object"===_typeof(t))return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new i(this,t))});if("string"==typeof t&&"_"!==t[0]&&"init"!==t){if(0===Array.prototype.slice.call(a,1).length&&-1!==e.inArray(t,e.fn[n].getters)){var r=e.data(this[0],"plugin_"+n);return r[t].apply(r,Array.prototype.slice.call(a,1))}return this.each(function(){var o=e.data(this,"plugin_"+n);o instanceof i&&"function"==typeof o[t]&&o[t].apply(o,Array.prototype.slice.call(a,1))})}},e.fn[n].getters=["complete","error"]}(jQuery,window,document,void 0),L.Control.WindMouseControl=L.Control.extend({options:{position:"bottomleft"},_GetControlHTML:function(){return"<table><tr><td class='leaflet-control-windmouse_zoomcol'><span>Zoom : </span> <span id='LWM_ZoomLevel'></span></td><td class='leaflet-control-windmouse_latlon'><span>Lat : </span> <span id='LWM_Lat'></span></td><td class='leaflet-control-windmouse_latlon'><span>Lon : </span> <span id='LWM_Lon'></span></td></tr><tr><td class='leaflet-control-windmouse_wndimg'><img class='BeaufortImg'></td><td class='leaflet-control-windmouse_wndhdg'><span id='LWM_Hdg'></span></td><td class='leaflet-control-windmouse_wndspd'><span id='LWM_Spd'></span></td></tr></table>"},onAdd:function(e){this._map=e;return this._Container=L.DomUtil.create("div","leaflet-control-windmouse-frame"),this._ZContainer=L.DomUtil.create("div","",this._Container),this._ZContainer.innerHTML=this._GetControlHTML(),e.on("mousemove",this._Update,this),e.on("zoomend",this._ZoomEnd,this),this._SetZoom(e.getZoom()),this._Container},_Update:function(e){if(void 0!==map.GribMap){var t=e.latlng.lat,a=e.latlng.lng,o=this._map.getZoom(),n=null;o>=MIN_MAP_ZOOM&&(n=GribMgr.WindAtPointInTime(map.GribMap.GetGribMapTime(),t,a));var r=[];if(r.push([FIELD_MAPPING_TEXT,"#LWM_Lat",RoundPow(t,3)]),r.push([FIELD_MAPPING_TEXT,"#LWM_Lon",RoundPow(a,3)]),n){r.push([FIELD_MAPPING_TEXT,"#LWM_Hdg",RoundPow(n.Speed,2)+" kts"]),r.push([FIELD_MAPPING_TEXT,"#LWM_Spd",RoundPow(n.Heading,2)+" °"]);var i=GribMgr.GetBeaufort(n.Speed);$(".BeaufortImg").css("background-position","-0px -"+24*i+"px");var s=n.Heading-56;$(".BeaufortImg").css("transform","rotate("+s+"deg)")}else r.push([FIELD_MAPPING_TEXT,"#LWM_Hdg","-- kts"]),r.push([FIELD_MAPPING_TEXT,"#LWM_Spd","-- °"]),$(".BeaufortImg").css('style="background-position: -0px -0px"');FillFieldsFromMappingTable(r),this._SetZoom(o)}},_ZoomEnd:function(e){this._SetZoom(this._map.getZoom())},_SetZoom:function(e){var t=[];t.push([FIELD_MAPPING_TEXT,"#LWM_ZoomLevel",RoundPow(e,1)]),FillFieldsFromMappingTable(t)}}),L.control.WindMouseControl=function(e){return new L.Control.WindMouseControl(e)};var _LocaleDict,_EnDict,BuoyMarker=L.Icon.extend({options:{iconSize:[36,72],iconAnchor:[18,36],popupAnchor:[0,-36]}}),TrackWPMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],iconUrl:"images/WP_Marker.gif"}}),PilototoMarker=L.Icon.extend({options:{iconSize:[24,24],iconAnchor:[6,24],iconUrl:"images/Pilototo.png"}}),BOAT_MARKET_SIZE=48,BOAT_EST_MARKET_SIZE=24,BoatMarker=L.Icon.extend({options:{iconSize:[BOAT_MARKET_SIZE,BOAT_MARKET_SIZE],iconAnchor:[BOAT_MARKET_SIZE/2,BOAT_MARKET_SIZE/2],iconUrl:"images/target.png",rotationOrigin:[BOAT_MARKET_SIZE/2,BOAT_MARKET_SIZE/2]}}),BoatEstMarker=L.Icon.extend({options:{iconSize:[BOAT_EST_MARKET_SIZE,BOAT_EST_MARKET_SIZE],iconAnchor:[BOAT_EST_MARKET_SIZE/2,BOAT_EST_MARKET_SIZE/2],iconUrl:"images/target.png",rotationOrigin:[BOAT_EST_MARKET_SIZE/2,BOAT_EST_MARKET_SIZE/2]}}),IceGateMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,-18],iconUrl:"images/icegate.png"}}),GateDirMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],rotationOrigin:[24,24]}});function GetPilototoMarker(e,t){var a=new PilototoMarker;return a.Order=e,a.OrderIndex=t,a}function GetBuoyMarker(e){var t=null;return(t=new BuoyMarker(e?{iconUrl:"images/Buoy1.png"}:{iconUrl:"images/Buoy2.png",color:"red"})).IsCWBuoy=e,t}function GetBoatMarker(e){var t=new BoatMarker;return t.MarkerOppId=e,t}function GetBoatEstimateMarker(){return new BoatEstMarker}function GetTrackWPMarker(){return new TrackWPMarker}function GetGateTypeMarker(e,t){return t?IceGateMarker:new GateDirMarker({iconUrl:"images/"+e})}function GetOpponentMarker(e){var t=new L.Icon({iconUrl:"images/opponent"+e.IsTeam+".png",iconAnchor:[e.IsFriend/2,e.IsFriend/2],iconSize:[e.IsFriend,e.IsFriend]});return t.MarkerOppId=e.idboat,t}function ClearCurrentMapMarkers(e){e&&e.RaceMapFeatures&&(e.RaceMapFeatures.OppPopup&&e.RaceMapFeatures.OppPopup.PrevOpp&&(e.RaceMapFeatures.OppPopup.PrevOpp.closePopup(),e.RaceMapFeatures.OppPopup.PrevOpp.unbindPopup()),RemoveFromMap(e.RaceMapFeatures,map))}function EnsureMarkersVisible(e){e&&RestoreMarkersOnMap(e.RaceMapFeatures,map)}function RestoreMarkersOnMap(e,t){if(e&&"function"!=typeof e)if(Array.isArray(e))for(var a in e)RestoreMarkersOnMap(e[a],t);else if("object"===_typeof(e)&&void 0===e._leaflet_id)for(var o in e)switch(o){case"OppPopup":break;default:RestoreMarkersOnMap(e[o],t)}else e._leaflet_id&&!e._map&&e.addTo(t)}function RemoveFromMap(e,t){if(e&&"function"!=typeof e)if(Array.isArray(e))for(var a in e)RemoveFromMap(e[a],t);else if("object"===_typeof(e)&&void 0===e._leaflet_id)for(var o in e)RemoveFromMap(e[o],t);else e._leaflet_id&&e.removeFrom(t)}!function(){var e=L.Marker.prototype._initIcon,t=L.Marker.prototype._setPos,a="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook(function(){var e=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;e&&(e=e[0]+"px "+e[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||e||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(e){e.target._applyRotation()})}),L.Marker.include({_initIcon:function(){e.call(this)},_setPos:function(e){t.call(this,e),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,a?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(e){return this.options.rotationAngle=e,this.update(),this},setRotationOrigin:function(e){return this.options.rotationOrigin=e,this.update(),this}})}();var _CurLocale="en",_SyncLocalizedCallBack=[];function LocalizeString(){return LocalizeItem($("[I18n]").get()),$(".LngFlag").click(function(e,t){var a=$(this).attr("lang");if(!a){var o=$(this).siblings("img");o&&(a=o[0].attributes.lang.value)}a&&(OnLangFlagClick(a),UpdateLngDropDown())}),!0}function OnLangFlagClick(e){InitLocale(e)}function LocalizeItem(e){try{var t;for(t in e){var a=e[t];if(a&&a.attributes&&a.attributes.I18n){var o=a.attributes.I18n.value;void 0!==_LocaleDict&&(a.innerHTML=GetLocalizedString(o))}}}finally{}return!0}function InitLocale(e){var t="/ws/serverinfo/translation.php";e&&"string"==typeof e&&(e.includes("-")&&(e=e.split("-")[0]),t+="?lang="+e),$.get(t,function(e){if(1==e.success){for(var t in _CurLocale=e.request.lang,_LocaleDict=e.strings,moment.locale(_CurLocale),LocalizeString(),UpdateLngDropDown(),_SyncLocalizedCallBack)_SyncLocalizedCallBack[t]&&_SyncLocalizedCallBack[t]();_SyncLocalizedCallBack=[];for(var a="",o=0;o<24;o+=6){""!==a&&(a+=", ");var n=moment.utc().minutes(30).hour(o+3);VLM2Prefs&&VLM2Prefs.MapPrefs&&VLM2Prefs.MapPrefs.UseUTC?a+=n.format("LT"):a+=n.local().format("LT")}VLM2Prefs&&VLM2Prefs.MapPrefs&&VLM2Prefs.MapPrefs.UseUTC&&(a+=" UTC"),$(".AProposLine").html(GetLocalizedString("a1",a))}else alert("Localization string table load failure....")}),void 0===_EnDict&&$.get("/ws/serverinfo/translation.php?lang=en",function(e){1==e.success?_EnDict=e.strings:alert("Fallback localization string table load failure....")})}function HTMLDecode(e){for(var t=document.createElement("textarea");e.includes("%25");)e=e.replace("%25","%");t.innerHTML=e;var a=t.value,o=["\n\r","\r\n","\n","\r"];for(var n in o)for(;o[n]&&-1!==a.indexOf(o[n]);)a=a.replace(o[n],"<br>");return a}function GetLocalizedString(e,t){var a="";return a=void 0!==_LocaleDict&&_LocaleDict&&e in _LocaleDict?HTMLDecode(_LocaleDict[e]):void 0!==_EnDict&&_EnDict&&e in _EnDict?HTMLDecode(_EnDict[e]):e,t&&(a=vsprintf(a,t)),a}function GetCurrentLocale(){return _CurLocale}function WaitLocaleInited(e){return!!e&&(!(!_LocaleDict&&!_EnDict)||(_SyncLocalizedCallBack.push(e),!1))}String.prototype.includes||(String.prototype.includes=function(e,t){if(e instanceof RegExp)throw TypeError("first argument must not be a RegExp");return void 0===t&&(t=0),-1!==this.indexOf(e,t)});var VLMMercatorTransform=new MercatorTransform;function MercatorTransform(){this.Width=1e4,this.Height=1e4,this.LonOffset=0,this.LatOffset=0,this.Scale=1e4/180,this.LonToMapX=function(e){return this.Width/2+(e-this.LonOffset)*this.Scale},this.LatToMapY=function(e){return e=Deg2Rad(e),e=Rad2Deg(e=Math.log(Math.tan(e)+1/Math.cos(e))),this.Height/2-(e-this.LatOffset)*this.Scale},this.SegmentsIntersect=function(e,t){var a=this.LonToMapX(e.P1.Lon.Value),o=this.LatToMapY(e.P1.Lat.Value),n=this.LonToMapX(e.P2.Lon.Value),r=this.LatToMapY(e.P2.Lat.Value),i=this.LonToMapX(t.P1.Lon.Value),s=this.LatToMapY(t.P1.Lat.Value),l=this.LonToMapX(t.P2.Lon.Value),d=this.LatToMapY(t.P2.Lat.Value);if(e.P1.Lon.Value===e.P2.Lon.Value&&e.P1.Lat.Value===e.P2.Lat.Value||t.P1.Lon.Value===t.P2.Lon.Value&&t.P1.Lat.Value===t.P2.Lat.Value)return!1;n-=a,r-=o,i-=a,s-=o,l-=a,d-=o,a=0,o=0;var c=Math.sqrt(n*n+r*r),u=n/c,p=r/c,h=i*u+s*p;if(s=s*u-i*p,i=h,h=l*u+d*p,d=d*u-l*p,l=h,s===d)return!1;var f=l+(i-l)*d/(d-s),P=f/c;if(P>=0&&P<=1){var g,L=o;if(l-i)g=(a+f-i)/(l-i);else{if(!(d-s))return!1;g=(L-s)/(d-s)}return g>=0&&g<=1}return!1}}var MsgBox=function(){function e(){_classCallCheck(this,e),this.OkYesCallBack=null,this.NoCancelCallBack=null,this.Btn1Function=function(){$("#MsgBoxDialog").modal("hide"),this.OkYesCallBack&&setTimeout(this.OkYesCallBack,100)},this.Btn2Function=function(){$("#MsgBoxDialog").modal("hide"),this.NoCancelCallBack&&setTimeout(this.NoCancelCallBack,100)},this.SetupButtons=function(t){var a=[!0,!1],o=["#MsgBoxButton1","#MsgBoxButton2"],n=["OK",""];switch(t){case e.MSGBOX_YESNO:n=[GetLocalizedString("yes"),GetLocalizedString("no")],a=[!0,!0]}for(var r in o)$(o[r]).text(n[r]).addClass("hidden"),a[r]&&$(o[r]).removeClass("hidden")},this.Show=function(e,t,a,o,n){this.SetupButtons(e),this.OkYesCallBack=o,this.NoCancelCallBack=n,$("#MsgBoxTitle").text(t),$("#MsgBoxText").html(a),$("#MsgBoxButton1").off("click"),$("#MsgBoxButton2").off("click"),$("#MsgBoxButton1").on("click",this.Btn1Function.bind(this)),$("#MsgBoxButton2").on("click",this.Btn2Function.bind(this));$(".modal .in").modal("hide");$("#MsgBoxDialog").modal("show")}}return _createClass(e,null,[{key:"MSGBOX_OKONLY",get:function(){return 0}},{key:"MSGBOX_YESNO",get:function(){return 1}}]),e}(),PolarManagerClass=function e(){_classCallCheck(this,e),this.Polars=[],this.PolarLoaderQueue={},this.Init=function(){this.Polars=[],$.get("/ws/polarlist.php",function(e){for(var t in e.list)PolarsManager.Polars["boat_"+e.list[t]]=null})},this.GetBoatSpeed=function(e,t,a,o){if(!(e in this.Polars))return NaN;if(this.Polars[e]){var n=WindAngle(o,a);return GetPolarAngleSpeed(this.Polars[e],n,t)}return this.LoadPolar(e,null,null),NaN},this.HandlePolarLoaded=function(e,t,a){var o=$.csv.toArrays(a,{separator:";"});for(var n in o)if(o[n])for(var r in o[n])o[n][r]&&(o[n][r]=parseFloat(o[n][r]));for(var i in PolarsManager.Polars[e]={},PolarsManager.Polars[e].SpeedPolar=o,PolarsManager.Polars[e].WindLookup=[],PolarsManager.Polars[e].AngleLookup=[],this.PolarLoaderQueue[e].callbacks){var s=this.PolarLoaderQueue[e].callbacks[i];s&&t?s(t):s&&s()}this.PolarLoaderQueue[e]=null},this.GetPolarLine=function(e,t,a,o,n){if(n||(n=5),void 0===this.Polars[e])return alert("Unexpected polarname : "+e),null;if(null!==this.Polars[e]){var r,i=[],s=0;for(r=0;r<=180;r+=n){var l=GetPolarAngleSpeed(this.Polars[e],r,t);s<l&&(s=l),i.push(l)}for(var d in i)i[d]&&(i[d]/=s);return i}this.LoadPolar(e,a,o)};var t=0;this.GetVMGCourse=function(e,a,o,n,r){for(var i=n.GetOrthoCourse(r),s=0,l=-1e10,d=-1;d<=1;d+=2)for(var c=0;c<=90;c+=1){var u=this.GetBoatSpeed(e,a,o,i+c*d),p=u*Math.cos(Deg2Rad(c));t&&console.log("VMG "+RoundPow((i+c*d+360)%360,3)+" "+RoundPow(u,3)+" "+RoundPow(p,3)+" "+RoundPow(l,3)+" "+(p>=l?"BEST":"")),p>=l&&(l=p,s=i+c*d)}return t=0,s},this.GetVBVMGCourse=function(e,t,a,o,n){var r=o.GetOrthoDist(n),i=o.GetOrthoCourse(n),s=0,l=0,d=0,c=0,u=0,p=1,h=this.GetBoatSpeed(e,t,a,i);u=h>0?r/h:8760;var f=a-i;f<-90?f+=360:f>90&&(f-=360),p=f>0?-1:1;for(var P=1;P<=90;P++){var g=P*Math.PI/180,L=Math.tan(g),M=Math.sqrt(1+L*L),m=this.GetBoatSpeed(e,t,a,i-P*p);if(isNaN(m))return NaN;if(m>0)for(var C=-89;C<=0;C++){var v=C*Math.PI/180,S=r*(Math.tan(-v)/(L+Math.tan(-v))),I=S*M/m;if(!(I<0||I>u)){var _=r-S,R=this.GetBoatSpeed(e,t,a,i-C*p);if(isNaN(R))return NaN;if(!(R<=0)){var T=Math.tan(-v),k=I+_*Math.sqrt(1+T*T)/R;k<u&&(u=k,s=P,l=C,d=m,c=R)}}}}var w=d*Math.cos(Deg2Rad(s)),b=c*Math.cos(Deg2Rad(l));if(isNaN(w)||isNaN(b))return NaN;return w>b?i-s*p:i-l*p},this.GetPolarMaxSpeed=function(e,t){if(!this.Polars[e])return null;var a,o=0;for(a=0;a<=180;a+=1){var n=GetPolarAngleSpeed(this.Polars[e],a,t);n>o&&(o=n)}return o},this.LoadPolar=function(e,t,a){this.PolarLoaderQueue[e]?t&&this.PolarLoaderQueue[e].callbacks.push(t):(this.PolarLoaderQueue[e]={},this.PolarLoaderQueue[e].callbacks=[],t&&this.PolarLoaderQueue[e].callbacks.push(t),$.get("/Polaires/"+e+".csv",this.HandlePolarLoaded.bind(this,e,a)))}},PolarsManager=new PolarManagerClass;function GetPolarAngleSpeed(e,t,a){var o,n,r,i,s=e.SpeedPolar,l=Math.floor(a);if(void 0!==e.WindLookup&&l in e.WindLookup)o=e.WindLookup[l];else for(var d in s[0]){if(d>0&&s[0][d]>a)break;e.WindLookup[l]=Math.floor(d),o=Math.floor(d)}for(n=o<s[0].length-1?o+1:o;t<0;)t+=360;t>=360&&(t%=360),t>180&&(t=360-t);var c=Math.floor(t);if(void 0!==e.AngleLookup&&c in e.AngleLookup)r=e.AngleLookup[c];else for(var u in s){if(u>0&&s[u][0]>t)break;e.AngleLookup[c]=Math.floor(u),r=Math.floor(u)}i=r<s.length-1?r+1:r;var p=GetAvgValue(a,s[0][o],s[0][n],s[r][o],s[r][n]),h=GetAvgValue(a,s[0][o],s[0][n],s[i][o],s[i][n]),f=GetAvgValue(t,s[r][0],s[i][0],p,h);if(isNaN(f))throw"GetAvgValue was NaN";return f}function WindAngle(e,t){return e>=t?e-t<=180?e-t:360-e+t:t-e<=180?t-e:360-t+e}function GetAvgValue(e,t,a,o,n){return e===t||t===a||o===n?o:o+(e-t)/(a-t)*(n-o)}var POS_FORMAT_DEFAULT=0,EARTH_RADIUS=3443.84,VLM_DIST_ORTHO=1;function Deg2Rad(e){return e/180*Math.PI}function Rad2Deg(e){return e/Math.PI*180}Math.fmod=function(e,t){return Number((e-Math.floor(e/t)*t).toPrecision(8))};var PowLut=[];function RoundPow(e,t){if(void 0!==t){PowLut[t]||(PowLut[t]=Math.pow(10,t));var a=PowLut[t];return Math.round(e*a)/a}return e}function NormalizeLongitudeDeg(e){return e<-180?e+=360:e>180&&(e-=360),e}function VLMPosition(e,t,a){void 0!==a&&a!=POS_FORMAT_DEFAULT||(this.Lon=new Coords(e,1),this.Lat=new Coords(t,0)),this.toString=function(e){return this.Lat.toString(e)+" "+this.Lon.toString(e)},this.GetEuclidianDist2=function(e){var t=(this.Lat.Value-e.Lat.Value)%90,a=(this.Lon.Value-e.Lon.Value)%180;return t*t+a*a},this.GetLoxoDist=function(e,t){var a,o=Deg2Rad(this.Lat.Value),n=Deg2Rad(e.Lat.Value),r=-Deg2Rad(this.Lon.Value),i=-Deg2Rad(e.Lon.Value),s=0;return s=Math.abs(n-o)<Math.sqrt(1e-15)?Math.cos(o):(n-o)/Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(o/2+Math.PI/4)),a=Math.sqrt(Math.pow(n-o,2)+s*s*(i-r)*(i-r)),RoundPow(EARTH_RADIUS*a,t)},this.ReachDistLoxo=function(e,t){var a=0,o=0;if(isNaN(t))throw"unsupported reaching NaN distance";"number"==typeof e?(a=Deg2Rad(e/60),o=Deg2Rad(t%360)):(a=this.GetLoxoDist(e)/EARTH_RADIUS*t,o=Deg2Rad(this.GetLoxoCourse(e)));var n=Deg2Rad(this.Lat.Value),r=Deg2Rad(this.Lon.Value),i=0,s=0,l=(n+(i=n+a*Math.cos(o)))/2;if((s=r+a*Math.sin(o)/Math.cos(l))>Math.PI?s-=2*Math.PI:s<-Math.PI&&(s+=2*Math.PI),isNaN(s)||isNaN(i))throw"Reached Nan Position!!!";if(s=Rad2Deg(s),i=Rad2Deg(i),s*this.Lon.Value<0&&Math.abs(this.Lon.Value-s)>90){var d=1;return this.Lon.Value-s<0&&(d=-1),new VLMPosition(s+360*d,i)}return new VLMPosition(s,i)},this.GetLoxoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),r=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var i=(o-a)%(2*Math.PI),s=(a-o)%(2*Math.PI),l=Math.log(Math.tan(r/2+Math.PI/4)/Math.tan(n/2+Math.PI/4));return RoundPow((720-(i<s?Math.atan2(i,l)%(2*Math.PI):Math.atan2(-s,l)%(2*Math.PI))/Math.PI*180)%360,t)},VLM_DIST_ORTHO?(this.GetOrthoDist=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),r=Deg2Rad(e.Lat.Value);return void 0!==t&&"number"==typeof t||(t=17),RoundPow(60*Rad2Deg(Math.acos(Math.sin(n)*Math.sin(r)+Math.cos(n)*Math.cos(r)*Math.cos(a-o))),t)},this.GetOrthoCourse=function(e,t){var a,o,n,r,i=Deg2Rad(this.Lon.Value),s=Deg2Rad(e.Lon.Value),l=Deg2Rad(this.Lat.Value),d=Deg2Rad(e.Lat.Value);if(void 0!==t&&"number"==typeof t||(t=17),o=Math.fmod(s-i,2*Math.PI),Math.abs(o)<1e-7)a=(r=d-l)>0?0:Math.PI;else{o<=-Math.PI?o+=2*Math.PI:o>Math.PI&&(o-=2*Math.PI),n=Math.acos(Math.sin(d)*Math.sin(l)+Math.cos(d)*Math.cos(l)*Math.cos(o)),r=Math.cos(l)*Math.sin(n);var c=(Math.sin(d)-Math.sin(l)*Math.cos(n))/r;c>1?(c=1,console.log("Nan Catch pos")):c<-1&&(c=-1,console.log("Nan Catch neg")),a=o<0?2*Math.PI-Math.acos(c):Math.acos(c)}return RoundPow(a=Rad2Deg(a%(2*Math.PI)),t)}):(this.GetOrthoDist=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),r=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var i=2*Math.asin(Math.sqrt(Math.pow(Math.sin((n-r)/2),2)+Math.pow(Math.cos(n)*Math.cos(r)*Math.sin((a-o)/2),2)));return RoundPow(EARTH_RADIUS*i,t)},this.GetOrthoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),r=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var i=Math.atan2(Math.sin(a-o)*Math.cos(r),Math.cos(n)*Math.sin(r)-Math.sin(n)*Math.cos(r)*Math.cos(a-o));return RoundPow(i=Rad2Deg(i%(2*Math.PI)),t)}),this.ReachDistOrtho=function(t,a){var o,n,r=t/EARTH_RADIUS,i=Deg2Rad(a),s=Deg2Rad(this.Lat.Value),l=Deg2Rad(-this.Lon.Value);return o=Math.asin(Math.sin(s)*Math.cos(r)+Math.cos(s)*Math.sin(r)*Math.cos(i)),n=Math.atan2(Math.sin(i)*Math.sin(r)*Math.cos(s),Math.cos(r)-Math.sin(s)*Math.sin(o)),new VLMPosition(NormalizeLongitudeDeg(Rad2Deg(-(e=(l-n+Math.PI)%(2*Math.PI)-Math.PI))),Rad2Deg(o))},this.GetVLMString=function(){return this.Lat.toString()+","+this.Lon.toString()}}var _IsLoggedIn,Race=function e(t){_classCallCheck(this,e),this.RaceId="number"==typeof t?t:parseInt(t,10),this.LastUpdate=new Date(0),this.ClearData=function(){VLM2Prefs.ClearRaceData(this.RaceId)},this.CheckRaceUpdates=function(e){var t=!0;if(e){var a=e.idraces,o=new Date(1e3*parseInt(e.VER,10)),n=VLM2Prefs.GetRaceFromStorage(a);n.LastUpdate=new Date(n.LastUpdate),n.LastUpdate<o&&VLM2Prefs&&(n.LastUpdate=o,VLM2Prefs.Save(),t=!1)}return t},this.HasSave=function(){return VLM2Prefs.HasRaceStorage(this.RaceId)},this.UpdatedForRaceStart=function(e){return e&&(RetOK=new Date(1e3*e.deptime)==new Date(1e3*e.VER)),!1},this.Subscribe=function(e){$.post("/ws/boatsetup/race_subscribe.php","parms="+JSON.stringify({idu:e,idr:this.RaceId}),function(a){if(a.success){$("#RacesListForm").modal("hide");var o=new RaceNewsHandler("",GetLocalizedString("youengaged"));StatMGR.Stat("RaceSubscribe",t),o.Show(),VLM2Prefs.GetRaceFromStorage(t).LastUpdate=new Date,VLM2Prefs.Save()}else{VLMAlertDanger(a.error.msg+"\n"+a.error.custom_error_string)}SetCurrentBoat(GetBoatFromIdu(e))})}},RaceNewsHandler=function e(t,a){_classCallCheck(this,e),this.Title=t,this.Message=a,this.Show=function(){$("#RaceNewsBox_Title").text(t),$("#NewsBody1").html(a),$("#RaceNewsBox").modal({backdrop:"static",keyboard:!1})}},PlotHorizon=function(){function e(t){_classCallCheck(this,e),this.LabelFormat=[],this.LabelFormat["1Day"]=this.TickFormat_1Day,this.LabelFormat["1Week"]=this.TickFormat_1Week,this.LabelFormat["1Month"]=this.TickFormat_1Month,this.LabelFormat["1Year"]=this.TickFormat_1Year,this.SetHorizon(t)}return _createClass(e,[{key:"MinPlotDate",value:function(){switch(this.Horizon){case"1Week":return moment().add(-7,"d").toDate();case"1Month":return moment().add(-1,"M").toDate();case"1Year":return moment().add(-1,"y").toDate();case"1Day":default:return moment().add(-1,"d").toDate()}}},{key:"SetHorizon",value:function(e){switch(e){case"1Day":case"1Week":case"1Day":case"1Year":this.Horizon=e;break;default:this.Horizon="1Day"}}},{key:"LabelFormatter",value:function(e,t,a){return this.SetHorizon(this.Horizon),this.LabelFormat[this.Horizon](e,t,a)}},{key:"TickFormat_1Day",value:function(e,t,a){return moment(e).format("LT")}},{key:"TickFormat_1Week",value:function(e,t,a){return a[t].major?moment(e).format("D-M LT"):null}},{key:"TickFormat_1Month",value:function(e,t,a){return a[t].major?moment(e).format("D-M"):null}},{key:"TickFormat_1Year",value:function(e,t,a){return a[t].major?moment(e).format("M"):null}}]),e}(),ServerStatsMgrClass=function(){function e(){_classCallCheck(this,e),this.TemplateDom=$("#StatIndicatorTemplate"),$(".StatIndicatorTile").on("click",this.HandleTileClick.bind(this)),this.CurSetID=null,this.TileInfo={Stat_MailQStat:{Threshold:[0,10,25],Colors:["#00FF00","#FFA500","#FF0000"],Unit:"msg",Image:"./images/Stats_Msg.png"},Stat_VolumeSpace:{Threshold:[0,90,95],Colors:["#00FF00","#FFA500","#FF0000"],Unit:"%",Image:"./images/Stats_Disk.png"},Stat_MySQLStats:{Threshold:[0,500,700],Colors:["#00FF00","#FFA500","#FF0000"],Unit:null,Image:"./images/Stats_Connections.png"},Stat_EngineStats:{Threshold:[0,50,90,180],Colors:["#FF0000","#FF0000","#FFA500","#00FF00"],Unit:"Boats/s",Image:"./images/Stats_Speed.png",Default:!0},BoatCount:{Threshold:[0],Colors:["#00FF00"],Unit:null,Default:!0},RaceCount:{Threshold:[0],Colors:["#00FF00"],Unit:null,Default:!0},max_connections:{Threshold:[0],Colors:["#0000FF"],Image:"./images/Stats_Connections.png"},"NTP Offset (ms)":{Threshold:[-10,-5,5,10],Colors:["#0000FF","#00FF00","#00FF00","#0000FF"],Image:"./images/Stats_Speed.png"}},this.PlotHorizon=new PlotHorizon("1Day")}return _createClass(e,[{key:"SetHorizon",value:function(e){this.PlotHorizon.Horizon=e,this.CurSetID&&this.PlotTileData(this.CurSetID)}},{key:"LoadStats",value:function(){$("#StatsPreloader").removeClass("hidden"),this.TimeOutHandle=this.GetStats(0)}},{key:"GetStats",value:function(e){var t=this;return setTimeout(function(){$.get("/ws/serverinfo/ServerStatus.php?v="+Math.round((new Date).getTime()/1e3/60/3),t.HandleStatLoaded.bind(t))},e)}},{key:"HandleStatLoaded",value:function(e){this.Stats=e,this.DataSetTiles=[],this.DisplayCurrentValues(),this.CurSetID||(this.CurSetID="Stt_BoatCount"),this.PlotTileData(this.CurSetID),$("#StatsPreloader").addClass("hidden"),this.TimeOutHandle=this.GetStats(3e4)}},{key:"DisplayCurrentValues",value:function(){for(var e in $("#StatsGen").text("Stats from : "+moment(1e3*this.Stats.Generated).format()),$("#StatsGenDur").text("Gen. in :"+RoundPow(1e3*this.Stats.GenerationTime,1)+" ms"),this.Stats.Data.sort(),this.Stats.Data)if(this.Stats.Data[e]){var t=this.Stats.Data[e],a=null;if(this.TileInfo[t.TypeName]){if(a=this.TileInfo[t.TypeName],!VLM2Prefs.AdvancedStats&&!a.Default)continue}else if(!VLM2Prefs.AdvancedStats)continue;for(var o in t.Data=t.Data.sort(this.TypedRowSorter),t.Data){var n=t.Data[o];if(n.Values=n.Values.sort(this.DataRowSorter),n.Name){var r=n.Name,i=n.Values,s=i[i.length-1].value,l=a;this.TileInfo[r]&&(l=this.TileInfo[r]);var d=this.UpdateStatTile(r,s,l,VLM2Prefs.AdvancedStats||l.Default);this.DataSetTiles[d]=n,this.DataSetTiles[d].TileInfo=l}}}}},{key:"TypedRowSorter",value:function(e,t){return e.Name&&t.Name?e.Name>t.Name?1:e.Name<t.Name?-1:0:e>=t?1:-1}},{key:"DataRowSorter",value:function(e,t){return e.date&&t.date?e.date===t.date?e.value>t.value?1:-1:e.date>t.date?1:-1:e>=t?1:-1}},{key:"UpdateStatTile",value:function(e,t,a,o){var n="Stt_"+e.replace(/[\/\(\ \)]/g,"_"),r=$("#"+n)[0];if(!r&&o){var i=this.TemplateDom.clone().removeClass("hidden")[0];$(i).attr("Id",n),$(i).find("[Fld_Id='title']").text(e),$(i).on("click",this.HandleTileClick.bind(this)),a.Unit&&$(i).find("[Fld_Id='unit']").text(a.Unit),a.Image&&$(i).find("[src]").attr("src",a.Image),$("#CountersList").append(i),r=i}else r&&(o?$(r).find("[src]").removeClass("hidden"):$(r).find("[src]").addClass("hidden"));$(r).find("[Fld_Id='value']").text(RoundPow(t,2));var s="lightgrey";if(a)for(var l=0;t>=a.Threshold[l];)s=a.Colors[l],l++;return $(r).find(".StatusColor").css("background-color",s),n}},{key:"HandleTileClick",value:function(e){var t=e.currentTarget.attributes.Id.value;this.DataSetTiles[t]&&this.PlotTileData(t)}},{key:"CancelStats",value:function(){this.TimeOutHandle&&(clearTimeout(this.TimeOutHandle),this.TimeOutHandle=null)}},{key:"PlotTileData",value:function(e){var t=[],a=this.DataSetTiles[e].Name,o=null,n=null,r=null;for(var i in this.CurSetID=e,this.DataSetTiles[e].Values){var s=this.DataSetTiles[e].Values[i],l=new Date(1e3*s.date);l>=this.PlotHorizon.MinPlotDate()&&(t.push({x:l,y:s.value}),o||(o=l),(!n||n<l)&&(n=l),(!r||r<s.value)&&(r=s.value))}var d=[];if(d.push({label:a,backgroundColor:"AliceBlue",borderColor:"AliceBlue",data:t,pointRadius:1,borderWidth:1,fill:!1,steppedLine:"middle"}),this.DataSetTiles[e].TileInfo){var c=this.DataSetTiles[e].TileInfo,u={};for(var p in c.Threshold)u={label:"Thr. "+c.Threshold[p],borderWidth:2,pointRadius:0,fill:!1,steppedLine:"middle",borderColor:c.Colors[p],data:[{x:o,y:c.Threshold[p]},{x:n,y:c.Threshold[p]}]},d.push(u)}if(!this.Chart){var h=$("#StatsContainer").css("Height");$("#StatsPlotCanvas").css("Height",h);var f=$("#StatsPlotCanvas")[0].getContext("2d");this.Chart=new Chart(f,{type:"line",data:{datasets:d},options:{scales:{yAxes:[{ticks:{tickLength:5},gridLines:{zeroLineColor:"#FFFFFF55",color:"#FFFFFF55"}}],xAxes:[{type:"time",time:{displayFormats:{minute:"LT",hour:"D/LT",day:"D-M",quarter:"MMM YYYY"}},gridLines:{zeroLineColor:"white",color:"#FFFFFF55"},ticks:{minRotation:0,maxRotation:0,autoSkipPadding:5,autoSkip:!0,tickLength:5}}]},legend:{display:!0},title:{display:!0,text:a}}})}this.Chart.config.data.datasets=d,this.Chart.options.title.text=a,this.Chart.update(),StatMGR.Stat("PlotStats",this.PlotHorizon.Horizon,a)}}]),e}(),ServerStatsMgr=new ServerStatsMgrClass,StatsManager=function e(){_classCallCheck(this,e),this.NoStat=!0,this.CheckGConsent=function(){if(VLM2Prefs&&VLM2Prefs.GConsentDate)this.NoStat=!isNaN(VLM2Prefs.GConsentDate);else if(VLM2Prefs){var e=(new Date).getTime(),t=VLM2Prefs.GConsentLastNo;t&&(t=new Date(t)),null===VLM2Prefs.GConsentDate&&(null===VLM2Prefs.GConsentLastNo||t.getTime()+15552e6<e)&&($(".GConsentToggle").on("click",this.HandleGconsentToggle.bind(this)),$("#GConsentModal").modal({backdrop:"static",keyboard:!1}))}},this.HandleGconsentToggle=function(e){var t=e.currentTarget.id;$("#"+t);"GConsentToggleNo"===t?($("#GConsentToggleNo").addClass("btn-danger").removeClass("btn-default"),$("#GConsentToggleYes").removeClass("btn-success").addClass("btn-default"),this.SetConsent(!1)):($("#GConsentToggleNo").removeClass("btn-danger").addClass("btn-default"),$("#GConsentToggleYes").addClass("btn-success").removeClass("btn-default"),this.SetConsent(!0)),$("#GConsentCloseFormBtn").removeClass("ui-state-disabled")},this.SetConsent=function(e){this.NoStat=e,e?(VLM2Prefs.GConsentDate=new Date,VLM2Prefs.GConsentLastNo=null):(VLM2Prefs.GConsentLastNo=new Date,VLM2Prefs.GConsentDate=null),VLM2Prefs.Save()},this.Stat=function(e,t,a,o){!this.NoStat&&"undefined"!=typeof gtag&&gtag&&(void 0!==t&&t||(t=e),"number"==typeof o?gtag("event",e,{event_category:t,event_label:a,value:o}):gtag("event",e,{event_category:t,event_label:a}))}},StatMGR=new StatsManager;function Boat(e){this.IdBoat=function(){return this.VLMInfo?("string"==typeof this.VLMInfo.IDU&&(this.VLMInfo.IDU=parseInt(this.VLMInfo.IDU,10)),this.VLMInfo.IDU):null},this.Engaged=function(){return this.VLMInfo?(void 0===this.VLMInfo.engaged&&this.VLMInfo.RAC&&(this.VLMInfo.engaged=parseInt(this.VLMInfo.RAC,10)),this.VLMInfo.engaged):0},this.BoatName=function(){return this.VLMInfo?(!this.VLMInfo.boatname&&this.VLMInfo.IDB&&(this.VLMInfo.boatname=this.VLMInfo.IDB),this.VLMInfo.boatname):null},this.BoatPseudo=function(){return this.VLMInfo?this.VLMInfo.boatpseudo:null},this.VLMInfo={},this.RaceInfo={},this.Exclusions=[],this.Track=[],this.RnkObject={},this.OppTrack=[],this.OppList=[],this.Reals=[],this.VLMPrefs=[],this.NextServerRequestDate=null,this.Estimator=new Estimator(this),this.EstimatePos=null,void 0!==e&&(this.VLMInfo.IDU=e.idu,this.VLMInfo.boatname=e.boatname,this.VLMInfo.boatpseudo=e.boatpseudo,e.engaged||0===e.engaged?this.VLMInfo.engaged=e.engaged:e.RAC&&(this.VLMInfo.engaged=parseInt(e.RAC,10)),this.RaceInfo=e.RaceInfo,this.Exclusions=e.Exclusions,this.Track=e.Track,this.RnkObject=e.RnkObject,this.Estimator.LoadTrack()),this.GetNextGateSegment=function(e){if("string"==typeof e&&(e=parseInt(e,10)),void 0===this.RaceInfo)return null;NormalizeRaceInfo(this.RaceInfo);var t=this.RaceInfo.races_waypoints[e];do{if("string"==typeof t&&(t=parseInt(t,10)),t.wpformat&WP_ICE_GATE){if(++e>=this.RaceInfo.races_waypoints)throw"Oops could not find requested gate type";t=this.RaceInfo.races_waypoints[e]}}while(t.wpformat&WP_ICE_GATE);var a=new VLMPosition(t.longitude1,t.latitude1),o={};if((t.wpformat&WP_GATE_BUOY_MASK)===WP_TWO_BUOYS||t.longitude2&&t.latitude2)o=new VLMPosition(t.longitude2,t.latitude2);else{var n=Compute2ndBuoyOfGate(t);o=new VLMPosition(n.Lon.Value,n.Lat.Value)}return{P1:a,P2:o}},this.GetClosestEstimatePoint=function(e){if(void 0===e||!e)return this.Estimator&&this.Estimator.ClearEstimatePosition(this.Estimator.Boat),null;if(this.Estimator){var t=this.Estimator.GetClosestEstimatePoint(e);return t?this.Estimator.ShowEstimatePosition(this.Estimator.Boat,t):this.Estimator.ClearEstimatePosition(this.Estimator.Boat),t}return this.Estimator.ShowEstimatePosition(null,null),null},this.GetNextWPPosition=function(e,t,a){if(void 0===this.VLMInfo)return null;this.VLMInfo.NWP;if(!(void 0!==a&&a||"0"===this.VLMInfo.WPLON&&"0"===this.VLMInfo.WPLAT))return new VLMPosition(this.VLMInfo.WPLON,this.VLMInfo.WPLAT);if(void 0!==a&&a&&0!==a.Lon.Value&&0!==a.Lat.Value)return new VLMPosition(a.Lon.Value,a.Lat.Value);var o=this.VLMInfo.NWP;void 0!==e&&e&&(o=e);var n=this.GetNextGateSegment(o);if(void 0===n||!n)return null;var r,i=n.P1.GetLoxoCourse(n.P2);r=void 0!==t&&t?t:new VLMPosition(this.VLMInfo.LON,this.VLMInfo.LAT);var s=i-n.P1.GetOrthoCourse(r);if(s>180?s-=360:s<-180&&(s+=360),(s=Math.abs(s))>90)return n.P1;var l=n.P1.GetLoxoDist(r);try{var d=l*Math.cos(Deg2Rad(s));return n.P1.GetLoxoDist(n.P2)>d?n.P1.ReachDistLoxo(d,i):n.P2}catch(e){return null}}}var User=function e(){_classCallCheck(this,e),this.MaxFleetSize=12,this.IdPlayer=-1,this.IsAdmin=!1,this.PlayerName="",this.PlayerJID="",this.Fleet=[],this.BSFleet=[],this.CurBoat={},this.LastLogin=0,this.KeepAlive=function(){console.log("Keeping login alive..."),CheckLogin()},setInterval(this.KeepAlive,6e5)},_CurPlayer=new User;function IsLoggedIn(){return _IsLoggedIn&&StatMGR.CheckGConsent(),_IsLoggedIn}function OnLoginRequest(){CheckLogin(!0)}function GetPHPSessId(){var e,t=document.cookie.split(";");for(e in t)if(t[e]){var a=t[e].split("=");if(a[0]&&"PHPSESSID"===a[0].trim())return a[0]}return null}function CheckLogin(e){var t=$(".UserName").val(),a=$(".UserPassword").val();GetPHPSessId()||"string"==typeof t&&"string"==typeof a&&t.trim().length>0&&a.trim().length>0?(ShowPb("#PbLoginProgress"),$.post("/ws/login.php",{VLM_AUTH_USER:t.trim(),VLM_AUTH_PW:a.trim()},function(t){var a=JSON.parse(t),o=null;_IsLoggedIn&&(o=_CurPlayer.CurBoatID),_IsLoggedIn=!0===a.success,HandleCheckLoginResponse(e),o&&SetCurrentBoat(GetBoatFromIdu(o),!1)})):HandleCheckLoginResponse(e)}function HandleCheckLoginResponse(e){if(_IsLoggedIn)StatMGR.CheckGConsent(),GetPlayerInfo();else if(e)VLMAlertDanger(GetLocalizedString("authfailed")),$(".UserPassword").val(""),setTimeout(function(){$("#LoginForm").modal("hide").modal("show")},1e3),initrecaptcha(!0,!1),$("#ResetPasswordLink").removeClass("hidden");else if(_CurPlayer.CreateBoatInfo&&WaitLocaleInited(function(){HandleCheckLoginResponse(e)})){var t=new MsgBox,a=GetLocalizedString("email")+" : "+_CurPlayer.CreateBoatInfo.UserName+"<br><br>"+GetLocalizedString("Confirm account creation ?");t.Show(MsgBox.MSGBOX_YESNO,GetLocalizedString("Your account is ready to be created"),a,HandleAccountValidationRequest)}HidePb("#PbLoginProgress"),DisplayLoggedInMenus(_IsLoggedIn)}function Logout(){DisplayLoggedInMenus(!1),$.post("/ws/logout.php",function(e){e.success?window.location.reload():(VLMAlertDanger("Something bad happened while logging out. Restart browser..."),windows.location.reload())}),_IsLoggedIn=!1}function GetPlayerInfo(e){ShowBgLoad(),$.get("/ws/playerinfo/profile.php",function(e){e.success?(void 0!==_CurPlayer&&_CurPlayer||(_CurPlayer=new User),_CurPlayer.IdPlayer=e.profile.idp,_CurPlayer.IsAdmin=e.profile.admin,_CurPlayer.PlayerName=e.profile.playername,$.get("/ws/playerinfo/fleet_private.php",function(e,t){HandleFleetInfoLoaded(e,t)})):Logout()})}function HandleFleetInfoLoaded(e,t){var a=null,o=VLM2Prefs.LastSelBoat;for(var n in void 0===_CurPlayer&&(_CurPlayer=new User),void 0===_CurPlayer.Fleet&&(_CurPlayer.Fleet=[]),_CurPlayer.FleetSize=0,e.fleet)void 0===_CurPlayer.Fleet[n]&&(_CurPlayer.Fleet[n]=new Boat(e.fleet[n]),(t===n||!a||a&&!a.Engaged()&&_CurPlayer.Fleet[n].Engaged())&&(a=_CurPlayer.Fleet[n])),_CurPlayer.FleetSize+=1;for(var r in e.fleet&&e.fleet[o]&&e.fleet[o].engaged&&(a=GetBoatFromIdu(o)),$("#FleetSizeInfo").text(" ("+_CurPlayer.FleetSize+"/"+_CurPlayer.MaxFleetSize+")"),void 0===_CurPlayer.fleet_boatsit&&(_CurPlayer.fleet_boatsit=[]),e.fleet_boatsit)void 0===_CurPlayer.BSFleet[r]&&(_CurPlayer.BSFleet[r]=new Boat(e.fleet_boatsit[r]));RefreshPlayerMenu(),void 0!==a&&a&&(DisplayCurrentDDSelectedBoat(a),SetCurrentBoat(a,!0),RefreshCurrentBoat(!0,!1,null))}function RefreshPlayerMenu(){for(var e in $("#PlayerId").text(_CurPlayer.PlayerName),ClearBoatSelector(),_CurPlayer.Fleet)AddBoatToSelector(_CurPlayer.Fleet[e],!0);for(var t in _CurPlayer.BSFleet)_CurPlayer.BSFleet[t]&&AddBoatToSelector(_CurPlayer.BSFleet[t],!1);UpdateBoatList(),DisplayLoggedInMenus(!0),HideBgLoad("#PbLoginProgress")}function SetupUserMenu(){var e=$(document).width()/2-$(".UserMenu").width()/2+"px";$(".UserMenu").show(),$(".UserMenu").animate({left:e,top:0},0)}function GetBoatFromIdu(e){if(void 0!==_CurPlayer){var t=GetBoatFromBoatArray(_CurPlayer.Fleet,e);return void 0===t&&(t=GetBoatFromBoatArray(_CurPlayer.BSFleet,e)),t}}function GetBoatFromBoatArray(e,t){for(var a in t=parseInt(t,10),e)if(e[a]&&e[a].IdBoat()===t)return e[a]}function GetFlagsList(){$.get("/ws/serverinfo/flags.php",function(e){if(e.success){var t=$("#CountryDropDownList"),a=0;for(var o in e.flags)if(e.flags[o]){var n=e.flags[o];t.append("<li class='FlagLine DDLine' flag='"+n+"'>"+GetCountryDropDownSelectorHTML(n,!0,a++)+"</li>")}}$(".FlagLine").on("click",HandleFlagLineClick)})}var FlagsIndexCache=[];function GetCountryDropDownSelectorHTML(e,t,a){if(t){var o=GetCountryFlagImg(e,a);FlagsIndexCache[e]=o}var n=" <span  class='FlagLabel' flag='"+e+"'> - "+e+"</span>";return FlagsIndexCache[e]+n}function GetCountryFlagImgHTML(e){return FlagsIndexCache[e]}function GetCountryFlagImg(e,t){return" <div class='FlagIcon' style='background-position: -"+t%16*30+"px -"+20*Math.floor(t/16)+"px' flag='"+e+"'></div>"}function HandleAccountValidationRequest(){var e={emailid:_CurPlayer.CreateBoatInfo.UserName,seed:_CurPlayer.CreateBoatInfo.Seed};$.post("/ws/playersetup/Player_Create.php",e,HandleAccountValidationReply)}function HandleAccountValidationReply(e){setTimeout(function(){var t=new MsgBox;e.success?t.Show(MsgBox.MSGBOX_OKONLY,GetLocalizedString("Your account has been created"),GetLocalizedString("Please connect to create your first boat")):t.Show(MsgBox.MSGBOX_OKONLY,GetLocalizedString("ValidateFailed"),GetLocalizedString(e.error.msg))},250)}function GetRandom(e,t){for(var a=20,o=0;a;)o+=Math.random(),a--;return Math.floor(o*(t-e)/20)+e}function TestRandom(){for(var e=[],t=0;t<1e6;t++){var a=GetRandom(1,60);if(void 0===e[a]&&(e[a]=0),e[a]++,t%1e5==0)for(var o=0;o<e.length;o++)e[o]?console.log(o+" : "+"".padStart(Math.floor(3*Math.log(e[o]))),"*"):console.log(o+" : ")}for(var n=0;n<e.length;n++)console.log(n+" : "+"".padStart(Math.floor(3*Math.log(e[n]))),"*")}function GetRandomShipName(){for(var e=0;!e;)e=GetRandom(0,3);for(var t=null,a=0;a<e;a++){for(var o=GetRandom(1,6),n="",r=0;r<o;r++)n+=GetSyllab();t?t+=" "+n:t=n}return t}function GetSyllab(){var e=GetLetter()+GetLetter(!0);return Math.random()>.9&&(e+=GetLetter()),e}function GetLetter(e){return e?"aeiouy"[Math.floor(Math.random()*"aeiouy".length)]:"bcdfghjklmnpqrstvwxz"[Math.floor(Math.random()*"bcdfghjklmnpqrstvwxz".length)]}var VLM_COORDS_FACTOR=1e3,OppPopups=[],StartSetWPOnClick=!1;function SetCurrentBoat(e,t,a,o){_CurPlayer&&_CurPlayer.CurBoat&&e&&(void 0!==_CurPlayer.CurBoat.IdBoat&&_CurPlayer.CurBoat.IdBoat()!==e.IdBoat()&&ClearCurrentMapMarkers(_CurPlayer.CurBoat),EnsureMarkersVisible(e)),CheckBoatRefreshRequired(e,t,a,o)}function CheckBoatRefreshRequired(e,t,a,o){if(void 0!==e&&e){new Date;var n=void 0!==e&&(void 0===e.VLMInfo||void 0===e.VLMInfo.AVG);UpdatePrefsDialog(e),void 0!==e.VLMInfo&&void 0!==e.VLMInfo.LUP||!0,console.log("Loading boat info from server...."),ShowPb("#PbGetBoatProgress"),$.get("/ws/boatinfo.php?forcefmt=json&select_idu="+e.IdBoat(),function(a){if(e.IdBoat()===parseInt(a.IDU,10)){_CurPlayer.CurBoat=e,LoadVLMPrefs(),VLM2Prefs.LastSelBoat=e.IdBoat(),VLM2Prefs.Save(!0),e.VLMInfo=a,e.NextServerRequestDate=new Date(1e3*(parseInt(e.VLMInfo.LUP,10)+parseInt(e.VLMInfo.VAC,10))),e.LastRefresh=new Date,e.VLMInfo.LON/=VLM_COORDS_FACTOR,e.VLMInfo.LAT/=VLM_COORDS_FACTOR,console.log("DBG WIND ");var r=GribMgr.WindAtPointInTime(new Date(1587912906e3),40.416194,29.100806);if(r){var i=r.Heading+40,s=PolarsManager.GetBoatSpeed("boat_figaro2",r.Speed,r.Heading,i);if(!isNaN(s))new VLMPosition(40.416194,29.100806).ReachDistLoxo(s/3600*300,i)}n&&UpdatePrefsDialog(e),UpdateBoatList(e),"0"!==e.VLMInfo.RAC?(void 0!==e.RaceInfo&&void 0!==e.RaceInfo.idraces||(GetRaceInfoFromServer(e,o),GetRaceExclusionsFromServer(e)),GetTrackFromServer(e),e.VLMInfo&&e.VLMInfo.RAC&&LoadRankings(e.VLMInfo.RAC),LoadRealsList(e),DrawBoat(e,t),UpdateInMenuRacingBoatInfo(e,o)):(NotifyEndOfRace(e.IdBoat()),UpdateInMenuDockingBoatInfo(e),$(".NWPBadge").css("visibility","hidden"))}HidePb("#PbGetBoatProgress"),OnPlayerLoadedCallBack&&(OnPlayerLoadedCallBack(),OnPlayerLoadedCallBack=null)})}}function NotifyEndOfRace(e){$.get("/ws/boatinfo/palmares.php?idu="+e,function(e){var t;if(e.success)for(t in e.palmares)if(e.palmares[t]){var a=e.palmares[t],o=new Race(a.idrace);if(o.HasSave()){var n=GetLocalizedString("EndOfRaceMessage",[a.racename,a.ranking.rank,a.ranking.racercount]);new RaceNewsHandler(GetLocalizedString("EndOfRaceTitle"),n).Show(),o.ClearData(),StatMGR.Stat("EndOfRaceMessage",a.raceid)}break}})}function GetTrackFromServer(e){var t=Math.floor(new Date/1e3),a=t-172800;$.get("/ws/boatinfo/tracks_private.php?idu="+e.IdBoat()+"&idr="+e.VLMInfo.RAC+"&starttime="+a+"&endtime="+t,function(t){if(t.success){for(var a in void 0!==e.Track?e.Track.length=0:e.Track=[],t.tracks)if(t.tracks[a]){var o=new VLMPosition(t.tracks[a][1]/1e3,t.tracks[a][2]/1e3);e.Track.push(o)}DrawBoat(e)}})}function GetRaceExclusionsFromServer(e){$.get("/ws/raceinfo/exclusions.php?idrace="+e.VLMInfo.RAC+"&v="+e.VLMInfo.VER,function(t){if(t.success){var a,o,n=[],r=[];for(o in t.Exclusions)if(t.Exclusions[o]){var i=t.Exclusions[o];(void 0===a||a[0]!==i[0][0]&&a[1]!==i[0][1])&&(void 0!==a&&(n.push(r),r=[]),r.push(i[0])),a=i[1],r.push(i[1])}n.push(r),e.Exclusions=n,DrawRaceExclusionZones(e,n)}})}function GetRaceInfoFromServer(e,t){$.get("/ws/raceinfo/desc.php?idrace="+e.VLMInfo.RAC+"&v="+e.VLMInfo.VER,function(a){e.RaceInfo=a;var o=new Race(e.VLMInfo.RAC);if(!o.CheckRaceUpdates(e.RaceInfo))if(o.UpdatedRaceForStart){var n=GetLocalizedString("RaceStartedNotice"),r="<H2>"+GetLocalizedString("racestarted",[e.VLMInfo.racename,e.VLMInfo.deptime])+"</H2>";new RaceNewsHandler(n,r).Show()}else{var i=GetLocalizedString("RaceChangeNotice"),s="<H2>"+e.RaceInfo.UpdateReason+"</H2>"+GetLocalizedString("RaceChangeNoticeText");new RaceNewsHandler(i,s).Show()}DrawRaceGates(e),FillRaceInstructions(e.RaceInfo),UpdateInMenuRacingBoatInfo(e,t)})}var DrawBoatTimeOutHandle=null,DeferredCenterValue=!1;function DrawBoat(e,t){void 0!==t&&(DeferredCenterValue=DeferredCenterValue||t),console.log("Call DrawbBoat ("+t+") deferred : "+DeferredCenterValue),DrawBoatTimeOutHandle&&(console.log("Pushed DrawBoat"),clearTimeout(DrawBoatTimeOutHandle)),DrawBoatTimeOutHandle=setTimeout(ActualDrawBoat,100,e,DeferredCenterValue)}function GetRaceMapFeatures(e){if(!e)throw"Should not GetRaceFeature unless a boat is defined";return void 0===e.RaceMapFeatures&&(e.RaceMapFeatures={}),e.RaceMapFeatures}function ActualDrawBoat(e,t){map.zoom;if(DeferredCenterValue=!1,DrawBoatTimeOutHandle=null,void 0===e||!e){if(void 0===_CurPlayer||!_CurPlayer||void 0===_CurPlayer.CurBoat||!_CurPlayer.CurBoat)return;e=_CurPlayer.CurBoat}if(void 0!==e&&e){var a=GetRaceMapFeatures(e),o=a.TrackWP,n=null;if(void 0!==e&&e&&(n=e.GetNextWPPosition()),void 0!==n&&n&&!isNaN(n.Lat.Value)&&!isNaN(n.Lon.Value))if(o)o.setLatLng([n.Lat.Value,n.Lon.Value]);else{var r=GetTrackWPMarker();a.TrackWP=L.marker([n.Lat.Value,n.Lon.Value],{icon:r,draggable:!0}).addTo(map).on("dragend",HandleWPDragEnded)}if(void 0!==_typeof(e.VLMInfo)&&e.VLMInfo&&(e.VLMInfo.LON||e.VLMInfo.LAT)){var i=a.BoatMarker;i?(i.setLatLng([e.VLMInfo.LAT,e.VLMInfo.LON]),i.setRotationAngle(e.VLMInfo.HDG)):(i=GetBoatMarker(e.IdBoat()),a.BoatMarker=L.marker([e.VLMInfo.LAT,e.VLMInfo.LON],{icon:i,rotationAngle:e.VLMInfo.HDG}).addTo(map).on("click",HandleOpponentClick)),void 0!==map&&map&&DrawBoatPolar(e,t,a)}void 0!==e.Track&&e.Track.length>0&&DrawBoatTrack(e,a),DrawBoatEstimateTrack(e,a),DrawOpponents(e),t&&void 0!==e.VLMInfo&&e.VLMInfo&&void 0!==map&&map&&map.setView([e.VLMInfo.LAT,e.VLMInfo.LON],VLM2Prefs.GetLastZoom(e.IdBoat())),RepositionCompass(e),console.log("ActualDrawBoatComplete")}}function GetNextPilOrderDate(e){if(Boat&&Boat.VLMInfo&&Boat.VLM.PIL)for(var t in NextPilOrder=null,Boat.VLM.PIL)if(Boat.VLM.PIL[t]&&"pending"===Boat.VLM.PIL[t].STS&&t>e)return t;return-1}function GetPilototoMarkerText(e){var t=moment("/date("+1e3*e.TTS+")/"),a="Date : "+GetLocalUTCTime(t,!0,!0)+"<BR>"+t.fromNow();switch(parseInt(e.PIM,10)){case PM_ANGLE:a+="<BR>"+GetLocalizedString("constantengaged")+" : "+e.PIP+"°";break;case PM_HEADING:a+="<BR>"+GetLocalizedString("heading")+" : "+e.PIP+"°";break;case PM_ORTHO:a+="<BR>"+GetLocalizedString("OrthoToWP")+" : "+e.PIP;break;case PM_VMG:a+="<BR>"+GetLocalizedString("bestvmgengaged")+" : "+e.PIP;break;case PM_VBVMG:a+="<BR>"+GetLocalizedString("vbvmgengaged")+" : "+e.PIP;break;default:a+="<BR> Strange PIM"+e.PIM+" : "+e.PIP}return a}function DrawBoatEstimateTrack(e,t){if(void 0!==e.Estimator&&e.Estimator){var a=e.Estimator.GetEstimateTracks(),o=["green","yellow","white"];for(var n in a)if(t.EstimateTracks&&t.EstimateTracks[n])void 0!==a[n]?t.EstimateTracks[n].setLatLngs(a[n]):(t.EstimateTracks[n].remove(),t.EstimateTracks[n]=null);else if(void 0===t.EstimateTracks&&(t.EstimateTracks=[]),a[n]){var r={weight:2,opacity:1,color:o[n]};t.EstimateTracks[n]=L.polyline(a[n],r).addTo(map)}var i=e.Estimator.GetPilotPoints();for(var s in void 0===t.PilotMarkers&&(t.PilotMarkers=[]),i)if(i[s]){var l=i[s],d=[l.Pos.Lat.Value,l.Pos.Lon.Value],c=!1;if(t.PilotMarkers[s]&&!t.PilotMarkers[s]._map)t.PilotMarkers[s].setLatLng(d),c=!0;else if(!t.PilotMarkers[s]){var u=GetPilototoMarker(l,s);t.PilotMarkers[s]=L.marker(d,{icon:u}).on("popupopen",HandlePilototoPopup),c=!0}if(c){var p=GetPilototoMarkerText(l);t.PilotMarkers[s].addTo(map).bindPopup(p)}}}}function HandlePilototoPopup(e){var t=e.popup._source.options.icon;if(!t.Opening){t.Opening=!0;var a=GetPilototoMarkerText(t.Order);e.sourceTarget.unbindPopup().bindPopup(a).closePopup().openPopup(),t.Opening=null}}function RepositionCompass(e){if(e){var t=GetRaceMapFeatures(e);map.Compass&&(t.Compass&&-1==t.Compass.Lat&&-1==t.Compass.Lon||!t.Compass&&e.VLMInfo&&(e.VLMInfo.LAT||e.VLMInfo.LON)?map.Compass.setLatLng([e.VLMInfo.LAT,e.VLMInfo.LON]):!t.Compass||isNaN(t.Compass.Lat)||isNaN(t.Compass.Lon)||map.Compass.setLatLng([t.Compass.Lat,t.Compass.Lon]))}}function DrawBoatTrack(e,t){var a=GetSafeTrackPointList(e.Track),o=e.VLMInfo.COL;o=SafeHTMLColor(o);var n=t.BoatTrack;n?n.setLatLngs(a).setStyle({color:o}):t.BoatTrack=L.polyline(a,{type:"HistoryTrack",color:o,weight:1.2}).addTo(map)}function GetSafeTrackPointList(e){for(var t=[],a=0,o=0,n=e.length-1;n>=0;n--){var r=e[n];a*r.Lon.Value<0&&Math.abs(r.Lon.Value-a)>90&&(a<0?o-=360:o+=360),t.unshift([r.Lat.Value,r.Lon.Value+o]),a=r.Lon.Value}return t}function DrawBoatPolar(e,t,a){var o,n=new VLMPosition(e.VLMInfo.LON,e.VLMInfo.LAT);o=BuildPolarLine(e,n,VLM2Prefs.MapPrefs.PolarVacCount,new Date(1e3*e.VLMInfo.LUP),function(){DrawBoatPolar(e,t,a)}),a.Polar=DefinePolarMarker(o,a.Polar)}function DefinePolarMarker(e,t){if(e)if(t)t.setLatLngs(e).addTo(map);else{(t=L.polyline(e,{color:"blue",opacity:1,weight:1})).addTo(map)}else t&&t.remove(),t=null;return t}function BuildPolarLine(e,t,a,o,n){var r=o,i=null;e&&e.VLMInfo&&e.VLMInfo.VAC&&(r-=1e3*e.VLMInfo.VAC),(!r||r<(new Date).getTime())&&(r=(new Date).getTime());var s=null;if(t&&t.Lat&&t.Lon&&(s=GribMgr.WindAtPointInTime(r,t.Lat.Value,t.Lon.Value,n)),s&&e.VLMInfo.POL&&e.VLMInfo.VAC){parseFloat(e.VLMInfo.HDG);var l,d=[];for(l=0;l<=180;l+=5){var c=PolarsManager.GetBoatSpeed(e.VLMInfo.POL,s.Speed,s.Heading,s.Heading+l);if(isNaN(c))return;for(var u=-1;u<=1;u+=2){var p=t.ReachDistLoxo(c/3600*e.VLMInfo.VAC*a,s.Heading+l*u),h=[p.Lat.Value,p.Lon.Value];d[u*l+180]=h}}for(var f in i=[],d)d[f]&&i.push(d[f])}return i}function GetVLMPositionFromClick(e){if(map){var t=map.getLonLatFromPixel(e).transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));return new VLMPosition(t.lon,t.lat)}return null}function CompleteWPSetPosition(e){var t=null;if(e.getLatLng)t=e.getLatLng();else{if(!e.latlng)return void VLMAlertDanger("Unexpected Object when setting WP report to devs.");t=e.latlng}var a=new VLMPosition(t.lng,t.lat);SendVLMBoatWPPos(_CurPlayer.CurBoat,a)}var WP_TWO_BUOYS=0,WP_ONE_BUOY=1,WP_GATE_BUOY_MASK=15,WP_DEFAULT=0,WP_ICE_GATE_N=16,WP_ICE_GATE_S=32,WP_ICE_GATE_E=64,WP_ICE_GATE_W=128,WP_ICE_GATE=WP_ICE_GATE_E|WP_ICE_GATE_N|WP_ICE_GATE_S|WP_ICE_GATE_W,WP_GATE_KIND_MASK=65520,WP_CROSS_CLOCKWISE=256,WP_CROSS_ANTI_CLOCKWISE=512,WP_CROSS_ONCE=1024,Exclusions=[],RaceGateSorter=function(){function e(t){_classCallCheck(this,e),this.NextWP=t}return _createClass(e,[{key:"RaceGatesSorter",value:function(e,t){if("object"===_typeof(e)&&"object"===_typeof(t)){if(e.wporder>=this.NextWP&&t.wporder>=this.NextWP||e.wporder<this.NextWP&&t.wporder<this.NextWP){var a=1;return e.wporder>=this.NextWP&&(a=-1),e.wporder>t.wporder?a:e.wporder==t.wporder?0:a}return e.wporder<this.NextWP?1:0}return"object"===_typeof(e)?1:-1}}]),e}();function DrawRaceGates(e){if(void 0!==e&&e&&e.RaceInfo){var t=e.RaceInfo,a=e.VLMInfo.NWP,o=GetRaceMapFeatures(e);if(void 0!==_typeof(t)&&t&&void 0!==t.races_waypoints&&t.races_waypoints){var n=[];if(!Array.isArray(t.races_waypoints)){for(var r in t.races_waypoints){var i=jQuery.extend({},t.races_waypoints[r]);n.push(i)}(t={}).races_waypoints=n;var s=new RaceGateSorter(a);t.races_waypoints.sort(s.RaceGatesSorter.bind(s))}for(var l in t.races_waypoints){o.Gates||(o.Gates=[]),o.Gates[l]||(o.Gates[l]={});var d=o.Gates[l];NormalizeRaceInfo(t);var c=parseInt(l,10);MakeSingleGateMapFeatures(map,t.races_waypoints[c],c,d,a)}}}}function MakeSingleGateMapFeatures(e,t,a,o,n){var r,i,s=o.Buoy1,l=!(t.wpformat&WP_CROSS_ANTI_CLOCKWISE),d=new VLMPosition(t.longitude1,t.latitude1);if(o.Buoy1=AddBuoyMarker(e,s,"WP"+t.wporder+" "+t.libelle+"<BR>"+d.toString(),t.longitude1,t.latitude1,l),(t.wpformat&WP_GATE_BUOY_MASK)===WP_TWO_BUOYS){var c=o.Buoy2,u=new VLMPosition(t.longitude2,t.latitude2);o.Buoy2=AddBuoyMarker(e,c,"WP"+t.wporder+" "+t.libelle+"<BR>"+u.toString(),t.longitude2,t.latitude2,!l),r=t.longitude2,i=t.latitude2}else{var p=Compute2ndBuoyOfGate(t);r=p.Lon.Value,i=p.Lat.Value}a=parseInt(a,10),n=parseInt(n,10),AddGateSegment(e,o,t.longitude1,t.latitude1,r,i,n==t.wporder,t.wporder<n,t.wpformat&WP_GATE_KIND_MASK)}function Compute2ndBuoyOfGate(e){for(var t=new VLMPosition(e.longitude1,e.latitude1),a=!1,o=2500,n=null;!a;)try{n=t.ReachDistLoxo(o,180+parseFloat(e.laisser_au)),Math.abs(n.Lat.Value)>85?o*=.95:a=!0}catch(e){o*=.7}return n}function DrawRaceExclusionZones(e,t){if(e){var a=GetRaceMapFeatures(e);for(var o in t)t[o]&&DrawRaceExclusionZone(a,t,o)}}function DrawRaceExclusionZone(e,t,a){var o=[],n=!1;for(var r in t[a])if(t[a][r]){var i=[t[a][r][0],t[a][r][1]];o.push(i),n=!0}n?(void 0===e.Exclusions&&(e.Exclusions=[]),e.Exclusions[a]?e.Exclusions[a].setLatLngs(o).addTo(map):e.Exclusions[a]=L.polygon(o,{color:"red",opacity:.25,weight:3}).addTo(map)):e.Exclusions&&e.Exclusions[index]&&(e.Exclusions[a].remove(),e.Exclusions[a]=null)}function GetLonOffset(e,t){return e*t>=0?0:Math.abs(t-e)>90?e>0?360:-360:0}function AddGateSegment(e,t,a,o,n,r,i,s,l){var d=[[o,a],[r,n]],c="",u=.75;if(c=i?"green":s?"blue":"red",s?u=.2:i||(u=.4),l&WP_CROSS_ONCE&&(t.Segment2?t.Segment2.setLatLngs(d):t.Segment2=L.polyline(d,{color:"black",dashArray:"20,10,5,10",weight:2,opacity:u}).addTo(e)),t.Segment?(t.Segment.setLatLngs(d),t.Segment.color=c):t.Segment=L.polyline(d,{color:c,weight:1,opacity:u}).addTo(e),l!==WP_DEFAULT){var p=new VLMPosition(a,o),h=new VLMPosition(n,r),f=p.GetLoxoCourse(h),P=p.ReachDistLoxo(h,.5);l&WP_CROSS_ANTI_CLOCKWISE?(f-=90,AddGateDirMarker(e,t,P.Lon.Value,P.Lat.Value,f,u)):l&WP_CROSS_CLOCKWISE?(f+=90,AddGateDirMarker(e,t,P.Lon.Value,P.Lat.Value,f,u)):l&WP_ICE_GATE&&AddGateIceGateMarker(e,t,P.Lon.Value,P.Lat.Value)}}var MAX_BUOY_INDEX=16,BuoyIndex=Math.floor(Math.random()*MAX_BUOY_INDEX);function AddGateDirMarker(e,t,a,o,n,r){AddGateCenterMarker(e,t,a,o,"BuoyDirs/BuoyDir4.png",n,!1,r),BuoyIndex++,BuoyIndex%=MAX_BUOY_INDEX+1}function AddGateIceGateMarker(e,t,a,o){AddGateCenterMarker(e,t,a,o,"icegate.png",!0)}function AddGateCenterMarker(e,t,a,o,n,r,i,s){var l=[o,a];if(t.GateMarker)t.GateMarker.setLatLng(l);else{var d=GetGateTypeMarker(n,i);t.GateMarker=L.marker(l,{icon:d}).addTo(e),i||(t.GateMarker.setRotationAngle(r),t.GateMarker.setOpacity(s))}}function AddBuoyMarker(e,t,a,o,n,r){var i=GetBuoyMarker(r);if(t){if(t.IsCWBuoy===r)return t.setLatLng([n,o]);t.remove()}return L.marker([n,o],{icon:i}).addTo(e).bindPopup(a)}var PM_HEADING=1,PM_ANGLE=2,PM_ORTHO=3,PM_VMG=4,PM_VBVMG=5;function SendVLMBoatWPPos(e,t){var a={idu:e.IdBoat(),pip:{targetlat:t.Lat.Value,targetlong:t.Lon.Value,targetandhdg:-1}};PostBoatSetupOrder(e.IdBoat(),"target_set",a)}function SendVLMBoatOrder(e,t,a,o){var n={};if(void 0!==_CurPlayer&&void 0!==_CurPlayer.CurBoat){switch(e){case PM_HEADING:case PM_ANGLE:n={idu:_CurPlayer.CurBoat.IdBoat(),pim:e,pip:t};break;case PM_ORTHO:case PM_VBVMG:case PM_VMG:n={idu:_CurPlayer.CurBoat.IdBoat(),pim:e,pip:{targetlong:parseFloat(t),targetlat:parseFloat(a),targetandhdg:o}};break;default:return}PostBoatSetupOrder(_CurPlayer.CurBoat.IdBoat(),"pilot_set",n)}else VLMAlertDanger("Must select a boat to send an order")}function PostBoatSetupOrder(e,t,a){$.post("/ws/boatsetup/"+t+".php?selectidu="+e,"parms="+JSON.stringify(a),function(e,t){e.success?RefreshCurrentBoat(!1,!0):VLMAlertDanger(GetLocalizedString("BoatSetupError")+"\n"+e.error.code+" "+e.error.msg)})}function EngageBoatInRace(e,t){new Race(e).Subscribe(t)}function DiconstinueRace(e,t){$.post("/ws/boatsetup/race_unsubscribe.php","parms="+JSON.stringify({idu:e,idr:parseInt(t,10)}),function(e){e.success?VLMAlertSuccess("Bye Bye!"):VLMAlertDanger(e.error.msg+"\n"+e.error.custom_error_string)})}function LoadRealsList(e){void 0!==e&&e&&void 0!==e.VLMInfo&&$.get("/ws/realinfo/realranking.php?idr="+e.VLMInfo.RAC,function(t){t.success?(e.Reals=t,DrawBoat(e,!1)):e.Reals=[]})}function LoadRankings(e,t){e&&"object"===_typeof(e)&&VLMAlertDanger("Not updated call to LoadRankings"),$.get("/cache/rankings/rnk_"+e+".json",function(a){a?(Rankings[e]=a.Boats,ResetRankingWPList(),t&&t(e)):Rankings[e]=null})}function contains(e,t){for(var a=0;a<e.length;a++)if(e[a]===t)return!0;return!1}function DrawOpponents(e){if(e&&void 0!==Rankings){var t,a=VLM2Prefs.MapPrefs.MapOppShow===VLM2Prefs.MapPrefs.MapOppShowOptions.ShowSel,o=GetRaceMapFeatures(e);if(VLM2Prefs.MapPrefs.ShowReals&&void 0!==e.Reals&&void 0!==e.Reals.ranking)for(t in e.Reals.ranking){AddOpponent(e,o,e.Reals.ranking[t],!0)}var n=150,r=Rankings;switch(void 0!==e.OppList&&e.OppList.length>0&&(r=e.OppList),VLM2Prefs.MapPrefs.MapOppShow){case VLM2Prefs.MapPrefs.MapOppShowOptions.Show10Around:r=GetClosestOpps(e,10);break;case VLM2Prefs.MapPrefs.MapOppShowOptions.Show5Around:r=GetClosestOpps(e,5);break;case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowTopN:case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowSel:var i=0,s=e.Engaged();for(t in n=VLM2Prefs.MapPrefs.ShowTopCount,r=[],Rankings[s])if(Rankings[s][t].rank<=VLM2Prefs.MapPrefs.ShowTopCount&&(r[t]=Rankings[s][t],++i>n))break;i>n&&(n=i);break;case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowMineOnly:r=[]}if(SortRankingData(e,"RAC",null,e.Engaged()),e.Engaged()&&void 0!==Rankings[e.Engaged()]&&void 0!==Rankings[e.Engaged()].RacerRanking&&Rankings[e.Engaged()].RacerRanking){var l=0;for(t in Rankings[e.Engaged()].RacerRanking)if(t in Rankings[e.Engaged()].RacerRanking){var d=Rankings[e.Engaged()].RacerRanking[t];if(RnkIsRacing(d)){var c=OppIsFriend(e,d.idusers);r[d.idusers]&&l<n&&(!a||c)?(AddOpponent(e,o,d,c),l+=1,void 0===e.OppList&&(e.OppList=[]),e.OppList[t]=d):(HideOpponent(e,o,d,OppIsFriend(e,d.idusers)),e.OppList[t]=null)}}}if(void 0!==e.RaceMapFeatures&&Object.keys(e.OppTrack).length>0){var u=e.RaceMapFeatures;for(var p in e.OppTrack){var h=e.OppTrack[p];if(h&&h.Visible&&h.DatePos.length>1){if(!h.OppTrackPoints){for(var f=[],P=Object.keys(h.DatePos).length,g=0;g<P;g++){var M=Object.keys(h.DatePos)[g],m=h.DatePos[M],C=new VLMPosition(m.lon,m.lat);f.push(C)}h.OppTrackPoints=GetSafeTrackPointList(f)}if(void 0===u.OppTrack&&(u.OppTrack=[]),u.OppTrack[p])u.OppTrack[p].setLatLngs(h.OppTrackPoints).addTo(map);else{var v="black";void 0!==h.TrackColor&&(v=h.TrackColor);var S={color:v,weight:1,opacity:.75};u.OppTrack[p]=L.polyline(h.OppTrackPoints,S).addTo(map)}h.LastShow=new Date}else e.RaceMapFeatures.OppTrack&&e.RaceMapFeatures.OppTrack[p]&&e.RaceMapFeatures.OppTrack[p].remove()}}}}function CompareDist(e,t){return e.dnm<t.dnm?-1:e.dnm>t.dnm?1:0}function GetClosestOpps(e,t){var a=null;e&&e.VLMInfo&&(a=e.VLMInfo.RAC);var o=[];if(a&&Rankings[a]){var n=Rankings[a][e.IdBoat];void 0!==n&&e||(n={dnm:0,nwp:1});parseFloat(n.dnm);var r=new VLMPosition(n.longitude,n.latitude),i=[];for(var s in Rankings[a])if(Rankings[a][s]){var l={id:s,dnm:r.GetOrthoDist(new VLMPosition(Rankings[a][s].longitude,Rankings[a][s].latitude))};i.push(l)}for(var d in i=i.sort(CompareDist).slice(0,t+1))o[i[d].id]=Rankings[a][i[d].id]}return o}var OPP_FRIEND_SIZE=12,OPP_SIZE=8;function HideOpponent(e,t,a,o){AddOpponent(e,t,a,o,!0),e.OppTrack&&e.OppTrack[a.idusers]&&(e.OppTrack[a.idusers].Visible=!1)}function AddOpponent(e,t,a,o){var n=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=[a.latitude,a.longitude],i={name:a.idusers,Coords:new VLMPosition(a.longitude,a.latitude).toString(),type:"opponent",idboat:a.idusers,rank:a.rank,Last1h:a.last1h,Last3h:a.last3h,Last24h:a.last24h,IsTeam:a.country==e.VLMInfo.CNT?"team":"",IsFriend:o?OPP_FRIEND_SIZE:OPP_SIZE,color:a.color};if(VLM2Prefs.MapPrefs.ShowOppNumbers||(i.name=""),void 0===t.Opponents&&(t.Opponents=[]),t.Opponents[a.idusers])t.Opponents[a.idusers].setLatLng(r),n?t.Opponents[a.idusers].remove():(t.Opponents[a.idusers].setLatLng(r),t.Opponents[a.idusers]._map||t.Opponents[a.idusers].addTo(map));else if(!n){var s=GetOpponentMarker(i);t.Opponents[a.idusers]=L.marker(r,{icon:s}).addTo(map),t.Opponents[a.idusers].on("click",HandleOpponentClick),t.Opponents[a.idusers].on("mouseover",HandleOpponentOver),t.Opponents[a.idusers].on("mouseout",HandleOpponentMouseOut),t.Opponents[a.idusers].IdUsers=a.idusers}}function ShowOpponentPopupInfo(e){var t=e.sourceTarget;if(t&&t.options&&t.options.icon&&void 0!==t.options.icon.MarkerOppId){var a=GetOppBoat(t.options.icon.MarkerOppId);if(a){var o=new VLMPosition(a.longitude,a.latitude),n=GetRaceMapFeatures(_CurPlayer.CurBoat);if(n){var r=BuildBoatPopupInfo(a);n.OppPopup||(n.OppPopup=L.popup(r)),n.OppPopup.PrevOpp&&n.OppPopup.PrevOpp.unbindPopup(),t.bindPopup(n.OppPopup),n.OppPopup.setContent(r),n.OppPopup.PrevOpp=t;var i=[],s=parseInt(t.options.icon.MarkerOppId,10);t.openPopup(),i.push([FIELD_MAPPING_TEXT,"#__BoatName"+s,s>0?a.PlayerName:a.boatname]),i.push([FIELD_MAPPING_POPUP,"#__BoatName"+s,a.boatname]),i.push([FIELD_MAPPING_TEXT,"#__BoatId"+s,a.idusers]),i.push([FIELD_MAPPING_TEXT,"#__BoatRank"+s,a.rank]),i.push([FIELD_MAPPING_TEXT,"#__BoatLoch"+s,RoundPow(parseFloat(a.loch),2)]),i.push([FIELD_MAPPING_TEXT,"#__BoatNWP"+s,"["+a.nwp+"] "+RoundPow(parseFloat(a.dnm),2)]),i.push([FIELD_MAPPING_TEXT,"#__BoatPosition"+s,o.GetVLMString()]),i.push([FIELD_MAPPING_TEXT,"#__Boat1HAvg"+s,RoundPow(parseFloat(a.last1h),2)]),i.push([FIELD_MAPPING_TEXT,"#__Boat3HAvg"+s,RoundPow(parseFloat(a.last3h),2)]),i.push([FIELD_MAPPING_TEXT,"#__Boat24HAvg"+s,RoundPow(parseFloat(a.last24h),2)]),i.push([FIELD_MAPPING_STYLE,"#__BoatColor"+s,"background-color",SafeHTMLColor(a.color)]),FillFieldsFromMappingTable(i),UpdatePictoFriendStatus(s),$("#PictoSetFriend").on("click",function(e){HandleSetFriend(e,_CurPlayer.CurBoat)})}}}}function UpdatePictoFriendStatus(e){"string"==typeof e&&(e=parseInt(e,10)),_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.IdBoat()===e?$("#PictoSetFriend").addClass("hidden"):_CurPlayer&&_CurPlayer.CurBoat&&OppIsFriend(_CurPlayer.CurBoat,e)?$("#PictoSetFriend").removeClass("hidden").removeClass("AddFriend").addClass("DelFriend").attr("BoatId",e):$("#PictoSetFriend").removeClass("hidden").addClass("AddFriend").removeClass("DelFriend").attr("BoatId",e)}function HandleSetFriend(e,t){var a=e.delegateTarget;if(a&&a.attributes&&a.attributes.boatid&&t&&t.VLMPrefs){var o=a.attributes.boatid.value;if(t.VLMPrefs){var n=[];t.VLMPrefs.mapPrefOpponents&&(n=t.VLMPrefs.mapPrefOpponents.split(",")),-1===$.inArray(o,n)?n.push(o):n.splice(n.findIndex(function(e){return e==o}),1),SaveVLMPrefs({mapPrefOpponents:n.join(",")})}else console.log("Unhandled Friend Change click "+o)}}function OppIsFriend(e,t){if(e&&e.VLMPrefs&&e.VLMPrefs.mapPrefOpponents){var a=_CurPlayer.CurBoat.VLMPrefs.mapPrefOpponents.split(",");return-1!==$.inArray(""+t,a)}return!1}function GetOppBoat(e){var t=_CurPlayer.CurBoat;if(t&&t.IdBoat()===e)return t.VLMInfo;if(void 0!==t&&t&&t.OppList){for(var a in t.OppList)if(t.OppList[a]){var o=t.OppList[a];if(o.idusers===e)return o}if(t.Reals&&t.Reals.ranking)for(var n in t.Reals.ranking)if(t.Reals.ranking[n]){var r=t.Reals.ranking[n];if(r.idusers===e)return r}}return null}function BuildBoatPopupInfo(e){if(!e||!e.idusers&&!e.IDU)return null;var t=e.idusers,a=GetCountryFlagImgHTML(e.country);return e.IDU&&(t=e.IDU,a=GetCountryFlagImgHTML(e.CNT)),'<div class="container-fluid"> <div class="MapPopup_InfoHeader">   <div class="row">     <div class="row col-xs-2">'+a+'</div>     <div class="col-xs-8" style="top:8px">       <a id="__BoatName'+t+'" class="PopupBoatNameNumber " href="#" data-toggle="tooltip" title="BoatName">PlayerName</a>       <span id="__BoatId'+t+'" class="PopupBoatNameNumber ">BoatNumber</span>     </div>     <div class="col-xs-2 TxtRank" id="__BoatRank'+t+'">Rank     </div>   </div>   <div class="row"id="__BoatColor'+t+'" style="height: 2px;">   </div> </div> <div class="row MapPopup_InfoBody">   <div class="col-xs-1">     <div class="row PictoSpacer"></div>     <div id="PictoSetFriend" class="row VLMPicto AddFriend"></div>     <div class="row PictoSpacer"></div>     <div id="PictoSetSetBS" class="row VLMPicto AddBS"></div>   </div>   <div class="col-xs-10">     <fieldset>       <span class="PopupHeadText " I18n="loch">'+GetLocalizedString("loch")+'</span><span class="PopupText"> : </span><span id="__BoatLoch'+t+'" class="loch PopupText">0.9563544</span>       <BR><span class="PopupHeadText " I18n="position">'+GetLocalizedString("position")+'</span><span class="PopupText"> : </span><span id="__BoatPosition'+t+'" class=" PopupText">0.9563544</span>       <BR><span class="PopupHeadText " I18n="NextWP">'+GetLocalizedString("NextWP")+'</span><span class="strong"> : </span><span id="__BoatNWP'+t+'" class="PopupText">[1] 4.531856536865234</span>       <BR><span class="PopupHeadText " I18n="Moyennes">'+GetLocalizedString("Moyennes")+' </span><span class="PopupText"> : </span>       <span class="PopupHeadText ">[1h]</span><span id="__Boat1HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>       <span class="PopupHeadText ">[3h]</span><span id="__Boat3HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>       <span class="PopupHeadText ">[24h]</span><span id="__Boat24HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>     </fieldset>   </div> </div></div>'}function HandleOpponentOver(e){var t,a=e.sourceTarget,o=GetRaceMapFeatures(_CurPlayer.CurBoat),n=null;if(a&&a.options&&a.options.icon&&(n=a.options.icon.MarkerOppId),n){for(t in o.OppTrack){var r=t===n;_CurPlayer.CurBoat.OppTrack[t].Visible=r}DrawOpponentTrack(n,o.Opponents[n]),o.Opponents[n].PopupTimeOut=setTimeout(function(t){DeferredOpponentPopup(e)},500)}}function HandleOpponentMouseOut(e){var t=e.sourceTarget,a=GetRaceMapFeatures(_CurPlayer.CurBoat),o=null;t&&t.options&&t.options.icon&&(o=t.options.icon.MarkerOppId),o&&clearTimeout(a.Opponents[o].PopupTimeOut)}function DeferredOpponentPopup(e){ShowOpponentPopupInfo(e)}function HandleOpponentClick(e){HandleOpponentOver(e),ShowOpponentPopupInfo(e)}function HandleFeatureOut(e){if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat&&_CurPlayer.CurBoat&&void 0!==_CurPlayer.CurBoat.OppTrack)for(var t in _CurPlayer.CurBoat.OppTrack)_CurPlayer.CurBoat.OppTrack[t].Visible=!1}var TrackPendingRequests=[],LastTrackRequest=0;function HideOpponentTrack(e,t){DrawOpponentTrack(e,t,!0)}function DrawOpponentTrack(e,t){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],o=_CurPlayer.CurBoat,n=new Date,r=null;if(void 0!==o&&!a&&o&&n>LastTrackRequest)if(LastTrackRequest=new Date(n/1e3+.5),void 0!==o.OppTrack||!(e in o.OppTrack)||e in o.OppTrack&&o.OppTrack[e].LastShow<=new Date(1e3*o.VLMInfo.LUP)){var i=new Date/1e3-172800,s=o.VLMInfo.RAC,l=new Date;if(r=e.toString()+"/"+s.toString(),void 0===t.Color)for(var d in o.OppList)if(o.OppList[d].idusers==e){t.Color=o.OppList[d].color;break}e in o.OppTrack&&(o.OppTrack[e].Visible=!0),r in TrackPendingRequests&&!(l>TrackPendingRequests[r])||(TrackPendingRequests[r]=new Date(l.getTime()+6e4),console.log("GetTrack "+r+" "+i),parseInt(e)>0?GetBoatTrack(o,e,s,i,t):parseInt(e)&&GetRealBoatTrack(o,e,s,i,t))}else console.log(" GetTrack ignore before next update"+r+" "+StartTime)}function GetRealBoatTrack(e,t,a,o,n){$.get("/ws/realinfo/tracks.php?idr="+a+"&idreals="+-t+"&starttime="+o,function(a){a.success&&(AddBoatOppTrackPoints(e,t,a.tracks,n.color),RefreshCurrentBoat(!1,!1))})}var TrackRequestPending=!1;function GetBoatTrack(e,t,a,o,n){TrackRequestPending||(TrackRequestPending=!0,$.get("/ws/boatinfo/smarttracks.php?idu="+t+"&idr="+a+"&starttime="+o,function(a){if(TrackRequestPending=!1,a.success){var o;for(o in AddBoatOppTrackPoints(e,t,a.tracks,n.Color),a.tracks_url){if(o>10)break;$.get("/cache/tracks/"+a.tracks_url[o],function(a){a.success&&(AddBoatOppTrackPoints(e,t,a.tracks,n.Color),DrawOpponents(e))})}DrawOpponents(e)}}))}function AddBoatOppTrackPoints(e,t,a,o){for(var n in t in e.OppTrack||(o=SafeHTMLColor(o),e.OppTrack[t]={LastShow:0,TrackColor:o,DatePos:[],Visible:!0,OppTrackPoints:null}),a){var r=a[n];e.OppTrack[t].DatePos[r[0]]={lat:r[2]/1e3,lon:r[1]/1e3}}e.OppTrack[t].LastShow=0,e.OppTrack[t].OppTrackPoints=null}function DeletePilotOrder(e,t){$.post("/ws/boatsetup/pilototo_delete.php?","parms="+JSON.stringify({idu:e.IdBoat(),taskid:parseInt(t)}),function(e){e.success&&RefreshCurrentBoat(!1,!0,"AutoPilot")})}function UpdateBoatPrefs(e,t){void 0!==e&&e.IdBoat&&void 0!==e.IdBoat()&&void 0!==t&&(t.idu=e.IdBoat(),$.post("/ws/boatsetup/prefs_set.php","parms="+JSON.stringify(t),function(e){e.success||(VLMAlertDanger("Save Prefs To Server "+GetLocalizedString("UpdateFailed")),RefreshCurrentBoat(!1,!1))}))}function LoadVLMPrefs(){var e;void 0!==_CurPlayer&&(e=_CurPlayer.CurBoat).IdBoat&&(SetDDTheme(VLM2Prefs.CurTheme),$.get("/ws/boatinfo/prefs.php?idu="+e.IdBoat(),HandlePrefsLoaded))}function SaveVLMPrefs(e){if(_CurPlayer&&_CurPlayer.CurBoat&&e){var t={idu:_CurPlayer.CurBoat.IdBoat(),prefs:e};$.post("/ws/boatsetup/prefs_set.php","parms="+JSON.stringify(t),HandlePrefsSaved)}}function HandlePrefsSaved(e){e.success?(VLMAlertSuccess(GetLocalizedString("PreferenceUpdateComplete")),LoadVLMPrefs()):VLMAlertDanger(e.error.msg)}function HandlePrefsLoaded(e){e.success?(_CurPlayer.CurBoat.VLMPrefs=e.prefs,VLM2Prefs.UpdateVLMPrefs(e.prefs),$("#AdvancedStats").prop("checked",VLM2Prefs.AdvancedStats),UpdateOppPrefs()):VLMAlertDanger("Error communicating with VLM, try reloading the browser page...")}function UpdateOppPrefs(){$("#PictoSetFriend").length>0&&UpdatePictoFriendStatus($("#PictoSetFriend")[0].attributes.BoatId.value),UpdateOppPictos(),DrawOpponents(_CurPlayer.CurBoat)}function UpdateOppPictos(){if(_CurPlayer){var e=GetRaceMapFeatures(_CurPlayer.CurBoat);if(e&&e.Opponents&&e.Opponents)for(var t in e.Opponents)if(e.Opponents[t]){var a=OppIsFriend(_CurPlayer.CurBoat,e.Opponents[t].IdUsers),o=e.Opponents[t].options.icon;o.options.iconSize=[a?OPP_FRIEND_SIZE:OPP_SIZE,a?OPP_FRIEND_SIZE:OPP_SIZE],e.Opponents[t].setIcon(o)}}}function HandleWPDragEnded(e){var t=_CurPlayer.CurBoat.RaceMapFeatures.TrackWP;CompleteWPSetPosition(t),VLMAlertInfo("User WP moved to "+t.getLatLng())}function CheckAndCreateNewBoat(){var e=$("#NewBoatName")[0].value,t=GetLocalizedString("ConfirmBoatName",e),a=GetLocalizedString("Create your boat");e&&""!==e?(new MsgBox).Show(MsgBox.MSGBOX_YESNO,a,t,CreateBoatOnServer):VLMAlertDanger(GetLocalizedString("No Empty Name"))}function CreateBoatOnServer(e){var t=$("#NewBoatName")[0].value;e&&(t=e);var a={idp:_CurPlayer.IdPlayer,BoatName:t};$.post("/ws/playersetup/BoatCreate.php","parms="+JSON.stringify(a),function(e){e.success?(VLMAlertInfo(GetLocalizedString("Your boat has been created",e.BoatName)),GetPlayerInfo(e.idu)):(new MsgBox).Show(MsgBox.MSGBOX_OKONLY,GetLocalizedString("Boat creation error"),e.error.code+" / "+e.error.msg)})}function InitXmpp(){converse.initialize({bosh_service_url:"https://bind.conversejs.org",i18n:locales.en,show_controlbox_by_default:!0,roster_groups:!0})}