"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var MAP_OP_SHOW_SEL=0,PrefMgr=function e(){_classCallCheck(this,e),this.CurTheme="bleu-noir",this.MapPrefs=new MapPrefs,this.GConsentDate=null,this.GConsentLastNo=null,this.InputDigits=3,this.RacesStorageLUT=[],this.VLMRacesStorage=[],this.ClearRaceData=function(e){this.RacesStorageLUT[e]&&(VLM2Prefs.VLMRacesStorage.splice(this.RacesStorageLUT[e],1),this.RacesStorageLUT.splice(e,1),this.Save())},this.HasRaceStorage=function(e){return void 0!==this.RacesStorageLUT&&void 0!==this.RacesStorageLUT[e]},this.Init=function(){this.MapPrefs.Load(),this.Load()},this.Load=function(){if(store.enabled){this.GConsentDate=LoadLocalPref("GConsentDate",null),this.GConsentLastNo=LoadLocalPref("GConsentLastNo",null);try{this.VLMRacesStorage=JSON.parse(LoadLocalPref("VLMRacesStorage",null))}catch(e){this.VLMRacesStorage=null}for(var e in this.InputDigits=JSON.parse(LoadLocalPref("InputDigits",3)),this.CurTheme=LoadLocalPref("CurTheme","bleu-noir"),this.VLMRacesStorage||(this.VLMRacesStorage=[]),this.VLMRacesStorage)this.VLMRacesStorage[e]&&(this.RacesStorageLUT[this.VLMRacesStorage[e].RaceId]=e)}},this.Save=function(){store.enabled&&store.set("ColorTheme",this.CurTheme),this.MapPrefs.Save(),store.set("GConsentDate",this.GConsentDate),store.set("GConsentLastNo",this.GConsentLastNo),store.set("VLMRacesStorage",JSON.stringify(this.VLMRacesStorage)),store.set("InputDigits",this.InputDigits)},this.UpdateVLMPrefs=function(e){switch(e.mapOpponents){case"mylist":case"mapselboats":case"NULL":case"null":case"all":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowSel;break;case"meandtop10":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowTop10;break;case"my10opps":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.Show10Around;break;case"my5opps":case"maponlyme":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.Show5Around;break;case"myboat":this.MapPrefs.MapOppShow=this.MapPrefs.MapOppShowOptions.ShowMineOnly;break;default:VLMAlertDanger("unexpected mapping option : "+e.mapOpponents)}},this.GetRaceFromStorage=function(e){if(this.RacesStorageLUT[e])return this.VLMRacesStorage[this.RacesStorageLUT[e]];var t=new Race(e),a=this.VLMRacesStorage.length;return this.VLMRacesStorage[a]=t,this.RacesStorageLUT[e]=a,this.Save(),t}},MapPrefs=function e(){_classCallCheck(this,e),this.ShowReals=!0,this.ShowCompass=!0,this.ShowOppNumbers=!0,this.MapOppShow=null,this.MapOppShowOptions={ShowSel:0,ShowMineOnly:1,Show5Around:2,ShowTop10:3,Show10Around:4},this.WindArrowsSpacing=64,this.MapZoomLevel=4,this.PolarVacCount=12,this.UseUTC=!1,this.EstTrackMouse=!1,this.TrackEstForecast=!0,this.ShowTopCount=50,this.Load=function(){store.enabled&&(this.ShowReals=LoadLocalPref("#ShowReals",!0),this.ShowCompass=LoadLocalPref("#ShowCompass",!0),this.ShowOppNumbers=LoadLocalPref("#ShowOppNumbers",!1),this.MapZoomLevel=LoadLocalPref("#MapZoomLevel",4),this.UseUTC=LoadLocalPref("#UseUTC",!1),this.EstTrackMouse=LoadLocalPref("#EstTrackMouse",!0),this.TrackEstForecast=LoadLocalPref("#TrackEstForecast",!1),this.PolarVacCount=LoadLocalPref("#PolarVacCount",12),this.PolarVacCount||(this.PolarVacCount=12),this.ShowTopCount=LoadLocalPref("ShowTopCount",50))},this.Save=function(){store.enabled&&(store.set("#ShowReals",this.ShowReals),store.set("#ShowCompass",this.ShowCompass),store.set("#ShowOppNumbers",this.ShowOppName),store.set("#MapZoomLevel",this.MapZoomLevel),store.set("#PolarVacCount",this.PolarVacCount),store.set("#UseUTC",this.UseUTC),store.set("#TrackEstForecast",this.TrackEstForecast),store.set("#EstTrackMouse",this.EstTrackMouse),store.set("ShowTopCount",this.ShowTopCount));var e="mapselboats";switch(this.MapOppShow){case this.MapOppShowOptions.ShowMineOnly:e="myboat";break;case this.MapOppShowOptions.Show5Around:e="my5opps";break;case this.MapOppShowOptions.ShowTop10:e="meandtop10";break;case this.MapOppShowOptions.Show10Around:e="my10opps"}var t={mapOpponents:e};void 0!==_CurPlayer&&_CurPlayer&&void 0!==t&&t&&UpdateBoatPrefs(_CurPlayer.CurBoat,{prefs:t})},this.GetOppModeString=function(e){switch(e){case this.MapOppShowOptions.ShowSel:return GetLocalizedString("mapselboats");case this.MapOppShowOptions.ShowMineOnly:return GetLocalizedString("maponlyme");case this.MapOppShowOptions.Show5Around:return GetLocalizedString("mapmy5opps");case this.MapOppShowOptions.ShowTop10:return GetLocalizedString("mapmeandtop10");case this.MapOppShowOptions.Show10Around:return GetLocalizedString("mapmy10opps");default:return e}}},VLM2Prefs=new PrefMgr;function LoadLocalPref(e,t){var a=store.get(e);return void 0===a&&(a=t),a}function AutoPilotOrder(e,t){if(this.Date=new Date((new Date).getTime()-(new Date).getTime()%3e5+45e4),this.PIM=PM_HEADING,this.PIP_Value=0,this.PIP_Coords=new VLMPosition(0,0),this.PIP_WPAngle=-1,this.ID=-1,void 0!==e&&e){if(!(t-1 in e.VLMInfo.PIL))return void alert("Invalid Pilototo order number. Report error to devs.");var a=e.VLMInfo.PIL[t-1];switch(this.Date=new Date(1e3*parseInt(a.TTS,10)),this.PIM=parseInt(a.PIM,10),this.ID=parseInt(a.TID,10),this.PIM){case PM_ANGLE:case PM_HEADING:this.PIP_Value=parseInt(a.PIP,10);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:var o=a.PIP.split(","),n=o[1].split("@");this.PIP_Coords.Lat.Value=parseFloat(o[0]),this.PIP_Coords.Lon.Value=parseFloat(n[0]),this.PIP_WPAngle=parseFloat(n[1])}}this.GetOrderDateString=function(){return this.Date.getDate()+"/"+(this.Date.getMonth()+1)+"/"+this.Date.getFullYear()},this.GetOrderTimeString=function(){return this.Date.getHours()+":"+this.Date.getMinutes()+":15"},this.GetPIMString=function(){switch(this.PIM){case PM_HEADING:return GetLocalizedString("autopilotengaged");case PM_ANGLE:return GetLocalizedString("constantengaged");case PM_ORTHO:return GetLocalizedString("orthodromic");case PM_VMG:return"VMG";case PM_VBVMG:return"VBVMG"}},this.GetPIPString=function(){switch(this.PIM){case PM_HEADING:case PM_ANGLE:return this.PIP_Value;case PM_ORTHO:case PM_VMG:case PM_VBVMG:return this.PIP_Coords.GetVLMString()+"@"+PIP_WPAngle}}}function HandleSendAPUpdate(e){var t="add";if(void 0!==_CurAPOrder&&_CurAPOrder){var a={idu:_CurPlayer.CurBoat.IdBoat,tasktime:Math.round(_CurAPOrder.Date/1e3),pim:_CurAPOrder.PIM};switch(-1!==_CurAPOrder.ID&&(t="update",a.taskid=_CurAPOrder.ID),_CurAPOrder.PIM){case PM_HEADING:case PM_ANGLE:a.pip=_CurAPOrder.PIP_Value;break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:a.pip={},a.pip.targetlat=_CurAPOrder.PIP_Coords.Lat.Value,a.pip.targetlong=_CurAPOrder.PIP_Coords.Lon.Value,a.pip.targetandhdg=-1===_CurAPOrder.PIP_WPAngle?null:_CurAPOrder.PIP_WPAngle}$.post("/ws/boatsetup/pilototo_"+t+".php","parms="+JSON.stringify(a),function(e){e.success?RefreshCurrentBoat(!1,!0,"AutoPilot"):alert(e.error.msg)})}}function HandleAPFieldChange(e){var t=e.target;if(void 0!==t.attributes.id)switch(t.attributes.id.value){case"AP_PIP":_CurAPOrder.PIP_Value=parseFloat(t.value),_CurAPOrder.PIP_Value.toString()!==t.Value&&(t.value=_CurAPOrder.PIP_Value.toString());break;case"AP_WPLat":CheckFloatInput(_CurAPOrder.PIP_Coords.Lat,t);break;case"AP_WPLon":CheckFloatInput(_CurAPOrder.PIP_Coords.Lon,t);break;case"AP_WPAt":var a={};a.Value=_CurAPOrder.PIP_WPAngle,CheckFloatInput(a,t),_CurAPOrder.PIP_WPAngle=a.Value}}function CheckFloatInput(e,t){var a;"object"===_typeof(e)?(e.Value=parseFloat(t.value),a=e.Value):a=e=parseFloat(t.value),a.toString()!==t.Value&&(t.value=a.toString())}function BoatEstimate(e){this.Position=null,this.Date=null,this.PrevDate=null,this.Mode=null,this.Value=null,this.Meteo=null,this.CurWP=new VLMPosition(0,0),this.HdgAtWP=-1,this.RaceWP=1,this.Heading=null,void 0!==e&&e&&(this.Position=new VLMPosition(e.Position.Lon.Value,e.Position.Lat.Value),this.Date=new Date(e.Date),this.PrevDate=new Date(e.PrevDate),this.Mode=e.Mode,this.Value=e.Value,void 0!==e.Meteo&&e.Meteo&&(this.Meteo=new WindData({Speed:e.Meteo.Speed,Heading:e.Meteo.Heading})),this.CurWP=e.CurWP,this.RaceWP=e.RaceWP,this.Heading=e.Heading)}function Estimator(e){if(void 0===e||!e)throw"Boat must exist for tracking....";this.Boat=e,this.MaxVacEstimate=0,this.CurEstimate=new BoatEstimate,this.Running=!1,this.EstimateTrack=[],this.ProgressCallBack=null,this.ErrorCount=0,this.EstimateMapFeatures=[],this.Stop=function(){this.Running&&(this.EstimateTrack?StatMGR.Stat("Estimator_Stop",null,null,this.EstimateTrack.length):StatMGR.Stat("Estimator_Stop",null,null,0),this.Running=!1,this.ReportProgress(!0),this.LastPctRefresh=-1,this.LastPctDraw=-1,this.ReportProgress(!0))},this.Start=function(e){if(this.ProgressCallBack=e,!this.Running)if(this.Running=!0,this.LastPctRefresh=0,this.LastPctDraw=0,GribMgr.Init(),void 0!==this.Boat.VLMInfo){if(this.CurEstimate.Position=new VLMPosition(this.Boat.VLMInfo.LON,this.Boat.VLMInfo.LAT),this.CurEstimate.Date=new Date(1e3*this.Boat.VLMInfo.LUP+1e3*this.Boat.VLMInfo.VAC),this.CurEstimate.PrevDate=this.CurEstimate.Date,this.CurEstimate.Date<new Date)if(void 0===this.Boat.RaceInfo)this.CurEstimate.Date=new Date;else{if(this.CurEstimate.PrevDate=new Date(1e3*parseInt(this.Boat.RaceInfo.deptime,10)+6e3),this.CurEstimate.PrevDate<new Date){var t=(new Date).getTime()/1e3;t-=t%this.Boat.VLMInfo.VAC,this.CurEstimate.PrevDate=new Date(1e3*t+6e3)}var a=new Date(this.CurEstimate.PrevDate.getTime()+1e3*this.Boat.VLMInfo.VAC);this.CurEstimate.Date=a}for(var o in this.CurEstimate.Mode=parseInt(this.Boat.VLMInfo.PIM,10),this.CurEstimate.CurWP=new VLMPosition(this.Boat.VLMInfo.WPLON,this.Boat.VLMInfo.WPLAT),this.CurEstimate.HdgAtWP=parseFloat(this.Boat.VLMInfo["H@WP"]),this.CurEstimate.RaceWP=parseInt(this.Boat.VLMInfo.NWP,10),this.CurEstimate.Mode!=PM_HEADING&&this.CurEstimate.Mode!=PM_ANGLE||(this.CurEstimate.Value=parseFloat(this.Boat.VLMInfo.PIP)),this.CurEstimate.PilOrders=[],this.Boat.VLMInfo.PIL){var n=this.Boat.VLMInfo.PIL[o],i={PIP:n.PIP,PIM:n.PIM,STS:n.STS,TTS:n.TTS};this.CurEstimate.PilOrders.push(i)}this.EstimateTrack=[],this.MaxVacEstimate=new Date(GribMgr.MaxWindStamp),this.ReportProgress(!1),this.EstimateTrack.push(new BoatEstimate(this.CurEstimate)),this.ErrorCount=0,StatMGR.Stat("Estimator_Start"),setTimeout(this.Estimate.bind(this),0)}else this.Stop()},this.Estimate=function(e){if(!this.Running||this.CurEstimate.Date>=this.MaxVacEstimate)this.Stop();else{var t,a=this.CurEstimate.Position.Lat.Value,o=this.CurEstimate.Position.Lon.Value;do{if(!(t=GribMgr.WindAtPointInTime(this.CurEstimate.PrevDate,a,o)))return this.ErrorCount>10?void this.Stop():(this.ErrorCount++,void setTimeout(this.Estimate.bind(this),1e3));if(this.ErrorCount=0,isNaN(t.Speed)){alert("Looping on NaN WindSpeed")}}while(isNaN(t.Speed));for(var n in this.CurEstimate.Meteo=t,this.CurEstimate.PilOrders){var i=this.CurEstimate.PilOrders[n];if(i&&"pending"===i.STS)if(new Date(1e3*parseInt(i.TTS,10))<=this.CurEstimate.Date){switch(this.CurEstimate.Mode=parseInt(i.PIM,10),this.CurEstimate.Mode){case PM_ANGLE:case PM_HEADING:this.CurEstimate.Value=parseFloat(i.PIP);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:var r=i.PIP.split("@"),s=r[0].split(",");this.CurEstimate.CurWP=new VLMPosition(parseFloat(s[1]),parseFloat(s[0])),this.CurEstimate.HdgAtWP=parseFloat(r[1]);break;default:return alert("unsupported pilototo mode"),void this.Stop()}this.CurEstimate.PilOrders[n].STS="Planned",this.CurEstimate.PilOrders[n].Pos=this.CurEstimate.Position;break}}var l=this.CurEstimate.Value,c=0,d=null,u=null;switch(this.CurEstimate.Mode){case PM_ANGLE:if(l=t.Heading+this.CurEstimate.Value,c=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(c))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();d=this.CurEstimate.Position.ReachDistLoxo(c/3600*this.Boat.VLMInfo.VAC,l);break;case PM_HEADING:if(c=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(c))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();d=this.CurEstimate.Position.ReachDistLoxo(c/3600*this.Boat.VLMInfo.VAC,l);break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:if(u=this.GetNextWPCoords(this.CurEstimate),this.CurEstimate.Mode==PM_ORTHO){if(l=this.CurEstimate.Position.GetOrthoCourse(u),c=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(c))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();d=this.CurEstimate.Position.ReachDistOrtho(c/3600*this.Boat.VLMInfo.VAC,l)}else{if(l=this.CurEstimate.Mode==PM_VMG?PolarsManager.GetVMGCourse(this.Boat.VLMInfo.POL,t.Speed,t.Heading,this.CurEstimate.Position,u):PolarsManager.GetVBVMGCourse(this.Boat.VLMInfo.POL,t.Speed,t.Heading,this.CurEstimate.Position,u),c=PolarsManager.GetBoatSpeed(this.Boat.VLMInfo.POL,t.Speed,t.Heading,l),isNaN(c))return VLMAlertDanger("PM_ANGLE : Error getting boatSpeed try again later..."),void this.Stop();d=this.CurEstimate.Position.ReachDistLoxo(c/3600*this.Boat.VLMInfo.VAC,l)}this.CheckWPReached(u,this.CurEstimate.Position,d);break;default:throw"Unsupported pilotmode for estimate..."+this.CurEstimate.Mode}console.log(this.CurEstimate.Date+this.CurEstimate.Position.toString(!0)+"=> "+d.Lon.toString(!0)+" "+d.Lat.toString(!0)+" Wind : "+RoundPow(t.Speed,4)+"@"+RoundPow(t.Heading,4)+" Boat "+RoundPow(c,4)+"kts"+RoundPow((l+360)%360,4));var p=!1;this.CheckGateValidation(d)&&(p=this.GetNextRaceWP()),this.CurEstimate.Heading=l,this.CurEstimate.Position=d,this.EstimateTrack.push(new BoatEstimate(this.CurEstimate)),this.CurEstimate.Date=new Date(1e3*(this.CurEstimate.Date/1e3+this.Boat.VLMInfo.VAC)),this.CurEstimate.PrevDate=this.CurEstimate.Date,p?this.Stop():(setTimeout(this.Estimate.bind(this),0),this.ReportProgress(!1))}},this.GetPilotPoints=function(){var e=[];for(var t in this.CurEstimate.PilOrders){var a=this.CurEstimate.PilOrders[t];a&&void 0!==a.Pos&&e.push(a)}return e},this.GetNextRaceWP=function(){var e=Object.keys(this.Boat.RaceInfo.races_waypoints).length;if(this.CurEstimate.RaceWP===e)return!0;for(var t=this.CurEstimate.RaceWP+1;t<=e;t++)if(!(this.Boat.RaceInfo.races_waypoints[t].wpformat&WP_ICE_GATE)){this.CurEstimate.RaceWP=t;break}return!1},this.CheckGateValidation=function(e){var t=this.GetNextGateSegment(this.CurEstimate),a=(this.Boat.RaceInfo.races_waypoints[this.CurEstimate.RaceWP],{P1:this.CurEstimate.Position,P2:e});return VLMMercatorTransform.SegmentsIntersect(t,a)},this.CheckWPReached=function(e,t,a){if(this.CurEstimate.CurWP.Lat.value||this.CurEstimate.CurWP.Lon.Value){var o=e.GetOrthoDist(t),n=e.GetOrthoDist(a),i=t.GetOrthoDist(a);(o<i||n<i)&&(this.CurEstimate.CurWP=new VLMPosition(0,0),-1!=this.CurEstimate.HdgAtWP&&(this.CurEstimate.Mode=PM_HEADING,this.CurEstimate.Value=this.CurEstimate.HdgAtWP),console.log("WP Reached"))}},this.GetNextWPCoords=function(e){return e.CurWP.Lat.value||e.CurWP.Lon.Value?e.CurWP:this.Boat.GetNextWPPosition(e.RaceWP,e.Position,e.CurWP)},this.GetNextGateSegment=function(e){return this.Boat.GetNextGateSegment(e.RaceWP)},this.ReportProgress=function(e){var t=0;this.ProgressCallBack&&(e||this.EstimateTrack.length>1&&(t=RoundPow(100*(1-(t=(this.MaxVacEstimate-this.EstimateTrack[this.EstimateTrack.length-1].Date)/(this.MaxVacEstimate-this.EstimateTrack[0].Date))),1)),this.ProgressCallBack(e,t,this.CurEstimate.Date))},this.GetClosestEstimatePoint=function(e){return e instanceof VLMPosition?this.GetClosestEstimatePointFromPosition(e):e instanceof Date?this.GetClosestEstimatePointFromTime(e):null},this.GetClosestEstimatePointFromTime=function(e){if(!e||!Object.keys(this.EstimateTrack).length)return null;var t,a=0;for(a=0;a<Object.keys(this.EstimateTrack).length;a++)if(this.EstimateTrack[a]){if(!(e>this.EstimateTrack[a].Date))break;t=e-this.EstimateTrack[a].Date}if(a<Object.keys(this.EstimateTrack).length&&void 0!==this.EstimateTrack[a+1]&&this.EstimateTrack[a+1]){var o=e-this.EstimateTrack[a+1].Date;Math.abs(o)<Math.abs(t)&&a++}return this.EstimateTrack[a]},this.GetClosestEstimatePointFromPosition=function(e){if(!e)return null;var t,a=1e30,o=null;for(t=0;t<Object.keys(this.EstimateTrack).length;t++)if(this.EstimateTrack[t]){var n=e.GetEuclidianDist2(this.EstimateTrack[t].Position);n<a&&(o=this.EstimateTrack[t],a=n)}return o},this.ClearEstimatePosition=function(e){this.ShowEstimatePosition(e,null)},this.ShowEstimatePosition=function(e,t){var a=GetRaceMapFeatures(e);if(e&&t&&t.Position&&(e.VLMInfo.LON!==t.Position.Lon.Value||e.VLMInfo.LAT!==t.Position.Lat.Value)){if(!a)return;var o=[t.Position.Lat.Value,t.Position.Lon.Value];if(a.BoatEstimateMarker)a.BoatEstimateMarker.setLatLng(o).addTo(map);else{var n=GetBoatEstimateMarker();a.BoatEstimateMarker=L.marker(o,{icon:n}).addTo(map)}if(a.BoatEstimateMarker&&a.BoatEstimateMarker.setRotationAngle(t.Heading),void 0!==t.Meteo&&t.Meteo){var i=BuildPolarLine(e,new VLMPosition(o[1],o[0]),VLM2Prefs.MapPrefs.PolarVacCount,t.Date);a.BoatEstimateMarkerPolar=DefinePolarMarker(i,a.BoatEstimateMarkerPolar)}}else a&&(a.BoatEstimateMarker&&a.BoatEstimateMarker.remove(),a.BoatEstimateMarkerPolar&&a.BoatEstimateMarkerPolar.remove())},this.GetEstimateTracks=function(e){var t=[],a=null,o=null;if("undefined"==typeof track||!e){if(!this.EstimateTrack||!this.EstimateTrack[0])return null;e=this.EstimateTrack}var n=(new Date).getTime(),i=n-n%216e5+126e5;for(var r in e)if(e[r]){var s=e[r],l=s.Date.getTime()-i,c=Math.floor(l/6/36e5);c<0?c=0:c>2&&(c=2),void 0===t[c]&&(t[c]=[]),c!==a&&o&&t[c].push([o.Position.Lat.Value,o.Position.Lon.Value]),t[c].push([s.Position.Lat.Value,s.Position.Lon.Value]),o=s,a=c}return t}}function Coords(e,t){this.Value="number"==typeof e?e:parseFloat(e),this.IsLon=t,this.Deg=function(){return Math.abs(this.Value)},this.Min=function(){return 60*(Math.abs(this.Value)-Math.floor(this.Deg()))},this.Sec=function(){return 60*(this.Min()-Math.floor(this.Min()))},this.toString=function(e){if(e)return this.Value;var t="";return t=void 0===this.IsLon||0==this.IsLon?this.Value>=0?" N":" S":this.Value>=0?" E":" W",Math.floor(this.Deg())+"° "+Math.floor(this.Min())+"' "+RoundPow(this.Sec(),2)+'"'+t}}function GetDegMinSecFromNumber(e,t,a,o){SplitNumber(e,t,void 0),SplitNumber(NaN,a,void 0),SplitNumber(NaN,o,void 0)}function SplitNumber(e,t,a){Math.floor(e)}VLM2Prefs.Init();var SrvIndex=1,MIN_MAP_ZOOM=5,GribMap={ServerURL:function(){return"undefined"!=typeof WindGridServers&&WindGridServers?(0===(SrvIndex=(SrvIndex+1)%WindGridServers.length)&&(SrvIndex=1),WindGridServers[SrvIndex]):""}},Pixel=function e(t,a){_classCallCheck(this,e),this.x=t,this.y=a,this.moveBy=function(e){this.x+=e.x,this.y+=e.y},this.moveByPolar=function(e,t){var a=(t-90)*Math.PI/180;this.x+=e*Math.cos(a),this.y+=e*Math.sin(a)}},BeaufortColors=["#FFFFFF","#9696E1","#508CCD","#3C64B4","#41B464","#B4CD0A","#D2D216","#E1D220","#FFB300","#FF6F00","#FF2B00","#E60000","#7F0000"];GribMap.Layer=L.Layer.extend({initialize:function(e){e||(e={}),this.cfg=e,this._canvas=L.DomUtil.create("canvas"),this._data=[],this._max=1,this._min=0,this.cfg.container=this._canvas,this._Density=10,this._Time=new Date,this.DrawWindDebugCnt=0,this.DrawWindDebugDepth=0},GetGribMapTime:function(){return this._Time},SetGribMapTime:function(e){this._Time=e,this._update()},_CheckDensity:function(){this._width<500||this.height<500?this._Density=5:this._Density=10},onAdd:function(e){var t=e.getSize();this._map=e,this._width=t.x,this._height=t.y,this._canvas.width=t.x,this._canvas.height=t.y,this._CheckDensity(),this._canvas.style.width=t.x+"px",this._canvas.style.height=t.y+"px",this._canvas.style.position="absolute",this._origin=this._map.layerPointToLatLng(new L.Point(0,0)),e.getPanes().overlayPane.appendChild(this._canvas),e.on("moveend",this._reset,this),this._reset(),this._draw()},addTo:function(e){return e.addLayer(this),this},onRemove:function(e){e.getPanes().overlayPane.removeChild(this._canvas),e.off("moveend",this._reset,this)},_draw:function(){this._map&&this._update()},_update:function(e){var t=this._canvas.getContext("2d");t.clearRect(0,0,this._canvas.width,this._canvas.height),this._DrawWindArea(t,e)},_DrawWindArea:function(e,t,a,o){var n=this;this.DrawWindDebugCnt++,this.DrawWindDebugDepth=t?this.DrawWindDebugDepth+1:0;this.arrowstep;var i,r,s=1;if(i=this._map.getBounds(),!((r=this._map.getZoom())<MIN_MAP_ZOOM)){var l=i.getWest(),c=i.getEast(),d=i.getNorth(),u=i.getSouth(),p=(c-l)/this._Density,h=(d-u)/this._Density,P=L.latLng(d,l),f=map.project(P,r),g=null;t&&void 0!==a&&void 0!==o&&(l=a,c=a,u=o,d=o);for(var M=function(a){for(var o=function(o){try{var i=n;if(g=GribMgr.WindAtPointInTime(n._Time,o,a,t?null:function(){i._update(!0,a,o)})){var l=L.latLng(o,a),c=map.project(l,r);n._drawWind(e,c.x-f.x,c.y-f.y,r,g.Speed,g.Heading)}}catch(e){s>0&&(console.log("_DrawWindArea "+a+" / "+o+" / <br>"+e),s-=1)}},i=u;i<=d;i+=h)o(i)},m=l;m<=c;m+=p)M(m)}},_drawWind:function(e,t,a,o,n,i){var r=this._drawWindTriangle(e,t,a,n,i);e.fillStyle="#626262",this._drawWindText(e,t,a+r,n,i)},_drawWindText:function(e,t,a,o,n){var i=t,r=a,s="?? / ???";(o||n)&&(r+=n>90&&n<270?13+5*Math.cos(n*Math.PI/180):7-5*Math.cos(n*Math.PI/180),s=RoundPow(o,1)+"/"+RoundPow(n,1)+"°");var l=e.measureText(s).width/2;e.fillText(s,i-l,r)},_drawWindTriangle:function(e,t,a,o,n){var i,r,s,l,c,d,u;if(!n&&!o)return 0;u=Math.log(o+1),d=(n+180)%360,i=new Pixel(t,a),r=new Pixel(t,a),s=new Pixel(t,a),i.moveByPolar(4+4*u,d),r.moveByPolar(0+2*u,d-135),s.moveByPolar(0+2*u,d+135),l=new Pixel((i.x+r.x+s.x)/3,(i.y+r.y+s.y)/3),c=new Pixel(t-l.x,a-l.y),i.moveBy(c),r.moveBy(c),s.moveBy(c);var p=this.windSpeedToColor(o);return e.fillStyle=p,e.strokeStyle=p,e.beginPath(),e.moveTo(i.x,i.y),e.lineTo(r.x,r.y),e.lineTo(s.x,s.y),e.fill(),e.stroke(),e.closePath(),Math.max(i.y,r.y,s.y)},windSpeedToColor:function(e){var t=GribMgr.GetBeaufort(e);return BeaufortColors[t]},_reset:function(){var e=this._map.containerPointToLayerPoint([0,0]);L.DomUtil.setTransform(this._canvas,e,1);var t=this._map.getSize();this._width!==t.x&&(this._canvas.width=t.x,this._width=t.x,this._CheckDensity()),this._height!==t.y&&(this._canvas.height=t.y,this._height=t.y,this._CheckDensity()),this._draw()},_animateZoom:function(e){var t=this._map.getZoomScale(e.zoom),a=this._map._getCenterOffset(e.center)._multiplyBy(-t).subtract(this._map._getMapPanePos());L.DomUtil.setTransform?L.DomUtil.setTransform(this._canvas,a,t):this._canvas.style[L.DomUtil.TRANSFORM]=L.DomUtil.getTranslateString(a)+" scale("+t+")"}});var BeaufortScale=[1,4,7,11,17,22,28,34,41,48,56,64],MaxBeaufort=12,GribData=function e(t){_classCallCheck(this,e),this.UGRD=NaN,this.VGRD=NaN,this.TWS=NaN,void 0!==t&&(this.UGRD=t.UGRD,this.VGRD=t.VGRD,this.TWS=t.TWS),this.Strength=function(){return 1.9438445*Math.sqrt(this.UGRD*this.UGRD+this.VGRD*this.VGRD)},this.Direction=function(){var e=Math.sqrt(this.UGRD*this.UGRD+this.VGRD*this.VGRD),t=Math.acos(-this.VGRD/e);return this.UGRD>0&&(t=2*Math.PI-t),(t=t/Math.PI*180%360)<0?t+=360:t>=360&&(t-=360),t}},WindData=function e(t){_classCallCheck(this,e),this.Speed=NaN,this.Heading=NaN,this.IsValid=function(){return!isNaN(this.Speed)&&!isNaN(this.Heading)},void 0!==t&&(this.Speed=t.Speed,this.Heading=t.Heading)},VLM2GribManager=function e(){_classCallCheck(this,e),this.Tables=[],this.TableTimeStamps=[],this.Inited=!1,this.Initing=!1,this.MinWindStamp=0,this.MaxWindStamp=0,this.WindTableLength=0,this.LoadQueue=[],this.GribStep=.5,this.LastGribDate=new Date(0),this.BeaufortCache=[],this.BeaufortCacheHits=0,this.BeaufortRecursionHits=0,this.BeaufortCacheRatio=0,this.Init=function(){this.Inited||this.Initing||(this.Initing=!0,$.get("/ws/windinfo/list.php?v="+Math.round((new Date).getTime()/1e3/60/3),this.HandleGribList.bind(this)))},this.GetBeaufort=function(e,t,a){if(t||a){this.BeaufortRecursionHits++;var o=Math.floor((a+t)/2);return e===BeaufortScale[o]?(this.BeaufortCache[e]=o,o):e<BeaufortScale[o]?o!==t?this.GetBeaufort(e,t,o):(this.BeaufortCache[e]=o,o):o+1<a?this.GetBeaufort(e,o,a):(this.BeaufortCache[e]=a,a)}if(e=Math.floor(e),this.BeaufortCache[e])return this.BeaufortCacheHits++,this.BeaufortCacheRatio=this.BeaufortCacheHits/(this.BeaufortCacheHits+this.BeaufortRecursionHits),this.BeaufortCache[e];var n=Math.floor(MaxBeaufort/2);return e<BeaufortScale[n]?this.GetBeaufort(e,0,n):this.GetBeaufort(e,n,MaxBeaufort)},this.HandleGribList=function(e){this.TableTimeStamps=e.grib_timestamps,this.Inited=!0,this.Initing=!1,this.MinWindStamp=new Date(1e3*this.TableTimeStamps[0]),this.MaxWindStamp=new Date(1e3*this.TableTimeStamps[this.TableTimeStamps.length-1]),this.WindTableLength=this.TableTimeStamps.length},this.WindAtPointInTime=function(e,t,a,o){if(!this.Inited)return!1;var n=Math.floor((e/1e3-this.MinWindStamp/1e3)/10800);if(n<0)return!1;if(n+1>=this.TableTimeStamps.length)return!1;var i=new WindData;if(Math.abs(t)>85)return i.Heading=0,i.Speed=0,i;var r=this.CheckGribLoaded(n,t,NormalizeLongitudeDeg(a),o),s=this.CheckGribLoaded(n+1,t+this.GribStep,NormalizeLongitudeDeg(a+this.GribStep),o);if(r&&!s&&(s=this.CheckGribLoaded(n+1,t+this.GribStep,NormalizeLongitudeDeg(a+this.GribStep),o)),!r||!s)return!1;var l=this.GetHydbridMeteoAtTimeIndex(n,t,NormalizeLongitudeDeg(a));if(!l)return!1;var c=this.GetHydbridMeteoAtTimeIndex(n+1,t,NormalizeLongitudeDeg(a));if(!c)return!1;var d=l.UGRD,u=l.VGRD,p=c.UGRD,h=c.VGRD,P=e/1e3-this.TableTimeStamps[n],f=new GribData({UGRD:d+P/10800*(p-d),VGRD:u+P/10800*(h-u)});return i.Heading=f.Direction(),i.Speed=l.TWS+P/10800*(c.TWS-l.TWS),i},this.GetHydbridMeteoAtTimeIndex=function(e,t,a){for(var o=a;o<0;)o+=360;for(;o>360;)o-=360;for(var n=t;n<0;)n+=90;for(;n>90;)n-=90;var i=(180/this.GribStep+Math.floor(a/this.GribStep)+360/this.GribStep)%(360/this.GribStep),r=(90/this.GribStep+Math.floor(t/this.GribStep)+180/this.GribStep)%(180/this.GribStep),s=(i+1)%(360/this.GribStep),l=(r+1)%(180/this.GribStep),c=o/this.GribStep-Math.floor(o/this.GribStep),d=n/this.GribStep-Math.floor(n/this.GribStep),u=this.Tables[e][i][r].UGRD,p=this.Tables[e][i][l].UGRD,h=this.Tables[e][s][r].UGRD,P=this.Tables[e][s][l].UGRD,f=this.Tables[e][i][r].VGRD,g=this.Tables[e][i][l].VGRD,L=this.Tables[e][s][r].VGRD,M=this.Tables[e][s][l].VGRD,m=this.Tables[e][i][r].Strength(),C=this.Tables[e][i][l].Strength(),v=this.Tables[e][s][r].Strength(),I=this.Tables[e][s][l].Strength(),R=this.QuadraticAverage(m,C,v,I,c,d);return new GribData({UGRD:this.QuadraticAverage(u,p,h,P,c,d),VGRD:this.QuadraticAverage(f,g,L,M,c,d),TWS:R})},this.QuadraticAverage=function(e,t,a,o,n,i){var r=e+i*(t-e);return r+n*(a+i*(o-a)-r)},this.CheckGribLoaded=function(e,t,a,o){var n=180/this.GribStep+Math.floor(a/this.GribStep),i=90/this.GribStep+Math.floor(t/this.GribStep),r=180/this.GribStep+Math.ceil(a/this.GribStep),s=90/this.GribStep+Math.ceil(t/this.GribStep);return!!(e in this.Tables&&this.Tables[e][n]&&this.Tables[e][n][i]&&this.Tables[e][n][s]&&this.Tables[e][r]&&this.Tables[e][r][i]&&this.Tables[e][r][s])||(this.CheckGribLoadedIdx(e,n,i,o),this.CheckGribLoadedIdx(e,n,s,o),this.CheckGribLoadedIdx(e,r,i,o),this.CheckGribLoadedIdx(e,r,s,o),!1)},this.CheckGribLoadedIdx=function(e,t,a,o){if(isNaN(t)||isNaN(a));if(!(this.Tables.length&&this.Tables[e]&&this.Tables[e][t]&&this.Tables[e][t][a])){var n,i,r=a*this.GribStep-90,s=t*this.GribStep-180,l=5*Math.floor(r/5),c=5*Math.floor(s/5);r<l?l=(n=l)-10:n=l+10,s<c?c=(i=c)-10:i=c+10,i>180&&(i=180,this.CheckGribLoadedIdx(e,0,a,o)),c<-180&&(c=-180,this.CheckGribLoadedIdx(e,180/this.GribStep-1,a,o));var d="0/"+c+"/"+i+"/"+n+"/"+l;this.AddGribLoadKey(d,n,l,c,i,o)}},this.AddGribLoadKey=function(e,t,a,o,n,i){e in this.LoadQueue?void 0!==i&&i&&this.LoadQueue[e].CallBacks.push(i):(this.LoadQueue[e]={length:0,CallBacks:[i]},$.get(GribMap.ServerURL()+"/ws/windinfo/smartgribs.php?north="+t+"&south="+a+"&west="+o+"&east="+n+"&seed="+(0+new Date),this.HandleGetSmartGribList.bind(this,e)))},this.HandleGetSmartGribList=function(e,t){if(t.success){for(var a in this.LastGribDate!==parseInt(t.GribCacheIndex,10)&&(this.LastGribDate=parseInt(t.GribCacheIndex,10),this.Tables=[],this.Inited=!1,this.Init()),t.gribs_url)if(t.gribs_interim_url){if(t.gribs_interim_url[a]){var o=t.gribs_interim_url[a].replace(".grb",".txt");$.get("/cache/gribtiles/"+o+"&v=0",this.HandleSmartGribData.bind(this,e,o))}}else if(t.gribs_url[a]){var n=t.gribs_url[a].replace(".grb",".txt");$.get("/cache/gribtiles/"+n+"&v=0",this.HandleSmartGribData.bind(this,e,n))}}else console.log(t)},this.HandleSmartGribData=function(e,t,a){if(this.ProcessInputGribData(t,a,e)&&this.LoadQueue[e]){for(var o in this.LoadQueue[e].CallBacks)this.LoadQueue[e].CallBacks[o]&&this.LoadQueue[e].CallBacks[o]();delete this.LoadQueue[e]}},this.ForceReloadGribCache=function(e,t){$.get("/cache/gribtiles/"+t+"&force=yes&seed=0",this.HandleSmartGribData.bind(this,e,t))},this.ProcessInputGribData=function(e,t,a){var o=t.split("\n"),n=o.length,i=[],r=0;if("--\n"===t)return this.ForceReloadGribCache(a,e),!1;if(-1!==t.search("invalid"))return console.log("invalid request :"+e),!1;for(var s=0;s<n;s++){var l=o[s];if("--"===l||-1==l.search(":")){r=s+1;break}l&&-1===l.search("GRID:")&&i.push(this.ProcessCatalogLine(l))}if(!(i.length<this.WindTableLength)){for(var c=e.split("/"),d=0;d<i.length;d++){if(void 0===o[r]||""===o[r]){this.ForceReloadGribCache(a,e);break}for(var u=o[r].split(" "),p=parseInt(u[0],10),h=parseInt(u[1],10),P=180/this.GribStep+parseInt(c[1],10)/this.GribStep,f=0;f<p;f++)for(var g=h+90/this.GribStep+parseInt(c[0],10)/this.GribStep,L=0;L<h;L++){i[d].DateIndex in this.Tables||(this.Tables[i[d].DateIndex]=[]);var M=this.Tables[i[d].DateIndex];P+f in M||(M[P+f]=[]),g-L-1 in M[P+f]||(M[P+f][g-L-1]=null);var m=this.Tables[i[d].DateIndex][P+f][g-L-1];void 0!==m&&m||(m=new GribData,this.Tables[i[d].DateIndex][P+f][g-L-1]=m),m[i[d].Type]=parseFloat(o[r+1+L*p+f])}r+=p*h+1}return!0}this.ForceReloadGribCache(a,e)},this.ProcessCatalogLine=function(e){var t=new WindCatalogLine,a=e.split(":");if(t.Type=a[3],void 0===a[12]||"anl"===a[12])t.DateIndex=0;else{t.DateIndex=parseInt(a[12].substring(0,a[12].indexOf("hr")),10)/3;var o=new Date(this.MinWindStamp.getTime()+108e5*t.DateIndex);o>this.MaxWindStamp&&(this.MaxWindStamp=o,this.WindTableLength=t.DateIndex+1,this.TableTimeStamps[t.DateIndex]=o.getTime()/1e3)}return t}},WindCatalogLine=function e(){_classCallCheck(this,e),this.Type="",this.DateIndex=0},WindTable=function e(){_classCallCheck(this,e),this.GribStep=.5,this.Table=[],this.TableDate=0,this.Init=function(e){for(lat=-90;lat<=90;lat+=this.GribStep)for(lon=-90;lon<=90;lon+=this.GribStep)this.Table[lat][lon]=null}},GribMgr=new VLM2GribManager;function HandleGribTestClick(e){for(var t=_CurPlayer.CurBoat,a=0;a<=0;a++){var o=new Date(1e3*t.VLMInfo.LUP+a*t.VLMInfo.VAC*1e3),n=GribMgr.WindAtPointInTime(o,t.VLMInfo.LAT,t.VLMInfo.LON);n?console.log(o+" "+n.Speed+"@"+n.Heading):console.log("no meteo yet at time : "+o)}}GribMgr.Init();var RACE_TYPE_CLASSIC=0,RACE_TYPE_RECORD=1,RACE_TYPE_OMORMB=2,FIELD_MAPPING_TEXT=0,FIELD_MAPPING_VALUE=1,FIELD_MAPPING_CHECK=2,FIELD_MAPPING_IMG=3,FIELD_MAPPING_CALLBACK=4,FIELD_MAPPING_STYLE=5,MAX_PILOT_ORDERS=5,BoatRacingStatus=["RAC","CST","LOC","DNS"],BoatArrivedStatus=["ARR"],BoatNotRacingStatus=["DNF","HC","HTP"],BoatRacingClasses={RAC:"ft_class_racing",CST:"ft_class_oncoast",LOC:"ft_class_locked",DNS:"ft_class_dns"},SetWPPending=!1,WPPendingTarget=null,GribWindController=null,map=null,VLMBoatsLayer=null,Rankings=[],PilototoFt=null,RankingFt=null,RaceHistFt=null,ICS_WPft=null,NSZ_WPft=null,VLMINdexFt=null,RC_PwdResetReq=null,RC_PwdResetConfirm=null,OnPlayerLoadedCallBack=null;$(document).ready(function(){$.ajaxSetup({error:function(e,t,a){401===e.status||403===e.status?window.location.replace("/"):404===e.status||VLMAlertDanger("An error occurred: "+t+"nError: "+a)}}),InitLocale(),InitMenusAndButtons(),PolarsManager.Init(),InitAlerts();var e=CheckPageParameters();setInterval(PageClock,1e3),e||(CheckLogin(),LeafletInit(),setTimeout(function(){map.GribMap=(new GribMap.Layer).addTo(map)},500)),GetFlagsList()});var COMPASS_SIZE=350;function LeafletInit(){map=L.map("jVlmMap").setView([0,0],8);var e=tileUrlSrv;L.tileLayer(e,{attribution:"gshhsv2",maxZoom:20,tms:!1,id:"vlm",detectRetina:!0,subdomains:tilesUrlArray}).addTo(map),map.WMControl=L.control.WindMouseControl().addTo(map),DrawCompass(),map.on("mousemove",HandleMapMouseMove),map.on("moveend",HandleMapGridZoom),map.on("click",HandleMapMouseClick),map.on("zoomend",HandleMapGridZoom)}function DrawCompass(){VLM2Prefs.MapPrefs.ShowCompass?map.Compass?(map.Compass.addTo(map),map.Compass.on("dragend",HandleCompassDragEnd),map.Compass.on("mousemove",HandleCompassMouseMove),map.Compass.on("mouseout",HandleCompassMouseOut)):(map.Compass=new L.marker([0,0],{icon:new L.icon({iconSize:[350,341],iconAnchor:[175,170],iconUrl:"images/compas-transparent.gif"}),draggable:!0}).addTo(map),map.Compass.on("dragend",HandleCompassDragEnd),map.Compass.on("mousemove",HandleCompassMouseMove),map.Compass.on("mouseout",HandleCompassMouseOut)):map.Compass&&(map.Compass.off("dragend",HandleCompassDragEnd),map.Compass.off("mousemove",HandleCompassMouseMove),map.Compass.off("mouseout",HandleCompassMouseOut),map.Compass.remove())}function HandleCompassMouseOut(e){map.Compass.dragging.enable()}function HandleCompassMouseMove(e){var t=map.getZoom(),a=map.project(map.Compass.getLatLng(),t),o=map.project(map.mouseEventToLatLng(e.originalEvent),t),n=a.x-o.x,i=a.y-o.y;n*n+i*i<COMPASS_SIZE*COMPASS_SIZE/8?map.Compass.dragging.disable():map.Compass.dragging.enable()}function HandleCompassDragEnd(e){if(_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.VLMInfo.LAT&&_CurPlayer.CurBoat.VLMInfo.LON){var t=_CurPlayer.CurBoat,a=[_CurPlayer.CurBoat.VLMInfo.LAT,_CurPlayer.CurBoat.VLMInfo.LON],o=map.Compass.getLatLng(),n=GetRaceMapFeatures(t);n.Compass||(n.Compass={});var i=map.getZoom(),r=map.project(a,i),s=map.project(o,i);Math.abs(r.x-s.x)<BOAT_MARKET_SIZE/2&&Math.abs(r.y-s.y)<BOAT_MARKET_SIZE/2?(n.Compass.Lat=-1,n.Compass.Lon=-1):(n.Compass.Lat=o.lat,n.Compass.Lon=o.lng)}}function HandleMapGridZoom(e){var t=e.sourceTarget,a=(t.getZoom(),t.getBounds()),o=a._northEast.lng-a._southWest.lng,n=a._northEast.lat-a._southWest.lat,i=o;n<o&&(i=n),(i=Math.pow(.25,Math.ceil(Math.log(i)/Math.log(.25))))>5?i=Math.pow(5,Math.floor(Math.log(i)/Math.log(5))):i<.25&&(i=.25),void 0===t.GridLayer?(t.Grid=[],t.GridLayer=L.layerGroup().addTo(t)):t.GridLayer.clearLayers();for(var r={weight:1,opacity:.4,color:"black"},s={permanent:!0,opacity:.4,offset:[0,-10]},l={permanent:!0,opacity:.4,offset:[0,30]},c={permanent:!0,opacity:.4,offset:[10,0]},d={permanent:!0,opacity:.4,offset:[-10,0]},u=0,p=Math.floor(a._southWest.lng);p<=a._northEast.lng;p+=i){var h=[[a._southWest.lat,p],[a._northEast.lat,p]];t.Grid[u]=L.polyline(h,r),t.GridLayer.addLayer(t.Grid[u++]);var P=RoundPow(4*p,0)/4;t.Grid[u]=L.circleMarker(h[0],{radius:1}).bindTooltip(""+P,s),t.GridLayer.addLayer(t.Grid[u++]),t.Grid[u]=L.circleMarker(h[1],{radius:1}).bindTooltip(""+P,l),t.GridLayer.addLayer(t.Grid[u++])}for(var f=Math.floor(a._southWest.lat);f<=a._northEast.lat;f+=i){var g=[[f,a._southWest.lng],[f,a._northEast.lng]],M=RoundPow(4*f,0)/4;t.Grid[u]=L.polyline(g,r),t.GridLayer.addLayer(t.Grid[u]),t.Grid[u]=L.circleMarker(g[0],{radius:1}).bindTooltip(""+M,c),t.GridLayer.addLayer(t.Grid[u++]),t.Grid[u]=L.circleMarker(g[1],{radius:1}).bindTooltip(""+M,d),t.GridLayer.addLayer(t.Grid[u++])}}var PasswordResetInfo=[];function HandlePasswordResetLink(e){PasswordResetInfo=unescape(e).split("|"),initrecaptcha(!1,!0),$("#ResetaPasswordConfirmation").modal("show")}function CheckPageParameters(){var e=!1,t=window.location.search,a=!0;if(t){var o=t.split("?")[1].split("&");for(var n in o)o[n]&&function(){var t=o[n].split("=");switch(t[0]){case"PwdResetKey":HandlePasswordResetLink(t[1]);break;case"RaceRank":a=!1,RankingFt.OnReadyTable=function(){HandleShowOtherRaceRank(t[1])},e=!0;break;case"VLMIndex":a=!1,VLMINdexFt.OnReadyTable=function(){HandleShowIndex(t[1])},e=!0;break;case"ICSRace":a=!1,HandleShowICS(t[1]),e=!0}}()}return e||(a?($(".RaceNavBar").css("display","inherit"),$(".OffRaceNavBar").css("display","none")):($(".RaceNavBar").css("display","none"),$(".OffRaceNavBar").css("display","inherit"),ShowApropos(!1))),e}function HandleShowICS(e){LoadRaceInfo(e,null,function(e){e&&(FillRaceInstructions(e),$("#RacesInfoForm").modal("show"))})}function LoadRaceInfo(e,t,a){t||(t=""),$.get("/ws/raceinfo/desc.php?idrace="+e+"&v="+t,a)}function HandleVLMIndex(e){if(e){var t;$("#Ranking-Panel").show();var a=1;for(t in e)e[t]&&(e[t].rank=a,e[t].vlmindex='<span data-toggle="tooltip" title="'+e[t].vlmindex+'">'+parseInt(e[t].vlmindex,10)+"</span>",a++);BackupVLMIndexTable(),VLMINdexFt.loadRows(e),$("#DivVlmIndex").removeClass("hidden"),$("#RnkTabsUL").addClass("hidden"),$("#DivRnkRAC").addClass("hidden")}}function HandleShowIndex(e){var t=HandleVLMIndex;$.get("/cache/rankings/VLMIndex_"+e+".json",t)}function HandleShowOtherRaceRank(e){RankingFt.RaceRankingId=e,LoadRaceInfo(e,0,function(e){FillRaceInfoHeader(e)}),LoadRankings(e,OtherRaceRankingLoaded)}function OtherRaceRankingLoaded(e){$("#Ranking-Panel").show(),SortRanking("RAC",0,e),console.log("off race ranking loaded")}function initrecaptcha(e,t){e&&!RC_PwdResetReq&&(RC_PwdResetReq=grecaptcha.render("recaptcha-PwdReset1")),t&&!RC_PwdResetConfirm&&(RC_PwdResetConfirm=grecaptcha.render("recaptcha-PwdReset2"))}function HandleShowServerInfoModal(e){$("ServerInfo").show()}function InitMenusAndButtons(){function e(){var e=$(window).width(),t=.12*$(window).width(),a=$(".VLMSplash").height()-t-180;$(".VLMSplashUpperFiller").css("height",t),$(".VLMSplashSmall").css("height",e).css("background-position-y",.1*$(window).width()),$(".Apropos-text").css("max-height",a)}$("div.vresp.modal").on("show.bs.modal",function(){$(this).show(),setModalMaxHeight(this)}),$("#ServerStatsLink").click(HandleShowServerInfoModal),e(),$(window).resize(function(){e(),0!=$(".modal.in").length&&setModalMaxHeight($(".modal.in"))}),$("#BtnChangePassword").on("click",function(e){e.preventDefault(),HandlePasswordChangeRequest(e)}),$("#ResetPasswordButton").on("click",function(e){null!==RC_PwdResetReq&&grecaptcha.execute(RC_PwdResetReq)}),$("#ConfirmResetPasswordButton").on("click",function(e){null!==RC_PwdResetConfirm&&grecaptcha.execute(RC_PwdResetConfirm)}),$("#LoginForm").on("show.bs.modal",function(e){ShowApropos(!1)}),$("#LoginForm").on("hide.bs.modal",function(e){ShowApropos(!1)}),$(".logindlgButton").on("click",function(e){$("#LoginForm").modal("show")}),$(".logOutButton").on("click",function(e){Logout()}),$("#Menu").menu(),$("#Menu").hide(),$("input[type=submit],button").button().click(function(e){e.preventDefault()}),$(".JVLMTabs").tabs(),HidePb("#PbLoginProgress"),HidePb("#PbGetBoatProgress"),HidePb("#PbGribLoginProgress"),$(".BCPane.WP_PM_Mode").click(function(){MoveWPBoatControlerDiv("#"+$(this)[0].classList[2])}),$(".BtnRaceList").click(function(){LoadRacesList(),$("#RacesListForm").modal("show")}),InitRankingEvents(),$("#LoginButton").click(function(){OnLoginRequest()}),$("#LoginPanel").keypress(function(e){"13"===e.which&&(OnLoginRequest(),$("#LoginForm").modal("hide"))}),$("#BtnSetting").click(function(){LoadVLMPrefs(),SetDDTheme(VLM2Prefs.CurTheme),$("#SettingsForm").modal("show")}),$("#SettingValidateButton").click(SaveBoatAndUserPrefs),$("#SettingCancelButton").click(function(){LoadVLMPrefs(),SetDDTheme(VLM2Prefs.CurTheme),$("#SettingsForm").modal("show")}),$("#SettingValidateButton").click(SaveBoatAndUserPrefs),$("#SettingCancelButton").click(function(){SetDDTheme(VLM2Prefs.CurTheme)}),$("#BtnPM_Heading").click(function(){SendVLMBoatOrder(PM_HEADING,$("#PM_Heading")[0].value)}),$("#BtnPM_Angle").click(function(){SendVLMBoatOrder(PM_ANGLE,$("#PM_Angle")[0].value)}),$("#BtnPM_Tack").click(function(){$("#PM_Angle")[0].value=-$("#PM_Angle")[0].value}),$("#BtnCreateAccount").click(function(){HandleCreateUser()}),$(".CreatePassword").pstrength(),$("#NewPlayerEMail").blur(function(e){$("#NewPlayerEMail").verimail({messageElement:"#verimailstatus",language:_CurLocale})}),$("#InscriptForm").on("shown.bs.modal",function(){$(this).find("div.modal-body :input").val("")}),$("#SetWPOnClick").click(HandleStartSetWPOnClick),$("#SetWPOffClick").click(HandleCancelSetWPOnClick),HandleCancelSetWPOnClick(),$("body").on("click",".PIL_EDIT",HandlePilotEditDelete),$("body").on("click",".PIL_DELETE",HandlePilotEditDelete),$("#AutoPilotAddButton").click(HandleOpenAutoPilotSetPoint),$("#AP_SetTargetWP").click(HandleClickToSetWP),$("#AP_Time").datetimepicker({locale:_CurLocale,format:"DD MM YYYY, HH:mm:ss"}),$("#AP_Time").on("dp.change",HandleDateChange),$("#APValidateButton").click(HandleSendAPUpdate),$(".APField").on("change",HandleAPFieldChange),$(".APMode").on("click",HandleAPModeDDClick),$(".Draggable").draggable({handle:".modal-header,.modal-body"}),$("#MapPrefsToggle").click(HandleShowMapPrefs),$(".chkprefstore").on("change",HandleMapPrefOptionChange),$(".MapOppShowLi").click(HandleMapOppModeChange),$(".DDTheme").click(HandleDDlineClick),$("#StartEstimator").on("click",HandleStartEstimator),$("#EstimatorStopButton").on("click",HandleStopEstimator),InitGribSlider(),InitFootables(),$(document.body).on("click",".RaceHistLink",function(e){HandleShowBoatRaceHistory(e)}),$("[PilRefresh]").on("click",HandleUpdatePilototoTable),$("#HistRankingButton").on("click",function(e){ShowUserRaceHistory(e,_CurPlayer.CurBoat.IdBoat)}),$(".RaceListTab").on("click",function(e){ShowUserRaceHistory(e,_CurPlayer.CurBoat.IdBoat)}),$(".RaceListFormTab").on("click",function(e){FillRacesListForm(e)}),$("#BtnPM_Ortho, #BtnPM_VMG, #BtnPM_VBVMG").click(function(){var e,t=PM_ORTHO,a=$("#PM_Lat")[0].value,o=$("#PM_Lon")[0].value;switch(e=parseInt($("#PM_WPHeading")[0].value,10),$(this)[0].id){case"BtnPM_Ortho":t=PM_ORTHO;break;case"BtnPM_VMG":t=PM_VMG;break;case"BtnPM_VBVMG":t=PM_VBVMG}SendVLMBoatOrder(t,o,a,e)}),$("#CalendarPanel").on("shown.bs.modal",function(e){HandleShowAgenda()}),$(".BoatSelectorDropDownList").on("click",HandleBoatSelectionChange),$("#cp11").colorpicker({useAlpha:!1,format:!1}),$(document.body).on("click",".ShowICSButton",function(e){HandleFillICSButton(e)}),$(document.body).on("click",".ShowRaceInSpectatorMode",function(e){HandleGoToRaceSpectator(e)}),$("#PolarTab").on("click",HandlePolarTabClik),UpdateVersionLine()}function InitRankingEvents(){$(document.body).on("click",".RankingButton",function(e){var t=$(e.currentTarget).attr("IdRace");void 0!==t&&t&&window.open("/jvlm?RaceRank="+t,"RankTab")}),$(document.body).on("click","[RnkSort]",function(e){HandleRaceSortChange(e)}),$("#Ranking-Panel").on("show.bs.collapse",function(e){ResetRankingWPList(e)})}function UpdateVersionLine(){var e=new moment(BuildDate);$("#BuildDate").text("Build : "+e.fromNow()),$('[data-toggle="tooltip"]').tooltip()}var _CachedRaceInfo=null;function HandlePolarTabClik(){_CachedRaceInfo&&DrawPolar(_CachedRaceInfo)}function InitPolar(e){_CachedRaceInfo=e}function HandleGoToRaceSpectator(e){if(void 0!==e&&e){e.target;var t=$(e.currentTarget).attr("idRace");if(void 0!==t&&t)return void window.open("/guest_map/index.html?idr="+t,"Spec_"+t)}}function HandleFillICSButton(e){if(void 0!==e&&e){e.target;var t=$(e.currentTarget).attr("idRace");if(void 0!==t&&t)return void HandleShowICS(t)}void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&FillRaceInstructions(_CurPlayer.CurBoat.RaceInfo)}var VLMAgenda=null;function HandleShowAgenda(){VLMAgenda&&VLMAgenda.destroy();var e=jQuery("#Calendar")[0];(VLMAgenda=new FullCalendar.Calendar(e,{plugins:["dayGrid"],locale:_CurLocale,editable:!1,header:{left:"title",center:"",right:"today prev,next"},firstDay:1,events:"/feed/races.fullcalendar.php",data:function(){return{jvlm:1}},timeFormat:"H:mm",loading:function(e){e?jQuery("#loading").show():jQuery("#loading").hide()}})).render(),$("#Infos").modal("hide")}function HandlePasswordChangeRequest(e){var t=$("#CurPassword")[0].value,a=$("#NewPassword1")[0].value,o=$("#NewPassword2")[0].value;if($(".Password").val(""),t&&""!==t)if(a===o)if(""!==a){var n={OldPwd:t,NewPwd:a};$.post("/ws/playersetup/password_change.php","parms="+JSON.stringify(n),function(e){HandlePasswordChangeResult(e)})}else VLMAlertDanger(GetLocalizedString("NewPwdRequired"));else VLMAlertDanger(GetLocalizedString("CurPwdRequired"));else VLMAlertDanger(GetLocalizedString("CurPwdRequired"))}function HandlePasswordChangeResult(e){e.success?VLMAlertInfo():VLMAlertDanger(GetLocalizedString(e.error.msg))}function SendResetPassword(e){PasswordResetInfo[0],PasswordResetInfo[1];$.get("/ws/playersetup/password_reset.php?email="+PasswordResetInfo[0]+"&seed="+PasswordResetInfo[1]+"&key="+e,function(e){HandlePasswordReset(e,!0)})}function SendResetPasswordLink(e){var t=$(".UserName").val();if(""===t)return VLMAlertDanger(GetLocalizedString("Enter your email for resetting your password")),void grecaptcha.reset(RC_PwdResetReq);var a={email:t,key:e};$.post("/ws/playersetup/password_reset.php","parms="+JSON.stringify(a),function(e){HandlePasswordReset(e,!1)})}function HandlePasswordReset(e,t){e.success?t?(VLMAlertInfo(GetLocalizedString("Check your inbox to get your new password.")),grecaptcha.reset(RC_PwdResetReq)):(VLMAlertInfo(GetLocalizedString("An email has been sent. Click on the link to validate.")),grecaptcha.reset(RC_PwdResetConfirm)):(VLMAlertDanger("Something went wrong :("),grecaptcha.reset(RC_PwdResetReq),grecaptcha.reset(RC_PwdResetConfirm))}function InitFooTable(e){var t=FooTable.init("#"+e,{name:e,on:{"ready.ft.table":HandleReadyTable,"after.ft.paging":HandlePagingComplete,"postdraw.ft.table":HandleTableDrawComplete}});return t.DrawPending=!0,t.CallbackPending=null,t}function InitFootables(){$("#DiscontinueRaceButton").on("click",HandleDiscontinueRaceRequest),PilototoFt=InitFooTable("PilototoTable"),RankingFt=InitFooTable("RankingTable"),RaceHistFt=InitFooTable("BoatRaceHist"),ICS_WPft=InitFooTable("RaceWayPoints"),NSZ_WPft=InitFooTable("NSZPoints"),VLMINdexFt=InitFooTable("VLMIndexTable")}function HandleUpdatePilototoTable(e){UpdatePilotInfo(_CurPlayer.CurBoat)}function InitSlider(e,t,a,o,n,i){var r=$("#"+t);$("#"+e).slider({orientation:"vertical",min:a,max:o,value:n,create:function(){r.text($(this).slider("value"))},slide:function(e,t){i(e,t)}})}function InitGribSlider(){InitSlider("GribSlider","GribSliderHandle",0,72,0,HandleGribSlideMove)}function HandleRaceSortChange(e){var t=$(e.currentTarget).attr("rnksort");switch(t){case"WP":RankingFt.DrawPending||SortRanking(t,$(e.currentTarget).attr("WPRnk"));break;case"DNF":case"HTP":case"HC":case"ABD":case"RAC":case"ARR":SortRanking(t);break;default:console.log("Sort change request"+e)}}function HandleGribSlideMove(e,t){if(void 0!==map.GribMap){$("#GribSliderHandle").text(t.value);var a=(new Date).getTime();if(map.GribMap.SetGribMapTime(a+36e5*t.value),VLM2Prefs.MapPrefs.TrackEstForecast&&_CurPlayer.CurBoat.Estimator)RefreshEstPosLabels(_CurPlayer.CurBoat.GetClosestEstimatePoint(new Date(a+3600*t.value*1e3))),StartEstimateTimeout()}}function HandleDiscontinueRaceRequest(){GetUserConfirmation(GetLocalizedString("unsubscribe"),!0,HandleRaceDisContinueConfirmation)}function HandleRaceDisContinueConfirmation(e){e?(DiconstinueRace(_CurPlayer.CurBoat.IdBoat,_CurPlayer.CurBoat.Engaged),$("#ConfirmDialog").modal("hide"),$("#RacesInfoForm").modal("hide")):VLMAlertDanger("Ouf!")}function HandleStopEstimator(e){var t=_CurPlayer.CurBoat;void 0!==t&&t&&t.Estimator.Stop()}function HandleStartEstimator(e){var t=_CurPlayer.CurBoat;if(void 0!==t&&t){var a=GetRaceMapFeatures(t);if(a)for(var o in a.PilotMarkers)a.PilotMarkers[o]&&(a.PilotMarkers[o].remove(),a.PilotMarkers[o].unbindPopup(a.PilotMarkers[o].getPopup()));t.Estimator.Start(HandleEstimatorProgress)}}function HandleEstimatorProgress(e,t,a){var o=_CurPlayer.CurBoat.Estimator;o&&(e?($("#StartEstimator").removeClass("hidden"),$("#PbEstimatorProgressBar").addClass("hidden"),$("#EstimatorStopButton").addClass("hidden"),o.LastPctRefresh=-1,o.LastPctDraw=-1,DrawBoat(_CurPlayer.CurBoat)):t-o.LastPctRefresh>.25?($("#EstimatorStopButton").removeClass("hidden"),$("#StartEstimator").addClass("hidden"),$("#PbEstimatorProgressBar").removeClass("hidden"),$("#PbEstimatorProgressText").removeClass("hidden"),$("#PbEstimatorProgressText").text(t),$("#PbEstimatorProgress").css("width",t+"%"),$("#PbEstimatorProgress").attr("aria-valuenow",t),$("#PbEstimatorProgress").attr("aria-valuetext",t),o.LastPctRefresh=t):t-o.LastPctDraw>1&&(DrawBoatEstimateTrack(_CurPlayer.CurBoat,GetRaceMapFeatures(_CurPlayer.CurBoat)),o.LastPctDraw=t))}function HandleFlagLineClick(e){SelectCountryDDFlag(e.target.attributes.flag.value)}function HandleCancelSetWPOnClick(){SetWPPending=!1,$("#SetWPOnClick").show(),$("#SetWPOffClick").hide()}function HandleStartSetWPOnClick(){SetWPPending=!0,WPPendingTarget="WP",$("#SetWPOnClick").hide(),$("#SetWPOffClick").show()}function ClearBoatSelector(){$(".BoatSelectorDropDownList").empty()}function AddBoatToSelector(e,t){BuildUserBoatList(e,t)}function BuildUserBoatList(e,t){$(".BoatSelectorDropDownList").append(GetBoatDDLine(e,t))}function GetBoatDDLine(e,t){var a='<li class="DDLine" BoatID="'+e.IdBoat+'">';return a=a+GetBoatInfoLine(e,t)+"</li>"}function GetBoatInfoLine(e,t){var a="",o="racing";return e.Engaged||(o="Docked"),void 0!==e.VLMInfo&&e.VLMInfo["S&G"]&&(o="stranded"),t||(a+='<span class="badge">BS'),a=a+'<img class="BoatStatusIcon" src="images/'+o+'.png" />',t||(a+="</span>"),a=a+"<span>-</span><span>"+HTMLDecode(e.BoatName)+"</span>"}function ShowBgLoad(){$("#BgLoadProgress").css("display","block")}function HideBgLoad(){$("#BgLoadProgress").css("display","block")}function ShowPb(e){$(e).show()}function HidePb(e){$(e).hide()}function DisplayLoggedInMenus(e){var t,a;e?(t="block",a="none"):(t="none",a="block"),$("[LoggedInNav='true']").css("display",t),$("[LoggedInNav='false']").css("display",a),void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.IsAdmin?$("[AdminNav='true']").css("display","block"):$("[AdminNav='true']").css("display","none"),ShowApropos(e)}function ShowApropos(e){e?($(".VLMSplash").css("visibility","hidden"),$(".MapContainer").css("visibility","visible")):($(".VLMSplash").css("visibility","visible"),$(".MapContainer").css("visibility","hidden"))}function HandleRacingDockingButtons(e){e?($('[RacingBtn="true"]').removeClass("hidden"),$('[RacingBtn="false"]').addClass("hidden")):($('[RacingBtn="true"]').addClass("hidden"),$('[RacingBtn="false"]').removeClass("hidden"))}function UpdateInMenuDockingBoatInfo(e){HandleRacingDockingButtons(void 0!==e&&void 0!==e.VLMInfo&&parseInt(e.VLMInfo.RAC,10))}function SetTWASign(e){var t=e.VLMInfo.TWD,a=e.VLMInfo.HDG,o=t-a;o<-180&&(o+=360),o>180&&(o-=360);o*e.VLMInfo.TWA>0&&(e.VLMInfo.TWA=-e.VLMInfo.TWA)}function UpdateInMenuRacingBoatInfo(e,t){if(e&&void 0!==e){HandleRacingDockingButtons(!0),SetTWASign(e),"2"===e.VLMInfo.PIM&&"0"===e.VLMInfo.PIP&&(e.VLMInfo.HDG=e.VLMInfo.TWD,e.VLMInfo.BSP=0),e.VLMInfo?($(".NWPBadge").css("visibility","visible"),$(".NWPBadge").text(e.VLMInfo.NWP)):$(".NWPBadge").css("visibility","hidden");var a=new Coords(e.VLMInfo.LON,!0),o=new Coords(e.VLMInfo.LAT),n=[];n.push([FIELD_MAPPING_TEXT,"#BoatLon",a.toString()]),n.push([FIELD_MAPPING_TEXT,"#BoatLat",o.toString()]),n.push([FIELD_MAPPING_TEXT,".BoatSpeed",RoundPow(e.VLMInfo.BSP,2)]),n.push([FIELD_MAPPING_TEXT,".BoatHeading",RoundPow(e.VLMInfo.HDG,1)]),n.push([FIELD_MAPPING_VALUE,"#PM_Heading",RoundPow(e.VLMInfo.HDG,VLM2Prefs.InputDigits)]),n.push([FIELD_MAPPING_TEXT,"#BoatAvg",RoundPow(e.VLMInfo.AVG,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatDNM",RoundPow(e.VLMInfo.DNM,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatLoch",RoundPow(e.VLMInfo.LOC,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatOrtho",RoundPow(e.VLMInfo.ORT,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatLoxo",RoundPow(e.VLMInfo.LOX,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatVMG",RoundPow(e.VLMInfo.VMG,1)]),n.push([FIELD_MAPPING_TEXT,".BoatWindSpeed",RoundPow(e.VLMInfo.TWS,1)]),n.push([FIELD_MAPPING_TEXT,"#BoatWindDirection",RoundPow(e.VLMInfo.TWD,1)]),n.push([FIELD_MAPPING_CHECK,"#PM_WithWPHeading","-1.0"!==e.VLMInfo["H@WP"]]),n.push([FIELD_MAPPING_TEXT,"#RankingBadge",e.VLMInfo.RNK]),n.push([FIELD_MAPPING_VALUE,"#PM_WPHeading",e.VLMInfo["H@WP"]]),n.push([FIELD_MAPPING_TEXT,".BoatClass",e.VLMInfo.POL.substring(5)]),n.push([FIELD_MAPPING_TEXT,".RaceName",e.VLMInfo.RAN]);var i=new VLMPosition(e.VLMInfo.WPLON,e.VLMInfo.WPLAT);n.push([FIELD_MAPPING_VALUE,"#PM_Lat",i.Lat.Value]),n.push([FIELD_MAPPING_VALUE,"#PM_Lon",i.Lon.Value]),0===i.Lon.Value&&0===i.Lat.Value&&(i=e.GetNextWPPosition()),void 0!==i&&i?(n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLat",i.Lat.toString()]),n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLon",i.Lon.toString()])):(n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLat","N/A"]),n.push([FIELD_MAPPING_TEXT,"#PM_CurWPLon","N/A"])),parseInt(e.VLMInfo.PIM,10)===PM_ANGLE?(n.push([FIELD_MAPPING_TEXT,".BoatWindAngle",RoundPow(Math.abs(e.VLMInfo.PIP),1)]),n.push([FIELD_MAPPING_VALUE,"#PM_Angle",RoundPow(e.VLMInfo.PIP,VLM2Prefs.InputDigits)])):(n.push([FIELD_MAPPING_TEXT,".BoatWindAngle",RoundPow(Math.abs(e.VLMInfo.TWA),1)]),n.push([FIELD_MAPPING_VALUE,"#PM_Angle",RoundPow(e.VLMInfo.TWA,VLM2Prefs.InputDigits)])),FillFieldsFromMappingTable(n);var r="lime";e.VLMInfo.TWA>0&&(r="red"),$(".BoatWindAngle").css("color",r);var s=Math.round(100*(e.VLMInfo.TWD+180))/100,l=(Math.round(100*e.VLMInfo.TWS),e.VLMInfo.POL),c=Math.round(100*e.VLMInfo.HDG)/100,d=Math.round(100*e.VLMInfo.TWS)/100,u=Math.round(100*e.VLMInfo.ORT)/100;$("#ImgWindAngle").attr("src","windangle.php?wheading="+s+"&boatheading="+c+"&wspeed="+d+"&roadtoend="+u+"&boattype="+l+"&jvlm="+e.VLMInfo.NOW),$("#ImgWindAngle").css("transform","rotate("+s+"deg)"),$("#DeckImage").css("transform","rotate("+c+"deg)"),$(".PMActiveMode").css("display","none"),$(".BCPane").removeClass("active");var p=".ActiveMode_",h="";switch(e.VLMInfo.PIM){case"1":p+="Heading",h="BearingMode";break;case"2":p+="Angle",h="AngleMode";break;case"3":p+="Ortho",h="OrthoMode";break;case"4":p+="VMG",h="VMGMode";break;case"5":p+="VBVMG",h="VBVMGMode";break;default:VLMAlert("Unsupported VLM PIM Mode, expect the unexpected....","alert-info")}$(p).css("display","inline"),$("."+h).addClass("active"),$("#"+h).addClass("active"),UpdatePilotInfo(e),UpdatePolarImages(e)}}function FillFieldsFromMappingTable(e){for(var t in e)if(e[t])switch(e[t][0]){case FIELD_MAPPING_TEXT:$(e[t][1]).text(e[t][2]);break;case FIELD_MAPPING_VALUE:$(e[t][1]).val(e[t][2]);break;case FIELD_MAPPING_CHECK:$(e[t][1]).prop("checked",e[t][2]);break;case FIELD_MAPPING_IMG:$(e[t][1]).attr("src",e[t][2]);break;case FIELD_MAPPING_CALLBACK:e[t][2](e[t][1]);break;case FIELD_MAPPING_STYLE:$(e[t][1]).css(e[t][2],e[t][3])}}function FillRaceInstructions(e){if(void 0!==e&&e){var t=!0;void 0!==_CurPlayer&&_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&(t=_CurPlayer.CurBoat.RaceInfo.idraces!==e.idraces),t?$("#DiscontinueRaceTab").addClass("hidden"):$("#DiscontinueRaceTab").removeClass("hidden");FillRaceInfoHeader(e),FillRaceWaypointList(e),InitPolar(e),$.get("/ws/raceinfo/exclusions.php?idr="+e.idraces+"&v="+e.VER,function(e){e&&e.success&&FillNSZList(e.Exclusions)})}}var PolarSliderInited=!1;function FillRaceInfoHeader(e){if(void 0!==e&&e){var t=[];t.push([FIELD_MAPPING_TEXT,".ICSRaceName",e.racename]),t.push([FIELD_MAPPING_TEXT,".RaceId",e.idraces]),t.push([FIELD_MAPPING_TEXT,".BoatType",e.boattype.substring(5)]),t.push([FIELD_MAPPING_TEXT,".VacFreq",parseInt(e.vacfreq,10)]),t.push([FIELD_MAPPING_TEXT,"#LockTime",parseInt(e.coastpenalty,10)/60]),t.push([FIELD_MAPPING_TEXT,"#EndRace",parseInt(e.firstpcttime,10)]),t.push([FIELD_MAPPING_TEXT,"#RaceStartDate",GetLocalUTCTime(1e3*parseInt(e.deptime,10),!0,!0)]),t.push([FIELD_MAPPING_TEXT,"#RaceLineClose",GetLocalUTCTime(1e3*parseInt(e.closetime,10),!0,!0)]),t.push([FIELD_MAPPING_IMG,"#RaceImageMap","/cache/racemaps/"+e.idraces+".png"]),FillFieldsFromMappingTable(t)}}function HandlePolarSpeedSlide(e,t,a){$("#PolarSpeedHandle").text(t.value),DrawPolar(a)}function DrawPolar(e){var t=$("#PolarCanvas")[0],a=25;PolarSliderInited&&(a=parseFloat($("#PolarSpeedHandle").text()));var o=PolarsManager.GetPolarLine(e.boattype,a,function(){DrawPolar(e)},null,1);if(o){PolarSliderInited||(InitSlider("PolarSpeedSlider","PolarSpeedHandle",0,60,a,function(t,a){HandlePolarSpeedSlide(t,a,e)}),PolarSliderInited=!0),t.width=$("#PolarCanvas").width(),t.height=t.width;var n,i,r=t.getContext("2d"),s=!0,l=Math.PI/o.length,c=t.width/2,d=t.width/2,u=PolarsManager.GetPolarMaxSpeed(e.boattype,a),p=0,h=!0;for(var P in r.beginPath(),r.lineWidth="1",r.strokeStyle="#FF0000",o)if(o[P]){var f=o[P],g=(P=parseInt(P,10))*l,L=c+d*f*Math.cos(g),M=3+d*f*Math.sin(g),m=Math.cos(g+0)*f;h&&m<=p?(r.stroke(),r.beginPath(),r.moveTo(n,i),r.strokeStyle="#FFFFFF",h=!1):!h&&m>=p&&(r.stroke(),r.beginPath(),r.moveTo(n,i),r.strokeStyle="#FF0000",h=!0),p=m,s?(r.moveTo(M,L),s=!1):r.lineTo(M,L),n=M,i=L}r.stroke(),r.beginPath(),r.lineWidth="1",r.strokeStyle="#00FF00",r.moveTo(3,0),r.lineTo(3,t.height),r.stroke(),r.moveTo(2,t.height/2),r.lineTo(3+t.width,t.height/2),r.stroke();var C=Math.round(u/5);C||(C=1);for(var v=1;C*v-1<=u;v++)r.beginPath(),r.strokeStyle="#7FFFFF",r.arc(3,c,d*v*C/u,Math.PI/2,1.5*Math.PI,!0),r.stroke(),r.strokeText(" "+C*v,4+C*d*v/u,c+10)}}function UpdatePolarImages(e){var t,a=e.VLMInfo.POL.substring(5),o="";for(t=0;t<=45;t+=15)o+='<li><img class="polaire" src="/scaledspeedchart.php?boattype=boat_'+a+"&amp;minws="+t+"&amp;maxws="+(t+15)+'&amp;pas=2" alt="speedchart"></li>';$("#PolarList").empty(),$("#PolarList").append(o)}function BackupFooTable(e,t,a){e.DOMBackup?void 0===$(t)[0]&&($(e.RestoreId).append(e.DOMBackup),console.log("Restored footable "+t+" "+new Date)):(e.DOMBackup=$(t),e.RestoreId=a)}function UpdatePilotInfo(e){if(void 0!==e&&e&&!PilototoFt.DrawPending){BackupFooTable(PilototoFt,"#PilototoTable","#PilototoTableInsertPoint");var t=[];if(e&&e.VLMInfo&&e.VLMInfo.PIL&&e.VLMInfo.PIL.length>0){for(var a in e.VLMInfo.PIL)if(e.VLMInfo.PIL[a]){var o=GetPilototoTableLigneObject(e,a);t.push(o)}e.VLMInfo.PIL.length<MAX_PILOT_ORDERS?$("#AutoPilotAddButton").removeClass("hidden"):$("#AutoPilotAddButton").addClass("hidden")}PilototoFt.DrawPending=!0,PilototoFt.loadRows(t,!1),console.log("loaded pilototo table"),UpdatePilotBadge(e)}}function HandleReadyTable(e,t){console.log("Table ready"+t),t.DrawPending=!1,t.OnReadyTable&&t.OnReadyTable()}function HandlePagingComplete(e,t){var a,o={ft_class_myboat:"rnk-myboat",ft_class_friend:"rnk-friend",ft_class_oncoast:"rnk-oncoast",ft_class_racing:"rnk-racing",ft_class_locked:"rnk-locked",ft_class_dns:"rnk-dns"};for(var n in o)o[n]&&$("td").closest("tr").removeClass(o[n]);for(a in o)o[a]&&$('td:contains("'+a+'")').closest("tr").addClass(o[a]);t.DrawPending=!1}function HandleTableDrawComplete(e,t){if(console.log("TableDrawComplete "+t.id),t.DrawPending=!1,t===RankingFt)setTimeout(function(){DeferedGotoPage(e,t)},500);else if(t.CallbackPending)return void setTimeout(function(){t.CallbackPending(),t.CallbackPending=null},500)}function DeferedGotoPage(e,t){RankingFt.TargetPage&&(RankingFt.gotoPage(RankingFt.TargetPage),RankingFt.TargetPage=0),setTimeout(function(){DeferedPagingStyle(e,t)},200)}function DeferedPagingStyle(e,t){HandlePagingComplete(e,t)}function GetPilototoTableLigneObject(e,t){var a=e.VLMInfo.PIL[t],o=GetLocalUTCTime(1e3*a.TTS,!0,!0),n=GetPilotModeName(a.PIM);return t=parseInt(t,10)+1,$("#EditCellTemplate .PIL_EDIT").attr("pil_id",t),$("#DeleteCellTemplate .PIL_DELETE").attr("TID",a.TID).attr("pil_id",t),{date:o,PIM:n,PIP:a.PIP,Status:a.STS,Edit:$("#EditCellTemplate").first().html(),Delete:$("#DeleteCellTemplate").first().html()}}function ShowAutoPilotLine(e,t){var a="#PIL"+t,o=e.VLMInfo.PIL[t-1],n=new Date(1e3*o.TTS),i=GetPilotModeName(o.PIM);if(void 0===$(a)[0]);$(a)[0].attributes.TID=o.TID,SetSubItemValue(a,"#PIL_DATE",n),SetSubItemValue(a,"#PIL_PIM",i),SetSubItemValue(a,"#PIL_PIP",o.PIP),SetSubItemValue(a,"#PIL_STATUS",o.STS),$(a).show()}function GetPILIdParentElement(e){for(var t=e;;){if(void 0===t)return;if("id"in t.attributes){var a=t.attributes.id.value;if(4===a.length&&"PIL"===a.substring(0,3))return t}t=t.parentElement}}function HandlePilotEditDelete(e){var t=$(this)[0],a=t.attributes.class.value,o=_CurPlayer.CurBoat;parseInt(t.attributes.pil_id.value,10);"PIL_EDIT"===a?HandleOpenAutoPilotSetPoint(e):"PIL_DELETE"===a&&DeletePilotOrder(o,t.attributes.TID.value)}function GetPilotModeName(e){switch(parseInt(e,10)){case 1:return GetLocalizedString("autopilotengaged");case 2:return GetLocalizedString("constantengaged");case 3:return GetLocalizedString("orthoengaged");case 4:return GetLocalizedString("bestvmgengaged");case 5:return GetLocalizedString("vbvmgengaged");default:return"PIM ???"+e+"???"}}function SetSubItemValue(e,t,a){var o=$(e).find(t);o.length>0&&o.text(a)}function UpdatePilotBadge(e){var t,a=0;if(void 0!==e&&e){var o=e.VLMInfo.PIL;if(void 0!==o&&o&&o.length)for(t in o)"pending"===o[t].STS&&a++;a>0?($(".PilotOrdersBadge").show(),$(".PilotOrdersBadge").text(a)):$(".PilotOrdersBadge").hide()}}function MoveWPBoatControlerDiv(e){$(e).prepend($("#PM_WPMode_Div"))}function UpdatePrefsDialog(e){if(void 0===e)$("#BtnSetting").addClass("hidden");else if($("#BtnSetting").removeClass("hidden"),$("#pref_boatname").val(e.BoatName),void 0!==e.VLMInfo){SelectCountryDDFlag(e.VLMInfo.CNT);var t=SafeHTMLColor(e.VLMInfo.COL);$("#pref_boatcolor").val(t),$("#cp11").colorpicker({useAlpha:!1,format:!1,color:t})}}var RaceSorterclass=function e(t){_classCallCheck(this,e),this.OldRacesSortMode=!1,t&&(this.OldRacesSortMode=!0),this.sort=function(e,t){return e.CanJoin===t.CanJoin?e.deptime>t.deptime?this.OldRacesSortMode?1:-1:e.deptime===t.deptime?e.racename>t.racename?1:e.racename===t.racename?0:-1:1:e.CanJoin?1:-1}};function FillRacesListForm(e){var t=null;e&&e.currentTarget&&e.currentTarget.value&&(t=100),LoadRacesList(t)}function LoadRacesList(e){var t=0,a=_CurPlayer.CurBoat.IdBoat;$("#RaceListPanel").empty(),$(".racelistpreloader").removeClass("hidden"),$("#BtnMoreOldRaces").addClass("hidden"),e&&(t=e),$.get("/ws/raceinfo/list.php?iduser="+a+"&OldRaces="+t+"&v="+(new Date).getTime(),function(t){var a=t;$("#RaceListPanel").empty();var o=[];for(var n in a)a[n]&&o.push(a[n]);var i=new RaceSorterclass(null!==e);for(var r in o.sort(i.sort.bind(i)),o)o[r]&&AddRaceToList(o[r]);$(".racelistpreloader").addClass("hidden"),e&&($("#BtnMoreOldRaces").removeClass("hidden").value=e);var s=0;$("#RaceListPanel .btn-group .btn-md").each(function(){$(this).height()>s&&(s=$(this).height())}),$("#RaceListPanel .btn-group .btn-md").height(s)})}function AddRaceToList(e){var t,a,o=$("#RaceListPanel").first(),n=(new Date(0),(e.racetype&RACE_TYPE_RECORD)==RACE_TYPE_RECORD),i=-1===e.started;if(_CurPlayer&&_CurPlayer.CurBoat&&_CurPlayer.CurBoat.RaceInfo&&_CurPlayer.CurBoat.RaceInfo.idraces&&(e.CanJoin=e.CanJoin&"0"===_CurPlayer.CurBoat.RaceInfo.idraces),e.CanJoin){var r=new Date;new Date(1e3*e.deptime)<=r?(t="CanJoinRace",a=GetLocalizedString("closerace")+" "+moment("/date("+1e3*e.closetime+")/").fromNow()):(t="CanJoinRaceNotStarted",a=GetLocalizedString("departuredate")+" "+moment("/date("+1e3*e.deptime+")/").fromNow())}else t="NoJoinRace";var s="???";e.boattype&&(s=e.boattype.substring(5));var l='<div class="raceheaderline panel panel-default '+t+'" )>  <div data-toggle="collapse" href="#RaceDescription'+e.idraces+'" class="panel-body collapsed " data-parent="#RaceListPanel" aria-expanded="false">    <div class="col-xs-12">      <div class="col-xs-3">        <img class="racelistminimap" src="/cache/minimaps/'+e.idraces+'.png" ></img>      </div>      <div class="col-xs-9">        <div class="col-xs-12">'+(n?'<span class="PRecordRace">P</span>':"")+'          <span ">'+e.racename+("0"!==e.racelength?" ("+e.racelength+" Nm)":"")+'          </span>        </div>        <div class="btn-group col-xs-12">          <button id="JoinRaceButton" type="button" class="'+(e.CanJoin?"":"hidden")+' btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("subscribe")+'          </button>          <button id="SpectateRaceButton" type="button" class="'+(i?"hidden":"")+'  ShowRaceInSpectatorMode btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("Spectator")+'          </button>          <button type="button" class="ShowICSButton btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("ic")+'          </button>          <button type="button" class="RankingButton btn-default btn-md col-xs-4" IdRace="'+e.idraces+'"  >'+GetLocalizedString("ranking")+"          </button>        </div>      </div>    </div>"+(a?'    <div class="col-xs-12">       <span "> '+a+"       </span>    </div>":"")+'  </div>  <div id="RaceDescription'+e.idraces+'" class="panel-collapse collapse" aria-expanded="false" style="height: 0px;">    <div class="panel-body">      <div class="col-xs-12"><img class="img-responsive" src="/cache/racemaps/'+e.idraces+'.png" width="530px"></div>        <div class="col-xs-12"><p>'+GetLocalizedString("race")+" : "+e.racename+"</p>          <p>Départ : "+GetLocalUTCTime(1e3*e.deptime,!0,!0)+"</p>          <p>"+GetLocalizedString("boattype")+" : "+s+"</p>          <p>"+GetLocalizedString("crank")+" : "+e.vacfreq+"'</p>          <p>"+GetLocalizedString("locktime")+parseInt(e.coastpenalty,10)/60+" '</p>          <p>"+GetLocalizedString("closerace")+GetLocalUTCTime(1e3*e.closetime,!0,!0)+"</p>"+(n?"":(e.RaceCloseDate?"          <p>"+GetLocalizedString("endrace")+GetLocalUTCTime(1e3*e.RaceCloseDate,!0,!0)+"</p>":"          <p>"+GetLocalizedString("endrace")+(100+e.firstpcttime)+"%")+"</p>")+"        </div>      </div>    </div>  </div>";o.prepend(l),$("#JoinRaceButton").click(function(e){EngageBoatInRace(e.currentTarget.attributes.idrace.value,_CurPlayer.CurBoat.IdBoat)})}function PageClock(){if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat){var e=_CurPlayer.CurBoat;if(void 0!==e&&void 0!==e.RaceInfo){var t=GetRaceClock(e.RaceInfo,e.VLMInfo.UDT),a=$(".RaceChrono");t<0?a.removeClass("ChronoRaceStarted").addClass("ChronoRacePending"):a.addClass("ChronoRaceStarted").removeClass("ChronoRacePending"),$("#RefreshAge").text(moment(_CurPlayer.CurBoat.LastRefresh).fromNow());var o=new Date(1e3*e.VLMInfo.LUP),n=e.VLMInfo.VAC,i=n-(new Date-o)/1e3%n;i>=n-1&&100,$("#pbar_innerdivvac").css("width",+Math.round(i%60*100/60)+"px"),$("#pbar_innerdivmin").css("width",Math.round(i/n*100)+"px"),a.text(GetFormattedChronoString(t))}}}function GetRaceClock(e,t){var a=new Date,o=new Date(1e3*e.deptime);if(e.racetype&RACE_TYPE_RECORD){var n=parseInt(t,10);if(-1===n)return 0;var i=new Date(1e3*n);return Math.floor((a-i)/1e3)}return Math.floor((a-o)/1e3)}function DisplayCurrentDDSelectedBoat(e){$(".BoatDropDown:first-child").html("<span BoatID="+e.IdBoat+">"+GetBoatInfoLine(e,e.IdBoat in _CurPlayer.Fleet)+'</span><span class="caret"></span>')}function PadLeftZero(e){return e<100?("00"+e).slice(-2):e}function GetFormattedChronoString(e){if(e<0)e=-e;else if(0===e)return"--:--:--";var t=PadLeftZero(e%60),a=PadLeftZero(Math.floor(e/60)%60),o=PadLeftZero(Math.floor(e/3600)%24),n=PadLeftZero(Math.floor(e/3600/24)),i=o.toString()+":"+a.toString()+":"+t.toString();return n>0&&(i=n.toString()+" d "+i),i}function RefreshCurrentBoat(e,t,a){var o=$(".BoatDropDown > span");void 0!==o&&void 0!==o[0]&&("BoatId"in o[0].attributes||"boatid"in o[0].attributes)&&SetCurrentBoat(GetBoatFromIdu(o[0].attributes.BoatID.value),e,t,a)}function UpdateLngDropDown(){var e=GetCurrentLocale();$("#SelectionLanguageDropDown:first-child").html('<img class=" LngFlag" lang="'+e+'" src="images/lng-'+e+'.png" alt="'+e+'"><span class="caret"></span>')}var _CurAPOrder=null;function HandleOpenAutoPilotSetPoint(e){var t,a=e.target;if("id"in a.attributes)t=a.attributes.id.nodeValue;else{if(!("class"in a.attributes))return void VLMAlert("Something bad has happened reload this page....","alert-danger");t=a.attributes.class.nodeValue}switch(t){case"AutoPilotAddButton":_CurAPOrder=new AutoPilotOrder;break;case"PIL_EDIT":var o=parseInt(a.attributes.pil_id.value,10);_CurAPOrder=new AutoPilotOrder(_CurPlayer.CurBoat,o),$("#AutoPilotSettingForm").modal("show");break;default:return void VLMalert("Something bad has happened reload this page....","alert-danger")}RefreshAPDialogFields()}function RefreshAPDialogFields(){$("#AP_Time").data("DateTimePicker").date(_CurAPOrder.Date),$("#AP_PIM:first-child").html("<span>"+_CurAPOrder.GetPIMString()+'</span><span class="caret"></span>'),$("#AP_PIP").val(_CurAPOrder.PIP_Value),$("#AP_WPLat").val(_CurAPOrder.PIP_Coords.Lat.Value),$("#AP_WPLon").val(_CurAPOrder.PIP_Coords.Lon.Value),$("#AP_WPAt").val(_CurAPOrder.PIP_WPAngle),UpdatePIPFields(_CurAPOrder.PIM)}function HandleDateChange(e){_CurAPOrder.Date=e.date}function HandleClickToSetWP(){SetWPPending=!0,WPPendingTarget="AP",$("#AutoPilotSettingForm").modal("hide")}function HandleAPModeDDClick(e){var t=e.target.attributes.PIM.value;_CurAPOrder.PIM=parseInt(t,10),$("#AP_PIM:first-child").html("<span>"+_CurAPOrder.GetPIMString()+'</span><span class="caret"></span>'),UpdatePIPFields(_CurAPOrder.PIM)}function UpdatePIPFields(e){var t=!0;switch(e){case PM_HEADING:case PM_ANGLE:t=!0;break;case PM_ORTHO:case PM_VMG:case PM_VBVMG:t=!1}t?($(".AP_PIPRow").removeClass("hidden"),$(".AP_WPRow").addClass("hidden")):($(".AP_PIPRow").addClass("hidden"),$(".AP_WPRow").removeClass("hidden"))}function SaveBoatAndUserPrefs(e){var t={},a=!1,o=$("#SelectionThemeDropDown").attr("SelTheme");void 0!==o&&(VLM2Prefs.CurTheme=o),VLM2Prefs.Save(),ComparePrefString($("#pref_boatname")[0].value,_CurPlayer.CurBoat.BoatName)||(t.boatname=encodeURIComponent($("#pref_boatname")[0].value),a=!0),ComparePrefString($("#pref_boatcolor")[0].value,SafeHTMLColor(_CurPlayer.CurBoat.VLMInfo.COL))||(t.color=$("#pref_boatcolor")[0].value.substring(1),a=!0);var n=GetPrefSelFlag();ComparePrefString(n,_CurPlayer.CurBoat.VLMInfo.CNT)||(t.country=encodeURIComponent(n),a=!0),a&&void 0!==_CurPlayer&&_CurPlayer&&UpdateBoatPrefs(_CurPlayer.CurBoat,{prefs:t})}function GetPrefSelFlag(){return $("#CountryDropDown:first-child [flag]")[0].attributes.flag.value}function ComparePrefString(e,t){return e.toString()===t.toString()}function SelectCountryDDFlag(e){$("#CountryDropDown:first-child").html("<div>"+GetCountryDropDownSelectorHTML(e,!1)+'<span class="caret"></span></div>')}function ResetCollapsiblePanels(e){$(".collapse").collapse("hide")}function HandleBoatSelectionChange(e){ResetCollapsiblePanels();var t=GetBoatFromIdu($(e.target).closest("li").attr("BoatID"));void 0!==t&&t?(SetCurrentBoat(t,!0,!1),DisplayCurrentDDSelectedBoat(t)):VLMAlertDanger(GetLocalizedString("Error Reload"))}var LastMouseMoveCall=0,ShowEstTimeOutHandle=null;function HandleMapMouseClick(e){SetWPPending&&("WP"===WPPendingTarget?(CompleteWPSetPosition(e),HandleCancelSetWPOnClick()):"AP"===WPPendingTarget?(SetWPPending=!1,_CurAPOrder.PIP_Coords=new VLMPosition(e.latlng.lng,e.latlng.lat),$("#AutoPilotSettingForm").modal("show"),RefreshAPDialogFields()):SetWPPending=!1)}function HandleMapMouseMove(e){var t=e.latlng;if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat&&void 0!==_CurPlayer.CurBoat.VLMInfo){var a=new VLMPosition(t.lng,t.lat),o=new VLMPosition(_CurPlayer.CurBoat.VLMInfo.LON,_CurPlayer.CurBoat.VLMInfo.LAT),n=_CurPlayer.CurBoat.GetNextWPPosition(),i=null,r=new Date-LastMouseMoveCall>300;if(VLM2Prefs.MapPrefs.EstTrackMouse&&r&&(i=_CurPlayer.CurBoat.GetClosestEstimatePoint(a),LastMouseMoveCall=new Date,clearTimeout(ShowEstTimeOutHandle),StartEstimateTimeout()),$("#MI_Lat").text(a.Lat.toString()),$("#MI_Lon").text(a.Lon.toString()),$("#MI_LoxoDist").text(o.GetLoxoDist(a,2)+" nM"),$("#MI_OrthoDist").text(o.GetOrthoDist(a,2)+" nM"),$("#MI_Loxo").text(o.GetLoxoCourse(a,2)+" °"),$("#MI_Ortho").text(o.GetOrthoCourse(a,2)+" °"),void 0!==n&&n?($("#MI_WPLoxoDist").text(n.GetLoxoDist(a,2)+" nM"),$("#MI_WPOrthoDist").text(n.GetOrthoDist(a,2)+" nM"),$("#MI_WPLoxo").text(n.GetLoxoCourse(a,2)+" °"),$("#MI_WPOrtho").text(n.GetOrthoCourse(a,2)+" °")):($("#MI_WPLoxoDist").text("--- nM"),$("#MI_WPOrthoDist").text("--- nM"),$("#MI_WPLoxo").text("--- °"),$("#MI_WPOrtho").text("--- °")),GribMgr){var s="-- N/A --",l="-- N/A --",c="-- N/A --";if(GribMgr.LastGribDate){s=moment("/date("+1e3*GribMgr.LastGribDate+")/").fromNow();var d=moment("/date("+1e3*GribMgr.TableTimeStamps[0]+")/"),u=moment("/date("+1e3*GribMgr.TableTimeStamps[GribMgr.TableTimeStamps.length-1]+")/"),p=moment.duration(u.diff(d));l=GetLocalUTCTime(d.add(3.5,"h"),!0,!0),c=p.asHours()+" h";var h=(new Date).getTime()/1e3;h-d.local().unix()>25200?$("#GribLoadOK").addClass("GribNotOK"):h-d.local().unix()>21600?$("#GribLoadOK").addClass("GribGetsOld"):$("#GribLoadOK").removeClass("GribNotOK").removeClass("GribGetsOld")}$("#MI_SrvrGribAge").text(s),$("#MI_LocalGribAge").text(l),$("#MI_LocalGribSpan").text(c)}r&&RefreshEstPosLabels(i)}}function StartEstimateTimeout(){ShowEstTimeOutHandle=setTimeout(function(){_CurPlayer.CurBoat.GetClosestEstimatePoint(null),RefreshEstPosLabels(null)},5e3)}function RefreshEstPosLabels(e){e&&void 0!==e.Date?$("#MI_EstDate").text(GetLocalUTCTime(e.Date,!1,!0)):$("#MI_EstDate").text("")}function GetWPrankingLI(e){return'<li id="RnkWP'+e.wporder+'" RnkSort="WP" WPRnk="'+e.wporder+'"><a href="#DivRnkRAC" RnkSort="WP" WPRnk="'+e.wporder+'">WP '+e.wporder+" : "+e.libelle+"</a></li>"}function ResetRankingWPList(e){$("[WPRnk]").remove(),$("#RnkTabsUL").addClass("WPNotInited")}function CheckWPRankingList(e,t){var a=$(".WPNotInited"),o=GetRankingRaceId(e),n=!1;if(void 0!==a&&a&&o)if(void 0!==e&&e&&void 0!==e.RaceInfo&&e.RaceInfo&&o===e.RaceInfo.RaceId)BuildWPTabList(void 0,a),n=!0;else if("object"===_typeof(t)&&t)BuildWPTabList(t,a),n=!0;else{var i=0;void 0!==e&&e&&void 0!==e.VLMInfo&&(i=e.VLMInfo.VER),$.get("/ws/raceinfo/desc.php?idrace="+o+"&v="+i,function(t){CheckWPRankingList(e,t)})}n&&($(a).removeClass("WPNotInited"),$(".JVLMTabs").tabs("refresh"))}function BuildWPTabList(e,t){var a;if(void 0!==t&&t)for(a in void 0!==e&&e||(e=Boat.RaceInfo.races_waypoints),e.races_waypoints)if(e.races_waypoints[a]){var o=GetWPrankingLI(e.races_waypoints[a]);$(t).append(o)}}function SortRanking(e,t,a){var o=null;void 0!==_CurPlayer&&_CurPlayer&&(o=_CurPlayer.CurBoat),CheckWPRankingList(o,a);var n=null;switch(void 0!==o&&o&&o.VLMPrefs&&o.VLMPrefs.mapPrefOpponents&&(n=o.VLMPrefs.mapPrefOpponents.split(",")),e){case"WP":SetRankingColumns(e),SortRankingData(o,e,t=parseInt(t,10)),FillWPRanking(o,t,n);break;case"DNF":case"HC":case"ARR":case"HTP":case"ABD":SetRankingColumns(e),SortRankingData(o,e),FillStatusRanking(o,e,n);break;default:SetRankingColumns("RAC"),SortRankingData(o,"RAC"),FillRacingRanking(o,n)}}function SetRankingColumns(e){switch(e){case"WP":SetWPRankingColumns();break;case"DNF":case"HC":case"ARR":case"HTP":case"ABD":SetNRClassRankingColumns();break;default:SetRacingClassRankingColumns()}}var RACColumnHeader=["Rank","Name","Distance","Time","Loch","Lon","Lat","Last1h","Last3h","Last24h","Delta1st"],NRColumnHeader=["Rank","Name","Distance"],WPColumnHeader=["Rank","Name","Time","Loch"],RACColumnHeaderLabels=["ranking","boatname","distance","racingtime","Loch","Lon","Lat","Last1h","Last3h","Last24h","ecart"],NRColumnHeaderLabels=["ranking","boatname","status"],WPColumnHeaderLabels=["ranking","boatname","racingtime","ecart"];function SetRacingClassRankingColumns(){SetColumnsVisibility(RACColumnHeader,RACColumnHeaderLabels)}function SetNRClassRankingColumns(){SetColumnsVisibility(NRColumnHeader,NRColumnHeaderLabels)}function SetWPRankingColumns(){SetColumnsVisibility(WPColumnHeader,WPColumnHeaderLabels)}function SetColumnsVisibility(e,t){var a;for(a=0;a<RankingFt.columns.array.length;a++)if(RankingFt.columns.array[a]){var o=e.indexOf(RankingFt.columns.array[a].name);o>-1&&$("[data-name='"+e[o]+"']").attr("I18n",t[o]),RankingFt.columns.array[a].visible=o>-1}LocalizeItem($("[I18n][data-name]").get())}function RnkIsArrived(e){return!(void 0===e||void 0===e.status||!e.status)&&-1!==BoatArrivedStatus.indexOf(e.status)}function RnkIsRacing(e){return!(void 0===e||void 0===e.status||!e.status)&&-1!==BoatRacingStatus.indexOf(e.status)}function Sort2ArrivedBoats(e,t){var a=parseInt(e.duration,10)+parseInt(e.penalty,10),o=parseInt(t.duration,10)+parseInt(t.penalty,10);return a>o?(DebugRacerSort(e,t,1),1):a<o?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,0),0)}function Sort2RacingBoats(e,t){var a=parseInt(e.nwp,10),o=parseInt(t.nwp,10);if(a===o){var n=parseFloat(e.dnm),i=parseFloat(t.dnm);if(n>i)return DebugRacerSort(e,t,1),1;if(n===i){DebugRacerSort(e,t,0);var r=e.country>t.country?1:e.country===t.country?0:-1;return r||(e.idusers>t.idusers?1:e.idusers===t.idusers?0:-1)}return DebugRacerSort(e,t,-1),-1}return a>o?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,1),1)}function GetWPDuration(e,t){return e&&e.WP&&e.WP[t-1]&&e.WP[t-1].duration?parseInt(e.WP[t-1].duration,10):9999999999}function WPRaceSort(e){return function(t,a){return GetWPDuration(t,e)-GetWPDuration(a,e)}}function RacersSort(e,t){return RnkIsRacing(e)&&RnkIsRacing(t)?Sort2RacingBoats(e,t):RnkIsArrived(e)&&RnkIsArrived(t)?Sort2ArrivedBoats(e,t):RnkIsArrived(e)?(DebugRacerSort(e,t,-1),-1):RnkIsArrived(t)?(DebugRacerSort(e,t,1),1):RnkIsRacing(e)?(DebugRacerSort(e,t,1),-1):RnkIsRacing(t)?(DebugRacerSort(e,t,1),1):Sort2NonRacing(e,t)}var AlertTemplate,DebugCount=1;function DebugRacerSort(e,t,a){}function Sort2NonRacing(e,t){if(void 0!==e.idusers&&void 0!==t.idusers){var a=e.country>t.country?1:e.country===t.country?0:-1;if(a)return a;var o=parseInt(e.idusers,10),n=parseInt(t.idusers,10);return o>n?(DebugRacerSort(e,t,1),1):o<n?(DebugRacerSort(e,t,-1),-1):(DebugRacerSort(e,t,0),0)}if("undefined"!=typeof IdUser1)return-1;if("undefined"!=typeof IdUser2)return-1;var i=[e,t];return i.sort(),i[0]===e?1:-1}function GetRankingRaceId(e,t){return t||RankingFt.RaceRankingId?t||RankingFt.RaceRankingId:e.Engaged}function SortRankingData(e,t,a,o){if(o=GetRankingRaceId(e,o),e||Rankings[o]){var n;if(Rankings&&Rankings[o]&&void 0===Rankings[o].RacerRanking)for(n in Rankings[o].RacerRanking=[],Rankings[o])Rankings[o][n]&&Rankings[o].RacerRanking.push(Rankings[o][n]);switch(t){case"WP":Rankings[o].RacerRanking.sort(WPRaceSort(a));break;case"RAC":case"DNF":case"HC":case"HTP":case"ABD":case"ARR":void 0!==Rankings&&Rankings[o]&&Rankings[o].RacerRanking&&Rankings[o].RacerRanking.sort(RacersSort);break;default:VLMAlertInfo("unexpected sort option : "+t)}var i=1,r=0;if(Rankings&&Rankings[o])for(r in Rankings[o].RacerRanking)if(Rankings[o].RacerRanking[r]&&e&&e.IdBoat===r){i=r+1;break}return i}}function FillWPRanking(e,t,a){var o,n=1,i=0,r=[];BackupRankingTable();var s=GetRankingRaceId(e);for(o in Rankings[s].RacerRanking)if(Rankings[s].RacerRanking[o]){var l=Rankings[s].RacerRanking[o];l.WP&&l.WP[t-1]&&!l.WP[t-1].Delta&&(i?(l.WP[t-1].Delta=l.WP[t-1].duration-i,l.WP[t-1].Pct=100*(l.WP[t-1].duration/i-1)):(i=l.WP[t-1].duration,l.WP[t-1].Delta=0,l.WP[t-1].Pct=0)),l.WP&&l.WP[t-1]&&(r.push(GetRankingObject(l,parseInt(o,10)+1,t,a)),void 0!==e&&e&&e.IdBoat===parseInt(l.idusers,10)&&(n=r.length))}var c=RoundPow(n/20,0)+(n%20>=10?0:1);RankingFt.DrawPending=!0,RankingFt.loadRows(r),RankingFt.TargetPage=c}function BackupICS_WPTable(){BackupFooTable(ICS_WPft,"#RaceWayPoints","#RaceWayPointsInsertPoint")}function getWaypointHTMLSymbols(e){var t="";switch(e&(WP_CROSS_CLOCKWISE|WP_CROSS_ANTI_CLOCKWISE)){case WP_CROSS_ANTI_CLOCKWISE:t+="&#x21BA; ";break;case WP_CROSS_CLOCKWISE:t+="&#x21BB; "}switch((e&WP_CROSS_ONCE)==WP_CROSS_ONCE&&(t+="&#x2285; "),e&(WP_ICE_GATE_N|WP_ICE_GATE_S)){case WP_ICE_GATE_S:t+="&#x27F0;";break;case WP_ICE_GATE_N:t+="&#x27F1;"}return t.trim()}function getWaypointHTMLSymbolsDescription(e){var t="";switch(e&(WP_CROSS_CLOCKWISE|WP_CROSS_ANTI_CLOCKWISE)){case WP_CROSS_ANTI_CLOCKWISE:t+=GetLocalizedString("Anti-clockwise")+" ";break;case WP_CROSS_CLOCKWISE:t+=GetLocalizedString("Clockwise")+" "}switch((e&WP_CROSS_ONCE)==WP_CROSS_ONCE&&(t+=GetLocalizedString("Only once")),e&(WP_ICE_GATE_N|WP_ICE_GATE_S)){case WP_ICE_GATE_S:t+=GetLocalizedString("Ice gate")+"("+GetLocalizedString("South")+") ";break;case WP_ICE_GATE_N:t+=GetLocalizedString("Ice gate")+"("+GetLocalizedString("North")+") "}return""!==t&&(t=GetLocalizedString("Crossing")+" : "+t),t.trim()}function NormalizeRaceInfo(e){if(void 0!==e&&e&&!e.IsNormalized){for(var t in e.startlat/=VLM_COORDS_FACTOR,e.startlong/=VLM_COORDS_FACTOR,e.races_waypoints)if(e.races_waypoints[t]){var a=e.races_waypoints[t];a.latitude1/=VLM_COORDS_FACTOR,a.longitude1/=VLM_COORDS_FACTOR,void 0!==a.latitude2&&(a.latitude2/=VLM_COORDS_FACTOR,a.longitude2/=VLM_COORDS_FACTOR)}e.IsNormalized=!0}}function FillRaceWaypointList(e){if(ICS_WPft.DrawPending)ICS_WPft.CallbackPending||(ICS_WPft.CallbackPending=function(){FillRaceWaypointList(e)});else if(BackupICS_WPTable(),e){NormalizeRaceInfo(e);var t=[],a={WaypointId:0};for(var o in a.WP1=e.startlat+"<BR>"+e.startlong,a.WP2="",a.Spec="",a.Type=GetLocalizedString("startmap"),a.Name="",t.push(a),e.races_waypoints)if(e.races_waypoints[o]){var n=e.races_waypoints[o],i={};i.WaypointId=n.wporder,i.WP1=n.latitude1+"<BR>"+n.longitude1,void 0!==n.latitude2?i.WP2=n.latitude2+"<BR>"+n.longitude2:i.WP2="@"+n.laisser_au,i.Spec="<span title='"+getWaypointHTMLSymbolsDescription(n.wpformat)+"'>"+getWaypointHTMLSymbols(n.wpformat)+"</span>",i.Type=GetLocalizedString(n.wptype),i.Name=n.libelle,t.push(i)}ICS_WPft.loadRows(t)}}function BackupNSZ_Table(){BackupFooTable(NSZ_WPft,"NSZPoints","NSZPointsInsertPoint")}function FillNSZList(e){if(NSZ_WPft.DrawPending)NSZ_WPft.CallbackPending||(NSZ_WPft.CallbackPending=function(){FillNSZList(e)});else if(BackupNSZ_Table(),e){var t=[];for(var a in e)if(e[a]){var o=e[a],n={};n.NSZId=a,n.Lon1=o[0][1],n.Lat1=o[0][0],n.Lon2=o[1][1],n.Lat2=o[1][0],t.push(n)}NSZ_WPft.loadRows(t)}}function BackupRankingTable(){BackupFooTable(RankingFt,"#RankingTable","#my-rank-content")}function BackupVLMIndexTable(){BackupFooTable(VLMINdexFt,"#VLMIndexTable","#my-vlmindex-content")}function FillStatusRanking(e,t,a){var o,n=1,i=[],r=GetRankingRaceId(e);for(o in BackupRankingTable(),Rankings[r].RacerRanking)if(Rankings[r].RacerRanking[o]){var s=Rankings[r].RacerRanking[o];s.status===t&&(i.push(GetRankingObject(s,parseInt(o,10)+1,null,a)),void 0!==e&&e&&e.IdBoat===parseInt(s.idusers,10)&&(n=i.length))}var l=RoundPow(n/20,0)+(n%20>=10?0:1);RankingFt.loadRows(i),RankingFt.TargetPage=l,RankingFt.DrawPending=!0}function FillRacingRanking(e,t){var a,o=[],n=0,i={Arrived1stTime:null,Racer1stPos:null};BackupRankingTable();var r=GetRankingRaceId(e),s=0;if(r&&void 0!==Rankings&&void 0!==Rankings[r]&&Rankings[r]&&Rankings[r].RacerRanking)for(a in Rankings[r].RacerRanking)if(Rankings[r].RacerRanking[a]){var l=Rankings[r].RacerRanking[a];if(void 0!==e&&e&&e.IdBoat===parseInt(l.idusers,10)&&(n=o.length),!RnkIsArrived(l)&&!RnkIsRacing(l))break;!i.Arrived1stTime&&RnkIsArrived(l)&&(i.Arrived1stTime=parseInt(l.duration,10)),!RnkIsRacing(l)||i.Racer1stPos&&l.nwp===s||(i.Racer1stPos=l.dnm,s=l.nwp),o.push(GetRankingObject(l,parseInt(a,10)+1,null,t,i))}var c=RoundPow(n/20,0)+(n%20>=10?0:1);RankingFt.loadRows(o),RankingFt.TargetPage=c,RankingFt.DrawPending=!0}function GetBoatInfoLink(e){var t=parseInt(e.idusers,10),a=e.boatname,o="";return e.country&&void 0===(o=GetCountryFlagImgHTML(e.country))&&(o=""),o+='<a class="RaceHistLink" boatid ="'+t+'"data-toggle="tooltip" title="'+t+'" >'+a+"</a>"}function GetRankingObject(e,t,a,o,n){var i="";void 0!==e.Challenge&&e.Challenge[1]&&(i='<img class="RnkLMNH" src="images/LMNH.png"></img>'+i);var r={Rank:t,Name:i+=GetBoatInfoLink(e),Distance:"",Time:"",Loch:"",Lon:"",Lat:"",Last1h:"",Last3h:"",Last24h:"",Class:"",Delta1st:""};if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.GetRankingObject&&parseInt(e.idusers,10)===_CurPlayer.CurBoat.IdBoat&&(r.Class+=" ft_class_myboat"),void 0!==o&&o&&-1!==o.indexOf(e.idusers)&&(r.Class+=" ft_class_friend"),RnkIsRacing(e)&&!a){var s="["+e.nwp+"] -=> "+RoundPow(e.dnm,2);if(t>1&&n&&n.Racer1stPos){new VLMPosition(e.longitude,e.latitude);r.Delta1st=RoundPow(e.dnm-n.Racer1stPos,2)}r.Distance=s;var l=Math.round((new Date-new Date(1e3*parseInt(e.deptime,10)))/1e3);for(var c in r.Time="-1"===e.deptime?"":GetFormattedChronoString(l),r.Loch=e.loch,r.Lon=FormatLon(e.longitude),r.Lat=FormatLat(e.latitude),r.Last1h=e.last1h,r.Last3h=e.last3h,r.Last24h=e.last24h,BoatRacingStatus)e.status===BoatRacingStatus[c]&&(r.Class+="  "+BoatRacingClasses[BoatRacingStatus[c]])}else if(a){var d;if(r.Time=GetFormattedChronoString(parseInt(e.WP[a-1].duration,10)),e.WP[a-1].Delta){var u=RoundPow(e.WP[a-1].Pct,2);d=GetFormattedChronoString(e.WP[a-1].Delta)+" (+"+u+" %)"}else d=GetLocalizedString("winner");r.Loch=d}else{var p=GetLocalizedString("status_"+e.status);r.Distance=p;var h=parseInt(e.duration,10);r.Time=GetFormattedChronoString(h),n&&h!==n.Arrived1stTime?(r.Time+=" ( +"+RoundPow(h/n.Arrived1stTime*100-100,2)+"% )",r.Delta1st=GetFormattedChronoString(h-n.Arrived1stTime)):n&&h==n.Arrived1stTime&&(r.Delta1st=GetLocalizedString("winner")),r.Loch=e.loch}return r}function formatCoords(e){e=Math.abs(e);var t=Math.trunc(e);return t+"° "+Math.trunc(60*(e-t))+"' "+RoundPow(3600*(e-t)%60,4)+'"'}function FormatLon(e){var t=e>0?"W":"E";return formatCoords(e)+t}function FormatLat(e){var t=e>0?"N":"S";return formatCoords(e)+t}function HandleShowMapPrefs(e){$("#DisplayReals").attr("checked",VLM2Prefs.MapPrefs.ShowReals),$("#ShowCompass").attr("checked",VLM2Prefs.MapPrefs.ShowCompass),$("#DisplayNames").attr("checked",VLM2Prefs.MapPrefs.ShowOppNumbers),$("#EstTrackMouse").attr("checked",VLM2Prefs.MapPrefs.EstTrackMouse),$("#TrackEstForecast").attr("checked",VLM2Prefs.MapPrefs.TrackEstForecast),$("#UseUTC").attr("checked",VLM2Prefs.MapPrefs.UseUTC),$("#DDMapSelOption:first-child").html("<span Mode="+VLM2Prefs.MapPrefs.MapOppShow+">"+VLM2Prefs.MapPrefs.GetOppModeString(VLM2Prefs.MapPrefs.MapOppShow)+'</span><span class="caret"></span>'),VLM2Prefs.MapPrefs.MapOppShow===VLM2Prefs.MapPrefs.MapOppShowOptions.ShowTop10?($("#NbDisplayBoat").removeClass("hidden"),$("#NbDisplayBoat").val(VLM2Prefs.MapPrefs.ShowTopCount)):$("#NbDisplayBoat").addClass("hidden"),$("#VacPol").val(VLM2Prefs.MapPrefs.PolarVacCount)}function HandleMapPrefOptionChange(e){var t=e.target;if(void 0!==t&&void 0!==t.attributes.id){var a=t.attributes.id.value,o=t.checked;switch(a){case"DisplayReals":case"ShowReals":case"UseUTC":case"DisplayNames":case"ShowOppNumbers":case"EstTrackMouse":case"TrackEstForecast":VLM2Prefs.MapPrefs[a]=o;break;case"ShowCompass":VLM2Prefs.MapPrefs[a]=o,DrawCompass();break;case"VacPol":var n=parseInt($("#VacPol").val(),10);n>0&&n<120?VLM2Prefs.MapPrefs.PolarVacCount=n:$("#VacPol").value(12);break;case"NbDisplayBoat":var i=parseInt($("#NbDisplayBoat").val(),10);VLM2Prefs.MapPrefs.ShowTopCount=i;break;default:return void console.log("unknown pref storage called : "+a)}VLM2Prefs.Save(),RefreshCurrentBoat(!1,!1)}}function SafeHTMLColor(e){return void 0===e&&(e="#000000"),(e=""+e).length<6&&(e=("000000"+e).slice(-6)),"#"!==e.substring(0,1)?e="#"+e:"#"===e.substring(1,2)&&(e=e.substring(1)),e}function HandleMapOppModeChange(e){var t=e.target;if(void 0!==t&&t&&void 0!==t.attributes&&"undefined"!==t.attributes.Mode&&t.attributes.Mode){var a=parseInt(t.attributes.Mode.value,10);VLM2Prefs.MapPrefs.MapOppShow=a,VLM2Prefs.Save(),HandleShowMapPrefs(e)}}function SetActiveStyleSheet(e){var t,a;for(t=0;a=document.getElementsByTagName("link")[t];t++)-1!==a.getAttribute("rel").indexOf("style")&&a.getAttribute("title")&&(a.disabled=!0,a.getAttribute("title")===e&&(a.disabled=!1))}function SetDDTheme(e){SetActiveStyleSheet(e),$("#SelectionThemeDropDown:first-child").html(e+'<span class="caret"></span>'),$("#SelectionThemeDropDown").attr("SelTheme",e)}function HandleDDlineClick(e){e.target;SetDDTheme(e.target.attributes.ddtheme.value)}function InitAlerts(){$("#AlertBox").css("display","block"),AlertTemplate=$("#AlertBox")[0],$("#AlertBoxContainer").empty(),$("#AlertBoxContainer").removeClass("hidden")}function VLMAlertSuccess(e){VLMAlert(e,"alert-success")}function VLMAlertDanger(e){VLMAlert(e,"alert-danger")}function VLMAlertInfo(e){VLMAlert(e,"alert-info")}Math.trunc=Math.trunc||function(e){return isNaN(e)?NaN:e>0?Math.floor(e):Math.ceil(e)};var AlertIntervalId=null;function VLMAlert(e,t){AlertIntervalId&&clearInterval(AlertIntervalId),void 0!==t&&t||(t="alert-info"),$("#AlertBoxContainer").empty().append(AlertTemplate).show(),$("#AlertText").text(e),$("#AlertBox").removeClass("alert-sucess"),$("#AlertBox").removeClass("alert-warning"),$("#AlertBox").removeClass("alert-info"),$("#AlertBox").removeClass("alert-danger"),$("#AlertBox").addClass(t),$("#AlertBox").show(),$("#AlertCloseBox").unbind().on("click",AutoCloseVLMAlert),AlertIntervalId&&clearInterval(AlertIntervalId),AlertIntervalId=setTimeout(AutoCloseVLMAlert,5e3)}function AutoCloseVLMAlert(){$("#AlertBox").hide()}function GetUserConfirmation(e,t,a){$("#ConfirmDialog").modal("show"),t?($("#OKBtn").hide(),$("#CancelBtn").hide(),$("#YesBtn").show(),$("#NoBtn").show()):($("#OKBtn").show(),$("#CancelBtn").show(),$("#YesBtn").hide(),$("#NoBtn").hide()),$("#ConfirmText").text(e),$(".OKBtn").unbind().on("click",function(){$("#ConfirmDialog").modal("hide"),a(!0)}),$(".NOKBtn").unbind().on("click",function(){$("#ConfirmDialog").modal("hide"),a(!1)})}function GetRaceRankingLink(e){return'<a href="/jvlm?RaceRank='+e.idrace+'" target="RankTab">'+e.racename+"</a>"}function FillBoatPalmares(e,t){var a;if("success"===t){var o=[];for(a in e.palmares)if(e.palmares[a]){var n=e.palmares[a],i={RaceId:e.palmares[a].idrace,RaceName:GetRaceRankingLink(e.palmares[a]),Ranking:n.ranking.rank+" / "+n.ranking.racercount};o.push(i)}RaceHistFt.loadRows(o)}var r=GetLocalizedString("palmares");r=r.replace("%s",e.boat.name),$("#palmaresheaderline").text(r)}function ShowUserRaceHistory(e,t){var a=e.currentTarget.value;switch(void 0===a&&($("#RaceHistory").modal("show"),a=0),a){case 2:break;case 1:default:var o=1==a?"&GetPlayerRaces=1":"";StatMGR.Stat("BoatPalmares",1==a?"Player":"Boat"),$.get("/ws/boatinfo/palmares.php?idu="+t+o,function(e,t){FillBoatPalmares(e,t)})}$(".JVLMTabs").tabs("refresh")}function HandleShowBoatRaceHistory(e){var t=$(e.target).attr("boatid");t&&ShowUserRaceHistory(e,t)}function HandleCreateUserResult(e,t){if("success"===t&&e)if($(".ValidationMark").addClass("hidden"),e.success?($(".ValidationMark.Valid").removeClass("hidden"),VLMAlertSuccess(GetLocalizedString("An email has been sent. Click on the link to validate.")),$("#InscriptForm").modal("hide"),$("#LoginForm").modal("hide")):e.request&&e.request.errorstring?VLMAlertDanger(GetLocalizedString(e.request.errorstring)):VLMAlertDanger(GetLocalizedString(e.error.msg)),e.request)e.request.MailOK?$(".ValidationMark.Email.Valid").removeClass("hidden"):$(".ValidationMark.Email.Invalid").removeClass("hidden"),e.request.PasswordOK?$(".ValidationMark.Password.Valid").removeClass("hidden"):$(".ValidationMark.Password.Invalid").removeClass("hidden"),e.request.PlayerNameOK?$(".ValidationMark.Pseudo.Valid").removeClass("hidden"):$(".ValidationMark.Pseudo.Invalid").removeClass("hidden");else if(e.error)switch(e.error.code){case"NEWPLAYER01":$(".ValidationMark.Email.Invalid").removeClass("hidden");break;case"NEWPLAYER02":$(".ValidationMark.Pseudo.Invalid").removeClass("hidden");break;case"NEWPLAYER03":$(".ValidationMark.Password.Invalid").removeClass("hidden")}$("#BtnCreateAccount").show()}function HandleCreateUser(){var e=$("#NewPlayerPseudo")[0].value,t={emailid:$("#NewPlayerEMail")[0].value,password:$("#NewPlayerPassword")[0].value,pseudo:e};$("#BtnCreateAccount").hide(),$.post("/ws/playerinfo/player_create.php",t,function(e,t){HandleCreateUserResult(e,t)})}function setModalMaxHeight(e){var t=$(e),a=t.find(".modal-content"),o=a.outerHeight()-a.innerHeight(),n=$(window).width()<768?20:60,i=$(window).height()-(n+o)-((t.find(".modal-header").outerHeight()||0)+(t.find(".modal-footer").outerHeight()||0));a.css({overflow:"hidden"}),t.find(".modal-body").css({"max-height":i,"overflow-y":"auto"})}function GetLocalUTCTime(e,t,a){var o=e,n="";return moment.isMoment(e)||(o=t?moment(e).utc():moment(e)),VLM2Prefs.MapPrefs.UseUTC?(o.isLocal()&&(o=o.utc()),n=" Z"):o.isLocal()||(o=o.local()),a?o.format("LLLL")+n:o}if("undefined"==typeof jQuery)throw new Error("jQuery progress timer requires jQuery");!function(e,t,a,o){var n="progressTimer",i={timeLimit:60,warningThreshold:5,onFinish:function(){},baseStyle:"",warningStyle:"progress-bar-danger",completeStyle:"progress-bar-success",showHtmlSpan:!0,errorText:"ERROR!",successText:"100%"},r=function(t,a){this.element=t,this.$elem=e(t),this.options=e.extend({},i,a),this._defaults=i,this._name=n,this.metadata=this.$elem.data("plugin-options"),this.init()};r.prototype.constructor=r,r.prototype.init=function(){var a=this;return e(a.element).empty(),a.span=e("<span/>"),a.barContainer=e("<div>").addClass("progress"),a.bar=e("<div>").addClass("progress-bar active progress-bar-striped").addClass(a.options.baseStyle).attr("role","progressbar").attr("aria-valuenow","0").attr("aria-valuemin","0").attr("aria-valuemax",a.options.timeLimit),a.span.appendTo(a.bar),a.options.showHtmlSpan||a.span.addClass("sr-only"),a.bar.appendTo(a.barContainer),a.barContainer.appendTo(a.element),a.start=new Date,a.limit=1e3*a.options.timeLimit,a.warningThreshold=1e3*a.options.warningThreshold,a.interval=t.setInterval(function(){a._run.call(a)},250),a.bar.data("progress-interval",a.interval),!0},r.prototype.destroy=function(){this.$elem.removeData()},r.prototype._run=function(){var e=this,t=new Date-e.start,a=t/e.limit*100;e.bar.attr("aria-valuenow",a),e.bar.width(a+"%");var o=a.toFixed(2);return o>=100&&(o=100),e.options.showHtmlSpan&&e.span.html(o+"%"),t>=e.warningThreshold&&e.bar.removeClass(this.options.baseStyle).removeClass(this.options.completeStyle).addClass(this.options.warningStyle),t>=e.limit&&e.complete.call(e),!0},r.prototype.removeInterval=function(){var a=e(".progress-bar",this.element);if(void 0!==a.data("progress-interval")){var o=a.data("progress-interval");t.clearInterval(o)}return a},r.prototype.complete=function(){var t=this,a=t.removeInterval.call(t),o=arguments;0!==o.length&&"object"===_typeof(o[0])&&(t.options=e.extend({},t.options,o[0])),a.removeClass(t.options.baseStyle).removeClass(t.options.warningStyle).addClass(t.options.completeStyle),a.width("100%"),t.options.showHtmlSpan&&e("span",a).html(t.options.successText),a.attr("aria-valuenow",100),setTimeout(function(){t.options.onFinish.call(a)},500),t.destroy.call(t)},r.prototype.error=function(){var t=this,a=t.removeInterval.call(t),o=arguments;0!==o.length&&"object"===_typeof(o[0])&&(t.options=e.extend({},t.options,o[0])),a.removeClass(t.options.baseStyle).addClass(t.options.warningStyle),a.width("100%"),t.options.showHtmlSpan&&e("span",a).html(t.options.errorText),a.attr("aria-valuenow",100),setTimeout(function(){t.options.onFinish.call(a)},500),t.destroy.call(t)},e.fn[n]=function(t){var a=arguments;if(t===o||"object"===_typeof(t))return this.each(function(){e.data(this,"plugin_"+n)||e.data(this,"plugin_"+n,new r(this,t))});if("string"==typeof t&&"_"!==t[0]&&"init"!==t){if(0===Array.prototype.slice.call(a,1).length&&-1!==e.inArray(t,e.fn[n].getters)){var i=e.data(this[0],"plugin_"+n);return i[t].apply(i,Array.prototype.slice.call(a,1))}return this.each(function(){var o=e.data(this,"plugin_"+n);o instanceof r&&"function"==typeof o[t]&&o[t].apply(o,Array.prototype.slice.call(a,1))})}},e.fn[n].getters=["complete","error"]}(jQuery,window,document,void 0),function(e){if(e.support.touch="ontouchend"in document,e.support.touch){var t,a=e.ui.mouse.prototype,o=a._mouseInit,n=a._mouseDestroy;a._touchStart=function(e){!t&&this._mouseCapture(e.originalEvent.changedTouches[0])&&(t=!0,this._touchMoved=!1,i(e,"mouseover"),i(e,"mousemove"),i(e,"mousedown"))},a._touchMove=function(e){t&&(this._touchMoved=!0,i(e,"mousemove"))},a._touchEnd=function(e){t&&(i(e,"mouseup"),i(e,"mouseout"),this._touchMoved||i(e,"click"),t=!1)},a._mouseInit=function(){this.element.bind({touchstart:e.proxy(this,"_touchStart"),touchmove:e.proxy(this,"_touchMove"),touchend:e.proxy(this,"_touchEnd")}),o.call(this)},a._mouseDestroy=function(){this.element.unbind({touchstart:e.proxy(this,"_touchStart"),touchmove:e.proxy(this,"_touchMove"),touchend:e.proxy(this,"_touchEnd")}),n.call(this)}}function i(e,t){if(!(e.originalEvent.touches.length>1)){e.preventDefault();var a=e.originalEvent.changedTouches[0],o=document.createEvent("MouseEvents");o.initMouseEvent(t,!0,!0,window,1,a.screenX,a.screenY,a.clientX,a.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(o)}}}(jQuery),L.Control.WindMouseControl=L.Control.extend({options:{position:"bottomleft"},_GetControlHTML:function(){return"<table><tr><td class='leaflet-control-windmouse_zoomcol'><span>Zoom : </span> <span id='LWM_ZoomLevel'></span></td><td class='leaflet-control-windmouse_latlon'><span>Lat : </span> <span id='LWM_Lat'></span></td><td class='leaflet-control-windmouse_latlon'><span>Lon : </span> <span id='LWM_Lon'></span></td></tr><tr><td class='leaflet-control-windmouse_wndimg'><img class='BeaufortImg'></td><td class='leaflet-control-windmouse_wndhdg'><span id='LWM_Hdg'></span></td><td class='leaflet-control-windmouse_wndspd'><span id='LWM_Spd'></span></td></tr></table>"},onAdd:function(e){this._map=e;return this._Container=L.DomUtil.create("div","leaflet-control-windmouse-frame"),this._ZContainer=L.DomUtil.create("div","",this._Container),this._ZContainer.innerHTML=this._GetControlHTML(),e.on("mousemove",this._Update,this),e.on("zoomend",this._ZoomEnd,this),this._SetZoom(e.getZoom()),this._Container},_Update:function(e){if(void 0!==map.GribMap){var t=e.latlng.lat,a=e.latlng.lng,o=this._map.getZoom(),n=null;o>=MIN_MAP_ZOOM&&(n=GribMgr.WindAtPointInTime(map.GribMap.GetGribMapTime(),t,a));var i=[];if(i.push([FIELD_MAPPING_TEXT,"#LWM_Lat",RoundPow(t,3)]),i.push([FIELD_MAPPING_TEXT,"#LWM_Lon",RoundPow(a,3)]),n){i.push([FIELD_MAPPING_TEXT,"#LWM_Hdg",RoundPow(n.Speed,2)+" kts"]),i.push([FIELD_MAPPING_TEXT,"#LWM_Spd",RoundPow(n.Heading,2)+" °"]);var r=GribMgr.GetBeaufort(n.Speed);$(".BeaufortImg").css("background-position","-0px -"+24*r+"px");var s=n.Heading-56;$(".BeaufortImg").css("transform","rotate("+s+"deg)")}else i.push([FIELD_MAPPING_TEXT,"#LWM_Hdg","-- kts"]),i.push([FIELD_MAPPING_TEXT,"#LWM_Spd","-- °"]),$(".BeaufortImg").css('style="background-position: -0px -0px"');FillFieldsFromMappingTable(i),this._SetZoom(o)}},_ZoomEnd:function(e){this._SetZoom(this._map.getZoom())},_SetZoom:function(e){var t=[];t.push([FIELD_MAPPING_TEXT,"#LWM_ZoomLevel",RoundPow(e,1)]),FillFieldsFromMappingTable(t)}}),L.control.WindMouseControl=function(e){return new L.Control.WindMouseControl(e)};var _LocaleDict,_EnDict,BuoyMarker=L.Icon.extend({options:{iconSize:[36,72],iconAnchor:[18,36],popupAnchor:[0,-36]}}),TrackWPMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],iconUrl:"images/WP_Marker.gif"}}),PilototoMarker=L.Icon.extend({options:{iconSize:[24,24],iconAnchor:[6,24],iconUrl:"images/Pilototo.png"}}),BOAT_MARKET_SIZE=48,BOAT_EST_MARKET_SIZE=24,BoatMarker=L.Icon.extend({options:{iconSize:[BOAT_MARKET_SIZE,BOAT_MARKET_SIZE],iconAnchor:[BOAT_MARKET_SIZE/2,BOAT_MARKET_SIZE/2],iconUrl:"images/target.png",rotationOrigin:[BOAT_MARKET_SIZE/2,BOAT_MARKET_SIZE/2]}}),BoatEstMarker=L.Icon.extend({options:{iconSize:[BOAT_EST_MARKET_SIZE,BOAT_EST_MARKET_SIZE],iconAnchor:[BOAT_EST_MARKET_SIZE/2,BOAT_EST_MARKET_SIZE/2],iconUrl:"images/target.png",rotationOrigin:[BOAT_EST_MARKET_SIZE/2,BOAT_EST_MARKET_SIZE/2]}}),IceGateMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,-18],iconUrl:"images/icegate.png"}}),GateDirMarker=L.Icon.extend({options:{iconSize:[48,48],iconAnchor:[24,24],rotationOrigin:[24,24]}});function GetPilototoMarker(e,t){var a=new PilototoMarker;return a.Order=e,a.OrderIndex=t,a}function GetBuoyMarker(e){var t=null;return(t=new BuoyMarker(e?{iconUrl:"images/Buoy1.png"}:{iconUrl:"images/Buoy2.png",color:"red"})).IsCWBuoy=e,t}function GetBoatMarker(e){var t=new BoatMarker;return t.MarkerOppId=e,t}function GetBoatEstimateMarker(){return new BoatEstMarker}function GetTrackWPMarker(){return new TrackWPMarker}function GetGateTypeMarker(e,t){return t?IceGateMarker:new GateDirMarker({iconUrl:"images/"+e})}function GetOpponentMarker(e){var t=new L.Icon({iconUrl:"images/opponent"+e.IsTeam+".png",iconAnchor:[e.IsFriend/2,e.IsFriend/2],iconSize:[e.IsFriend,e.IsFriend]});return t.MarkerOppId=e.idboat,t}function ClearCurrentMapMarkers(e){e&&e.RaceMapFeatures&&(e.RaceMapFeatures.OppPopup&&e.RaceMapFeatures.OppPopup.PrevOpp&&(e.RaceMapFeatures.OppPopup.PrevOpp.closePopup(),e.RaceMapFeatures.OppPopup.PrevOpp.unbindPopup()),RemoveFromMap(e.RaceMapFeatures))}function EnsureMarkersVisible(e){e&&RestoreMarkersOnMap(e.RaceMapFeatures)}function RestoreMarkersOnMap(e){if(e&&"function"!=typeof e)if(Array.isArray(e))for(var t in e)RestoreMarkersOnMap(e[t]);else if("object"===_typeof(e)&&void 0===e._leaflet_id)for(var a in e)switch(a){case"OppPopup":break;default:RestoreMarkersOnMap(e[a])}else e._leaflet_id&&!e._map&&e.addTo(map)}function RemoveFromMap(e){if(e&&"function"!=typeof e)if(Array.isArray(e))for(var t in e)RemoveFromMap(e[t]);else if("object"===_typeof(e)&&void 0===e._leaflet_id)for(var a in e)RemoveFromMap(e[a]);else e._leaflet_id&&e.removeFrom(map)}!function(){var e=L.Marker.prototype._initIcon,t=L.Marker.prototype._setPos,a="msTransform"===L.DomUtil.TRANSFORM;L.Marker.addInitHook(function(){var e=this.options.icon&&this.options.icon.options&&this.options.icon.options.iconAnchor;e&&(e=e[0]+"px "+e[1]+"px"),this.options.rotationOrigin=this.options.rotationOrigin||e||"center bottom",this.options.rotationAngle=this.options.rotationAngle||0,this.on("drag",function(e){e.target._applyRotation()})}),L.Marker.include({_initIcon:function(){e.call(this)},_setPos:function(e){t.call(this,e),this._applyRotation()},_applyRotation:function(){this.options.rotationAngle&&(this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin,a?this._icon.style[L.DomUtil.TRANSFORM]="rotate("+this.options.rotationAngle+"deg)":this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)")},setRotationAngle:function(e){return this.options.rotationAngle=e,this.update(),this},setRotationOrigin:function(e){return this.options.rotationOrigin=e,this.update(),this}})}();var _CurLocale="en";function LocalizeString(){return LocalizeItem($("[I18n]").get()),$(".LngFlag").click(function(e,t){OnLangFlagClick($(this).attr("lang")),UpdateLngDropDown()}),!0}function OnLangFlagClick(e){InitLocale(e)}function LocalizeItem(e){try{var t;for(t in e){var a=e[t],o=a.attributes.I18n.value;void 0!==_LocaleDict&&(a.innerHTML=GetLocalizedString(o))}}finally{}return!0}function InitLocale(e){var t="/ws/serverinfo/translation.php";e&&(t+="?lang="+e),$.get(t,function(e){1==e.success?(_CurLocale=e.request.lang,_LocaleDict=e.strings,moment.locale(_CurLocale),LocalizeString(),UpdateLngDropDown()):alert("Localization string table load failure....")}),void 0===_EnDict&&$.get("/ws/serverinfo/translation.php?lang=en",function(e){1==e.success?_EnDict=e.strings:alert("Fallback localization string table load failure....")})}function HTMLDecode(e){var t=document.createElement("textarea");t.innerHTML=e;var a=t.value,o=["\n\r","\r\n","\n","\r"];for(var n in o)for(;o[n]&&-1!==a.indexOf(o[n]);)a=a.replace(o[n],"<br>");return a}function GetLocalizedString(e,t){var a="";return a=void 0!==_LocaleDict&&_LocaleDict&&e in _LocaleDict?HTMLDecode(_LocaleDict[e]):void 0!==_EnDict&&_EnDict&&e in _EnDict?HTMLDecode(_EnDict[e]):e,t&&(a=vsprintf(a,t)),a}function GetCurrentLocale(){return _CurLocale}var VLMMercatorTransform=new MercatorTransform;function MercatorTransform(){this.Width=1e4,this.Height=1e4,this.LonOffset=0,this.LatOffset=0,this.Scale=1e4/180,this.LonToMapX=function(e){return this.Width/2+(e-this.LonOffset)*this.Scale},this.LatToMapY=function(e){return e=Deg2Rad(e),e=Rad2Deg(e=Math.log(Math.tan(e)+1/Math.cos(e))),this.Height/2-(e-this.LatOffset)*this.Scale},this.SegmentsIntersect=function(e,t){var a=this.LonToMapX(e.P1.Lon.Value),o=this.LatToMapY(e.P1.Lat.Value),n=this.LonToMapX(e.P2.Lon.Value),i=this.LatToMapY(e.P2.Lat.Value),r=this.LonToMapX(t.P1.Lon.Value),s=this.LatToMapY(t.P1.Lat.Value),l=this.LonToMapX(t.P2.Lon.Value),c=this.LatToMapY(t.P2.Lat.Value);if(e.P1.Lon.Value===e.P2.Lon.Value&&e.P1.Lat.Value===e.P2.Lat.Value||t.P1.Lon.Value===t.P2.Lon.Value&&t.P1.Lat.Value===t.P2.Lat.Value)return!1;n-=a,i-=o,r-=a,s-=o,l-=a,c-=o,a=0,o=0;var d=Math.sqrt(n*n+i*i),u=n/d,p=i/d,h=r*u+s*p;if(s=s*u-r*p,r=h,h=l*u+c*p,c=c*u-l*p,l=h,s===c)return!1;var P=l+(r-l)*c/(c-s),f=P/d;if(f>=0&&f<=1){var g,L=o;if(l-r)g=(a+P-r)/(l-r);else{if(!(c-s))return!1;g=(L-s)/(c-s)}return g>=0&&g<=1}return!1}}var PolarManagerClass=function e(){_classCallCheck(this,e),this.Polars=[],this.PolarLoaderQueue={},this.Init=function(){this.Polars=[],$.get("/ws/polarlist.php",function(e){for(var t in e.list)PolarsManager.Polars["boat_"+e.list[t]]=null})},this.GetBoatSpeed=function(e,t,a,o){if(!(e in this.Polars))return NaN;if(this.Polars[e]){var n=WindAngle(o,a);return GetPolarAngleSpeed(this.Polars[e],n,t)}return this.LoadPolar(e,null,null),NaN},this.HandlePolarLoaded=function(e,t,a){var o=$.csv.toArrays(a,{separator:";"});for(var n in o)if(o[n])for(var i in o[n])o[n][i]&&(o[n][i]=parseFloat(o[n][i]));for(var r in PolarsManager.Polars[e]={},PolarsManager.Polars[e].SpeedPolar=o,PolarsManager.Polars[e].WindLookup=[],PolarsManager.Polars[e].AngleLookup=[],this.PolarLoaderQueue[e].callbacks){var s=this.PolarLoaderQueue[e].callbacks[r];s&&t?s(t):s&&s()}this.PolarLoaderQueue[e]=null},this.GetPolarLine=function(e,t,a,o,n){if(n||(n=5),void 0===this.Polars[e])return alert("Unexpected polarname : "+e),null;if(null!==this.Polars[e]){var i,r=[],s=0;for(i=0;i<=180;i+=n){var l=GetPolarAngleSpeed(this.Polars[e],i,t);s<l&&(s=l),r.push(l)}for(var c in r)r[c]&&(r[c]/=s);return r}this.LoadPolar(e,a,o)};var t=0;this.GetVMGCourse=function(e,a,o,n,i){for(var r=n.GetOrthoCourse(i),s=0,l=-1e10,c=-1;c<=1;c+=2)for(var d=0;d<=90;d+=.1){var u=this.GetBoatSpeed(e,a,o,r+d*c),p=u*Math.cos(Deg2Rad(d));t&&console.log("VMG "+RoundPow((r+d*c+360)%360,3)+" "+RoundPow(u,3)+" "+RoundPow(p,3)+" "+RoundPow(l,3)+" "+(p>=l?"BEST":"")),p>=l&&(l=p,s=r+d*c)}return t=0,s},this.GetVBVMGCourse=function(e,t,a,o,n){var i=o.GetOrthoDist(n),r=o.GetOrthoCourse(n),s=0,l=0,c=0,d=0,u=0,p=1,h=this.GetBoatSpeed(e,t,a,r);u=h>0?i/h:8760;var P=a-r;P<-90?P+=360:P>90&&(P-=360),p=P>0?-1:1;for(var f=1;f<=90;f++){var g=f*Math.PI/180,L=Math.tan(g),M=Math.sqrt(1+L*L),m=this.GetBoatSpeed(e,t,a,r-f*p);if(isNaN(m))return NaN;if(m>0)for(var C=-89;C<=0;C++){var v=C*Math.PI/180,I=i*(Math.tan(-v)/(L+Math.tan(-v))),R=I*M/m;if(!(R<0||R>u)){var _=i-I,S=this.GetBoatSpeed(e,t,a,r-C*p);if(isNaN(S))return NaN;if(!(S<=0)){var T=Math.tan(-v),k=R+_*Math.sqrt(1+T*T)/S;k<u&&(u=k,s=f,l=C,c=m,d=S)}}}}var D=c*Math.cos(Deg2Rad(s)),w=d*Math.cos(Deg2Rad(l));if(isNaN(D)||isNaN(w))return NaN;return D>w?r-s*p:r-l*p},this.GetPolarMaxSpeed=function(e,t){if(!this.Polars[e])return null;var a,o=0;for(a=0;a<=180;a+=1){var n=GetPolarAngleSpeed(this.Polars[e],a,t);n>o&&(o=n)}return o},this.LoadPolar=function(e,t,a){this.PolarLoaderQueue[e]?t&&this.PolarLoaderQueue[e].callbacks.push(t):(this.PolarLoaderQueue[e]={},this.PolarLoaderQueue[e].callbacks=[],t&&this.PolarLoaderQueue[e].callbacks.push(t),$.get("/Polaires/"+e+".csv",this.HandlePolarLoaded.bind(this,e,a)))}},PolarsManager=new PolarManagerClass;function GetPolarAngleSpeed(e,t,a){var o,n,i,r,s=e.SpeedPolar,l=Math.floor(a);if(void 0!==e.WindLookup&&l in e.WindLookup)o=e.WindLookup[l];else for(var c in s[0]){if(c>0&&s[0][c]>a)break;e.WindLookup[l]=Math.floor(c),o=Math.floor(c)}for(n=o<s[0].length-1?o+1:o;t<0;)t+=360;t>=360&&(t%=360),t>180&&(t=360-t);var d=Math.floor(t);if(void 0!==e.AngleLookup&&d in e.AngleLookup)i=e.AngleLookup[d];else for(var u in s){if(u>0&&s[u][0]>t)break;e.AngleLookup[d]=Math.floor(u),i=Math.floor(u)}r=i<s.length-1?i+1:i;var p=GetAvgValue(a,s[0][o],s[0][n],s[i][o],s[i][n]),h=GetAvgValue(a,s[0][o],s[0][n],s[r][o],s[r][n]),P=GetAvgValue(t,s[i][0],s[r][0],p,h);if(isNaN(P))throw"GetAvgValue was NaN";return P}function WindAngle(e,t){return e>=t?e-t<=180?e-t:360-e+t:t-e<=180?t-e:360-t+e}function GetAvgValue(e,t,a,o,n){return e===t||t===a||o===n?o:o+(e-t)/(a-t)*(n-o)}var POS_FORMAT_DEFAULT=0,EARTH_RADIUS=3443.84,VLM_DIST_ORTHO=1;function Deg2Rad(e){return e/180*Math.PI}function Rad2Deg(e){return e/Math.PI*180}function RoundPow(e,t){if(void 0!==t){var a=Math.pow(10,t);return Math.round(e*a)/a}return e}function NormalizeLongitudeDeg(e){return e<-180?e+=360:e>180&&(e-=360),e}function VLMPosition(e,t,a){void 0!==a&&a!=POS_FORMAT_DEFAULT||(this.Lon=new Coords(e,1),this.Lat=new Coords(t,0)),this.toString=function(e){return this.Lat.toString(e)+" "+this.Lon.toString(e)},this.GetEuclidianDist2=function(e){var t=(this.Lat.Value-e.Lat.Value)%90,a=(this.Lon.Value-e.Lon.Value)%180;return t*t+a*a},this.GetLoxoDist=function(e,t){var a,o=Deg2Rad(this.Lat.Value),n=Deg2Rad(e.Lat.Value),i=-Deg2Rad(this.Lon.Value),r=-Deg2Rad(e.Lon.Value),s=0;return s=Math.abs(n-o)<Math.sqrt(1e-15)?Math.cos(o):(n-o)/Math.log(Math.tan(n/2+Math.PI/4)/Math.tan(o/2+Math.PI/4)),a=Math.sqrt(Math.pow(n-o,2)+s*s*(r-i)*(r-i)),RoundPow(EARTH_RADIUS*a,t)},this.ReachDistLoxo=function(e,t){var a=0,o=0;if(isNaN(t))throw"unsupported reaching NaN distance";"number"==typeof e?(a=Deg2Rad(e/60),o=Deg2Rad(t%360)):(a=this.GetLoxoDist(e)/EARTH_RADIUS*t,o=Deg2Rad(this.GetLoxoCourse(e)));var n=Deg2Rad(this.Lat.Value),i=Deg2Rad(this.Lon.Value),r=0,s=0,l=(n+(r=n+a*Math.cos(o)))/2;if((s=i+a*Math.sin(o)/Math.cos(l))>Math.PI?s-=2*Math.PI:s<-Math.PI&&(s+=2*Math.PI),isNaN(s)||isNaN(r))throw"Reached Nan Position!!!";if(s=Rad2Deg(s),r=Rad2Deg(r),s*this.Lon.Value<0&&Math.abs(this.Lon.Value-s)>90){var c=1;return this.Lon.Value-s<0&&(c=-1),new VLMPosition(s+360*c,r)}return new VLMPosition(s,r)},this.GetLoxoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=(o-a)%(2*Math.PI),s=(a-o)%(2*Math.PI),l=Math.log(Math.tan(i/2+Math.PI/4)/Math.tan(n/2+Math.PI/4));return RoundPow((720-(r<s?Math.atan2(r,l)%(2*Math.PI):Math.atan2(-s,l)%(2*Math.PI))/Math.PI*180)%360,t)},VLM_DIST_ORTHO?(this.GetOrthoDist=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);return void 0!==t&&"number"==typeof t||(t=17),RoundPow(60*Rad2Deg(Math.acos(Math.sin(n)*Math.sin(i)+Math.cos(n)*Math.cos(i)*Math.cos(a-o))),t)},this.GetOrthoCourse=function(e,t){var a,o,n,i,r=Deg2Rad(this.Lon.Value),s=Deg2Rad(e.Lon.Value),l=Deg2Rad(this.Lat.Value),c=Deg2Rad(e.Lat.Value);if(void 0!==t&&"number"==typeof t||(t=17),o=Math.fmod(s-r,2*Math.PI),Math.abs(o)<1e-7)a=(i=c-l)>0?0:Math.PI;else{o<=-Math.PI?o+=2*Math.PI:o>Math.PI&&(o-=2*Math.PI),n=Math.acos(Math.sin(c)*Math.sin(l)+Math.cos(c)*Math.cos(l)*Math.cos(o)),i=Math.cos(l)*Math.sin(n);var d=(Math.sin(c)-Math.sin(l)*Math.cos(n))/i;d>1?(d=1,console.log("Nan Catch pos")):d<-1&&(d=-1,console.log("Nan Catch neg")),a=o<0?2*Math.PI-Math.acos(d):Math.acos(d)}return RoundPow(a=Rad2Deg(a%(2*Math.PI)),t)}):(this.GetOrthoDist=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=2*Math.asin(Math.sqrt(Math.pow(Math.sin((n-i)/2),2)+Math.pow(Math.cos(n)*Math.cos(i)*Math.sin((a-o)/2),2)));return RoundPow(EARTH_RADIUS*r,t)},this.GetOrthoCourse=function(e,t){var a=-Deg2Rad(this.Lon.Value),o=-Deg2Rad(e.Lon.Value),n=Deg2Rad(this.Lat.Value),i=Deg2Rad(e.Lat.Value);void 0!==t&&"number"==typeof t||(t=17);var r=Math.atan2(Math.sin(a-o)*Math.cos(i),Math.cos(n)*Math.sin(i)-Math.sin(n)*Math.cos(i)*Math.cos(a-o));return RoundPow(r=Rad2Deg(r%(2*Math.PI)),t)}),this.ReachDistOrtho=function(t,a){var o,n,i=t/EARTH_RADIUS,r=Deg2Rad(a),s=Deg2Rad(this.Lat.Value),l=Deg2Rad(-this.Lon.Value);return o=Math.asin(Math.sin(s)*Math.cos(i)+Math.cos(s)*Math.sin(i)*Math.cos(r)),n=Math.atan2(Math.sin(r)*Math.sin(i)*Math.cos(s),Math.cos(i)-Math.sin(s)*Math.sin(o)),new VLMPosition(NormalizeLongitudeDeg(Rad2Deg(-(e=(l-n+Math.PI)%(2*Math.PI)-Math.PI))),Rad2Deg(o))},this.GetVLMString=function(){return this.Lat.toString()+","+this.Lon.toString()}}Math.fmod=function(e,t){return Number((e-Math.floor(e/t)*t).toPrecision(8))};var _IsLoggedIn,Race=function e(t){_classCallCheck(this,e),this.RaceId="number"==typeof t?t:parseInt(t,10),this.LastUpdate=new Date(0),this.ClearData=function(){VLM2Prefs.ClearRaceData(this.RaceId)},this.CheckRaceUpdates=function(e){var t=!0;if(e){var a=e.idraces,o=new Date(1e3*parseInt(e.VER,10)),n=VLM2Prefs.GetRaceFromStorage(a);n.LastUpdate=new Date(n.LastUpdate),n.LastUpdate<o&&VLM2Prefs&&(n.LastUpdate=o,VLM2Prefs.Save(),t=!1)}return t},this.HasSave=function(){return VLM2Prefs.HasRaceStorage(this.RaceId)},this.UpdatedForRaceStart=function(e){return e&&(RetOK=new Date(1e3*e.deptime)==new Date(1e3*e.VER)),!1},this.Subscribe=function(e){$.post("/ws/boatsetup/race_subscribe.php","parms="+JSON.stringify({idu:e,idr:this.RaceId}),function(e){if(e.success){$("#RacesListForm").modal("hide");var a=new RaceNewsHandler("",GetLocalizedString("youengaged"));StatMGR.Stat("RaceSubscribe",t),a.Show(),VLM2Prefs.GetRaceFromStorage(t).LastUpdate=new Date,VLM2Prefs.Save()}else{VLMAlertDanger(e.error.msg+"\n"+e.error.custom_error_string)}})}},RaceNewsHandler=function e(t,a){_classCallCheck(this,e),this.Title=t,this.Message=a,this.Show=function(){$("#RaceNewsBox_Title").text(t),$("#NewsBody1").html(a),$("#RaceNewsBox").modal({backdrop:"static",keyboard:!1})}},StatsManager=function e(){_classCallCheck(this,e),this.NoStat=!0,this.CheckGConsent=function(){if(VLM2Prefs&&VLM2Prefs.GConsentDate)this.NoStat=!isNaN(VLM2Prefs.GConsentDate);else if(VLM2Prefs){var e=(new Date).getTime(),t=VLM2Prefs.GConsentLastNo;t&&(t=new Date(t)),null===VLM2Prefs.GConsentDate&&(null===VLM2Prefs.GConsentLastNo||t.getTime()+15552e6<e)&&($(".GConsentToggle").on("click",this.HandleGconsentToggle.bind(this)),$("#GConsentModal").modal({backdrop:"static",keyboard:!1}))}},this.HandleGconsentToggle=function(e){var t=e.currentTarget.id;$("#"+t);"GConsentToggleNo"===t?($("#GConsentToggleNo").addClass("btn-danger").removeClass("btn-default"),$("#GConsentToggleYes").removeClass("btn-success").addClass("btn-default"),this.SetConsent(!1)):($("#GConsentToggleNo").removeClass("btn-danger").addClass("btn-default"),$("#GConsentToggleYes").addClass("btn-success").removeClass("btn-default"),this.SetConsent(!0)),$("#GConsentCloseFormBtn").removeClass("ui-state-disabled")},this.SetConsent=function(e){this.NoStat=e,e?(VLM2Prefs.GConsentDate=new Date,VLM2Prefs.GConsentLastNo=null):(VLM2Prefs.GConsentLastNo=new Date,VLM2Prefs.GConsentDate=null),VLM2Prefs.Save()},this.Stat=function(e,t,a,o){!this.NoStat&&"undefined"!=typeof gtag&&gtag&&(void 0!==t&&t||(t=e),"number"==typeof o?gtag("event",e,{event_category:t,event_label:a,value:o}):gtag("event",e,{event_category:t,event_label:a}))}},StatMGR=new StatsManager;function Boat(e){this.IdBoat=-1,this.Engaged=!1,this.BoatName="",this.BoatPseudo="",this.VLMInfo={},this.RaceInfo={},this.Exclusions=[],this.Track=[],this.RnkObject={},this.OppTrack=[],this.OppList=[],this.Reals=[],this.VLMPrefs=[],this.NextServerRequestDate=null,this.Estimator=new Estimator(this),this.EstimatePos=null,void 0!==e&&(this.IdBoat=e.idu,this.Engaged=e.engaged,this.BoatName=e.boatname,this.BoatPseudo=e.boatpseudo,this.VLMInfo=e.VLMInfo,this.RaceInfo=e.RaceInfo,this.Exclusions=e.Exclusions,this.Track=e.Track,this.RnkObject=e.RnkObject),this.GetNextGateSegment=function(e){if("string"==typeof e&&(e=parseInt(e,10)),void 0===this.RaceInfo)return null;var t=this.RaceInfo.races_waypoints[e];do{if("string"==typeof t&&(t=parseInt(t,10)),t.wpformat&WP_ICE_GATE){if(++e>=this.RaceInfo.races_waypoints)throw"Oops could not find requested gate type";t=this.RaceInfo.races_waypoints[e]}}while(t.wpformat&WP_ICE_GATE);var a=new VLMPosition(t.longitude1,t.latitude1);if((t.format&WP_GATE_BUOY_MASK)!==WP_TWO_BUOYS)throw"not implemented 1 buoy gate";return{P1:a,P2:new VLMPosition(t.longitude2,t.latitude2)}},this.GetClosestEstimatePoint=function(e){if(void 0===e||!e)return this.Estimator&&this.Estimator.ClearEstimatePosition(this.Estimator.Boat),null;if(this.Estimator){var t=this.Estimator.GetClosestEstimatePoint(e);return t?this.Estimator.ShowEstimatePosition(this.Estimator.Boat,t):this.Estimator.ClearEstimatePosition(this.Estimator.Boat),t}return this.Estimator.ShowEstimatePosition(null,null),null},this.GetNextWPPosition=function(e,t,a){if(void 0===this.VLMInfo)return null;this.VLMInfo.NWP;if(!(void 0!==a&&a||"0"===this.VLMInfo.WPLON&&"0"===this.VLMInfo.WPLAT))return new VLMPosition(this.VLMInfo.WPLON,this.VLMInfo.WPLAT);if(void 0!==a&&a&&0!==a.Lon.Value&&0!==a.Lat.Value)return new VLMPosition(a.Lon.Value,a.Lat.Value);var o=this.VLMInfo.NWP;void 0!==e&&e&&(o=e);var n=this.GetNextGateSegment(o);if(void 0===n||!n)return null;var i,r=n.P1.GetLoxoCourse(n.P2);i=void 0!==t&&t?t:new VLMPosition(this.VLMInfo.LON,this.VLMInfo.LAT);var s=r-n.P1.GetOrthoCourse(i);if(s>180?s-=360:s<-180&&(s+=360),(s=Math.abs(s))>90)return n.P1;var l=n.P1.GetLoxoDist(i);try{var c=l*Math.cos(Deg2Rad(s));return n.P1.GetLoxoDist(n.P2)>c?n.P1.ReachDistLoxo(c,r):n.P2}catch(e){return null}}}function User(){this.IdPlayer=-1,this.IsAdmin=!1,this.PlayerName="",this.PlayerJID="",this.Fleet=[],this.BSFleet=[],this.CurBoat={},this.LastLogin=0,this.KeepAlive=function(){console.log("Keeping login alive..."),CheckLogin()},setInterval(this.KeepAlive,6e5)}function IsLoggedIn(){return _IsLoggedIn&&StatMGR.CheckGConsent(),_IsLoggedIn}function OnLoginRequest(){CheckLogin(!0)}function GetPHPSessId(){var e,t=document.cookie.split(";");for(e in t)if(t[e]){var a=t[e].split("=");if(a[0]&&"PHPSESSID"===a[0].trim())return a[0]}return null}function CheckLogin(e){var t=$(".UserName").val(),a=$(".UserPassword").val();GetPHPSessId()||"string"==typeof t&&"string"==typeof a&&t.trim().length>0&&a.trim().length>0?(ShowPb("#PbLoginProgress"),$.post("/ws/login.php",{VLM_AUTH_USER:t.trim(),VLM_AUTH_PW:a.trim()},function(t){var a=JSON.parse(t),o=null;_IsLoggedIn&&(o=_CurPlayer.CurBoatID),_IsLoggedIn=!0===a.success,HandleCheckLoginResponse(e),o&&SetCurrentBoat(GetBoatFromIdu(select),!1)})):HandleCheckLoginResponse(e)}function HandleCheckLoginResponse(e){_IsLoggedIn?(StatMGR.CheckGConsent(),GetPlayerInfo()):e&&(VLMAlertDanger(GetLocalizedString("authfailed")),$(".UserPassword").val(""),setTimeout(function(){$("#LoginForm").modal("hide").modal("show")},1e3),initrecaptcha(!0,!1),$("#ResetPasswordLink").removeClass("hidden")),HidePb("#PbLoginProgress"),DisplayLoggedInMenus(_IsLoggedIn)}function Logout(){DisplayLoggedInMenus(!1),$.post("/ws/logout.php",function(e){e.success?window.location.reload():(VLMAlertDanger("Something bad happened while logging out. Restart browser..."),windows.location.reload())}),_IsLoggedIn=!1}var _CurPlayer=null;function GetPlayerInfo(){ShowBgLoad(),$.get("/ws/playerinfo/profile.php",function(e){e.success?(void 0!==_CurPlayer&&_CurPlayer||(_CurPlayer=new User),_CurPlayer.IdPlayer=e.profile.idp,_CurPlayer.IsAdmin=e.profile.admin,_CurPlayer.PlayerName=e.profile.playername,$.get("/ws/playerinfo/fleet_private.php",HandleFleetInfoLoaded),RefreshPlayerMenu()):Logout()})}function HandleFleetInfoLoaded(e){var t;for(var a in void 0===_CurPlayer&&(_CurPlayer=new User),void 0===_CurPlayer.Fleet&&(_CurPlayer.Fleet=[]),e.fleet)void 0===_CurPlayer.Fleet[a]&&(_CurPlayer.Fleet[a]=new Boat(e.fleet[a]),void 0===t&&(t=_CurPlayer.Fleet[a]));for(var o in void 0===_CurPlayer.fleet_boatsit&&(_CurPlayer.fleet_boatsit=[]),e.fleet_boatsit)void 0===_CurPlayer.BSFleet[o]&&(_CurPlayer.BSFleet[o]=new Boat(e.fleet_boatsit[o]));RefreshPlayerMenu(),void 0!==t&&t&&(DisplayCurrentDDSelectedBoat(t),SetCurrentBoat(GetBoatFromIdu(t),!0),RefreshCurrentBoat(!0,!1))}function RefreshPlayerMenu(){for(var e in $("#PlayerId").text(_CurPlayer.PlayerName),ClearBoatSelector(),_CurPlayer.Fleet)AddBoatToSelector(_CurPlayer.Fleet[e],!0);for(var t in _CurPlayer.BSFleet)_CurPlayer.BSFleet[t]&&AddBoatToSelector(_CurPlayer.BSFleet[t],!1);DisplayLoggedInMenus(!0),HideBgLoad("#PbLoginProgress")}function SetupUserMenu(){var e=$(document).width()/2-$(".UserMenu").width()/2+"px";$(".UserMenu").show(),$(".UserMenu").animate({left:e,top:0},0)}function GetBoatFromIdu(e){if(void 0!==_CurPlayer){var t=GetBoatFromBoatArray(_CurPlayer.Fleet,e);return void 0===t&&(t=GetBoatFromBoatArray(_CurPlayer.BSFleet,e)),t}}function GetBoatFromBoatArray(e,t){for(var a in t=parseInt(t,10),e)if(e[a]&&e[a].IdBoat===t)return e[a]}function GetFlagsList(){$.get("/ws/serverinfo/flags.php",function(e){if(e.success){var t=$("#CountryDropDownList"),a=0;for(var o in e.flags)if(e.flags[o]){var n=e.flags[o];t.append("<li class='FlagLine DDLine' flag='"+n+"'>"+GetCountryDropDownSelectorHTML(n,!0,a++)+"</li>")}}$(".FlagLine").on("click",HandleFlagLineClick)})}var FlagsIndexCache=[];function GetCountryDropDownSelectorHTML(e,t,a){if(t){var o=GetCountryFlagImg(e,a);FlagsIndexCache[e]=o}var n=" <span  class='FlagLabel' flag='"+e+"'> - "+e+"</span>";return FlagsIndexCache[e]+n}function GetCountryFlagImgHTML(e){return FlagsIndexCache[e]}function GetCountryFlagImg(e,t){return" <div class='FlagIcon' style='background-position: -"+t%16*30+"px -"+20*Math.floor(t/16)+"px' flag='"+e+"'></div>"}var VLM_COORDS_FACTOR=1e3,OppPopups=[],StartSetWPOnClick=!1;function SetCurrentBoat(e,t,a,o){_CurPlayer&&_CurPlayer.CurBoat&&e&&(_CurPlayer.CurBoat.IdBoat!==e.IdBoat&&ClearCurrentMapMarkers(_CurPlayer.CurBoat),EnsureMarkersVisible(e)),CheckBoatRefreshRequired(e,t,a,o)}var BoatLoading=new Date(0);function CheckBoatRefreshRequired(e,t,a,o){if(void 0!==e&&e){var n=new Date,i=void 0!==e&&(void 0===e.VLMInfo||void 0===e.VLMInfo.AVG);UpdatePrefsDialog(e),void 0!==e.VLMInfo&&void 0!==e.VLMInfo.LUP||(a=!0),a||n>=e.NextServerRequestDate?(BoatLoading=n+3e3,console.log("Loading boat info from server...."),ShowPb("#PbGetBoatProgress"),$.get("/ws/boatinfo.php?forcefmt=json&select_idu="+e.IdBoat,function(a){if(e.IdBoat===parseInt(a.IDU,10)){_CurPlayer.CurBoat=e,LoadVLMPrefs(),e.VLMInfo=a,e.NextServerRequestDate=new Date(1e3*(parseInt(e.VLMInfo.LUP,10)+parseInt(e.VLMInfo.VAC,10))),e.LastRefresh=new Date,e.VLMInfo.LON/=VLM_COORDS_FACTOR,e.VLMInfo.LAT/=VLM_COORDS_FACTOR,console.log("DBG WIND ");var n=GribMgr.WindAtPointInTime(new Date(1566149443e3),49.753227868452,-8.9971082951315);if(n){var r=n.Heading+40,s=PolarsManager.GetBoatSpeed("boat_figaro2",n.Speed,n.Heading,r);if(!isNaN(s))new VLMPosition(49.753227868452,-8.9971082951315).ReachDistLoxo(s/3600*300,r)}i&&UpdatePrefsDialog(e),"0"!==e.VLMInfo.RAC?(void 0!==e.RaceInfo&&void 0!==e.RaceInfo.idraces||(GetRaceInfoFromServer(e,o),GetRaceExclusionsFromServer(e)),GetTrackFromServer(e),e.VLMInfo&&e.VLMInfo.RAC&&LoadRankings(e.VLMInfo.RAC),LoadRealsList(e),DrawBoat(e,t),UpdateInMenuRacingBoatInfo(e,o)):(NotifyEndOfRace(e.IdBoat),UpdateInMenuDockingBoatInfo(e),$(".NWPBadge").css("visibility","hidden"))}HidePb("#PbGetBoatProgress"),OnPlayerLoadedCallBack&&(OnPlayerLoadedCallBack(),OnPlayerLoadedCallBack=null)})):e&&(_CurPlayer.CurBoat=e,UpdateInMenuDockingBoatInfo(e),UpdateInMenuRacingBoatInfo(e,o),DrawBoat(e,t))}}function NotifyEndOfRace(e){$.get("/ws/boatinfo/palmares.php?idu="+e,function(e){var t;if(e.success)for(t in e.palmares)if(e.palmares[t]){var a=e.palmares[t],o=new Race(a.idrace);if(o.HasSave()){var n=GetLocalizedString("EndOfRaceMessage",[a.racename,a.ranking.rank,a.ranking.racercount]);new RaceNewsHandler(GetLocalizedString("EndOfRaceTitle"),n).Show(),o.ClearData(),StatMGR.Stat("EndOfRaceMessage",a.raceid)}break}})}function GetTrackFromServer(e){var t=Math.floor(new Date/1e3),a=t-172800;$.get("/ws/boatinfo/tracks_private.php?idu="+e.IdBoat+"&idr="+e.VLMInfo.RAC+"&starttime="+a+"&endtime="+t,function(t){if(t.success){for(var a in void 0!==e.Track?e.Track.length=0:e.Track=[],t.tracks)if(t.tracks[a]){var o=new VLMPosition(t.tracks[a][1]/1e3,t.tracks[a][2]/1e3);e.Track.push(o)}DrawBoat(e)}})}function GetRaceExclusionsFromServer(e){$.get("/ws/raceinfo/exclusions.php?idrace="+e.VLMInfo.RAC+"&v="+e.VLMInfo.VER,function(t){if(t.success){var a,o,n=[],i=[];for(o in t.Exclusions)if(t.Exclusions[o]){var r=t.Exclusions[o];(void 0===a||a[0]!==r[0][0]&&a[1]!==r[0][1])&&(void 0!==a&&(n.push(i),i=[]),i.push(r[0])),a=r[1],i.push(r[1])}n.push(i),e.Exclusions=n,DrawRaceExclusionZones(e,n)}})}function GetRaceInfoFromServer(e,t){$.get("/ws/raceinfo/desc.php?idrace="+e.VLMInfo.RAC+"&v="+e.VLMInfo.VER,function(a){e.RaceInfo=a;var o=new Race(e.VLMInfo.RAC);if(!o.CheckRaceUpdates(e.RaceInfo))if(o.UpdatedRaceForStart){var n=GetLocalizedString("RaceStartedNotice"),i="<H2>"+GetLocalizedString("racestarted",[e.VLMInfo.racename,e.VLMInfo.deptime])+"</H2>";new RaceNewsHandler(n,i).Show()}else{var r=GetLocalizedString("RaceChangeNotice"),s="<H2>"+e.RaceInfo.UpdateReason+"</H2>"+GetLocalizedString("RaceChangeNoticeText");new RaceNewsHandler(r,s).Show()}DrawRaceGates(e),UpdateInMenuRacingBoatInfo(e,t)})}var DrawBoatTimeOutHandle=null,DeferredCenterValue=!1;function DrawBoat(e,t){void 0!==t&&(DeferredCenterValue=DeferredCenterValue||t),console.log("Call DrawbBoat ("+t+") deferred : "+DeferredCenterValue),DrawBoatTimeOutHandle&&(console.log("Pushed DrawBoat"),clearTimeout(DrawBoatTimeOutHandle)),DrawBoatTimeOutHandle=setTimeout(ActualDrawBoat,100,e,DeferredCenterValue)}function GetRaceMapFeatures(e){if(!e)throw"Should not GetRaceFeature unless a boat is defined";return void 0===e.RaceMapFeatures&&(e.RaceMapFeatures={}),e.RaceMapFeatures}function ActualDrawBoat(e,t){map.zoom;if(DeferredCenterValue=!1,DrawBoatTimeOutHandle=null,void 0===e||!e){if(void 0===_CurPlayer||!_CurPlayer||void 0===_CurPlayer.CurBoat||!_CurPlayer.CurBoat)return;e=_CurPlayer.CurBoat}if(void 0!==e&&e){var a=GetRaceMapFeatures(e),o=a.TrackWP,n=null;if(void 0!==e&&e&&(n=e.GetNextWPPosition()),void 0!==n&&n&&!isNaN(n.Lat.Value)&&!isNaN(n.Lon.Value))if(o)o.setLatLng([n.Lat.Value,n.Lon.Value]);else{var i=GetTrackWPMarker();a.TrackWP=L.marker([n.Lat.Value,n.Lon.Value],{icon:i,draggable:!0}).addTo(map).on("dragend",HandleWPDragEnded)}if(void 0!==_typeof(e.VLMInfo)&&e.VLMInfo&&(e.VLMInfo.LON||e.VLMInfo.LAT)){var r=a.BoatMarker;r?(r.setLatLng([e.VLMInfo.LAT,e.VLMInfo.LON]),r.setRotationAngle(e.VLMInfo.HDG)):(r=GetBoatMarker(e.VLMInfo.idusers),a.BoatMarker=L.marker([e.VLMInfo.LAT,e.VLMInfo.LON],{icon:r,rotationAngle:e.VLMInfo.HDG}).addTo(map).on("click",HandleOpponentClick)),void 0!==map&&map&&DrawBoatPolar(e,t,a)}void 0!==e.Track&&e.Track.length>0&&DrawBoatTrack(e,a),DrawBoatEstimateTrack(e,a),DrawOpponents(e),t&&void 0!==e.VLMInfo&&e.VLMInfo&&void 0!==map&&map&&map.setView([e.VLMInfo.LAT,e.VLMInfo.LON]),RepositionCompass(e),console.log("ActualDrawBoatComplete")}}function GetNextPilOrderDate(e){if(Boat&&Boat.VLMInfo&&Boat.VLM.PIL)for(var t in NextPilOrder=null,Boat.VLM.PIL)if(Boat.VLM.PIL[t]&&"pending"===Boat.VLM.PIL[t].STS&&t>e)return t;return-1}function GetPilototoMarkerText(e){var t=moment("/date("+1e3*e.TTS+")/"),a="Date : "+GetLocalUTCTime(t,!0,!0)+"<BR>"+t.fromNow();switch(parseInt(e.PIM,10)){case PM_ANGLE:a+="<BR>"+GetLocalizedString("constantengaged")+" : "+e.PIP+"°";break;case PM_HEADING:a+="<BR>"+GetLocalizedString("heading")+" : "+e.PIP+"°";break;case PM_ORTHO:a+="<BR>"+GetLocalizedString("OrthoToWP")+" : "+e.PIP;break;case PM_VMG:a+="<BR>"+GetLocalizedString("bestvmgengaged")+" : "+e.PIP;break;case PM_VBVMG:a+="<BR>"+GetLocalizedString("vbvmgengaged")+" : "+e.PIP;break;default:a+="<BR> Strange PIM"+e.PIM+" : "+e.PIP}return a}function DrawBoatEstimateTrack(e,t){if(void 0!==e.Estimator&&e.Estimator){var a=e.Estimator.GetEstimateTracks(),o=["green","yellow","white"];for(var n in a)if(t.EstimateTracks&&t.EstimateTracks[n])void 0!==a[n]?t.EstimateTracks[n].setLatLngs(a[n]):(t.EstimateTracks[n].remove(),t.EstimateTracks[n]=null);else if(void 0===t.EstimateTracks&&(t.EstimateTracks=[]),a[n]){var i={weight:2,opacity:1,color:o[n]};t.EstimateTracks[n]=L.polyline(a[n],i).addTo(map)}var r=e.Estimator.GetPilotPoints();for(var s in void 0===t.PilotMarkers&&(t.PilotMarkers=[]),r)if(r[s]){var l=r[s],c=[l.Pos.Lat.Value,l.Pos.Lon.Value],d=!1;if(t.PilotMarkers[s]&&!t.PilotMarkers[s]._map)t.PilotMarkers[s].setLatLng(c),d=!0;else if(!t.PilotMarkers[s]){var u=GetPilototoMarker(l,s);t.PilotMarkers[s]=L.marker(c,{icon:u}).on("popupopen",HandlePilototoPopup),d=!0}if(d){var p=GetPilototoMarkerText(l);t.PilotMarkers[s].addTo(map).bindPopup(p)}}}}function HandlePilototoPopup(e){var t=e.popup._source.options.icon;if(!t.Opening){t.Opening=!0;var a=GetPilototoMarkerText(t.Order);e.sourceTarget.unbindPopup().bindPopup(a).closePopup().openPopup(),t.Opening=null}}function RepositionCompass(e){if(e){var t=GetRaceMapFeatures(e);map.Compass&&(t.Compass&&-1==t.Compass.Lat&&-1==t.Compass.Lon||!t.Compass&&e.VLMInfo&&(e.VLMInfo.LAT||e.VLMInfo.LON)?map.Compass.setLatLng([e.VLMInfo.LAT,e.VLMInfo.LON]):!t.Compass||isNaN(t.Compass.Lat)||isNaN(t.Compass.Lon)||map.Compass.setLatLng([t.Compass.Lat,t.Compass.Lon]))}}function DrawBoatTrack(e,t){var a=GetSafeTrackPointList(e.Track),o=e.VLMInfo.COL;o=SafeHTMLColor(o);var n=t.BoatTrack;n?n.setLatLngs(a):t.BoatTrack=L.polyline(a,{type:"HistoryTrack",color:o,weight:1.2}).addTo(map)}function GetSafeTrackPointList(e){for(var t=[],a=0,o=0,n=e.length-1;n>=0;n--){var i=e[n];a*i.Lon.Value<0&&Math.abs(i.Lon.Value-a)>90&&(a<0?o-=360:o+=360),t.unshift([i.Lat.Value,i.Lon.Value+o]),a=i.Lon.Value}return t}function DrawBoatPolar(e,t,a){var o,n=new VLMPosition(e.VLMInfo.LON,e.VLMInfo.LAT);o=BuildPolarLine(e,n,VLM2Prefs.MapPrefs.PolarVacCount,new Date(1e3*e.VLMInfo.LUP),function(){DrawBoatPolar(e,t,a)}),a.Polar=DefinePolarMarker(o,a.Polar)}function DefinePolarMarker(e,t){if(e)if(t)t.setLatLngs(e).addTo(map);else{(t=L.polyline(e,{color:"white",opacity:.6,weight:1})).addTo(map)}else t&&t.remove(),t=null;return t}function BuildPolarLine(e,t,a,o,n){var i=o,r=null;e&&e.VLMInfo&&e.VLMInfo.VAC&&(i-=1e3*e.VLMInfo.VAC),(!i||i<(new Date).getTime())&&(i=(new Date).getTime());var s=null;if(t&&t.Lat&&t.Lon&&(s=GribMgr.WindAtPointInTime(i,t.Lat.Value,t.Lon.Value,n)),s){parseFloat(e.VLMInfo.HDG);var l,c=[];for(l=0;l<=180;l+=5){var d=PolarsManager.GetBoatSpeed(e.VLMInfo.POL,s.Speed,s.Heading,s.Heading+l);if(isNaN(d))return;for(var u=-1;u<=1;u+=2){var p=t.ReachDistLoxo(d/3600*e.VLMInfo.VAC*a,s.Heading+l*u),h=[p.Lat.Value,p.Lon.Value];c[u*l+180]=h}}for(var P in r=[],c)c[P]&&r.push(c[P])}return r}function GetVLMPositionFromClick(e){if(map){var t=map.getLonLatFromPixel(e).transform(new OpenLayers.Projection("EPSG:900913"),new OpenLayers.Projection("EPSG:4326"));return new VLMPosition(t.lon,t.lat)}return null}function CompleteWPSetPosition(e){var t=null;if(e.getLatLng)t=e.getLatLng();else{if(!e.latlng)return void VLMAlertDanger("Unexpected Object when setting WP report to devs.");t=e.latlng}var a=new VLMPosition(t.lng,t.lat);SendVLMBoatWPPos(_CurPlayer.CurBoat,a)}var WP_TWO_BUOYS=0,WP_ONE_BUOY=1,WP_GATE_BUOY_MASK=15,WP_DEFAULT=0,WP_ICE_GATE_N=16,WP_ICE_GATE_S=32,WP_ICE_GATE_E=64,WP_ICE_GATE_W=128,WP_ICE_GATE=WP_ICE_GATE_E|WP_ICE_GATE_N|WP_ICE_GATE_S|WP_ICE_GATE_W,WP_GATE_KIND_MASK=65520,WP_CROSS_CLOCKWISE=256,WP_CROSS_ANTI_CLOCKWISE=512,WP_CROSS_ONCE=1024,Exclusions=[];function DrawRaceGates(e){if(void 0!==e&&e&&e.RaceInfo){var t=e.RaceInfo,a=e.VLMInfo.NWP,o=GetRaceMapFeatures(e);if(void 0!==_typeof(t)&&t&&void 0!==t.races_waypoints&&t.races_waypoints)for(var n in t.races_waypoints){o.Gates||(o.Gates=[]),o.Gates[n]||(o.Gates[n]={});var i=o.Gates[n];if(t.races_waypoints[n]){var r=i.Buoy1,s=t.races_waypoints[n];NormalizeRaceInfo(t);var l=!(s.wpformat&WP_CROSS_ANTI_CLOCKWISE),c=new VLMPosition(s.longitude1,s.latitude1);if(i.Buoy1=AddBuoyMarker(r,"WP"+n+" "+s.libelle+"<BR>"+c.toString(),s.longitude1,s.latitude1,l),(s.wpformat&WP_GATE_BUOY_MASK)===WP_TWO_BUOYS){var d=i.Buoy2,u=new VLMPosition(s.longitude2,s.latitude2);i.Buoy2=AddBuoyMarker(d,"WP"+n+" "+s.libelle+"<BR>"+u.toString(),s.longitude2,s.latitude2,!l)}else{for(var p=new VLMPosition(s.longitude1,s.latitude1),h=!1,P=2500,f=null;!h;)try{f=p.ReachDistLoxo(P,180+parseFloat(s.laisser_au)),h=!0}catch(e){P*=.7}s.longitude2=f.Lon.Value,s.latitude2=f.Lat.Value}n=parseInt(n,10),a=parseInt(a,10),AddGateSegment(i,s.longitude1,s.latitude1,s.longitude2,s.latitude2,a===n,n<a,s.wpformat&WP_GATE_KIND_MASK)}}}}function DrawRaceExclusionZones(e,t){if(e){var a=GetRaceMapFeatures(e);for(var o in t)t[o]&&DrawRaceExclusionZone(a,t,o)}}function DrawRaceExclusionZone(e,t,a){var o=[],n=!1;for(var i in t[a])if(t[a][i]){var r=[t[a][i][0],t[a][i][1]];o.push(r),n=!0}n?(void 0===e.Exclusions&&(e.Exclusions=[]),e.Exclusions[a]?e.Exclusions[a].setLatLngs(o).addTo(map):e.Exclusions[a]=L.polygon(o,{color:"red",opacity:.25,weight:3}).addTo(map)):e.Exclusions&&e.Exclusions[index]&&(e.Exclusions[a].remove(),e.Exclusions[a]=null)}function GetLonOffset(e,t){return e*t>=0?0:Math.abs(t-e)>90?e>0?360:-360:0}function AddGateSegment(e,t,a,o,n,i,r,s){var l=[[a,t],[n,o]],c="";if(c=i?"green":r?"blue":"red",s&WP_CROSS_ONCE&&(e.Segment2?e.Segment2.setLatLngs(l):e.Segment2=L.polyline(l,{color:"black",dashArray:"20,10,5,10",weight:2,opacity:.75}).addTo(map)),e.Segment?(e.Segment.setLatLngs(l),e.Segment.color=c):e.Segment=L.polyline(l,{color:c,weight:1,opacity:.75}).addTo(map),s!==WP_DEFAULT){var d=new VLMPosition(t,a),u=new VLMPosition(o,n),p=d.GetLoxoCourse(u),h=d.ReachDistLoxo(u,.5);s&WP_CROSS_ANTI_CLOCKWISE?(p-=90,AddGateDirMarker(e,h.Lon.Value,h.Lat.Value,p)):s&WP_CROSS_CLOCKWISE?(p+=90,AddGateDirMarker(e,h.Lon.Value,h.Lat.Value,p)):s&WP_ICE_GATE&&AddGateIceGateMarker(e,h.Lon.Value,h.Lat.Value)}}var MAX_BUOY_INDEX=16,BuoyIndex=Math.floor(Math.random()*MAX_BUOY_INDEX);function AddGateDirMarker(e,t,a,o){AddGateCenterMarker(e,t,a,"BuoyDirs/BuoyDir"+BuoyIndex+".png",o,!1),BuoyIndex++,BuoyIndex%=MAX_BUOY_INDEX+1}function AddGateIceGateMarker(e,t,a){AddGateCenterMarker(e,t,a,"icegate.png",!0)}function AddGateCenterMarker(e,t,a,o,n,i){var r=[a,t];if(e.GateMarker)e.GateMarker.setLatLng(r);else{var s=GetGateTypeMarker(o,i);e.GateMarker=L.marker(r,{icon:s}).addTo(map),i||e.GateMarker.setRotationAngle(n)}}function AddBuoyMarker(e,t,a,o,n){var i=GetBuoyMarker(n);if(e){if(e.IsCWBuoy===n)return e.setLatLng([o,a]);e.remove()}return L.marker([o,a],{icon:i}).addTo(map).bindPopup(t)}var PM_HEADING=1,PM_ANGLE=2,PM_ORTHO=3,PM_VMG=4,PM_VBVMG=5;function SendVLMBoatWPPos(e,t){var a={idu:e.IdBoat,pip:{targetlat:t.Lat.Value,targetlong:t.Lon.Value,targetandhdg:-1}};PostBoatSetupOrder(e.IdBoat,"target_set",a)}function SendVLMBoatOrder(e,t,a,o){var n={};if(void 0!==_CurPlayer&&void 0!==_CurPlayer.CurBoat){switch(e){case PM_HEADING:case PM_ANGLE:n={idu:_CurPlayer.CurBoat.IdBoat,pim:e,pip:t};break;case PM_ORTHO:case PM_VBVMG:case PM_VMG:n={idu:_CurPlayer.CurBoat.IdBoat,pim:e,pip:{targetlong:parseFloat(t),targetlat:parseFloat(a),targetandhdg:o}};break;default:return}PostBoatSetupOrder(_CurPlayer.CurBoat.IdBoat,"pilot_set",n)}else VLMAlertDanger("Must select a boat to send an order")}function PostBoatSetupOrder(e,t,a){$.post("/ws/boatsetup/"+t+".php?selectidu="+e,"parms="+JSON.stringify(a),function(e,t){e.success?RefreshCurrentBoat(!1,!0):VLMAlertDanger(GetLocalizedString("BoatSetupError")+"\n"+e.error.code+" "+e.error.msg)})}function EngageBoatInRace(e,t){new Race(e).Subscribe(t)}function DiconstinueRace(e,t){$.post("/ws/boatsetup/race_unsubscribe.php","parms="+JSON.stringify({idu:e,idr:parseInt(t,10)}),function(e){e.success?VLMAlertSuccess("Bye Bye!"):VLMAlertDanger(e.error.msg+"\n"+e.error.custom_error_string)})}function LoadRealsList(e){void 0!==e&&e&&void 0!==e.VLMInfo&&$.get("/ws/realinfo/realranking.php?idr="+e.VLMInfo.RAC,function(t){t.success?(e.Reals=t,DrawBoat(e,!1)):e.Reals=[]})}function LoadRankings(e,t){e&&"object"===_typeof(e)&&VLMAlertDanger("Not updated call to LoadRankings"),$.get("/cache/rankings/rnk_"+e+".json",function(a){a?(Rankings[e]=a.Boats,ResetRankingWPList(),t&&t(e)):Rankings[e]=null})}function contains(e,t){for(var a=0;a<e.length;a++)if(e[a]===t)return!0;return!1}function DrawOpponents(e){if(e&&void 0!==Rankings){var t,a=[],o=GetRaceMapFeatures(e);if(VLM2Prefs.MapPrefs.MapOppShow===VLM2Prefs.MapPrefs.MapOppShowOptions.ShowSel&&(void 0!==e.VLMInfo&&void 0!==e.VLMInfo.MPO&&(a=e.VLMInfo.MPO.split(",")),0!==a.length)){var n=e.VLMInfo.RAC;for(t in a)if(a[t]&&Rankings[n]){var i=Rankings[n][a[t]];void 0!==i&&parseInt(i.idusers,10)!==e.IdBoat&&AddOpponent(e,o,i,!0)}}if(VLM2Prefs.MapPrefs.ShowReals&&void 0!==e.Reals&&void 0!==e.Reals.ranking)for(t in e.Reals.ranking){AddOpponent(e,o,e.Reals.ranking[t],!0)}var r=150,s=r/Object.keys(Rankings).length,l=0,c=Rankings;switch(void 0!==e.OppList&&e.OppList.length>0&&(c=e.OppList,s=1),VLM2Prefs.MapPrefs.MapOppShow){case VLM2Prefs.MapPrefs.MapOppShowOptions.Show10Around:c=GetClosestOpps(e,10),s=1;break;case VLM2Prefs.MapPrefs.MapOppShowOptions.Show5Around:c=GetClosestOpps(e,5),s=1;break;case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowTop10:var d=0,u=e.Engaged;for(t in r=VLM2Prefs.MapPrefs.ShowTopCount,c=[],Rankings[u])if(Rankings[u][t].rank<=VLM2Prefs.MapPrefs.ShowTopCount&&(c[t]=Rankings[u][t],++d>r))break;d>r&&(r=d),s=1;break;case VLM2Prefs.MapPrefs.MapOppShowOptions.ShowMineOnly:c=[],s=1}if(SortRankingData(e,"RAC",null,e.Engaged),e.Engaged&&void 0!==Rankings[e.Engaged]&&void 0!==Rankings[e.Engaged].RacerRanking&&Rankings[e.Engaged].RacerRanking)for(t in Rankings[e.Engaged].RacerRanking)if(t in Rankings[e.Engaged].RacerRanking){var p=Rankings[e.Engaged].RacerRanking[t];if(parseInt(p.idusers,10)!==e.IdBoat&&c[p.idusers]&&!contains(a,p.idusers)&&RnkIsRacing(p)&&Math.random()<=s&&l<r)AddOpponent(e,o,p,!1),l+=1,void 0===e.OppList&&(e.OppList=[]),e.OppList[t]=p;else if(l>=r)break}if(void 0!==e.RaceMapFeatures&&Object.keys(e.OppTrack).length>0){var h=e.RaceMapFeatures;for(var P in e.OppTrack){var f=e.OppTrack[P];if(f&&f.Visible&&f.DatePos.length>1){if(!f.OppTrackPoints){for(var g=[],M=Object.keys(f.DatePos).length,m=0;m<M;m++){var C=Object.keys(f.DatePos)[m],v=f.DatePos[C],I=new VLMPosition(v.lon,v.lat);g.push(I)}f.OppTrackPoints=GetSafeTrackPointList(g)}if(void 0===h.OppTrack&&(h.OppTrack=[]),h.OppTrack[P])h.OppTrack[P].setLatLngs(f.OppTrackPoints).addTo(map);else{var R="black";void 0!==f.TrackColor&&(R=f.TrackColor);var _={color:R,weight:1,opacity:.75};h.OppTrack[P]=L.polyline(f.OppTrackPoints,_).addTo(map)}f.LastShow=new Date}else e.RaceMapFeatures.OppTrack&&e.RaceMapFeatures.OppTrack[P]&&e.RaceMapFeatures.OppTrack[P].remove()}}}}function CompareDist(e,t){return e.dnm<t.dnm?-1:e.dnm>t.dnm?1:0}function GetClosestOpps(e,t){var a=null;e&&e.VLMInfo&&(a=e.VLMInfo.RAC);var o=[];if(a&&Rankings[a]){var n=Rankings[a][e.IdBoat];void 0!==n&&e||(n={dnm:0,nwp:1});var i=parseFloat(n.dnm),r=n.nwp,s=[];for(var l in Rankings[a])if(Rankings[a][l]&&r===Rankings[a][l].nwp){var c={id:l,dnm:Math.abs(i-parseFloat(Rankings[a][l].dnm))};s.push(c)}for(var d in(s=s.sort(CompareDist)).slice(0,t-1))o[s[d].id]=Rankings[a][s[d].id]}return o}function AddOpponent(e,t,a,o){var n=[a.latitude,a.longitude],i={name:a.idusers,Coords:new VLMPosition(a.longitude,a.latitude).toString(),type:"opponent",idboat:a.idusers,rank:a.rank,Last1h:a.last1h,Last3h:a.last3h,Last24h:a.last24h,IsTeam:a.country==e.VLMInfo.CNT?"team":"",IsFriend:o?16:8,color:a.color};if(VLM2Prefs.MapPrefs.ShowOppNumbers||(i.name=""),void 0===t.Opponents&&(t.Opponents=[]),t.Opponents[a.idusers])t.Opponents[a.idusers].setLatLng(n);else{var r=GetOpponentMarker(i);t.Opponents[a.idusers]=L.marker(n,{icon:r}).addTo(map),t.Opponents[a.idusers].on("click",HandleOpponentClick),t.Opponents[a.idusers].on("mouseover",HandleOpponentOver),t.Opponents[a.idusers].IdUsers=a.idusers}}function ShowOpponentPopupInfo(e){var t=e.sourceTarget;if(t&&t.options&&t.options.icon&&void 0!==t.options.icon.MarkerOppId){var a=GetOppBoat(t.options.icon.MarkerOppId);if(a){var o=new VLMPosition(a.longitude,a.latitude),n=GetRaceMapFeatures(_CurPlayer.CurBoat);if(n){var i=BuildBoatPopupInfo(a);n.OppPopup||(n.OppPopup=L.popup(i)),n.OppPopup.PrevOpp&&n.OppPopup.PrevOpp.unbindPopup(),t.bindPopup(n.OppPopup),n.OppPopup.setContent(i),n.OppPopup.PrevOpp=t;var r=[],s=t.options.icon.MarkerOppId;t.openPopup(),r.push([FIELD_MAPPING_TEXT,"#__BoatName"+s,a.boatname]),r.push([FIELD_MAPPING_TEXT,"#__BoatId"+s,a.idusers]),r.push([FIELD_MAPPING_TEXT,"#__BoatRank"+s,a.rank]),r.push([FIELD_MAPPING_TEXT,"#__BoatLoch"+s,RoundPow(parseFloat(a.loch),2)]),r.push([FIELD_MAPPING_TEXT,"#__BoatNWP"+s,"["+a.nwp+"] "+RoundPow(parseFloat(a.dnm),2)]),r.push([FIELD_MAPPING_TEXT,"#__BoatPosition"+s,o.GetVLMString()]),r.push([FIELD_MAPPING_TEXT,"#__Boat1HAvg"+s,RoundPow(parseFloat(a.last1h),2)]),r.push([FIELD_MAPPING_TEXT,"#__Boat3HAvg"+s,RoundPow(parseFloat(a.last3h),2)]),r.push([FIELD_MAPPING_TEXT,"#__Boat24HAvg"+s,RoundPow(parseFloat(a.last24h),2)]),r.push([FIELD_MAPPING_STYLE,"#__BoatColor"+s,"background-color",SafeHTMLColor(a.color)]),FillFieldsFromMappingTable(r)}}}}function GetOppBoat(e){var t=_CurPlayer.CurBoat;if(void 0!==t&&t&&t.OppList){for(var a in t.OppList)if(t.OppList[a]){var o=t.OppList[a];if(o.idusers===e)return o}if(t.Reals&&t.Reals.ranking)for(var n in t.Reals.ranking)if(t.Reals.ranking[n]){var i=t.Reals.ranking[n];if(i.idusers===e)return i}}return null}function BuildBoatPopupInfo(e){if(!e||!e.idusers)return null;var t=e.idusers;return'<div class="MapPopup_InfoHeader">'+GetCountryFlagImgHTML(e.country)+' <span id="__BoatName'+t+'" class="PopupBoatNameNumber ">BoatName</span> <span id="__BoatId'+t+'" class="PopupBoatNameNumber ">BoatNumber</span> <div id="__BoatRank'+t+'" class="TxtRank">Rank</div></div><div id="__BoatColor'+t+'" style="height: 2px;"></div><div class="MapPopup_InfoBody"> <fieldset>   <span class="PopupHeadText " I18n="loch">'+GetLocalizedString("loch")+'</span><span class="PopupText"> : </span><span id="__BoatLoch'+t+'" class="loch PopupText">0.9563544</span>   <BR><span class="PopupHeadText " I18n="position">'+GetLocalizedString("position")+'</span><span class="PopupText"> : </span><span id="__BoatPosition'+t+'" class=" PopupText">0.9563544</span>   <BR><span class="PopupHeadText " I18n="NextWP">'+GetLocalizedString("NextWP")+'</span><span class="strong"> : </span><span id="__BoatNWP'+t+'" class="PopupText">[1] 4.531856536865234</span>   <BR><span class="PopupHeadText " I18n="Moyennes">'+GetLocalizedString("Moyennes")+' </span><span class="PopupText"> : </span>   <span class="PopupHeadText ">[1h]</span><span id="__Boat1HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>   <span class="PopupHeadText ">[3h]</span><span id="__Boat3HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span>   <span class="PopupHeadText ">[24h]</span><span id="__Boat24HAvg'+t+'" class="PopupText">[1H] </strong>0.946785,[3H] 0.946785,[24H] 0.946785 </span> </fieldset></div>'}function HandleOpponentOver(e){var t,a=e.sourceTarget,o=GetRaceMapFeatures(_CurPlayer.CurBoat),n=a.IdUsers;if(n){for(t in o.OppTrack){var i=t===n;_CurPlayer.CurBoat.OppTrack[t].Visible=i}DrawOpponentTrack(n,o.Opponents[n])}}function HandleOpponentClick(e){HandleOpponentOver(e),ShowOpponentPopupInfo(e)}function HandleFeatureOut(e){if(void 0!==_CurPlayer&&_CurPlayer&&void 0!==_CurPlayer.CurBoat&&_CurPlayer.CurBoat&&void 0!==_CurPlayer.CurBoat.OppTrack)for(var t in _CurPlayer.CurBoat.OppTrack)_CurPlayer.CurBoat.OppTrack[t].Visible=!1}var TrackPendingRequests=[],LastTrackRequest=0;function DrawOpponentTrack(e,t){var a=_CurPlayer.CurBoat,o=new Date,n=null;if(void 0!==a&&a&&o>LastTrackRequest)if(LastTrackRequest=new Date(o/1e3+.5),void 0!==a.OppTrack||!(e in a.OppTrack)||e in a.OppTrack&&a.OppTrack[e].LastShow<=new Date(1e3*a.VLMInfo.LUP)){var i=new Date/1e3-172800,r=a.VLMInfo.RAC,s=new Date;n=e.toString()+"/"+r.toString(),e in a.OppTrack&&(a.OppTrack[e].Visible=!0),n in TrackPendingRequests&&!(s>TrackPendingRequests[n])||(TrackPendingRequests[n]=new Date(s.getTime()+6e4),console.log("GetTrack "+n+" "+i),parseInt(e)>0?GetBoatTrack(a,e,r,i,t):parseInt(e)&&GetRealBoatTrack(a,e,r,i,t))}else console.log(" GetTrack ignore before next update"+n+" "+StartTime)}function GetRealBoatTrack(e,t,a,o,n){$.get("/ws/realinfo/tracks.php?idr="+a+"&idreals="+-t+"&starttime="+o,function(a){a.success&&(AddBoatOppTrackPoints(e,t,a.tracks,n.color),RefreshCurrentBoat(!1,!1))})}var TrackRequestPending=!1;function GetBoatTrack(e,t,a,o,n){TrackRequestPending||(TrackRequestPending=!0,$.get("/ws/boatinfo/smarttracks.php?idu="+t+"&idr="+a+"&starttime="+o,function(a){if(TrackRequestPending=!1,a.success){var o;for(o in AddBoatOppTrackPoints(e,t,a.tracks,n.Color),a.tracks_url){if(o>10)break;$.get("/cache/tracks/"+a.tracks_url[o],function(a){a.success&&(AddBoatOppTrackPoints(e,t,a.tracks,n.Color),DrawOpponents(e))})}DrawOpponents(e)}}))}function AddBoatOppTrackPoints(e,t,a,o){for(var n in t in e.OppTrack||(o=SafeHTMLColor(o),e.OppTrack[t]={LastShow:0,TrackColor:o,DatePos:[],Visible:!0,OppTrackPoints:null}),a){var i=a[n];e.OppTrack[t].DatePos[i[0]]={lat:i[2]/1e3,lon:i[1]/1e3}}e.OppTrack[t].LastShow=0,e.OppTrack[t].OppTrackPoints=[],e.OppTrack[t].OppTrackPoints=null}function DeletePilotOrder(e,t){$.post("/ws/boatsetup/pilototo_delete.php?","parms="+JSON.stringify({idu:e.IdBoat,taskid:parseInt(t)}),function(e){e.success&&RefreshCurrentBoat(!1,!0,"AutoPilot")})}function UpdateBoatPrefs(e,t){void 0!==e&&void 0!==e.IdBoat&&void 0!==t&&(t.idu=e.IdBoat,$.post("/ws/boatsetup/prefs_set.php","parms="+JSON.stringify(t),function(e){e.success?RefreshCurrentBoat(!1,!1):VLMAlertDanger("Save Prefs To Server "+GetLocalizedString("UpdateFailed"))}))}function LoadVLMPrefs(){var e;void 0!==_CurPlayer&&(e=_CurPlayer.CurBoat,SetDDTheme(VLM2Prefs.CurTheme),$.get("/ws/boatinfo/prefs.php?idu="+e.IdBoat,HandlePrefsLoaded))}function HandlePrefsLoaded(e){e.success?(_CurPlayer.CurBoat.VLMPrefs=e.prefs,VLM2Prefs.UpdateVLMPrefs(e.prefs)):VLMAlertDanger("Error communicating with VLM, try reloading the browser page...")}function HandleWPDragEnded(e){var t=_CurPlayer.CurBoat.RaceMapFeatures.TrackWP;CompleteWPSetPosition(t),VLMAlertInfo("User WP moved to "+t.getLatLng())}function InitXmpp(){converse.initialize({bosh_service_url:"https://bind.conversejs.org",i18n:locales.en,show_controlbox_by_default:!0,roster_groups:!0})}